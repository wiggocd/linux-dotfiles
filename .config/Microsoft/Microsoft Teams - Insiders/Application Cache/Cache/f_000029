!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("@skype/rt-js-bindings")):"function"==typeof define&&define.amd?define("skype-calling-electron",["lodash","@skype/rt-js-bindings"],t):"object"==typeof exports?exports["skype-calling-electron"]=t(require("lodash"),require("@skype/rt-js-bindings")):e["skype-calling-electron"]=t(e.lodash,e["@skype/rt-js-bindings"])}("undefined"!=typeof self?self:this,function(e,t){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=40)}([function(t,n){t.exports=e},function(e,t,n){"use strict";function r(){return!!(window.SlimCoreRT&&window.SlimCoreRT.SlimCore&&window.SlimCoreRT.SlimCore.Enums)}function i(e){return e[0].toUpperCase()+e.substr(1)}function o(e,t){var n=i(t);if(n!==t){var r=e[t];e[r]=n,delete e[t],e[n]=r}}function a(e){Object.keys(e).forEach(function(t){o(e,t)})}function s(e,t,n){n[e]={},Object.keys(t).forEach(function(r){n[e][r]=t[r]})}function l(e,t){for(var n in t)if(t.hasOwnProperty(n)&&e[n]!==t[n])return!1;return!0}function c(e,t){return function(n){l(n,t)&&e(n)}}function d(e,t,n,r,i){try{return e.getIntProperty(n,r)}catch(e){return t.logFailure("getIntProperty failed: "+e),i}}function u(e){return new Promise(function(t,n){var r,i=!1,o=null,a=0,s=null,l=function(e){if(i=!0,o&&(o.dispose(),o=null),a&&(clearTimeout(a),a=0),r&&r.dispose(),e)if(s){var l=function(){return n(e)};s.then(l,l)}else n(e);else s?s.then(t,n):t()},c=function(t,n){if(!i){var r=t;void 0===t&&(r=d(e.slimcoreObject,e.logger,e.videoObjectId,S.Property.VideoStatus)),n?e.logger.info("waitForVideoObjectState["+e.videoObjectId+"] timeout. check state "+r+" ("+S.VideoStatus[r]+") again"):e.logger.info("waitForVideoObjectState["+e.videoObjectId+"] state changed -> "+r+" ("+S.VideoStatus[r]+")"),p(r,e.resolveStates)?l():e.rejectStates&&p(r,e.rejectStates)?l("waitForVideoObjectState["+e.videoObjectId+"] rejecting state "+r+" ("+S.VideoStatus[r]+")"):n&&l("waitForVideoObjectState["+e.videoObjectId+"] timeout. state "+r+" ("+S.VideoStatus[r]+") expectedStates "+JSON.stringify(e.resolveStates))}};e.timeout&&(a=setTimeout(function(){return c(void 0,!0)},e.timeout)),e.cancelEvent&&(r=e.cancelEvent.subscribe(function(){e.logger.info("waitForVideoObjectState["+e.videoObjectId+"] canceled. expectedStates "+JSON.stringify(e.resolveStates)),l("waitForVideoObjectState["+e.videoObjectId+"] canceled.")})),o=e.slimcoreInstance.handle("object-property-changed",{objectId:e.videoObjectId,propKey:S.Property.VideoStatus},function(e){return c(e.value)}),e.operation&&(s=e.operation()).catch(l),c()})}function p(e,t){return-1!==t.indexOf(e)}function h(e){var t=_(e,function(e){return e.isDuplicated}),n=_(e,function(e){return e.isPrimary});return 0===t&&1===n&&e.length>1}function g(e){var t=_(e,function(e){return e.isDuplicated}),n=_(e,function(e){return e.isPrimary});return 1===t&&1===n}function _(e,t){return m.reduce(e,function(e,n){return t(n)?e+1:e},0)}var f=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var m=n(0),C=n(24);m.defaults(window,{SlimCore:{}}),m.defaults(SlimCore,{Enums:{}}),r()&&(function(e,t){Object.keys(e).forEach(function(n){s(n,e[n],t)})}(window.SlimCoreRT.SlimCore.Enums,SlimCore.Enums),function(e){Object.keys(e).forEach(function(t){a(e[t])})}(SlimCore.Enums)),Proxy&&(SlimCore.Enums=new Proxy(SlimCore.Enums,{get:function(e,t){return t in e?e[t]:{}}}));var S=SlimCore.Enums;t.isSlimCoreRTModuleAvailable=r;var y=[S.VideoStatus.Available,S.VideoStatus.Starting,S.VideoStatus.Running];t.wrap=function(e,t){void 0===t&&(t={});return t.enableNativeHandle&&"handle"in e?e:m.assign(e,{handle:function(t,n,r){var i=n?c(r,n):r;return e.addListener(t,i),{dispose:function(){e.removeListener(t,i)}}}})};!function(e){e[e.Electron=1]="Electron",e[e.Uwp=2]="Uwp"}(t.PlatformType||(t.PlatformType={})),t.forgetAndLog=function(e,t,n){return e?(t.info("Promise executing: "+n),e.catch(function(e){t.logFailure("Promise execution: "+n+" failed: "+e)})):(t.logFailure("Undefined promise @ "+(new Error).stack),Promise.resolve())},t.getStrProperty=function(e,t,n,r,i){try{return e.getStrProperty(n,r)}catch(e){return t.logFailure("getStrProperty failed for objectId="+n+", propertyKey="+r+": "+e),i}},t.getIntProperty=d,t.hasFeature=function(e){return e in S.Feature};var v=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t.prototype.fire=function(){this.raiseEvents(function(e){return e()})},t}(C.EventSourceImpl);t.VideoStateCancelEvent=v,t.waitForVideoObjectState=u,t.isVideoInState=p,t.videoObjectTimeout=function(e){return 5e3},t.waitForVideoObjectToBeAvailable=function(e,t,n,r,i,o){return u({slimcoreInstance:e,slimcoreObject:t,videoObjectId:n,logger:r,resolveStates:y,rejectStates:[],timeout:i,cancelEvent:o})},t.waitForVideoObjectToBeRunning=function(e,t,n,r,i,o){return u({slimcoreInstance:e,slimcoreObject:t,videoObjectId:n,logger:r,resolveStates:[S.VideoStatus.Running],rejectStates:[S.VideoStatus.Stopping],timeout:i,cancelEvent:o})},t.waitForVideoObjectToBeStopped=function(e,t,n,r,i,o){return u({slimcoreInstance:e,slimcoreObject:t,videoObjectId:n,logger:r,resolveStates:[S.VideoStatus.NotStarted,S.VideoStatus.Available,S.VideoStatus.NotAvailable],rejectStates:[],timeout:i,cancelEvent:o})},t.isVideoAvailable=function(e){return p(e,y)},t.bufferToString=function(e){return String.fromCharCode.apply(null,e)},t.stringToBuffer=function(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n},t.mapMediaTypeStringToMediaType=function(e){switch(e){case"audio":return 0;case"video":return 1;case"panoramic-video":return 2;case"applicationsharing-video":return 3;case"data":return 4;default:return}},t.mapToEmptyStrIfFalsy=function(e){return e||""},t.hasCreateDataSource=function(e){return!(!e.createDataSource&&!SlimCore.createDataSource)},t.hasCreateDataSink=function(e){return!(!e.createDataSink&&!SlimCore.createDataSink)},t.createDataSource=function(e,t){return e.createDataSource?e.createDataSource(t):SlimCore.createDataSource(t)},t.createDataSink=function(e,t){return e.createDataSink?e.createDataSink(t):SlimCore.createDataSink(t)},t.convertImageData=function(e){if(e.isImage)return e;var t=e.data,n=new Uint8ClampedArray(t.buffer,t.byteOffset,t.byteLength);return new ImageData(n,e.width,e.height)},t.convertEndpointScope=function(e){switch(e){case 0:return S.RemoveEndpointScope.RemoveEndpointScopeSpecified;case 1:return S.RemoveEndpointScope.RemoveEndpointScopeOther;default:return}},t.returnVideoDirection=function(e){if(void 0!==e.videoDirection)return e.videoDirection;if(e.withVideo)return 4;if(e.sendMediaModalities&&e.sendMediaModalities.mediaStates){var t=m.find(e.sendMediaModalities.mediaStates,function(e){return 1===e.mediaType});if(t)return t.isDisabled?0:4}return 1},t.returnStringifiedVersionOfMediaStateConfiguration=function(e){return e?JSON.stringify(e,function(e,t){return t&&t.constructor===RegExp?t.toString():"mediaType"===e?0===t?"Audio":4===t?"Data":3===t?"ScreenShare":1===t?"Video":"Unknown":t}):""},t.selectMonitorForScreenSharing=function(e,t){return e?function(t){return e.isDuplicated&&h(t)?m.find(t,function(e){return!e.isInternal}):null}(t)||function(t){return!e.isDuplicated&&g(t)?m.find(t,function(e){return e.isPrimary}):null}(t)||function(t){return m.find(t,function(t){return t.monitorId===e.monitorId||m.isEqual(t.region,e.region)})}(t):null}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=8;t.generateCauseId=function(){for(var e="abcdef0123456789".length,t="",n=0;n<r;n++)t+="abcdef0123456789".charAt(Math.floor(Math.random()*e));return t},t.validateCauseId=function(e){return new RegExp("^[a-f0-9]{8}$").test(e)&&e.length===r}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(41),o=n(1),a=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i._logger=t,i._settings=n,i._slimcoreInstance=r,i._disposables=[],i._objectPropertyChangedHandlers=new Map,i}return r(t,e),t.prototype.dispose=function(t){this._logger.info("dispose"),this._disposables.forEach(function(e){return e.dispose(t)}),this._disposables=[],this._objectPropertyChangedHandlers.clear(),e.prototype.dispose.call(this)},t.prototype._registerDisposable=function(e){e?this._disposables.push(e):this._logger.error("Attempt to register null disposable, ignoring")},t.prototype._getProperties=function(e,t,n,r){if(e.getProperties&&this._settings.enableNativeGetProperties)return e.getProperties(t,n,r);for(var i={},a=0,s=Object.keys(n);a<s.length;a++){u=n[d=s[a]];i[d]=o.getStrProperty(e,this._logger,u.objectId||t,u.propKey,u.fallback)}for(var l=0,c=Object.keys(r);l<c.length;l++){var d=c[l],u=r[d];i[d]=o.getIntProperty(e,this._logger,u.objectId||t,u.propKey,u.fallback)}return i},t.prototype._getStrProperty=function(e,t,n,r){return o.getStrProperty(e,this._logger,t,n,r)},t.prototype._getIntProperty=function(e,t,n,r){return o.getIntProperty(e,this._logger,t,n,r)},t.prototype._onObjectPropertyChanged=function(e,t,n){var r=this;this._objectPropertyChangedHandlers.has(e)||(this._objectPropertyChangedHandlers.set(e,new Map),this._registerDisposable(this._slimcoreInstance.handle("object-property-changed",{objectId:e},function(e){return r._onObjectPropertyChangedCallback(e)}))),this._objectPropertyChangedHandlers.get(e).set(t,n)},t.prototype._onObjectPropertyChangedCallback=function(e){var t=this._objectPropertyChangedHandlers.get(e.objectId);if(t){var n=t.get(e.propKey);if(this._settings.enableSlimCoreEventsCounting){var r=SlimCore.Enums.Property[e.propKey]||e.propKey,i=SlimCore.Enums.ObjectType[e.objectType]||e.objectType;this._logger.debug("_onObjectPropertyChangedCallback - objectId: "+e.objectId+", objectType: "+i+", propKey: "+r+", value: "+e.value+", handler: "+!!n)}n&&n.call(this,e)}},t.prototype.raiseChanged=function(){try{e.prototype.raiseChanged.call(this)}catch(e){this._logger.error("Change handling error: "+e)}},t.prototype._raiseEventImpl=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];try{e.prototype._raiseEventImpl.apply(this,[t].concat(n))}catch(e){this._logger.error("Event '"+t+"' handling error: "+e)}},t}(i.default);t.default=a},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.asap=function(e){return new Promise(function(t){t(e())})};var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(Error);t.TimeoutError=i;var o=function(){function e(e){this.ontimeout=e}return e.prototype.start=function(e){this.timeoutId=setTimeout(this.ontimeout,e)},e.prototype.stop=function(){clearTimeout(this.timeoutId)},e}();t.Timer=o,t.defer=function(){var e,t;return{promise:new Promise(function(n,r){e=n,t=r}),resolve:e,reject:t}},t.timedDefer=function(e,t){void 0===t&&(t="deferred timed out after "+e+"ms");var n,r,a=new o(function(){return r(new i(t))}),s=new Promise(function(e,t){n=function(t){a.stop(),e(t)},r=function(e){a.stop(),t(e)}});return a.start(e),{promise:s,resolve:n,reject:r}},t.delay=function(e){return new Promise(function(t){return setTimeout(t,e)})}},function(e,t,n){"use strict";function r(e){return"string"==typeof e?i.pii.Mri(e):i.pii.Omit(e)}Object.defineProperty(t,"__esModule",{value:!0});var i=n(8);t.scrubMriOrOmit=r,t.scrubMriOrOmitList=function(e){return e.forEach(r)},t.mriOrId=function(e){return e&&i.pii.Mri(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.INITIALIZE="Initialize",e.START_CALL="StartCall",e.START_TRANSFER_TARGET_CALL="StartTransferTargetCall",e.STOP_CALL="StopCall",e.STOP_CALL_WITH_BEACON="StopCallWithBeacon",e.JOIN_CALL="JoinCall",e.JOIN_PREHEATED_CALL="JoinPreheatedCall",e.SUBSCRIBE="Subscribe",e.START_CALL_TO_VOICE_MAIL="StartCallToVoiceMail",e.ACKNOWLEDGE="Acknowledge",e.ACCEPT="Accept",e.REJECT="Reject",e.START_VIDEO="StartVideo",e.STOP_VIDEO="StopVideo",e.HOLD="Hold",e.UNHOLD="Unhold",e.UPDATE_ENDPOINT_METADATA="UpdateEndpointMetadata",e.SEND_DTMF_TONE="SendDtmfTone",e.SET_AUDIO_USAGE="SetAudioUsage",e.DUMP_VIDEO_SOURCE_IMAGES="DumpVideoSourceImages",e.BLIND_TRANSFER="BlindTransfer",e.SAFE_TRANSFER="SafeTransfer",e.TRANSFER_TO_VOICEMAIL="TransferToVoicemail",e.CONSULTATIVE_TRANSFER="ConsultativeTransfer",e.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE="ConsultativeTransferWithPickupCode",e.START_SCREEN_SHARING="StartScreenSharing",e.STOP_SCREEN_SHARING="StopScreenSharing",e.START_DATA_CHANNEL="StartDataChannel",e.STOP_DATA_CHANNEL="StopDataChannel",e.SHARE_SYSTEM_SOUNDS="ShareSystemSounds",e.START_MULTICHANNEL_AUDIO_DEVICE="StartMultichannelAudioDevice",e.STOP_MULTICHANNEL_AUDIO_DEVICE="StopMultichannelAudioDevice",e.MUTE="Mute",e.UNMUTE="Unmute",e.MUTE_SPEAKER="MuteSpeaker",e.UNMUTE_SPEAKER="UnmuteSpeaker",e.MUTE_PARTICIPANTS="MuteParticipants",e.UPDATE_MEETING_ROLE="UpdateMeetingRole",e.START_AUDIO="StartAudio",e.STOP_AUDIO="StopAudio",e.ASSIMILATE="Assimilate",e.SET_MAX_VIDEO_CHANNELS="SetMaxVideoChannels",e.CREATE_CONTENT_SHARING_SESSION="CreateContentSharingSession",e.START_CALL_WITH_NUDGE="StartCallWithNudge",e.START_CALL_AND_UNPARK="StartCallAndUnpark",e.PARK_CALL="ParkCall",e.UNPARK_CALL="UnparkCall",e.NUDGE_PARTICIPANTS="NudgeParticipants",e.LWJ_FALLBACK="LwjFallback",e.ELECTRON_SHOW_CQF_INFO="ElectronShowCQFInfo",e.ELECTRON_IS_CQF_RENDERED="ElectronIsCQFRendered",e.ELECTRON_PROVIDE_CQF="ElectronProvideCQF",e.MERGE_CALL="MergeCall",e.ADD_GROUP_MODALITY="AddGroupModality",e.MERGE_WITH_PICKUP_CODE="MergeWithPickupCode",e.PUBLISH_STATE="PublishState",e.REMOVE_STATE="RemoveState",e.UPDATE_MEETING_SETTINGS="UpdateMeetingSettings",e.MERGE_PARTICIPANT="MergeParticipant",e.ADMIT="Admit"}(t.CALL_OPERATIONS||(t.CALL_OPERATIONS={}));!function(e){e.CALL_START_OR_JOIN_INITIATED="_CallStartOrJoinInitiated",e.INCOMING_INITIALIZE="_IncomingInitialize",e.CALL_ENDED="_CallEnded",e.RECONNECT="_Reconnect",e.RENEGOTIATE="_Renegotiate",e.RENEGOTIATE_OUTGOING="_RenegotiateOutgoing",e.RENEGOTIATE_INCOMING="_RenegotiateIncoming",e.COMPLETE_NEGOTIATION_FAILED="_CompleteNegotiationFailed",e.UPDATE_LOCAL_MEDIA_STATUS="_UpdateLocalMediaStatus",e.START_PREVIEW_VIDEO="_StartPreviewVideo",e.START_LOCAL_VIDEO="_StartLocalVideo",e.SET_LOCAL_VIDEO="_SetLocalVideo",e.CALL_TRANSFER_IN_PROGRESS="_CallTransferInProgress",e.ON_TRANSFER_REQUESTED="_OnTransferRequested",e.ON_TRANSFER_REQUESTED_INVALID="_OnTransferRequestedInvalid",e.ON_INCOMING_CALL_REPLACEMENT="_onIncomingCallReplacement",e.GET_CALL_REPLACEMENT_DETAILS="_GetCallReplacementDetails",e.SET_CALL_STATE="_SetCallState",e.SET_TRANSFER_STATE="_SetTransferState",e.SET_PARK_STATE="_SetParkState",e.SET_MUTED="_SetMuted",e.SET_MUTED_SPEAKER="_SetMutedSpeaker",e.SET_SCREEN_SHARING="_SetScreenSharing",e.SET_CALL_ORIGIN="_SetCallOrigin",e.CONNECT_CALL="_ConnectCall",e.WAIT_FOR_ANSWER="_WaitForAnswer",e.MEDIA_ACKNOWLEDGMENT="_MediaAcknowledgment",e.SIGNALING_STATE_CHANGED="_SignalingStateChanged",e.CALL_TERMINATION_INFO="_CallTerminationInfo",e.MEDIA_WHITELISTING_ISSUE_DETECTED="_MediaWhiteListingIssueDetected",e.CALL_ESCALATED_TO_CONFERENCE="_CallEscalatedToConference",e.WEB_ON_OFFER="_WebOnOffer",e.WEB_ON_ANSWER="_WebOnAnswer",e.WEB_ON_RETARGET_SUCCESS="_WebRetargetSuccess",e.WEB_ON_RETARGET_FAILURE="_WebRetargetFailure",e.WEB_ON_ESCALATION_SUCCESS="_WebOnEscalationSuccess",e.WEB_ON_ESCALATION_FAILURE="_WebOnEscalationFailure",e.CALL_USES_MIXER="_CallUsesMixer",e.ESCALATION_IN_PROGRESS="_EscalationInProgress",e.ESCALATION_COMPLETED="_EscalationCompleted",e.ELECTRON_WAIT_FOR_HANDLE_PUSH="_ElectronWaitForHandlePush",e.ELECTRON_WAIT_FOR_RINGING="_ElectronWaitForRinging",e.ELECTRON_START_SCREEN_SHARING="_ElectronStartScreenSharing",e.ELECTRON_STOP_SCREEN_SHARING="_ElectronStopScreenSharing",e.ELECTRON_SLIMCORE_READY="_ElectronSlimcoreReady",e.ELECTRON_DATA_CHANNEL_CREATED="_ElectronDataChannelCreated",e.ELECTRON_ATTACH_SLIMCORE_CALL="_ElectronAttachSlimcoreCall",e.ELECTRON_ATTACH_SLIMCORE_CALL_FAILED="_ElectronAttachSlimcoreCallFailed",e.ELECTRON_LEAVE_CALL="_ElectronLeaveCall",e.PROCESS_CALL_START_OPTIONS="_ProcessCallStartOptions"}(t.CALL_OPERATIONS_INTERNAL||(t.CALL_OPERATIONS_INTERNAL={}));!function(e){e.CCWM="CCWM",e.ENCRYPTED="Encrypted",e.LWJ="LWJ",e.PREHEAT="Preheat",e.MULTIPLEVIDEOS="MultipleVideos",e.SPECIFIED="Specified",e.ALL="All",e.NONE="None"}(t.OPERATION_VARIANTS||(t.OPERATION_VARIANTS={}));!function(e){e.AUDIO_QUALITY_CHANGED="AudioQualityChanged",e.SESSION_ERROR="SessionError",e.NEGOTIATION_REQUIRED="NegotiationRequired",e.OUTGOING_NEGOTIATION_FAILURE="OutgoingNegotiationFailure",e.INCOMING_NEGOTIATION_FAILURE="IncomingNegotiationFailure",e.NEGOTIATION_FATAL_ERROR="NegotiationFatalError",e.NEGOTIATION_COMPLETION="NegotiationCompletion",e.AUDIO_STATE_CHANGED="AudioStateChanged",e.INCOMPATIBLE_OFFER="IncompatibleOffer",e.NEW_OFFER_FAILED="NewOfferFailed"}(t.MEDIA_EVENT||(t.MEDIA_EVENT={}));!function(e){e.ADD_PARTICIPANT="AddParticipant",e.REMOVE_PARTICIPANT="RemoveParticipant",e.ADMIT_PARTICIPANT="AdmitParticipant",e.CALL_ME_BACK="CallMeBack",e.ADD_PARTICIPANTS="AddParticipants"}(t.PARTICIPANT_OPERATIONS||(t.PARTICIPANT_OPERATIONS={}));!function(e){e.SET_PARTICIPANT_STATE_INVALID="_SetParticipantStateInvalid",e.UPDATE_LOCAL_PARTICIPANT_STREAM="_UpdateLocalParticipantStream",e.PARTICIPANT_JOINED="_ParticipantJoined",e.SELF_PARTICIPANT_UPDATED="_SelfParticipantUpdated"}(t.PARTICIPANT_OPERATIONS_INTERNAL||(t.PARTICIPANT_OPERATIONS_INTERNAL={}));!function(e){e.START_CONTENT_SHARING="StartContentSharing",e.STOP_CONTENT_SHARING="StopContentSharing",e.JOIN_CONTENT_SHARING="JoinContentSharing",e.TAKE_CONTENT_SHARING_CONTROL="TakeContentSharingControl",e.UPDATE_CONTENT_SHARING_SESSION_STATE="UpdateContentSharingSessionState",e.UPDATE_PARTICIPANT_STATE="UpdateParticipantState"}(t.CONTENT_SHARING_OPERATIONS||(t.CONTENT_SHARING_OPERATIONS={}));!function(e){e.SET_CONTENT_SHARING_STATUS="_SetContentSharingStatus"}(t.CONTENT_SHARING_OPERATIONS_INTERNAL||(t.CONTENT_SHARING_OPERATIONS_INTERNAL={})),t.UNPARK_CODE={PARK:"*11",SHARED_LINE:"*12",SERVER_HOLD:"*13"};!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FORBIDDEN=403]="FORBIDDEN",e[e.CLIENT_ERROR=499]="CLIENT_ERROR",e[e.SIGNALING_ERROR=599]="SIGNALING_ERROR"}(t.TRANSACTION_END_CODE||(t.TRANSACTION_END_CODE={}));!function(e){e[e.LOCAL_REJECT=0]="LOCAL_REJECT",e[e.TRANSACTION_NOT_ALLOWED=3548]="TRANSACTION_NOT_ALLOWED"}(t.TRANSACTION_END_SUBCODE||(t.TRANSACTION_END_SUBCODE={}));!function(e){e.TRANSACTION_COMPLETE="TransactionComplete",e.TRANSACTION_ALLOWED="TransactionAllowed",e.TRANSACTION_DISALLOWED="TransactionDisallowed",e.UNKNOWN="Unknown"}(t.TRANSACTION_END_PHRASE||(t.TRANSACTION_END_PHRASE={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noop=function(){}},function(e,n){e.exports=t},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","endpointId","phrase","subCode","reason"];t.getPIISafeObject=function(e){try{return JSON.parse(JSON.stringify(e,r,4))}catch(e){return{error:"failed to parse object"}}},t.getPrintableObject=function(e,t){void 0===t&&(t=!1);if(void 0===e)return"void";if(e instanceof Error)return e.toString();if(e instanceof String||e instanceof Number||e instanceof Boolean)return e.toString();try{return e.stack&&(e.stack=function(e){try{return e.split("\n")[0]}catch(e){return"invalid stack"}}(e.stack)),(t?JSON.stringify(e):JSON.stringify(e,r,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(t){return"failed to get error information:"+(e&&"function"==typeof e.toString&&e.toString())+" "+(e&&e.response&&JSON.stringify(e.response))}},t.safeJsonStringify=function(e){try{return JSON.stringify(e,null,2)}catch(e){return"failed to stringify obj"}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTsCallingVersion=function(){return"2020.24.01.5"},t.getOvb=function(){return"9788b934d5009dbdc68550bd35c663fbf07ac952"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i=function(){function e(e){this._logger=e,this._promise=Promise.resolve(void 0),this._actionQueue=[]}return e.prototype.chainPromise=function(e,t,n,i){var o=this;void 0===n&&(n=r.generateCauseId()),void 0===i&&(i=!1);var a=Date.now(),s=(("function"==typeof t?t():t)||"").toString();this._actionQueue.push(s),this._logger.info("["+n+"]["+s+"]enqueueing, queue=["+this._actionQueue+"], reset="+i);var l=function(){o._actionQueue=o._actionQueue.filter(function(e){return e!==s})};return i&&this.reset(n),this._promise=this._promise.catch(function(){}).then(function(){var t=Date.now()-a;return o._logger.info("["+n+"]["+s+"]begin, delayMs="+t),e()}),this._promise.then(function(){l();var e=Date.now()-a;o._logger.info("["+n+"]["+s+"]success, durationMs="+e)},function(e){l();var t=Date.now()-a;o._logger.warn("["+n+"]["+s+"]failed="+e+", drationMs="+t)}),this._promise},e.prototype.reset=function(e){this._logger.info("["+e+"] resetting"),this._promise=Promise.resolve(void 0)},e}();t.default=i},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)},o=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},a=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}},l=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},c=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var d=n(13),u=n(0),p=n(4),h=n(6),g=n(14),_=n(15),f=n(26),m=n(16),C=n(17),S=n(5),y=n(43),v=n(44),I=n(45),T=n(1),O=n(3),P=n(27),E=n(46),A=n(48),R=n(20),b=n(30),L=n(32),N=n(19),D=n(18),w=n(49),M=SlimCore.Enums,F=n(2),j=n(7),k=n(9),V=function(e){function t(t,n,r,i,o,a,s,d,p,g,_,f){var m,S=e.call(this,t.createChild(function(){var e=(S.endpointId||"").substr(0,8),t=(S.participantId||"").substr(0,8);return"Electron["+S.slimcoreCallId+":"+S.callId+"]["+e+"]["+t+"]["+S.state+"]"}),n,r)||this;S._slimcoreCallHandler=i,S._deviceManager=o,S._appHooks=a,S.threadId=s,S.callId=d,S.currentUserSkypeIdentity=p,S.participantId=g,S._telemetryLoggers=_,S.participants=[],S.participantMap={},S.isMuted=!1,S.isSpeakerMuted=!1,S.isServerMuted=!1,S.isVideoOn=!1,S.isScreenSharingOn=!1,S.dominantSpeakerInfo={speakerList:[],timestamp:null},S.callStartedAt=null,S.callHeldAt=null,S.failureType=2,S.slimcoreCallId=0,S.isHostless=!0,S.callType=-1,S.isIncomingOneOnOneVideoCall=!1,S.contentSharingSessions=[],S.screenSharingControl=null,S.dataChannelAdapter=null,S.isPreheatEnabled=!1,S.localMediaStreams=[],S.mediaStreams=(m={},m[0]=[],m[1]=[],m),S._streamContextMap={},S._isAudioStreamConnected=!1,S._wasAudioStreamConnected=!1,S._callGotConnected=!1,S._enableGroupCallMeetupGeneration=!1,S._mediaPeerType=0,S._dataChannel=null,S._dataChannelUsers=[],S._isRelayWhiteListingIssue=!1,S._isOptimizedSpeakerEventingEnabled=!1,S._isSetVideoChannelsRenegotiated=!1,S._callIsSetupComplete=!1,S._transferState=0,S._parkState=0,S._capabilityFlags=M.SelfCapability.None,S._capabilities={canMuteOthers:!1,canUnmuteSelf:!1},S.inCallTelemetryReported=!1,S.setupTelemetryReported=!1,S.connectCallPromise=Promise.resolve(),S._videoRequestedOnWhileConnecting=!1,S._videoRequestedOffWhileConnecting=!1,S._callStartTime=(new Date).getTime(),S._state=0,S.isServerMuteUnmuteEnabled=function(){return!!S.endpoints&&u.some(S.endpoints.endpointDetails,function(e){return S.endpointId===e.endpointId&&(e.capabilities&&"enabled"===e.capabilities.serverMuteUnmute)})},S.isMuteDisabled=function(){return S.isMuted},S.isUnMuteDisabled=function(){return 1===S.callType?!S.isMuted:2===S.callType&&(S.isServerMuteUnmuteEnabled()?!S.isServerMuted&&!S.isMuted:!S.isMuted)},S.cleanUp=function(e){return l(S,void 0,void 0,function(){var t;return c(this,function(n){switch(n.label){case 0:return this._logger.info("["+e+"][cleanup]start"),[4,Promise.all([this._getCallEndOperation(),this._cleanCallResources(e)])];case 1:return n.sent(),t={code:y.CONSTANTS.CODE.CLIENT_ERROR_CODE,subCode:y.CONSTANTS.SUB_CODE.ABANDONED},this._callOperationHandler.rejectPendingOperations(61,e,t),this._participantOperationHandler.rejectPendingOperations(47,e,t),this._callTelemetry.setTerminationState(this.state),this._callTelemetry.setTerminationReason(this.terminatedReason),this._reportTsCallingTelemetry(!this._callIsSetupComplete),[2]}})})},S._getCallEndOperation=function(){return S._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.STOP_CALL)?S._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.STOP_CALL):S._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.REJECT)?S._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.REJECT):Promise.resolve()},S._getFirstParticipantFailureReason=function(e){try{if(S.participants.length){var t=u.head(S.participants).getIntProperty(M.Property.ParticipantFailureReason);return e.info("participantFailureReason="+t),t}return void e.logFailure("no participants , can't query for participantFailureReason")}catch(e){return void S._logger.logFailure("participantFailureReason="+k.getPrintableObject(e))}},S._setTransferState=function(e,t){S.transferState!==e&&(S._logger.info("Transfer: state set: "+e),S._transferState=e,S._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_TRANSFER_STATE,{state:e},t),S.raiseChanged())},S._setParkState=function(e,t){S.parkState!==e&&(S._logger.info("Park: state set: "+e),S._parkState=e,S._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_PARK_STATE,{state:e},t),S.raiseChanged())},S._logger.info("constructor"),S.terminatedReason=0,S._setupCallTelemetry(),S._setParticipantId(S.participantId),S._setThreadId(S.threadId),S._setCallId(S.callId),S._setCallOrigin(0),S._setMessageId(f),S._setIsEmergency(!1);try{S._setEndpointId(S._slimcoreInstance.getRegistrationId(S.currentUserSkypeIdentity.id))}catch(e){S._logger.warn("getRegistrationId is missing!")}S.screenSharingControl=new w.default(S._logger,S._settings,S._slimcoreInstance,S,S._appHooks.getControlInjector(),S._telemetryLoggers),S.raiseRenderedAtViewer=S.raiseRenderedAtViewer.bind(S),S.screenSharingControl.setRaiseRenderedAtViewer(S.raiseRenderedAtViewer),S.dataChannelAdapter=new A.default(S._logger,S._slimcoreInstance),S._dataChannelUsers=[S.screenSharingControl,S.dataChannelAdapter];var v=!1;try{v=S._slimcoreInstance.ecsGetSettingAsBool("SkypeCalling","enableErrorConversion",!1),S._logger.info("ecsEnableErrorConversion is: "+v)}catch(e){S._logger.logFailure("Assuming setting of convertError in APIs is disabled via ECS. Error: "+e)}return S._callOperationHandler=new C.default(S._logger,S._callTelemetry,v),S._participantOperationHandler=new C.default(S._logger,S._callTelemetry,v),S._dataChannelCreatedPromise=S._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_DATA_CHANNEL_CREATED),S._dataChannelCreatedPromise.catch(j.noop),S._streamContextMap[0]=new N.SlimCoreElectronRemoteStreamContext(S._logger),S._streamContextMap[1]=new N.SlimCoreElectronRemoteStreamContext(S._logger),S}return r(t,e),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},set:function(e){this._state=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transferState",{get:function(){return this._transferState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parkState",{get:function(){return this._parkState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"capabilities",{get:function(){return this._capabilities},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"publishedStates",{get:function(){return this._publishedStates},enumerable:!0,configurable:!0}),t.prototype.init=function(e){this._setMessageId(e.messageId),e.threadId&&this._setThreadId(e.threadId),this._meetingInfo=e.meetingInfo,this._enableGroupCallMeetupGeneration=!!e.enableGroupCallMeetupGeneration,e.transferContext&&(this._transferContext=e.transferContext,1===e.transferContext.transferType?this._setCallOrigin(2):0===e.transferContext.transferType?this._setCallOrigin(1):2===e.transferContext.transferType&&this._setCallOrigin(3),e.transferContext.transferorMri&&this._updateTransferorMri(e.transferContext.transferorMri)),this._endpointMetadata=e.endpointMetadata,this.onBehalfOfMri=e.onBehalfOf,this._emergencyContent=e.emergencyContent,this._mediaPeerType=e.mediaPeerType,this.broadcastMeeting&&(this.broadcastMeeting.context=e.broadcastContext),this._setIsEmergency(!!e.isEmergency),this.raiseChanged()},t.prototype.processCallStartOptions=function(e,t){var n=this._logger.createFnLogger(h.CALL_OPERATIONS_INTERNAL.PROCESS_CALL_START_OPTIONS,t);try{1&e.preheatFlags&&(this.isPreheatEnabled=!0)}catch(e){n.logFailure(e)}},t.prototype.containsMultipleVideos=function(e){return e&&e.sendMediaModalities&&e.sendMediaModalities.mediaStates&&u.filter(e.sendMediaModalities.mediaStates,function(e){return 1===e.mediaType&&!e.isDisabled}).length>1},t.prototype.join=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r;return c(this,function(i){return this._setCallerMri(f.stripMriAliases(e.groupCallInitiator),n),this._callTelemetry.setDirection(g.DIRECTION.INCOMING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.JOIN),this.containsMultipleVideos(t)&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.JOIN_CALL,h.OPERATION_VARIANTS.MULTIPLEVIDEOS),1&t.preheatFlags&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.JOIN_CALL,h.OPERATION_VARIANTS.PREHEAT),t.muteFlags&&(r={muteMicrophone:!!(1&t.muteFlags),muteSpeaker:!!(2&t.muteFlags)},this._callTelemetry.updateOperationData(h.CALL_OPERATIONS.JOIN_CALL,r,n)),this._callTelemetry.setPreheatFlags(t.preheatFlags),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.JOIN_CALL),[2,this._joinOrStartCall({audioDirection:t.audioDirection,videoDirection:T.returnVideoDirection(t),screenshareDirection:t.screenshareDirection,datachannelDirection:t.datachannelDirection,muteFlags:t.muteFlags,conversationUrl:e.conversationUrl,preheatFlags:t.preheatFlags,label:t.label,conversationType:e.conversationType,enableLightWeightMeeting:!1,maxVideoChannels:t.maxVideoChannels,negotiationTag:t.negotiationTag,scenario:T.mapToEmptyStrIfFalsy(t.scenario),sendMediaModalities:T.returnStringifiedVersionOfMediaStateConfiguration(t.sendMediaModalities),endpointBehaviors:t.endpointBehaviors,clientEndpointCapabilities:t.clientEndpointCapabilities,clientEndpointDebugContent:t.clientEndpointDebugContent,invitationDataJson:t.invitationDataJson},n)]})})},t.prototype.start=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i,o,a=this;return c(this,function(s){return n=this._logger.createFnLogger(h.CALL_OPERATIONS.START_CALL,t),this._setCallerMri(f.MRI_SKYPE_PREFIX+this.currentUserSkypeIdentity.id,t),this._callTelemetry.setDirection(g.DIRECTION.OUTGOING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLER),this.containsMultipleVideos(e)&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL,h.OPERATION_VARIANTS.MULTIPLEVIDEOS),1&e.preheatFlags?this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL,h.OPERATION_VARIANTS.PREHEAT):e.encryptedKey&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL,h.OPERATION_VARIANTS.ENCRYPTED),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.START_CALL),e.muteFlags&&(r={muteMicrophone:!!(1&e.muteFlags),muteSpeaker:!!(2&e.muteFlags)},this._callTelemetry.updateOperationData(h.CALL_OPERATIONS.START_CALL,r,t)),this._callTelemetry.setPreheatFlags(e.preheatFlags),this._transferContext?(n.info("Transfer: Starting transfered call."),(i=this._transferContext.context).newCallObjectId?(this._setCallType(1),o=4===T.returnVideoDirection(e),2===this._transferContext.transferType&&(o=!1),[2,this._callOperationHandler.execute(function(){return a._startTransferTargetCall(i.newCallObjectId,o,t)},h.CALL_OPERATIONS.START_TRANSFER_TARGET_CALL)]):[2,Promise.reject(new Error("Transfer: Transfered context is invalid. Missing callObjectId or newCallObjectId"))]):[2,this._joinOrStartCall({audioDirection:e.audioDirection,videoDirection:T.returnVideoDirection(e),screenshareDirection:e.screenshareDirection,datachannelDirection:e.datachannelDirection,ringOthers:e.ringOthers,preheatFlags:e.preheatFlags,label:e.label,conversationType:this.isEmergency?"emergencyGroupCall":e.isCast?"cast":"",enableLightWeightMeeting:!1,callKey:e.callKey,encryptedKey:e.encryptedKey,connectionType:e.connectionType,mediaConfiguration:e.mediaConfiguration,maxVideoChannels:e.maxVideoChannels,routingFlags:e.routingFlags,muteFlags:e.muteFlags,negotiationTag:e.negotiationTag,scenario:T.mapToEmptyStrIfFalsy(e.scenario),sendMediaModalities:T.returnStringifiedVersionOfMediaStateConfiguration(e.sendMediaModalities),endpointBehaviors:e.endpointBehaviors,clientEndpointCapabilities:e.clientEndpointCapabilities,clientEndpointDebugContent:e.clientEndpointDebugContent,invitationDataJson:e.invitationDataJson},t)]})})},t.prototype.startCallToVoicemail=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return this._setCallerMri(f.MRI_SKYPE_PREFIX+this.currentUserSkypeIdentity.id,t),this._callTelemetry.setDirection(g.DIRECTION.OUTGOING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLER),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.START_CALL_TO_VOICE_MAIL),[2,this._joinOrStartCall({callToVoicemail:!0,voicemailResourcePath:e.voicemailResourcePath,voicemailItemId:e.voicemailItemId},t)]})})},t.prototype.startCallWithNudge=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r;return c(this,function(i){return this._setCallerMri(f.MRI_SKYPE_PREFIX+this.currentUserSkypeIdentity.id,n),r=this._logger.createFnLogger(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE,n),this._callTelemetry.setDirection(g.DIRECTION.OUTGOING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLER),this.containsMultipleVideos(t)&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE,h.OPERATION_VARIANTS.MULTIPLEVIDEOS),t.encryptedKey&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE,h.OPERATION_VARIANTS.ENCRYPTED),u.isEmpty(e)?(r.logFailure("No participants provided to nudge"),[2,Promise.reject(new Error("No participants provided to nudge"))]):(this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE),[2,this._joinOrStartCall({audioDirection:t.audioDirection,videoDirection:T.returnVideoDirection(t),screenshareDirection:t.screenshareDirection,datachannelDirection:t.datachannelDirection,ringOthers:!1,label:t.label,conversationType:t.isCast?"cast":"",enableLightWeightMeeting:!1,callKey:t.callKey,encryptedKey:t.encryptedKey,connectionType:t.connectionType,mediaConfiguration:t.mediaConfiguration,participantsToNudge:e,invitationType:M.InvitationType.Nudge,negotiationTag:t.negotiationTag,muteFlags:t.muteFlags,scenario:T.mapToEmptyStrIfFalsy(t.scenario),sendMediaModalities:T.returnStringifiedVersionOfMediaStateConfiguration(t.sendMediaModalities),endpointBehaviors:t.endpointBehaviors,clientEndpointCapabilities:t.clientEndpointCapabilities,clientEndpointDebugContent:t.clientEndpointDebugContent,invitationDataJson:t.invitationDataJson},n)])})})},t.prototype.startAndUnpark=function(e,t,n,r){return void 0===n&&(n={}),void 0===r&&(r=F.generateCauseId()),l(this,void 0,void 0,function(){var i,o;return c(this,function(a){return this._setCallerMri(f.MRI_SKYPE_PREFIX+this.currentUserSkypeIdentity.id,r),i=this._logger.createFnLogger(h.CALL_OPERATIONS.START_CALL_AND_UNPARK,r),this._callTelemetry.setDirection(g.DIRECTION.OUTGOING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLER),this.containsMultipleVideos(n)&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE,h.OPERATION_VARIANTS.MULTIPLEVIDEOS),n.encryptedKey&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.START_CALL_AND_UNPARK,h.OPERATION_VARIANTS.ENCRYPTED),this._setCallType(1),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.START_CALL_AND_UNPARK),o=0===e?h.UNPARK_CODE.PARK:1===e?h.UNPARK_CODE.SHARED_LINE:h.UNPARK_CODE.SERVER_HOLD,this.addParticipant("4:"+o,void 0,r).catch(function(e){return i.logFailure("Failed to add participant to unparked call="+e)}),[2,this._joinOrStartCall({audioDirection:n.audioDirection,videoDirection:T.returnVideoDirection(n),screenshareDirection:n.screenshareDirection,datachannelDirection:n.datachannelDirection,ringOthers:n.ringOthers,label:n.label,conversationType:n.isCast?"cast":"",enableLightWeightMeeting:!1,callKey:n.callKey,encryptedKey:n.encryptedKey,connectionType:n.connectionType,mediaConfiguration:n.mediaConfiguration,maxVideoChannels:n.maxVideoChannels,routingFlags:n.routingFlags,muteFlags:n.muteFlags,parkContext:e,pickupCode:t,scenario:T.mapToEmptyStrIfFalsy(n.scenario),sendMediaModalities:T.returnStringifiedVersionOfMediaStateConfiguration(n.sendMediaModalities),endpointBehaviors:n.endpointBehaviors,clientEndpointCapabilities:n.clientEndpointCapabilities,clientEndpointDebugContent:n.clientEndpointDebugContent,invitationDataJson:n.invitationDataJson},r)]})})},t.prototype.joinCallWithoutCallModality=function(e,n,r){return void 0===r&&(r=F.generateCauseId()),l(this,void 0,void 0,function(){var i,o,a,s;return c(this,function(l){switch(l.label){case 0:if(this._setCallerMri(f.stripMriAliases(e.groupCallInitiator),r),(i=this._logger.createFnLogger(h.CALL_OPERATIONS.SUBSCRIBE,r)).info("joinCallWithoutCallModality: "+e.conversationUrl),this._callTelemetry.setDirection(g.DIRECTION.OUTGOING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.SUBSCRIBE),e.conversationUrl||this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.SUBSCRIBE,h.OPERATION_VARIANTS.CCWM),0!==this.state)return i.logFailure("Trying to start a call that has already been acted on"),[2,Promise.reject(new Error("Trying to start a call that has already been acted on"))];o=this._getSlimCoreCallProperties({audioDirection:M.MediaDirection.Disabled,videoDirection:M.MediaDirection.Disabled,screenshareDirection:M.MediaDirection.Disabled,datachannelDirection:M.MediaDirection.Disabled,mediaPeerType:t.convertToSlimCoreMediaPeerType(this._mediaPeerType),isVideoEnabled:!1,isGoLive:!n.ringOthers,isHostless:!0,participantLegId:this.participantId,enableGroupCallMeetupGeneration:this._enableGroupCallMeetupGeneration,threadId:T.mapToEmptyStrIfFalsy(this.threadId),messageId:T.mapToEmptyStrIfFalsy(this.messageId),subject:T.mapToEmptyStrIfFalsy(n.label),conversationType:T.mapToEmptyStrIfFalsy(e.conversationType),meetingInfo:T.mapToEmptyStrIfFalsy(JSON.stringify(this._meetingInfo)),endpointMetadata:T.mapToEmptyStrIfFalsy(this._endpointMetadata),onBehalfOf:T.mapToEmptyStrIfFalsy(this.onBehalfOfMri),enableLightWeightMeeting:!1,emergencyContent:T.mapToEmptyStrIfFalsy(this._emergencyContent),broadcastContext:this.broadcastMeeting&&this.broadcastMeeting.context?JSON.stringify(this.broadcastMeeting.context):null,callKey:"",encryptedKey:"",invitationType:M.InvitationType.None,connectionType:M.ConnectionType.AllSupported,maxVideoChannels:void 0!==n.maxVideoChannels?n.maxVideoChannels:0,muteFlags:n.muteFlags,negotiationTag:T.mapToEmptyStrIfFalsy(n.negotiationTag),routingFlags:n.routingFlags,scenario:T.mapToEmptyStrIfFalsy(n.scenario),mediaConfigurationJson:T.mapToEmptyStrIfFalsy(JSON.stringify(n.mediaConfiguration)),mediaStateConfigurationJson:T.returnStringifiedVersionOfMediaStateConfiguration(n.sendMediaModalities),clientEndpointCapabilities:n.clientEndpointCapabilities,clientEndpointDebugContent:T.mapToEmptyStrIfFalsy(n.clientEndpointDebugContent),invitationDataJson:T.mapToEmptyStrIfFalsy(n.invitationDataJson)}),l.label=1;case 1:return l.trys.push([1,3,,4]),a=this._slimcoreCallHandler.subscribe(JSON.stringify({conversationUrl:e.conversationUrl,conversationId:this.callId,conversationType:e.conversationType}),o),this._setCallState(8,r),[4,this.attachSlimCoreCallObject(a,r,!0,"joinCallWithoutCallModality")];case 2:return l.sent(),T.hasFeature(M.Feature.ObservingStateSupported)?[2,this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.SUBSCRIBE,void 0,r)]:[2,Promise.resolve()];case 3:throw s=l.sent(),i.logFailure("sync failure, cleaning up slimcore ready operation: error="+k.getPrintableObject(s)),this._callTelemetry.updateOperationData(h.CALL_OPERATIONS.SUBSCRIBE,{error:k.getPIISafeObject(s)},r),this._callOperationHandler.rejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY),s;case 4:return[2]}})})},t.prototype._assertSlimcoreObjectId=function(e,t){if(0===e)throw new Error(t+" Failed. Slimcore returned objectId of 0")},t.prototype.joinPreheatedCall=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n;return c(this,function(r){if(n=this._logger.createFnLogger(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL,t),11!==this.state&&12!==this.state)return n.logFailure("Trying to join a call that is not in preheating state"),[2,Promise.reject(new Error("Trying to join a call that is not in preheating state"))];1==(1&e.muteFlags)&&(n.info("isMuted set to true in joinPreheatedCall"),this.isMuted=!0),2==(2&e.muteFlags)&&(n.info("isSpeakerMuted set to true in joinPreheatedCall"),this.isSpeakerMuted=!0),this._setCallState(2,t),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL);try{this._slimcoreCallHandler.joinPreheatedCall(this.slimcoreCallId,t,e.muteFlags)}catch(e){throw this.stopInternal({causeId:t}),n.logFailure(e),e}return[2,this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL,void 0,t)]})})},t.prototype.startVideoSafe=function(e){var t=this;return this.startVideo(e).catch(function(n){t._logger.createFnLogger(h.CALL_OPERATIONS.START_VIDEO,e).logFailure(n)})},t.prototype.startVideo=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i=this;return c(this,function(o){return n=this._logger.createFnLogger(h.CALL_OPERATIONS.START_VIDEO,t),this.callStateCanToggleVideo()?(r=Promise.resolve().then(function(){return i._startLocalVideo(e,t)}).then(function(){return i._setVideoOn(!0,t)}),[2,this._callOperationHandler.registerPromise(h.CALL_OPERATIONS.START_VIDEO,r).catch(function(n){throw i._callTelemetry.updateOperationData(h.CALL_OPERATIONS.START_VIDEO,{error:k.getPIISafeObject(n)},t),i._logger.logFailure(n),i.stopVideo(e,t).catch(j.noop),n})]):(n.info("startVideo called but call is not in togglable state - starting preview only, video will start once available"),this._videoRequestedOnWhileConnecting=!0,this._videoRequestedOffWhileConnecting=!1,this._setVideoOn(!0,t),[2])})})},t.prototype.stopVideo=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i,o=this;return c(this,function(a){return n=this._logger.createFnLogger(h.CALL_OPERATIONS.STOP_VIDEO,t),this.callStateCanToggleVideo()?(r=function(){var e=o._getLocalVideo();e&&(o._removeMediaStream(e),e.dispose(t)),o._setVideoOn(!1,t)},i=Promise.resolve().then(function(){return l(o,void 0,void 0,function(){var r;return c(this,function(i){switch(i.label){case 0:return(r=this._getLocalVideo())?[4,T.forgetAndLog(r.stop(t,e),n,"stopVideo: stopping localVideo")]:[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}})})}),[2,this._callOperationHandler.registerPromise(h.CALL_OPERATIONS.STOP_VIDEO,i).then(r,function(e){o._callTelemetry.updateOperationData(h.CALL_OPERATIONS.STOP_VIDEO,{error:k.getPIISafeObject(e)},t),n.logFailure(e),r()})]):(this._videoRequestedOnWhileConnecting?(n.info("stopVideo called but call is not in togglable state - video will stop once available"),this._videoRequestedOffWhileConnecting=!0):n.info("stopVideo called but call is not in togglable state - enabling video was not requested anyway, so ignoring"),[2,Promise.resolve()])})})},Object.defineProperty(t.prototype,"endpointId",{get:function(){return this._endpointId},enumerable:!0,configurable:!0}),t.prototype._setEndpointId=function(e){this._endpointId=e,this._callTelemetry.setEndpointId(e)},t.prototype._setFailureType=function(e){this._callTelemetry.setFailureType(e),this.failureType=e},t.prototype._setThreadId=function(e){this._logger.info("Set threadId:"+e),this.threadId=e,this._callTelemetry.setThreadId(e)},t.prototype._setMessageId=function(e){this._logger.info("Set messageId:"+e),this.messageId=e,this._callTelemetry.setMesageId(e)},t.prototype._setCallType=function(e){this._logger.info("Set callType:"+e),this.callType=e,this._callTelemetry.setCallType(e)},t.prototype._setCallerMri=function(e,t){this._logger.info("["+t+"]Set callerMri:"+e),this.callerMri=e},t.prototype._setCallOrigin=function(e){this._logger.info("Set origin:"+e),this._origin=e,this._callTelemetry.setCallOrigin(e)},t.prototype._setIsCast=function(e){this._logger.info("Set isCast:"+e),this.isCast=e,this._callTelemetry.setIsCast(e)},t.prototype._setIsEmergency=function(e){this._logger.info("Set isEmergency:"+e),this.isEmergency=e,this._callTelemetry.setIsEmergency(e)},t.prototype._addToMediaStreams=function(e){this.localMediaStreams.push(e),this.raiseChanged()},t.prototype._removeMediaStream=function(e){u.remove(this.localMediaStreams,e),this.raiseChanged()},t.prototype._getLocalVideo=function(){return u.find(this.localMediaStreams,function(e){return 1===e.mediaType})},t.prototype._getlocalScreenShareStream=function(){return u.find(this.localMediaStreams,function(e){return 3===e.mediaType})},t.prototype._startLocalVideo=function(e,t){var n=this._getLocalVideo();return n||(n=new L.default(this._logger,this._settings,this._slimcoreInstance,this.slimcoreCallId,this._slimcoreCallHandler,this._deviceManager,t),this._addToMediaStreams(n)),n.start(t,e)},t.prototype.dumpVideoSourceImages=function(){return l(this,void 0,void 0,function(){var e;return c(this,function(t){return(e=this._getLocalVideo())?[2,e.dumpVideoSourceImages()]:[2,Promise.reject(new Error("Cannot dump video effects debug images when there is no local video"))]})})},t.prototype.startScreenSharing=function(e,t,n,r){return void 0===r&&(r=F.generateCauseId()),l(this,void 0,void 0,function(){var i=this;return c(this,function(o){return this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&this.screenSharingControl.shutdownControlForViewer(),[2,Promise.resolve().then(function(){var e=i._getlocalScreenShareStream();return e||(e=new b.default(i._logger,i._settings,i._slimcoreInstance,i.slimcoreCallId,i._slimcoreCallHandler,i._deviceManager,i._appHooks,i.screenSharingControl,i._callTelemetry),i._addToMediaStreams(e),e.changed(function(){return i._onLocalScreenShareStreamChanged(r)}),e.on("sharingSourceLost",function(){return i._onLocalScreenShareSourceLost()}),e.on("windowClosed",function(){return i.stopScreenSharing(!1,n,r)}),e.on("scraperEvent",function(e){return i._onScraperEvent(e)})),e}).then(function(i){return i.start(r,e,t,n)})]})})},t.prototype.changeCropRegion=function(e){var t=this._getlocalScreenShareStream();t&&t.changeCropRegion(e)},t.prototype._onLocalScreenShareSourceLost=function(){this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&this.screenSharingControl.shutdownControlForSharer();var e=this._getlocalScreenShareStream();e&&e.isStreaming&&this.event("sharingDropped").raise()},t.prototype._onScraperEvent=function(e){var t={event:e.event,data:e.data};this.event("scraperEvent").raise(t)},t.prototype.raiseRenderedAtViewer=function(e){this.event("sharingRenderedAtViewer").raise(e)},t.prototype._onLocalScreenShareStreamChanged=function(e){var t=this._getlocalScreenShareStream();t&&t.isStreaming?(!this.isScreenSharingOn&&this._dataChannel&&this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&(this.screenSharingControl.initControlForSharer(t.negotiationTag),this._dataChannel.start()),this._setScreenSharingOn(!0,e)):t&&!t.isAvailable&&(this.isScreenSharingOn&&this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&this.screenSharingControl.shutdownControlForSharer(),this._setScreenSharingOn(!1,e))},t.prototype.stopScreenSharing=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var e,r,i,o=this;return c(this,function(a){return e=this._logger.createFnLogger(h.CALL_OPERATIONS.STOP_SCREEN_SHARING,n),r=function(){var e=o._getlocalScreenShareStream();e&&(o._removeMediaStream(e),e.dispose(n)),o._setScreenSharingOn(!1,n),o.screenSharingControl&&o.screenSharingControl.isScreenSharingControlEnabled()&&o.screenSharingControl.shutdownControlForSharer()},i=Promise.resolve().then(function(){return l(o,void 0,void 0,function(){var r;return c(this,function(i){switch(i.label){case 0:return(r=this._getlocalScreenShareStream())?[4,T.forgetAndLog(r.stop(n,t),e,"stopScreenSharing: stopping screen sharing")]:[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}})})}),[2,this._callOperationHandler.registerPromise(h.CALL_OPERATIONS_INTERNAL.ELECTRON_STOP_SCREEN_SHARING,i).then(r,function(t){throw e.logFailure(t),r(),t})]})})},t.prototype.startDataChannel=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this._dataChannelCreatedPromise];case 1:return t.sent(),[2,this._dataChannel.start(e)]}})})},t.prototype.stopDataChannel=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this._dataChannelCreatedPromise];case 1:return t.sent(),[2,this._dataChannel.stop(e)]}})})},t.prototype.sendUserEvents=function(e,t){return l(this,void 0,void 0,function(){return c(this,function(n){switch(n.label){case 0:return[4,this._dataChannelCreatedPromise];case 1:return n.sent(),[2,this._dataChannel.sendUserEvents(e,t)]}})})},t.prototype.shareSystemSound=function(e){return l(this,void 0,void 0,function(){var t=this;return c(this,function(n){return this._logger.info("shareSystemSound: "+e),[2,Promise.resolve().then(function(){t._slimcoreCallHandler.callShareSystemSound(t.slimcoreCallId,e)})]})})},t.prototype.startMultichannelAudioDevice=function(e,t){return l(this,void 0,void 0,function(){return c(this,function(n){return this._logger.info("startMultichannelAudioDevice: "+e),this._slimcoreCallHandler.startMultichannelAudioDevice(this.slimcoreCallId,e,t),[2]})})},t.prototype.stopMultichannelAudioDevice=function(){return l(this,void 0,void 0,function(){return c(this,function(e){return this._logger.info("stopMultichannelAudioDevice"),this._slimcoreCallHandler.stopMultichannelAudioDevice(this.slimcoreCallId),[2]})})},t.prototype.transferCall=function(e){return this._logger.warn("transferCall is deprecated, please use callBlindTransfer instead"),this.callBlindTransfer(e)},t.prototype.callBlindTransfer=function(e,t,n){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var r;return c(this,function(i){return r={transferTarget:e,transferType:0,transferStatusSuccessList:[M.CallStatus.Transferring,M.CallStatus.Transferred]},[2,this._transferCall(r,n,t)]})})},t.prototype.callSafeTransfer=function(e,t,n){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var r;return c(this,function(i){return r={transferTarget:e,transferType:0,transferStatusSuccessList:[M.CallStatus.Transferred]},[2,this._transferCall(r,n,t)]})})},t.prototype.transferCallToVoicemail=function(e,t){void 0===t&&(t=F.generateCauseId());var n={transferTarget:e.transferTargetMri,transferType:2,transferStatusSuccessList:[M.CallStatus.Transferred]};return this._transferCall(n,null,t)},t.prototype.callConsultativeTransfer=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n;return c(this,function(r){return n={targetCallId:e.slimcoreCallId,transferType:0,transferStatusSuccessList:[M.CallStatus.Transferred]},[2,this._transferCall(n,null,t)]})})},t.prototype.consultativeTransferWithPickupCode=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i=this;return c(this,function(o){return(n=this._logger.createFnLogger(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE,t)).info("pickup code: "+e),e?(r=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE,"",t),[2,Promise.resolve().then(function(){return i._slimcoreCallHandler.consultativeTransferWithOptions(i.slimcoreCallId,e,0,t)}).catch(function(e){return i._callTelemetry.updateOperationData(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE,{error:k.getPIISafeObject(e)},t),n.logFailure(e),Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return r})]):(n.info("pickup code cannot be empty"),[2,Promise.reject(_.getRejectTransactionEnd("pickup code cannot be empty"))])})})},t.prototype._transferCall=function(e,t,n){return l(this,void 0,void 0,function(){var r,i;return c(this,function(o){if((r=this._logger.createFnLogger("Transfer",n)).info("start"),this._setTransferState(1,n),i=this._waitForTransferSuccessOrFailure(e.transferStatusSuccessList,0,n),e.transferTarget&&2===e.transferType)this._slimcoreCallHandler.startCallTransfer(this.slimcoreCallId,e.transferTarget,M.TransferType.TransferToVoicemail,!1);else if(e.transferTarget)this._slimcoreCallHandler.startCallTransfer(this.slimcoreCallId,e.transferTarget,M.TransferType.TransferStandard,!(!t||!t.disableForwardingAndUnanswered));else{if(!e.targetCallId)return[2,Promise.reject(new Error("Either transferTarget/transfereeCallId should be present"))];this._slimcoreCallHandler.startConsultativeCallTransfer(e.targetCallId,this.slimcoreCallId)}return[2,i]})})},t.prototype.park=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i=this;return c(this,function(o){return n={context:e,parkStatusSuccessList:[M.CallStatus.Parked]},this._setParkState(1,t),this._parkCompletePromise=this._waitForTransferSuccessOrFailure(n.parkStatusSuccessList,1,t),(r=this.mapParkContext(n.context))===M.ParkContext.Invalid?[2,Promise.reject(32)]:(this._slimcoreCallHandler.startCallPark(this.slimcoreCallId,r),[2,this._parkCompletePromise.then(function(){try{var e=i.getStrProperty(M.Property.CallParkPickupCode);return i._serverHoldLocation=i.getStrProperty(M.Property.CallServerHoldLocation),Promise.resolve(e)}catch(e){return Promise.reject(32)}})])})})},t.prototype.unpark=function(e,t){return l(this,void 0,void 0,function(){return c(this,function(e){return[2,Promise.reject(new Error("Not implemented"))]})})},t.prototype.getServerHoldLocation=function(){return l(this,void 0,void 0,function(){var e=this;return c(this,function(t){return[2,this._parkCompletePromise.then(function(){return e._logger.info("getServerHoldLocation="+e._serverHoldLocation),Promise.resolve(e._serverHoldLocation)})]})})},t.prototype.getJoinBlob=function(){return l(this,void 0,void 0,function(){var e=this;return c(this,function(t){return[2,Promise.resolve().then(function(){var t=e._slimcoreCallHandler.getJoinBlob(e.slimcoreCallId);return e._logger.info("getJoinBlob="+t),t})]})})},t.prototype.mapParkContext=function(e){switch(e){case 0:return M.ParkContext.Team;case 1:return M.ParkContext.Sharedline;case 2:return M.ParkContext.Serverhold;default:return M.ParkContext.Invalid}},t.prototype._waitForTransferSuccessOrFailure=function(e,n,r){var i=this,o=this._logger.createFnLogger("WaitForTransfer",r);o.info("successStatusList="+e+", type="+n);var a=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS,void 0,r),s=0===n?M.Property.CallTransferStatus:M.Property.CallParkStatus,l=0===n?M.Property.CallTransferFailureReason:M.Property.CallParkFailureReason,c=function(n){if(o.info("status changed: "+n+" ("+M.CallStatus[n]+")"),-1!==e.indexOf(n)||n===M.CallStatus.Failed)if(d&&(d.dispose(),d=null),-1!==e.indexOf(n))i._callOperationHandler.resolveOperation(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS,1);else{var a=i.getIntProperty(l),s=t.convertParticipantReasonToTerminatedReason(R.convertFailureReasonToParticipantReason(a)),c={reason:a,code:i.transferDiagnosticsInfo&&i.transferDiagnosticsInfo.callControllerCode,subcode:i.transferDiagnosticsInfo&&i.transferDiagnosticsInfo.callControllerSubCode};i._callTelemetry.updateOperationData(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS,c,r),o.logFailure("failureReason="+a+" => terminatedReason="+s+", diagnostic info: "+k.getPrintableObject(i.transferDiagnosticsInfo)),i._callOperationHandler.rejectOperation(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS,s)}},d=this._slimcoreInstance.handle("object-property-changed",{objectId:this.slimcoreCallId,propKey:s},function(e){return c(e.value)});return a},t.prototype.mute=function(e){return void 0===e&&(e=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){return this.isMuteDisabled()?[2,Promise.reject(_.getRejectTransactionEnd(h.TRANSACTION_END_PHRASE.TRANSACTION_DISALLOWED))]:[2,this._muteUnmute(!0,e)]})})},t.prototype.unmute=function(e){return void 0===e&&(e=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){return this.isUnMuteDisabled()?[2,Promise.reject(new Error("Cannot unmute when already locally and server unmuted"))]:[2,this._muteUnmute(!1,e)]})})},t.prototype.muteSpeaker=function(e){return void 0===e&&(e=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){return this.isSpeakerMuted?[2,Promise.reject(new Error("Cannot mute speaker when already muted"))]:[2,this._muteUnmuteSpeaker(!0,e)]})})},t.prototype.unmuteSpeaker=function(e){return void 0===e&&(e=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(t){return this.isSpeakerMuted?[2,this._muteUnmuteSpeaker(!1,e)]:[2,Promise.reject(new Error("Cannot unmute speaker when already unmuted"))]})})},t.prototype.muteParticipants=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(r){return[2,this._muteParticipants(e,t,n)]})})},t.prototype.hold=function(e,t,n){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return[2,this._holdUnhold(!0,t,e)]})})},t.prototype.unhold=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return[2,this._holdUnhold(!1,t,e)]})})},t.prototype.updateEndpointMetadata=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return 3!==this.state?(this._logger.warn("Trying to updateEndpointMetadata in a call which is not connected, callId = "+this.callId),[2,Promise.reject(new Error("cannot updateEndpointMetadata in a call which is not connected"))]):(this._endpointMetadata=e,[2,this._updateEndpointMetadata(this._endpointMetadata,t)])})})},t.prototype.sendDtmfTone=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return this._logger.info("DTMF tone <omitted>"),[2,this._sendDtmfTone(e,t)]})})},t.prototype.setAudioUsageMode=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){return c(this,function(n){return[2,this._setAudioUsageMode(e,t)]})})},t.prototype.getTechnicalInformationJson=function(){return l(this,void 0,void 0,function(){var e=this;return c(this,function(t){return[2,Promise.resolve().then(function(){try{return e._slimcoreCallHandler.callGetTechnicalInformationJson(e.slimcoreCallId)}catch(t){throw e._logger.error("Error in callGetTechnicalInformationJson callId: "+e.callId+", error: "+t),t}})]})})},t.prototype.startAudio=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r;return c(this,function(i){return n=this._logger.createFnLogger(h.CALL_OPERATIONS.START_AUDIO,t),3!==this.state?(n.logFailure("cannot startAudio when call is not connected"),[2,Promise.reject(60)]):(r=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.START_AUDIO,void 0,t),this._slimcoreCallHandler.callStartAudio(this.slimcoreCallId,e),[2,r])})})},t.prototype.stopAudio=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r;return c(this,function(i){return n=this._logger.createFnLogger(h.CALL_OPERATIONS.STOP_AUDIO,t),3!==this.state?(n.logFailure("cannot stopAudio when call is not connected"),[2,Promise.reject(60)]):(r=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.STOP_AUDIO,void 0,t),this._slimcoreCallHandler.callStopAudio(this.slimcoreCallId,e),[2,r])})})},t.prototype.assimilate=function(e,t,n,r){return void 0===r&&(r=F.generateCauseId()),l(this,void 0,void 0,function(){var i;return c(this,function(o){return(i=this._logger.createFnLogger(h.CALL_OPERATIONS.ASSIMILATE,r)).info("assimilate: "+e.callId+" threadId: "+t+", messageId: "+n+", causeId: "+r),this._slimcoreCallHandler.callAssimilate(this.slimcoreCallId,e.slimcoreCallId,t,n),[2,Promise.resolve({code:0})]})})},t.prototype._onMediaNegotiationStatusChanged=function(e){this._logger.createFnLogger("onMediaNegotiationStatusChanged",e.causeId).info("_onMediaNegotiationStatusChanged modalityType: "+e.modalityType+"\n            mediaNegotiationStatusCode: "+e.mediaNegotiationStatusCode);var t;switch(e.modalityType){case M.ModalityType.Audio:t=this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.START_AUDIO)?h.CALL_OPERATIONS.START_AUDIO:h.CALL_OPERATIONS.STOP_AUDIO;break;case M.ModalityType.Video:t=h.CALL_OPERATIONS.SET_MAX_VIDEO_CHANNELS;break;default:return}this._callOperationHandler.hasPendingOperation(t)&&(e.mediaNegotiationStatusCode===M.MediaNegotiationStatusCode.Succeeded?this._callOperationHandler.maybeResolveOperation(t,e.mediaNegotiationStatusCode,void 0,e.causeId):this._callOperationHandler.maybeRejectOperation(t,e.mediaNegotiationStatusCode,void 0,e.causeId))},t.prototype.publishState=function(e,t){var n=this,r=e.level,i=this._logger.createFnLogger(h.CALL_OPERATIONS.PUBLISH_STATE,t);return this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.PUBLISH_STATE,e.participantIds&&e.participantIds.length>0?h.OPERATION_VARIANTS.SPECIFIED:h.OPERATION_VARIANTS.NONE),Promise.resolve().then(function(){var i=n.getSlimcoreEnumLevel(r);n._slimcoreCallHandler.publishState(n.slimcoreCallId,e.type,i,e.content,t,e.participantIds)}).catch(function(e){return Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return n._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.PUBLISH_STATE,t,t)}).catch(function(e){return n._callTelemetry.updateOperationData(h.CALL_OPERATIONS.PUBLISH_STATE,{error:k.getPIISafeObject(e)},t),i.logFailure(e),Promise.reject(e)})},t.prototype.publishStatesForEveryone=function(e,t){var n=this,r=e.level,i=this._logger.createFnLogger(h.CALL_OPERATIONS.PUBLISH_STATE,t);return this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.PUBLISH_STATE,h.OPERATION_VARIANTS.ALL),Promise.resolve().then(function(){var i=n.getSlimcoreEnumLevel(r);n._slimcoreCallHandler.publishStatesForEveryone(n.slimcoreCallId,e.type,i,e.content,t)}).catch(function(e){return Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return n._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.PUBLISH_STATE,t,t)}).catch(function(e){return n._callTelemetry.updateOperationData(h.CALL_OPERATIONS.PUBLISH_STATE,{error:k.getPIISafeObject(e)},t),i.logFailure(e),Promise.reject(e)})},t.prototype.removeState=function(e,t){var n=this,r=this._logger.createFnLogger(h.CALL_OPERATIONS.REMOVE_STATE,t);return Promise.resolve().then(function(){n._slimcoreCallHandler.removeState(n.slimcoreCallId,e.stateIds,t)}).catch(function(e){return Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return n._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.REMOVE_STATE,t)}).catch(function(e){throw n._callTelemetry.updateOperationData(h.CALL_OPERATIONS.REMOVE_STATE,{error:k.getPIISafeObject(e)},t),r.logFailure(e),e})},t.prototype.removeStatesForEveryone=function(e,t){var n=this,r=this._logger.createFnLogger(h.CALL_OPERATIONS.REMOVE_STATE,t);return Promise.resolve().then(function(){n._slimcoreCallHandler.removeStatesForEveryone(n.slimcoreCallId,e.type,t)}).catch(function(e){return Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return n._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.REMOVE_STATE,t)}).catch(function(e){throw n._callTelemetry.updateOperationData(h.CALL_OPERATIONS.REMOVE_STATE,{error:k.getPIISafeObject(e)},t),r.logFailure(e),e})},t.prototype.updateMeetingSettings=function(e,t){var n=this,r=this._logger.createFnLogger(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,t);return Promise.resolve().then(function(){n._slimcoreCallHandler.updateMeetingSettingsJson?n._slimcoreCallHandler.updateMeetingSettingsJson(n.slimcoreCallId,JSON.stringify(e),t):n._slimcoreCallHandler.updateMeetingSettings(n.slimcoreCallId,!!e.allowRaiseHands,t)}).catch(function(e){return Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return n._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,t)}).catch(function(e){throw n._callTelemetry.updateOperationData(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,{error:k.getPIISafeObject(e)},t),r.logFailure(e),e})},t.prototype.stop=function(e,t,n){void 0===e&&(e=!1),void 0===t&&(t=F.generateCauseId());var r=this._logger.createFnLogger(h.CALL_OPERATIONS.STOP_CALL,t);if(6===this.state)return r.logFailure("Trying to stop a call which is already Disconnecting, callId = "+this.callId),Promise.reject(new Error("cannot stop call in Disconnecting state"));if(7===this.state)return r.logFailure("Trying to stop a call which is already Disconnected, callId = "+this.callId),Promise.reject(new Error("cannot stop call in Disconnected state"));var o=i({},n,{causeId:t,forEveryone:e});return this.stopInternal(o)},t.prototype.reject=function(e){return void 0===e&&(e=F.generateCauseId()),1!==this.state?Promise.reject(60):this.stopInternal({causeId:e})},t.prototype.stopInternal=function(e){var t=this,n=e.causeId,r=e.terminatedReason||0,i=this._logger.createFnLogger("stopInternal",n);return 6===this.state?(i.info("Trying to stop a call which is already Disconnecting"),this.disconnectingPromise):7===this.state?(i.info("Trying to stop a call which is already Disconnected"),this.disconnectingPromise):(this._setCallState(6,n,r),this.disconnectingPromise=Promise.resolve().then(function(){return i.info("Leaving from call"),t._leaveSlimCoreCall(e)}).catch(function(e){throw t._callTelemetry.updateOperationData(h.CALL_OPERATIONS.STOP_CALL,{error:k.getPIISafeObject(e)},n),i.logFailure(e),t._setCallState(7,n,e),e}),this.disconnectingPromise)},t.prototype.mapEndpointScope=function(e){switch(e){case 1:return M.EndpointScope.EndpointScopeAll;default:return M.EndpointScope.EndpointScopeNone}},t.prototype._leaveSlimCoreCall=function(e){var t=this,n=e.causeId,r=this._logger.createFnLogger(h.CALL_OPERATIONS_INTERNAL.ELECTRON_LEAVE_CALL,n);if(r.info("forEveryone: "+(e&&e.forEveryone)),0===this.slimcoreCallId)return r.logFailure("slimcoreCallId == 0"),Promise.reject(32);var i=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.CALL_ENDED);return Promise.resolve().then(function(){e&&e.forEveryone?t._slimcoreCallHandler.endCallForAll(t.slimcoreCallId):t._slimcoreCallHandler.leaveCall(t.slimcoreCallId,t.mapEndpointScope(e.scope),n)}).then(function(){return r.info("Waiting for SlimCore to end call")}).then(function(){return i}).then(function(){r.info("SlimCore ended the call")},function(e){return r.logFailure("Error in leaveSlimCoreCall().. ignoring, error = "+k.getPrintableObject(e)+", reason = 25"),Promise.reject(25)})},t.prototype.incomingCallInit=function(e,t){void 0===t&&(t=F.generateCauseId());var n=this._logger.createFnLogger(h.CALL_OPERATIONS_INTERNAL.INCOMING_INITIALIZE,t);try{if(this.callerMri=f.stripMriAliases(this._getStrProperty(this._slimcoreCallHandler,e,M.Property.CallerMriIdentity)),!this.callerMri)return void n.logFailure("Unable to get callerMRI from call object. Ignoring incoming call");var r=this._getProperties(this._slimcoreCallHandler,e,{conversationType:{propKey:M.Property.CallConversationType},callQueueInfo:{propKey:M.Property.CallQueueInfo},transferorMri:{propKey:M.Property.CallTransferorMri},transferorDisplayName:{propKey:M.Property.CallTransferorDisplayName},transferorType:{propKey:M.Property.CallTransferorType},onBehalfOfMri:{propKey:M.Property.CallOnBehalfOfMri},incomingCallType:{propKey:M.Property.CallIncomingType},consultativeCallId:{propKey:M.Property.CallConsultativeTransferCallId},messageId:{propKey:M.Property.CallMessageId}},{status:{propKey:M.Property.CallStatus},isIncomingOneOnOneVideoCall:{propKey:M.Property.CallIsIncomingOneOnOneVideoCall}});this.transferorMri=f.stripMriAliases(r.transferorMri),this.transferorDisplayName=r.transferorDisplayName,this.transferorType=r.transferorType,this.onBehalfOfMri=f.stripMriAliases(r.onBehalfOfMri),this.callQueueInfo=r.callQueueInfo&&JSON.parse(r.callQueueInfo).callQueueInfo,this.incomingCallType=r.incomingCallType,this.consultativeCallId=r.consultativeCallId,this.isIncomingOneOnOneVideoCall=!!r.isIncomingOneOnOneVideoCall,this.messageId=r.messageId,this._updateConversationType(r.conversationType,t),this.attachSlimCoreCallObject(e,t),r.status===M.CallStatus.RingingIn&&(this._setCallState(1,t),this._callTelemetry.setDirection(g.DIRECTION.INCOMING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLEE))}catch(e){throw n.logFailure("sync failure, cleaning up slimcore ready operation: error="+k.getPrintableObject(e)),this._callTelemetry.updateOperationData(h.CALL_OPERATIONS_INTERNAL.INCOMING_INITIALIZE,{error:k.getPIISafeObject(e)},t),this._callOperationHandler.rejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY),e}},t.prototype.acknowledge=function(e,n){var r=this;void 0===n&&(n=F.generateCauseId());var i=this._logger.createFnLogger(h.CALL_OPERATIONS.ACKNOWLEDGE,n);if(0!==this.state&&8!==this.state)return this._callTelemetry.maybeRecordOperationSuccess(h.CALL_OPERATIONS.ACKNOWLEDGE,{code:4}),Promise.reject(new Error("Trying to acknowledge a call that has already been acted on"));this._setCallerMri(f.stripMriAliases(e.callerId),n),this._callTelemetry.setDirection(g.DIRECTION.INCOMING),this._callTelemetry.setSelfParticipantRole(g.SELF_PARTICIPANT_ROLE.CALLEE);var o={callId:e.convoCallId,callerId:e.callerId,launchTime:e.launchTime.toString(),pushReceivedTime:e.pushReceivedTime.toString(),registrationId:e.registrationId,participantId:e.participantId},a=this._slimcoreInstance.handlePushNotification({eventType:e.body.evt,servicePayload:e.body.gp,correlationIdsJson:JSON.stringify(o),callKey:e.callKey,connectionType:t.convertConnectionType(e.connectionType),accountIdentity:this.currentUserSkypeIdentity.id,mediaConfigurationJson:T.mapToEmptyStrIfFalsy(JSON.stringify(e.mediaConfiguration))}),s=[],l=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_HANDLE_PUSH,void 0,n);s.push(this._slimcoreInstance.handle("push-handling-complete",{token:a},function(e){if(e.token===a)if(i.info("HandlePushNotification: Received event for token: "+e.token+" result: "+e.result),e.result===M.PushHandlingResult.CallSetupSucceeded)i.logSuccess("HandlePushNotification: Succeeded"),r._callOperationHandler.resolveOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_HANDLE_PUSH,{code:1,success:!0},void 0,n).catch(function(e){i.logFailure("HandlePushNotification: Failed "+e)});else if(e.result===M.PushHandlingResult.CallSetupProgress)i.info("HandlePushNotification: In progress, keep waiting...");else{var o="HandlePushNotification: Failed "+e.result;i.logFailure(o),r._callOperationHandler.resolveOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_HANDLE_PUSH,t.convertPushHandlingResult(e.result),void 0,n).catch(function(e){i.logFailure("HandlePushNotification: Failed "+e)})}else i.logFailure("HandlePushNotification: Received unexpected token "+e.token+" (expected "+a+")")}));var c=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_RINGING);c.catch(j.noop),s.push(this._slimcoreInstance.handle("object-property-changed",{objectType:M.ObjectType.Call},function(e){var t=r._getStrProperty(r._slimcoreCallHandler,e.objectId,M.Property.CallName),o=r._getIntProperty(r._slimcoreCallHandler,e.objectId,M.Property.CallStatus);t===r.callId?o===M.CallStatus.RingingIn&&(r.attachSlimCoreCallObject(e.objectId,n,!1,"acknowledge"),r._fillIncomingCallProperties(n),r._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_RINGING)&&r._callOperationHandler.resolveOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_RINGING,void 0,void 0,n).then(function(){i.logSuccess("Reached ringing/active state for call pending acknowledgement")},function(e){i.logFailure("Reached ringing/active state for call pending acknowledgement "+e)}),r.raiseChanged()):i.info("Ignoring SlimCore event for incorrect call "+e.objectId+"/"+t)}));var d=function(){return u.each(s,function(e){return e.dispose()})},p=function(e){r._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_RINGING,e,void 0,n),r._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_WAIT_FOR_HANDLE_PUSH,e,void 0,n)};return l.then(function(e){return e.success?c.then(function(){return r._setCallState(1,n),e}):(p(e),e)}).then(function(e){return i.logSuccess("Acknowledge done"),d(),e}).catch(function(e){throw i.logFailure("sync failure, cleaning up slimcore ready operation: error="+k.getPrintableObject(e)),r._callTelemetry.updateOperationData(h.CALL_OPERATIONS_INTERNAL.INCOMING_INITIALIZE,{error:k.getPIISafeObject(e)},n),r._callOperationHandler.rejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY),d(),p(e),e})},t.prototype.accept=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i,o,a;return c(this,function(s){switch(s.label){case 0:(n=this._logger.createFnLogger(h.CALL_OPERATIONS.ACCEPT,t)).info("accept, answerMediaType: "+e.answerMediaType+",\n                            withVideo: "+e.withVideo+",\n                            muted: "+e.muted+",\n                            clientEndpointCapabilities: "+e.clientEndpointCapabilities),e.muted&&n.logFailure("Accepting call muted is not implemented"),this.containsMultipleVideos(e)&&this._callTelemetry.setOperationVariant(h.CALL_OPERATIONS.ACCEPT,h.OPERATION_VARIANTS.MULTIPLEVIDEOS),this._setCallState(2,t),this.connectCallPromise=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.ACCEPT),r=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,void 0,t),s.label=1;case 1:if(s.trys.push([1,5,,6]),e.sendMediaModalities&&this._slimcoreCallHandler.answer){if(i=T.returnStringifiedVersionOfMediaStateConfiguration(e.sendMediaModalities),this._logger.info("sendMediaModalitiesJson: "+i),""===i)throw new Error("Passed invalid JSON");o=e.endpointBehaviors?JSON.stringify(e.endpointBehaviors):"",this._slimcoreCallHandler.answer(this.slimcoreCallId,i,o,e.clientEndpointCapabilities||0)}else this._acceptCall(e,t);return this._updateCallType(this.getIntProperty(M.Property.CallIsConference),t),1===e.answerMediaType||e.sendMediaModalities&&e.sendMediaModalities.mediaStates&&u.find(e.sendMediaModalities.mediaStates,function(e){return 1===e.mediaType&&!0!==e.isDisabled})?(n.info("Call has been answered - turning on video"),[4,this.startVideoSafe(t)]):[3,3];case 2:s.sent(),s.label=3;case 3:return[4,r];case 4:return s.sent(),this._setCallState(3,t),[3,6];case 5:throw a=s.sent(),this._callTelemetry.updateOperationData(h.CALL_OPERATIONS.ACCEPT,{error:k.getPIISafeObject(a)},t),this.stopInternal({causeId:t}),this._logger.error("Error in accept(), callId = "+this.callId+", error = "+a),a;case 6:return[2]}})})},t.prototype.mergeParticipants=function(e,t,n,r){return l(this,void 0,void 0,function(){var i,o,a,s,l,d,u=this;return c(this,function(c){if(i=[],0===t.length)return[2,Promise.reject(_.getRejectTransactionEnd("Invalid participantIds"))];for(o=0,a=t;o<a.length;o++){if(s=a[o],!(l=v.findParticipantUsingParticipantLegId(e,s)))return[2,Promise.reject(_.getRejectTransactionEnd("ParticipantId "+s+" is invalid!"))];d=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS.MERGE_PARTICIPANT,l.id,r),i.push(d)}return[2,Promise.resolve().then(function(){if(!u.slimcoreCallId)return Promise.reject(_.getRejectTransactionEnd("Invalid self slimcore call id "+u.slimcoreCallId));if(!e)return Promise.reject(_.getRejectTransactionEnd("Invalid callToMerge slimcore call id "+u.slimcoreCallId));var i=n.additionalData?JSON.stringify(n.additionalData):"";return u._slimcoreCallHandler.mergeCallParticipants(u.slimcoreCallId,e.slimcoreCallId,t,n.threadId,n.messageId,r,i)}).catch(function(e){return u._callTelemetry.updateOperationData(h.CALL_OPERATIONS.MERGE_PARTICIPANT,{error:k.getPIISafeObject(e)},r),u._logger.logFailure(e),Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return i})]})})},t.prototype.mergeWithPickupCode=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o,a=this;return c(this,function(s){return(r=this._logger.createFnLogger(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE,n)).info("mergeWithPickupCode: pickup code: "+e+", threadId: "+t.threadId+" messageId: "+t.messageId),e?(i=t.additionalData?JSON.stringify(t.additionalData):"",o=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE,e,n),[2,Promise.resolve().then(function(){return a._mergeWithPickupCode(e,t.threadId,t.messageId,n,i)}).catch(function(e){return a._callTelemetry.updateOperationData(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE,{error:k.getPIISafeObject(e)},n),r.logFailure(e),Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return o})]):(r.info("mergeWithPickupCode: pickup code cannot be empty"),[2,Promise.reject(_.getRejectTransactionEnd("pickup code cannot be empty"))])})})},t.prototype.merge=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o,a,s,l=this;return c(this,function(c){return(r=this._logger.createFnLogger(h.CALL_OPERATIONS.MERGE_CALL,n)).info("merge: "+e.callId+" threadId: "+t.threadId+", messageId: "+t.messageId),e.participants&&1===e.participants.length?(i=e.participants[0].id,o=t.additionalData?JSON.stringify(t.additionalData):"",a=this._getOrCreateParticipant(i,n),this._addParticipantToCall(a,n),s=this._participantOperationHandler.createPendingOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,a.id,n),[2,Promise.resolve().then(function(){return l._slimcoreCallHandler.callMerge(l.slimcoreCallId,e.slimcoreCallId,t.threadId,t.messageId,n,o)}).catch(function(e){return l._callTelemetry.updateOperationData(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,{error:k.getPIISafeObject(e)},n,i),r.logFailure(e),l._handleParticipantRemoved(i,n,e),Promise.reject(_.getRejectTransactionEnd(e))}).then(function(){return s}).then(function(){return Promise.resolve({code:h.TRANSACTION_END_CODE.SUCCESS,subCode:0,phrase:h.TRANSACTION_END_PHRASE.TRANSACTION_COMPLETE})}).catch(function(e){r.logFailure(e),l._handleParticipantRemoved(i,n,e);var t=e;return _.isTransactionEnd(e)&&(t=e),Promise.reject(t)})]):(r.error("error invalid number of participants on call to be merged "+e.participants.length),[2,Promise.reject(_.getRejectTransactionEnd(h.TRANSACTION_END_PHRASE.TRANSACTION_DISALLOWED))])})})},t.prototype._acceptCall=function(e,n){var r=e.endpointBehaviors?JSON.stringify(e.endpointBehaviors):"";try{e.withVideo&&(e.answerMediaType=1),this._slimcoreCallHandler.acceptCall(this.slimcoreCallId,t.toAnswerMediaType(e.answerMediaType),r,e.clientEndpointCapabilities||0)}catch(t){this._logger.info("acceptCall is missing from the slimcore electron module: "+t),1===e.answerMediaType&&(e.withVideo=!0),this._slimcoreCallHandler.answerCall(this.slimcoreCallId,e.withVideo,r)}},t.prototype.reconnect=function(){return Promise.reject(new Error("Retargeting is not supported"))},t.prototype.toCallType=function(e){var t=M.EcsCallType.CallTypeS2s;return 0===e?t=M.EcsCallType.CallTypeGroup:2===e?t=M.EcsCallType.CallTypePstn:1===e&&(t=M.EcsCallType.CallTypeS2s),t},t.prototype.showCQFInfo=function(e,t){return l(this,void 0,void 0,function(){return c(this,function(n){this._logger.info("showCQFInfo");try{return[2,this._slimcoreCallHandler.showCQFInfo(e,this.callId,this.toCallType(t))]}catch(e){throw this._logger.error("Error in showCQFInfo callId: "+this.callId+", error: "+e),e}return[2]})})},t.prototype.isCqfRendered=function(e){return l(this,void 0,void 0,function(){return c(this,function(t){this._logger.info("isCqfRendered");try{this._slimcoreCallHandler.isCqfRendered(this.callId,this.participantId,e)}catch(e){throw this._logger.error("Error in isCqfRendered callId: "+this.callId+", error: "+e),e}return[2]})})},t.prototype.provideCallQualityFeedback=function(e,t,n,r){return l(this,void 0,void 0,function(){return c(this,function(i){return[2,this.provideCallQualityFeedbackEx(e,t,n,r,"","")]})})},t.prototype.provideCallQualityFeedbackEx=function(e,t,n,r,i,o){return l(this,void 0,void 0,function(){return c(this,function(a){this._logger.info("provideCallQualityFeedback");try{this._slimcoreCallHandler.provideCallQualityFeedbackEx(this.callId,this.participantId,e,t,n,r,i,o)}catch(e){throw this._logger.error("Error in provideCallQualityFeedback callId: "+this.callId+", error: "+e),e}return[2]})})},t.prototype._mergeWithPickupCode=function(e,t,n,r,i){this._logger.info("_mergeWithPickupCode: pickupCode = "+e+" threadId = "+t+" messageId = "+n+" causeId = "+r),this._slimcoreCallHandler.mergeCallWithPickupCode(this.slimcoreCallId,e,T.mapToEmptyStrIfFalsy(t),T.mapToEmptyStrIfFalsy(n),T.mapToEmptyStrIfFalsy(r),T.mapToEmptyStrIfFalsy(i))},t.prototype._onCallOriginChanged=function(e){e===M.OriginType.Transfer?this._setCallOrigin(1):e===M.OriginType.Park?this._setCallOrigin(2):e===M.OriginType.Unspecified?this._setCallOrigin(0):e===M.OriginType.TransferToVoicemail?this._setCallOrigin(3):this._logger.info("Unknown origin")},t.prototype._onCallMutedUnmuted=function(e){var t=10===this.state;this._logger.info("onCallMutedUnmuted current: "+this.isMuted+" new: "+e),this._logger.info("onCallMutedUnmuted isServerMuted: "+this.isServerMuted+" inLobby: "+t),this.isServerMuted&&!t||e||(this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.MUTE),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNMUTE)),e&&(this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.MUTE),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNMUTE)),this.isMuted!==e&&(this._logger.info("isMuted set to "+e+" in _onCallMutedUnmuted"),this.isMuted=e,this._logger.info("onCallMutedUnmuted isMuted: "+this.isMuted),this._updateCapabilities(F.generateCauseId()),this.raiseChanged())},t.prototype._onCallMutedUnmutedSpeaker=function(e,t){void 0===t&&(t=F.generateCauseId()),this._logger.createFnLogger("onCallMutedUnmutedSpeaker",t).info("current: "+this.isSpeakerMuted+" new: "+e),e?this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.MUTE_SPEAKER,void 0,void 0,t):this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNMUTE_SPEAKER,void 0,void 0,t),this._setMutedSpeaker(e,t)},t.prototype._onCallIsServerMuted=function(e,t){void 0===t&&(t=F.generateCauseId()),this._logger.info("_onCallIsServerMuted "+e),e!==this.isServerMuted&&(this.isServerMuted=e,this._callTelemetry.recordEvent(h.PARTICIPANT_OPERATIONS_INTERNAL.SELF_PARTICIPANT_UPDATED,{isServerMuted:this.isServerMuted},t),this.event("serverMutedChanged").raise(e),this._updateCapabilities(t),this.raiseChanged())},t.prototype._onCallCapabilitiesChanged=function(e){e!==this._capabilityFlags&&(this._logger.info("_onCallCapabilitiesChanged: new value is "+e),this._capabilityFlags=e,this._updateCapabilities(F.generateCauseId(),!0))},t.prototype._updateCapabilities=function(e,t){void 0===t&&(t=!1);var n=!1,r=!1;I.callStateIsAnyOf(this.state,[11,12])||(n=!(this.isUnMuteDisabled()||this.isServerMuted&&!(this._capabilityFlags&M.SelfCapability.UnmuteSelf)),r=!!(this._capabilityFlags&M.SelfCapability.MuteOthers)),this._capabilities.canUnmuteSelf===n&&this._capabilities.canMuteOthers===r||(this._capabilities.canUnmuteSelf=n,this._capabilities.canMuteOthers=r,this._logger.info("["+e+"]_updateCapabilities Computed capabilities: "+JSON.stringify(this._capabilities)),t&&this.raiseChanged())},t.prototype._getCallParticipantMriMap=function(){for(var e={},t=this._slimcoreCallHandler.callGetParticipants(this.slimcoreCallId)||[],n={},r=0,i=t;r<i.length;r++){var o=i[r];n[o]={objectId:o,propKey:M.Property.ParticipantMriIdentity}}for(var a=this._getProperties(this._slimcoreCallHandler,0,n,{}),s=0,l=t;s<l.length;s++){var c=l[s],d=a[c];d&&(e[d]=c)}return e},t.prototype._getParticipantsData=function(e){for(var t={},n={},r={},i=function(e,t){return e+"_"+t},o=0,a=e;o<a.length;o++){for(var s=a[o],l=0,c=Object.keys(P.participantStrProps);l<c.length;l++){p=c[l];t[i(s.objectId,p)]={objectId:s.objectId,propKey:P.participantStrProps[p].propKey,fallback:P.participantStrProps[p].fallback}}for(var d=0,u=Object.keys(P.participantIntProps);d<u.length;d++){var p=u[d];n[i(s.objectId,p)]={objectId:s.objectId,propKey:P.participantIntProps[p].propKey,fallback:P.participantIntProps[p].fallback}}r[s.objectId]=s.mri}var h={};if(e.length)for(var g=this._getProperties(this._slimcoreCallHandler,0,t,n),_=0,f=Object.keys(g);_<f.length;_++){var m=f[_],C=m.split("_"),S=C[0],y=C[1];h[S]||(h[S]={objectId:Number(S),mri:r[S],props:{}}),h[S].props[y]=g[m]}for(var v=[],I=0,T=Object.keys(h);I<T.length;I++){S=T[I];v.push(h[S])}return v},t.prototype._callGetParticipantsData=function(e,t){var n=this,r=this._getCallParticipantMriMap(),i=[],o=[],a=function(e){return r.hasOwnProperty(e.mri)},s=function(e){return e.objectId},l=function(e){return e.objectId===r[e.mri]},c=Object.keys(r).length;e.forEach(function(e){a(e)?s(e)?l(e)?n._participantOperationHandler.hasPendingOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,e.mri)||delete r[e.mri]:o.push(e):(i.push(e),delete r[e.objectId]):o.push(e)}),this._logger.info("["+t+"]onParticipantJoinedOrRemoved # of participants in roster="+c+"["+Object.keys(e).length+"]["+i.length+"]["+o.length+"]"),Object.keys(r).forEach(function(e){return i.push({mri:e,objectId:r[e]})});var d=[];return d=this._settings.enableParticipantsGetPropsAggregation?this._getParticipantsData(i):i,{newParticipantsData:d,participantsToRemove:o}},t.prototype._onParticipantJoinedOrRemoved=function(e){var t=this,n=this._callGetParticipantsData(this.participants.map(function(e){return{objectId:e.slimcoreObjectId,mri:e.id}}),e),r=n.newParticipantsData;n.participantsToRemove.forEach(function(n){return t._handleParticipantRemoved(n.mri,e,t.participantMap[n.mri].stateReason)}),Object.keys(r).forEach(function(n){return t._handleParticipantJoined(r[n],e)})},t.prototype._updateDominantSpeakerList=function(){var e=this;if(this._isOptimizedSpeakerEventingEnabled)return{fullOrderMatches:!0,topSpeakerMatches:!1};var t=u.map(u.sortBy(u.map(u.filter(this.participants,function(e){return 3===e.state}),function(t){return{mri:t.id,rank:t.dominantSpeakerRank?t.dominantSpeakerRank:e.participants.length+1}}),"rank"),function(e){return e.mri}),n=u.isEqual(this.dominantSpeakerInfo.speakerList,t),r=n;return r||(r=!u.isEmpty(this.dominantSpeakerInfo.speakerList)&&!u.isEmpty(t)&&u.head(this.dominantSpeakerInfo.speakerList)===u.head(t)),this.dominantSpeakerInfo={speakerList:t,timestamp:new Date},n||this._logger.info("_updateDominantSpeakerList: "+this.dominantSpeakerInfo.speakerList.length),{fullOrderMatches:n,topSpeakerMatches:r}},t.prototype._handleParticipantRemoved=function(e,t,n){void 0===n&&(n=0);var r=this._logger.createFnLogger("handleParticipantRemoved",t);r.info("reason="+n),this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&this.screenSharingControl.handleParticipantRemoved(e);var i=this._removeParticipantEntry(e);i?(i.setState(4,t,n),this._participantOperationHandler.maybeRejectOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,n,e),this._participantOperationHandler.maybeResolveOperation(h.PARTICIPANT_OPERATIONS.REMOVE_PARTICIPANT,n,e),i.rejectAdmitParticipantDeferred(n),i.dispose(),this._updateDominantSpeakerList(),this.event("participantRemoved").raise(i),this.raiseChangedDeferred()):r.logFailure("unable to remove participant")},t.prototype._handleParticipantJoined=function(e,t){var n=this;this._logger.debug("["+t+"]handleParticipantJoined: "+S.scrubMriOrOmit(e.mri));var r=this._getOrCreateParticipant(e.mri,t,e.objectId,e);if(P.default.isParticipantActive(r.state)&&this._participantOperationHandler.hasPendingOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,e.mri)){this._participantOperationHandler.resolveOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,r,e.mri),this._callTelemetry.recordOperationSuccess(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,null,e.mri);this._callTelemetry.recordOperationSuccess(h.PARTICIPANT_OPERATIONS_INTERNAL.PARTICIPANT_JOINED,g.getEndpointInformationForTelemetry(function(e){return e&&e.endpoints&&e.endpoints.endpointDetails||[]}(r)),e.mri,t)}this._handleParticipantJoinedDefer||(this._handleParticipantJoinedDefer=u.defer(function(){delete n._handleParticipantJoinedDefer,n._updateDominantSpeakerList().fullOrderMatches||n.raiseChangedDeferred()}))},t.prototype._admitParticipantToSlimCoreElectronCall=function(e){var t=[e];return this._slimcoreCallHandler.admitParticipants(this.slimcoreCallId,t),Promise.resolve()},t.prototype.admitParticipant=function(e,t){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var n,r,i,o,a=this;return c(this,function(s){return(n=this._logger.createFnLogger(h.PARTICIPANT_OPERATIONS.ADMIT_PARTICIPANT,t)).info("participantId = "+S.scrubMriOrOmit(e)),0===this.slimcoreCallId?[2,Promise.reject(11)]:7!==(r=this._getOrCreateParticipant(e,t)).state?[2,Promise.reject(43)]:(i=p.defer(),o=this._admitParticipantToSlimCoreElectronCall(e).then(function(){return r.addAdmitParticipantDeferred(i)}).then(function(){return i.promise}).then(function(){return n.logSuccess("admitted")}).catch(function(i){return n.logFailure(i),a._handleParticipantOperationFailure(h.PARTICIPANT_OPERATIONS.ADMIT_PARTICIPANT,i,t,e,r),Promise.reject(i)}),this.raiseChanged(),[2,o])})})},t.prototype.admit=function(e,t){throw new Error("not implemented")},t.prototype._addParticipantToSlimCoreElectronCall=function(e,t,n,r){this._logger.info("addParticipantToSlimCoreElectronCall: participantId = "+S.scrubMriOrOmit(e)+" threadId = "+t+" messageId = "+n+" participantInvitationData = "+S.scrubMriOrOmit(r));var i=this._slimcoreCallHandler.addParticipant(this.slimcoreCallId,e,T.mapToEmptyStrIfFalsy(t),T.mapToEmptyStrIfFalsy(n),T.mapToEmptyStrIfFalsy(r));return 0===i?Promise.reject(new Error("AddParticipant call to slimcore failed")):Promise.resolve(i)},t.prototype.callMeBack=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o,a=this;return c(this,function(s){return(r=this._logger.createFnLogger(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,n)).info("callMeBack: participantMri = "+S.scrubMriOrOmit(e)+" assertedMri = "+S.scrubMriOrOmit(t)),0===this.slimcoreCallId?(r.logFailure("call is not initialized yet"),[2,Promise.reject(new Error("call is not initialized yet"))]):(i=this._participantOperationHandler.waitForOperation(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,e),o=f.generateAliasedMri(""+f.MRI_SKYPE_PREFIX+this.currentUserSkypeIdentity.id,this.currentUserSkypeIdentity.sipUri),[2,Promise.resolve().then(function(){return a._slimcoreCallHandler.callMeBack(a.slimcoreCallId,e,t||o,n),i}).catch(function(t){throw a._callTelemetry.updateOperationData(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,{error:k.getPIISafeObject(t)},n,e),a._participantOperationHandler.maybeRejectOperation(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,1,e,n),r.logFailure("Error in callMeBack(), callId = "+a.callId+", error = "+t),t})])})})},t.prototype.nudgeParticipants=function(e,t,n,r){return void 0===n&&(n={}),void 0===r&&(r=F.generateCauseId()),l(this,void 0,void 0,function(){var i,o,a,s=this;return c(this,function(l){return(i=this._logger.createFnLogger(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,r)).info("nudgeParticipants: context = "+e),2!==this.state&&3!==this.state?[2,Promise.reject(48)]:0===this.slimcoreCallId?[2,Promise.reject(new Error("call is not initialized yet"))]:n.sipUri?[2,Promise.reject(new Error("sipUri not supported yet"))]:(o=n.participantInvitationData?JSON.stringify(n.participantInvitationData):"",i.info("nudgeParticipants: context = "+e+" threadId = "+n.threadId+" messageId = "+n.messageId+" participantInvitationData = "+S.scrubMriOrOmit(o)),a=this._participantOperationHandler.waitForOperation(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,e),[2,Promise.resolve().then(function(){return s._slimcoreCallHandler.nudgeParticipants(s.slimcoreCallId,t,T.mapToEmptyStrIfFalsy(e),T.mapToEmptyStrIfFalsy(n.threadId),T.mapToEmptyStrIfFalsy(n.messageId),T.mapToEmptyStrIfFalsy(o)),a}).catch(function(t){throw s._callTelemetry.updateOperationData(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,{error:k.getPIISafeObject(t)},r,e),s._participantOperationHandler.rejectOperation(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,38,e,r),i.logFailure("Error in NudgeParticipants(), callId = "+s.callId+", context = "+e+", error = "+t),t})])})})},t.prototype._handleParticipantOperationFailure=function(e,t,n,r,i){this._callTelemetry.updateOperationData(e,{error:k.getPIISafeObject(t)},n,r);var o=R.convertFailureReasonToParticipantReason(t),a={callId:this.callId,reason:o},s=i||this._getParticipant(r);return s&&s.callEndDiagnosticsInfo&&(a.code=s.callEndDiagnosticsInfo.callControllerCode,a.subCode=s.callEndDiagnosticsInfo.callControllerSubCode),this._callTelemetry.recordOperationFailure(e,a,r,n),o},t.prototype.updateMeetingRoles=function(e,t,n){return void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o=this;return c(this,function(a){return(r=this._logger.createFnLogger(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,n)).info("updateMeetingRole: participants = "+S.scrubMriOrOmitList(e)+", role = "+t),2!==this.state&&3!==this.state||!T.hasFeature(M.Feature.StructuredMeetings)?[2,Promise.reject({code:y.CONSTANTS.CODE.CLIENT_ERROR_CODE,subCode:y.CONSTANTS.SUB_CODE.ACTION_NOT_ALLOWED,phrase:"ActionNotAllowed"})]:(i=this._participantOperationHandler.waitForOperation(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,n),[2,Promise.resolve().then(function(){return o._slimcoreCallHandler.updateMeetingRoles(o.slimcoreCallId,e,t,n),i}).catch(function(e){throw r.logFailure("Error in UpdateMeetingRoles(), callId = "+o.callId+", error = "+e),o._callTelemetry.updateOperationData(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,{error:k.getPIISafeObject(e)},n),o._participantOperationHandler.rejectOperation(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,38,n,n),e})])})})},t.prototype.addParticipant=function(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o,a,s,l,d=this;return c(this,function(c){return r=this._logger.createFnLogger(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,n),this.isEmergency&&0===this.slimcoreCallId&&0!==this.participants.length?[2,Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"))]:(t.sipUri&&r.logFailure("sipUri not supported yet"),i=t.participantInvitationData?JSON.stringify(t.participantInvitationData):"",r.info("participantId = "+S.scrubMriOrOmit(e)+" threadId = "+t.threadId+" messageId = "+t.messageId+" participantInvitationData = "+S.scrubMriOrOmit(i)),o=this._getOrCreateParticipant(e,n),0===this.slimcoreCallId?[2,Promise.resolve(o)]:-1===(a=[0,4]).indexOf(o.state)?[2,Promise.resolve(o)]:(s=this._participantOperationHandler.waitForOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,o.id),l=Promise.resolve().then(function(){return d._addParticipantToCall(o,n)}).then(function(){return d._addParticipantToSlimCoreElectronCall(o.id,t.threadId,t.messageId,i)}).then(function(e){return o.attachSlimcoreObjectId(e,n)}).catch(function(t){return d._callTelemetry.updateOperationData(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,{error:k.getPIISafeObject(t)},n,e),r.logFailure(t),Promise.reject(1)}).then(function(){return s}).then(function(){return o}).catch(function(t){return r.logFailure(t),d._handleParticipantOperationFailure(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,t,n,e,o),d._handleParticipantRemoved(e,n,t),Promise.reject(t)}),this.raiseChanged(),[2,l]))})})},t.prototype.addParticipants=function(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=F.generateCauseId()),l(this,void 0,void 0,function(){var r,i,o,a,s,l,d=this;return c(this,function(c){return r=this._logger.createFnLogger(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANTS,n),!this.isEmergency||0!==this.slimcoreCallId||0===this.participants.length&&1===e.length?(i=t.participantInvitationData?JSON.stringify(t.participantInvitationData):"",r.info("threadId = "+t.threadId+" messageId = "+t.messageId+" participantInvitationData = "+S.scrubMriOrOmit(i)),o=[],a=[],s=[],l=[0,4],e.forEach(function(e){var t=d._getOrCreateParticipant(e,n);0===d.slimcoreCallId?s.push(Promise.resolve(t)):-1!==l.indexOf(t.state)?(o.push(t),a.push(e),d._addParticipantToCall(t,n),s.push(d._participantOperationHandler.createPendingOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,t.id,n))):d._participantOperationHandler.hasPendingOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,t.id)?s.push(d._participantOperationHandler.waitForOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT,t.id)):s.push(Promise.resolve(t))}),0===o.length?[2,Promise.resolve(s)]:[2,Promise.resolve().then(function(){return d._slimcoreCallHandler.addParticipantsToCall(d.slimcoreCallId,a,T.mapToEmptyStrIfFalsy(t.threadId),T.mapToEmptyStrIfFalsy(t.messageId),T.mapToEmptyStrIfFalsy(i),void 0!==t.disableUnmute&&t.disableUnmute,n)}).then(function(e){if(!e||0===e.length)throw new Error("addParticipants: participantObjectIds null or empty");for(var t=0;t<e.length;t++)o[t].attachSlimcoreObjectId(e[t],n);return s}).catch(function(e){return r.logFailure(e),a.forEach(function(t){d._handleParticipantRemoved(t,n,e)}),Promise.reject(1)})]):[2,Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"))]})})},t.prototype.removeParticipant=function(e,t,n,r){return void 0===t&&(t=F.generateCauseId()),l(this,void 0,void 0,function(){var i,o,a,s,l,d=this;return c(this,function(c){return(i=this._logger.createFnLogger(h.PARTICIPANT_OPERATIONS.REMOVE_PARTICIPANT,t)).info("removeParticipant: participantId = "+S.scrubMriOrOmit(e)+", endpointScope ="+r),(o=this._getParticipant(e))&&(i.info("removeParticipant: current participant state: "+o.state),0===o.state||4===o.state)?(i.logFailure("Participant in invalid state, None or Disconnected"),[2,Promise.reject(new Error("Participant already in disconnected state"))]):(a=T.convertEndpointScope(r),r&&!a?(this._logger.error("Slimcore mapping for endpointScope failed: "+r+" => "+a),[2,Promise.reject(60)]):(s=p.defer(),l=Promise.resolve().then(function(){o?(d._assertSlimcoreObjectId(o.slimcoreObjectId,"removeParticipant"),d._slimcoreCallHandler.removeParticipant(o.slimcoreObjectId,a),o.addRemoveParticipantDeferred(s)):(d._assertSlimcoreObjectId(d.slimcoreCallId,"removeParticipantByMri"),d._slimcoreCallHandler.removeParticipantByMri(d.slimcoreCallId,e,n,a),s.resolve())}).then(function(){return T.hasFeature(M.Feature.AttendeeBlackList)||s.resolve(),s.promise}).then(function(){return i.logSuccess("removed")}).catch(function(n){return i.logFailure(n),d._handleParticipantOperationFailure(h.PARTICIPANT_OPERATIONS.REMOVE_PARTICIPANT,n,t,e,o),Promise.reject(n)}),this.raiseChanged(),[2,l]))})})},t.prototype._startTransferTargetCall=function(e,t,n){var r=this;return this._logger.info("Transfer: _startTransferTargetCall",e),this.attachSlimCoreCallObject(e,n,!1,"_startTransferTargetCall").then(function(){return r._slimcoreCallHandler.startTransferTargetCall(e,t,r.threadId,r.messageId)})},t.prototype._getSlimCoreCallProperties=function(e){if(this._logger.info("_getSlimCoreCallProperties"),!T.isSlimCoreRTModuleAvailable())return e;try{var t=new window.SlimCoreRT.SlimCore.CallProperties;return t.audioDirection=e.audioDirection,t.videoDirection=e.videoDirection,t.screenshareDirection=e.screenshareDirection,t.datachannelDirection=e.datachannelDirection,t.muteFlags=e.muteFlags,t.mediaPeerType=e.mediaPeerType,t.isVideoEnabled=e.isVideoEnabled,t.isGoLive=e.isGoLive,t.isHostless=e.isHostless,t.participantLegId=e.participantLegId,t.enableGroupCallMeetupGeneration=e.enableGroupCallMeetupGeneration,t.threadId=e.threadId,t.messageId=e.messageId,t.subject=e.subject,t.conversationType=e.conversationType,t.meetingInfo=e.meetingInfo,t.endpointMetadata=e.endpointMetadata,t.onBehalfOf=e.onBehalfOf,t.enableLightWeightMeeting=e.enableLightWeightMeeting,t.emergencyContent=e.emergencyContent,t.broadcastContext=e.broadcastContext,t.callKey=e.callKey,t.encryptedKey=e.encryptedKey,t.invitationType=e.invitationType,t.connectionType=e.connectionType,t.maxVideoChannels=e.maxVideoChannels,t.negotiationTag=e.negotiationTag,t.routingFlags=e.routingFlags,t.scenario=e.scenario,t.preheatFlags=e.preheatFlags,t.mediaConfigurationJson=e.mediaConfigurationJson,t.mediaStateConfigurationJson=e.mediaStateConfigurationJson,t.endpointBehaviors=e.endpointBehaviors,t.clientEndpointCapabilities=e.clientEndpointCapabilities,t.clientEndpointDebugContent=e.clientEndpointDebugContent,t.invitationDataJson=e.invitationDataJson,this._logger.info("_getSlimCoreCallProperties created RT CallProperties"),t}catch(e){this._logger.info("_getSlimCoreCallProperties failed, reverting back to property bag ",e)}return e},t.prototype._isEnterpriseMultiParty=function(e){return 5===e||10===e},t.prototype._joinOrStartSlimCoreCall=function(e,n){var r=this,i=this._logger.createFnLogger("joinOrStartSlimCoreCall",n),o=0,a=!e.ringOthers,s=JSON.stringify(e.endpointBehaviors);if(e.conversationUrl||e.isExistingCallInObservingState){i.info("options: "+k.getPrintableObject(e));u=this._getSlimCoreCallProperties({audioDirection:void 0!==e.audioDirection?t.toMediaDirection(e.audioDirection):M.MediaDirection.Bidirectional,videoDirection:void 0!==e.videoDirection?t.toMediaDirection(e.videoDirection):M.MediaDirection.ReceiveFromPeer,screenshareDirection:void 0!==e.screenshareDirection?t.toMediaDirection(e.screenshareDirection):this._isEnterpriseMultiParty(this._mediaPeerType)?M.MediaDirection.ReceiveFromPeer:M.MediaDirection.Disabled,datachannelDirection:void 0!==e.datachannelDirection?t.toMediaDirection(e.datachannelDirection):M.MediaDirection.Disabled,muteFlags:e.muteFlags,mediaPeerType:t.convertToSlimCoreMediaPeerType(this._mediaPeerType),isVideoEnabled:4===e.videoDirection,isGoLive:a,isHostless:!0,participantLegId:this.participantId,enableGroupCallMeetupGeneration:this._enableGroupCallMeetupGeneration,threadId:T.mapToEmptyStrIfFalsy(this.threadId),messageId:T.mapToEmptyStrIfFalsy(this.messageId),subject:T.mapToEmptyStrIfFalsy(e.label),conversationType:T.mapToEmptyStrIfFalsy(e.conversationType),meetingInfo:T.mapToEmptyStrIfFalsy(JSON.stringify(this._meetingInfo)),endpointMetadata:T.mapToEmptyStrIfFalsy(this._endpointMetadata),onBehalfOf:T.mapToEmptyStrIfFalsy(this.onBehalfOfMri),enableLightWeightMeeting:e.enableLightWeightMeeting,emergencyContent:T.mapToEmptyStrIfFalsy(this._emergencyContent),broadcastContext:this.broadcastMeeting&&this.broadcastMeeting.context?JSON.stringify(this.broadcastMeeting.context):null,callKey:e.callKey,encryptedKey:e.encryptedKey,invitationType:M.InvitationType.None,connectionType:t.convertConnectionType(e.connectionType),maxVideoChannels:void 0!==e.maxVideoChannels?e.maxVideoChannels:0,negotiationTag:T.mapToEmptyStrIfFalsy(e.negotiationTag),routingFlags:e.routingFlags,scenario:T.mapToEmptyStrIfFalsy(e.scenario),preheatFlags:e.preheatFlags,mediaConfigurationJson:T.mapToEmptyStrIfFalsy(JSON.stringify(e.mediaConfiguration)),mediaStateConfigurationJson:T.mapToEmptyStrIfFalsy(e.sendMediaModalities),endpointBehaviors:s,clientEndpointCapabilities:e.clientEndpointCapabilities||0,clientEndpointDebugContent:T.mapToEmptyStrIfFalsy(e.clientEndpointDebugContent),invitationDataJson:T.mapToEmptyStrIfFalsy(e.invitationDataJson)});o=this._slimcoreCallHandler.joinCall(JSON.stringify({conversationUrl:e.conversationUrl,conversationId:this.callId,conversationType:e.conversationType}),u),this._assertSlimcoreObjectId(o,"JoinCall"),i.logSuccess("slimcoreCallHandler.JoinCall()")}else if(e.callToVoicemail){if(i.info("Calling slimcoreCallHandler.PlaceCallToVoicemail"),1!==this.participants.length)throw new Error("PlaceCallToVoicemail Failed. Participant size should be one");this._addParticipantToCall(this.participants[0],n),o=this._slimcoreCallHandler.placeCallToVoicemail(this.callId,t.convertToSlimCoreMediaPeerType(this._mediaPeerType),this.participants[0].id,{threadId:this.threadId,voicemailResourcePath:e.voicemailResourcePath,voicemailItemId:e.voicemailItemId}),this._assertSlimcoreObjectId(o,"PlaceCallToVoicemail"),i.logSuccess("slimcoreCallHandler.PlaceCallToVoicemail()")}else if(void 0!==e.parkContext&&void 0!==e.pickupCode){var l=this.mapParkContext(e.parkContext);this._setCallType(1);u=this._getSlimCoreCallProperties({audioDirection:void 0!==e.audioDirection?t.toMediaDirection(e.audioDirection):M.MediaDirection.Bidirectional,videoDirection:void 0!==e.videoDirection?t.toMediaDirection(e.videoDirection):M.MediaDirection.ReceiveFromPeer,screenshareDirection:M.MediaDirection.Disabled,datachannelDirection:void 0!==e.datachannelDirection?t.toMediaDirection(e.datachannelDirection):M.MediaDirection.Disabled,muteFlags:e.muteFlags,mediaPeerType:t.convertToSlimCoreMediaPeerType(this._mediaPeerType),isVideoEnabled:4===e.videoDirection,isGoLive:a,isHostless:!0,participantLegId:this.participantId,enableGroupCallMeetupGeneration:this._enableGroupCallMeetupGeneration,threadId:T.mapToEmptyStrIfFalsy(this.threadId),messageId:T.mapToEmptyStrIfFalsy(this.messageId),subject:T.mapToEmptyStrIfFalsy(e.label),conversationType:T.mapToEmptyStrIfFalsy(e.conversationType),meetingInfo:T.mapToEmptyStrIfFalsy(JSON.stringify(this._meetingInfo)),endpointMetadata:T.mapToEmptyStrIfFalsy(this._endpointMetadata),onBehalfOf:T.mapToEmptyStrIfFalsy(this.onBehalfOfMri),enableLightWeightMeeting:e.enableLightWeightMeeting,emergencyContent:T.mapToEmptyStrIfFalsy(this._emergencyContent),broadcastContext:this.broadcastMeeting&&this.broadcastMeeting.context?JSON.stringify(this.broadcastMeeting.context):null,callKey:e.callKey,encryptedKey:e.encryptedKey,connectionType:t.convertConnectionType(e.connectionType),invitationType:e.invitationType,maxVideoChannels:void 0!==e.maxVideoChannels?e.maxVideoChannels:0,routingFlags:e.routingFlags,negotiationTag:T.mapToEmptyStrIfFalsy(e.negotiationTag),scenario:T.mapToEmptyStrIfFalsy(e.scenario),mediaConfigurationJson:T.mapToEmptyStrIfFalsy(JSON.stringify(e.mediaConfiguration)),mediaStateConfigurationJson:T.mapToEmptyStrIfFalsy(e.sendMediaModalities),endpointBehaviors:s,clientEndpointCapabilities:e.clientEndpointCapabilities||0,clientEndpointDebugContent:T.mapToEmptyStrIfFalsy(e.clientEndpointDebugContent),invitationDataJson:T.mapToEmptyStrIfFalsy(e.invitationDataJson)});o=this._slimcoreCallHandler.startCallUnpark(this.callId,u,l,e.pickupCode),this._assertSlimcoreObjectId(o,"StartCallUnpark"),i.logSuccess("slimcoreCallHandler.StartCallUnpark()")}else{i.info("Calling slimcoreCallHandler.PlaceCall");var c=[];e.invitationType===M.InvitationType.Nudge&&e.participantsToNudge?c=e.participantsToNudge:this.participants.forEach(function(e){r._addParticipantToCall(e,n),c.push(e.id)});var d=1!==c.length;this._setCallType(d?2:1);var u=this._getSlimCoreCallProperties({audioDirection:void 0!==e.audioDirection?t.toMediaDirection(e.audioDirection):M.MediaDirection.Bidirectional,videoDirection:void 0!==e.videoDirection?t.toMediaDirection(e.videoDirection):M.MediaDirection.ReceiveFromPeer,screenshareDirection:void 0!==e.screenshareDirection?t.toMediaDirection(e.screenshareDirection):2===this.callType&&this._isEnterpriseMultiParty(this._mediaPeerType)?M.MediaDirection.ReceiveFromPeer:M.MediaDirection.Disabled,datachannelDirection:void 0!==e.datachannelDirection?t.toMediaDirection(e.datachannelDirection):M.MediaDirection.Disabled,muteFlags:e.muteFlags,mediaPeerType:t.convertToSlimCoreMediaPeerType(this._mediaPeerType),isVideoEnabled:4===e.videoDirection,isGoLive:a,isHostless:!0,participantLegId:this.participantId,enableGroupCallMeetupGeneration:this._enableGroupCallMeetupGeneration,threadId:T.mapToEmptyStrIfFalsy(this.threadId),messageId:T.mapToEmptyStrIfFalsy(this.messageId),subject:T.mapToEmptyStrIfFalsy(e.label),conversationType:T.mapToEmptyStrIfFalsy(e.conversationType),meetingInfo:T.mapToEmptyStrIfFalsy(JSON.stringify(this._meetingInfo)),endpointMetadata:T.mapToEmptyStrIfFalsy(this._endpointMetadata),onBehalfOf:T.mapToEmptyStrIfFalsy(this.onBehalfOfMri),enableLightWeightMeeting:e.enableLightWeightMeeting,emergencyContent:T.mapToEmptyStrIfFalsy(this._emergencyContent),broadcastContext:this.broadcastMeeting&&this.broadcastMeeting.context?JSON.stringify(this.broadcastMeeting.context):null,callKey:e.callKey,encryptedKey:e.encryptedKey,connectionType:t.convertConnectionType(e.connectionType),invitationType:e.invitationType,maxVideoChannels:void 0!==e.maxVideoChannels?e.maxVideoChannels:0,routingFlags:e.routingFlags,negotiationTag:T.mapToEmptyStrIfFalsy(e.negotiationTag),scenario:T.mapToEmptyStrIfFalsy(e.scenario),preheatFlags:e.preheatFlags,mediaConfigurationJson:T.mapToEmptyStrIfFalsy(JSON.stringify(e.mediaConfiguration)),mediaStateConfigurationJson:T.mapToEmptyStrIfFalsy(e.sendMediaModalities),endpointBehaviors:s,clientEndpointCapabilities:e.clientEndpointCapabilities||0,clientEndpointDebugContent:T.mapToEmptyStrIfFalsy(e.clientEndpointDebugContent),invitationDataJson:T.mapToEmptyStrIfFalsy(e.invitationDataJson)});o=this._slimcoreCallHandler.placeCall(this.callId,c,u),this._assertSlimcoreObjectId(o,"PlaceCall"),i.logSuccess("slimcoreCallHandler.PlaceCall()")}this.attachSlimCoreCallObject(o,n,!1,"_joinOrStartSlimCoreCall"),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.CALL_START_OR_JOIN_INITIATED,void 0,void 0,n)},t.prototype._fillIncomingCallProperties=function(e){var t=this._getProperties(this._slimcoreCallHandler,this.slimcoreCallId,{conversationType:{propKey:M.Property.CallConversationType},callQueueInfo:{propKey:M.Property.CallQueueInfo},callerMri:{propKey:M.Property.CallerMriIdentity},transferorMri:{propKey:M.Property.CallTransferorMri},transferorDisplayName:{propKey:M.Property.CallTransferorDisplayName},transferorType:{propKey:M.Property.CallTransferorType},onBehalfOfMri:{propKey:M.Property.CallOnBehalfOfMri},incomingCallType:{propKey:M.Property.CallIncomingType},consultativeTransferCallId:{propKey:M.Property.CallConsultativeTransferCallId}},{isIncomingOneOnOneVideoCall:{propKey:M.Property.CallIsIncomingOneOnOneVideoCall}});this._setCallerMri(f.stripMriAliases(t.callerMri),e),this._updateConversationType(t.conversationType,e),this.transferorMri=f.stripMriAliases(t.transferorMri),this.transferorDisplayName=t.transferorDisplayName,this.transferorType=t.transferorType,this.onBehalfOfMri=f.stripMriAliases(t.onBehalfOfMri),this.callQueueInfo=t.callQueueInfo&&JSON.parse(t.callQueueInfo),this.incomingCallType=t.incomingCallType,this._setConsultativeCallId(this.consultativeCallId),this.isIncomingOneOnOneVideoCall=!!t.isIncomingOneOnOneVideoCall},t.prototype._onCallPropertyChanged=function(e,t){this._onObjectPropertyChanged(this.slimcoreCallId,e,t)},t.prototype.attachSlimCoreCallObject=function(e,t,n,r){var i=this;void 0===n&&(n=!1),void 0===r&&(r="attachSlimCoreCallObject");var o=this._logger.createFnLogger("attachSlimCoreCallObject",t),a=this._callOperationHandler.getPendingOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY),s=this.slimcoreCallId;if(this.slimcoreCallId===e)return this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.ELECTRON_ATTACH_SLIMCORE_CALL_FAILED,{slimCoreCallObjectId:e,reason:"Call already attached to a SlimCore object"},t),o.logFailure("Call already attached to a SlimCore object"),a;0!==this.slimcoreCallId&&o.info("Call already attached to a different SlimCore object, attaching to new object"),o.info("new slimCoreCallObjectId="+e),this.slimcoreCallId=e;try{this._isOptimizedSpeakerEventingEnabled=this._slimcoreInstance.ecsGetSettingAsBool("SkypeCalling","enableOptimizedSpeakerChangeEvents",!1),this._isSetVideoChannelsRenegotiated=this._slimcoreInstance.ecsGetSettingAsBool("SkypeCalling","renegotiateVideoChannels",!1)}catch(e){o.logFailure("Assuming optimized speaker event feature is disabled via ECS. Error: "+e)}this._slimCoreElectronRemoteManager=new D.default(this._logger,this._settings,this._slimcoreInstance,this._slimcoreCallHandler,this.slimcoreCallId,this.mediaStreams,this._streamContextMap,n),this._slimCoreElectronRemoteManager.changed(function(){return i.raiseChanged()}),this._onCallPropertyChanged(M.Property.CallOrigin,function(e){return i._onCallOriginChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallStatus,function(e){return i._onCallStatusChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallTransferStatus,function(e){return i._onCallTransferStatusChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallParkStatus,function(e){return i._onCallParkStatusChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallIsMuted,function(e){return i._onCallMutedUnmuted(!!e.value)}),this._onCallPropertyChanged(M.Property.CallIsMutedSpeaker,function(e){return i._onCallMutedUnmutedSpeaker(!!e.value)}),this._onCallPropertyChanged(M.Property.CallIsServerMuted,function(e){return i._onCallIsServerMuted(!!e.value)}),this._onCallPropertyChanged(M.Property.CallActiveMembers,function(e){return i._onParticipantJoinedOrRemovedDeferred()}),this._onCallPropertyChanged(M.Property.CallThreadId,function(e){return i._onThreadIdChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallMessageId,function(e){return i._onMessageIdChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallEndpointDetails,function(e){return i._updateEndpointDetails(e.value)}),this._onCallPropertyChanged(M.Property.SelfParticipantRole,function(e){return i._onSelfParticipantRoleChanged(e.value)}),this._onCallPropertyChanged(M.Property.SelfParticipantTenantId,function(e){return i._onSelfParticipantTenantIdChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallMeetingDetails,function(e){return i._updateMeetingDetails(e.value)}),this._onCallPropertyChanged(M.Property.CallMemberCountChanged,function(e){return i._onParticipantJoinedOrRemovedDeferred()}),this._onCallPropertyChanged(M.Property.CallIsConference,function(e){return i._updateCallType(e.value,t)}),this._onCallPropertyChanged(M.Property.CallIsHostless,function(e){return i._updateIsHostless(e.value)}),this._onCallPropertyChanged(M.Property.CallForwardingDestinationType,function(e){return i._updateForwardingDestinationType(e.value)}),this._onCallPropertyChanged(M.Property.CallOptimalRemoteVideoCount,function(e){return i._onCallOptimalVideoCountChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallName,function(e){return i._onCallIdChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallDataChannelObjectId,function(e){return i._updateDataChannel(e.value)}),this._onCallPropertyChanged(M.Property.CallBroadcastMetadata,function(e){return i._onBroadcastMetadataChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallProgressStatus,function(e){return i._onCallProgressStatusChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallEndDiagnosticsCode,function(e){return i._onDiagnosticsCodeChanged(e.value)}),this._onCallPropertyChanged(M.Property.TransferDiagnosticsCode,function(e){return i._onTransferDiagnosticsCodeChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallInvitationData,function(e){return i._updateCallInvitationData(e.value)}),this._onCallPropertyChanged(M.Property.SelfMeetingRole,function(e){return i._updateMeetingRole(e.value)}),this._onCallPropertyChanged(M.Property.CallTransferorMri,function(e){return i._updateTransferorMri(e.value)}),this._onCallPropertyChanged(M.Property.CallCapabilities,function(e){return i._onCallCapabilitiesChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallActiveVideoChannelCount,function(e){return i._updateActiveVideoChannelCount(e.value)}),this._onCallPropertyChanged(M.Property.CallPublishedStates,function(e){return i._onPublishedStatesChanged(e.value)}),this._onCallPropertyChanged(M.Property.CallConversationType,function(e){return i._updateConversationType(e.value,t)}),this._registerDisposable(this._slimcoreInstance.handle("object-property-changed",{propKey:M.Property.ContentSharingStatus},function(e){return i._onContentSharingChanged()})),this._registerDisposable(this._slimcoreCallHandler.handle("audio-stream-state-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onAudioStreamStateChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("transfer-requested",{callObjectId:this.slimcoreCallId},function(e){return i._onTransferRequested(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("callmeback-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onCallMeBackOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("unmuteself-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onUnmuteOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("media-negotiation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onMediaNegotiationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("nudge-participants-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onNudgeParticipantOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("update-meeting-roles-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onUpdateMeetingRoleOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("mute-participants-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onMuteParticipantOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("active-speaker-list-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onActiveSpeakerListChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("dominant-speaker-list-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onDominantSpeakerListChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("remote-user-events-received",{callObjectId:this.slimcoreCallId},function(e){return i._onRemoteUserEventsReceived(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("publish-state-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onPublishStateOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreCallHandler.handle("remove-state-operation-status-changed",{callObjectId:this.slimcoreCallId},function(e){return i._onRemoveStateOperationStatusChanged(e)})),this._registerDisposable(this._slimcoreInstance.handle("quality-changed",void 0,function(e){return i._onQualityChanged(e)}));var l=this._getProperties(this._slimcoreCallHandler,this.slimcoreCallId,{callId:{propKey:M.Property.CallName},threadId:{propKey:M.Property.CallThreadId},messageId:{propKey:M.Property.CallMessageId},meetingDetails:{propKey:M.Property.CallMeetingDetails},tenantId:{propKey:M.Property.SelfParticipantTenantId},role:{propKey:M.Property.SelfParticipantRole},broadcastMetadata:{propKey:M.Property.CallBroadcastMetadata},invitationData:{propKey:M.Property.CallInvitationData},meetingRole:{propKey:M.Property.SelfMeetingRole},publishedStates:{propKey:M.Property.CallPublishedStates}},{status:{propKey:M.Property.CallStatus},isConference:{propKey:M.Property.CallIsConference},isServerMuted:{propKey:M.Property.CallIsServerMuted},capabilityFlags:{propKey:M.Property.CallCapabilities},activeVideoChannelCount:{propKey:M.Property.CallActiveVideoChannelCount}});return this._updateCallType(l.isConference,t),this._onCallIdChanged(l.callId),this._onThreadIdChanged(l.threadId),this._onMessageIdChanged(l.messageId),this._onCallStatusChanged(l.status,t),this._updateMeetingDetails(l.meetingDetails),this._onSelfParticipantTenantIdChanged(l.tenantId),this._onSelfParticipantRoleChanged(l.role),this._onCallIsServerMuted(!!l.isServerMuted),this._onBroadcastMetadataChanged(l.broadcastMetadata),this._updateCallInvitationData(l.invitationData),this._updateMeetingRole(l.meetingRole),this._onPublishedStatesChanged(l.publishedStates),this._onCallCapabilitiesChanged(l.capabilityFlags),this._updateActiveVideoChannelCount(l.activeVideoChannelCount),this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.ELECTRON_ATTACH_SLIMCORE_CALL,{slimCoreCallObjectId:e,oldSlimcoreCallId:s,callId:l.callId,threadId:l.threadId,messageId:l.messageId,role:l.role},t),this._onParticipantJoinedOrRemoved(t),this._callOperationHandler.resolveOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY,void 0,void 0,void 0,!0),this._assertSlimcoreObjectId(this.slimcoreCallId,r),a},t.prototype.getStrProperty=function(e,t){return this._getStrProperty(this._slimcoreCallHandler,this.slimcoreCallId,e,T.mapToEmptyStrIfFalsy(t))},t.prototype.getIntProperty=function(e,t,n){return this._getIntProperty(this._slimcoreCallHandler,n||this.slimcoreCallId,e,t)},t.prototype._updateCallInvitationData=function(e){try{e&&(this.invitationData=JSON.parse(e),this._logger.info("_updateCallInvitationData updated: "+(this.invitationData.length>0)),this.raiseChanged())}catch(t){this._logger.info("Failed to parse invitation data. Error: "+t+", diagnosticsCode: "+e)}},t.prototype._updateCallType=function(e,t){var n=this._logger.createFnLogger("updateCallType",t,"current="+this.callType),r=0===e?1:1===e?2:-1;2!==this.callType||1!==r?(n.info("newValue: "+r),r!==this.callType&&(2===r&&this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.CALL_ESCALATED_TO_CONFERENCE,void 0,t),this._setCallType(r),this._updateCapabilities(t),this.raiseChanged())):n.logFailure("De-escalating to P2P not allowed!")},t.prototype._updateConversationType=function(e,t){this._logger.createFnLogger("updateConversationType",t,"current="+this.conversationType).info("newValue: "+e),e!==this.conversationType&&(this.conversationType=e,this._callTelemetry.setConversationType(this.conversationType),this.raiseChanged())},t.prototype._updateForwardingDestinationType=function(e){e!==this.forwardingDestinationType&&(this.forwardingDestinationType=e,this.raiseChanged())},t.prototype._setupCallTelemetry=function(){this._callTelemetry=new g.default(this._logger,this._callStartTime);try{this._callTelemetry.setStackConfig({ConversationServiceUrl:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/ConversationServiceUrl"),UdpTransportUrl:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/UdpTransportUrl"),KeyDistributionUrl:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/KeyDistributionUrl"),PotentialCallRequestUrl:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/PotentialCallRequestUrl"),UploadLogUrl:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/UploadLogUrl"),UdpEnabled:this._slimcoreInstance.setupGetStr("*Lib/Call/NG/UdpEnabled"),SlimCoreVersion:SlimCore.getVersion()})}catch(e){this._logger.info("Failed to log stack config")}},t.prototype._updateDataChannel=function(e){if(this._logger.info("_updateDataChannel()"),e){this._dataChannel&&this._dataChannel.dispose();var t=void 0;try{t=this._slimcoreInstance.getDataChannel(e)}catch(e){return this._logger.error("failed to get data channel: "+e),void this._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_DATA_CHANNEL_CREATED)}this._dataChannel=new d.default(this._logger,this._settings,this._slimcoreInstance,this,this._slimcoreCallHandler,t,this._dataChannelUsers,e),this._dataChannel.setAdapterSourceSinkCallback(this.dataChannelAdapter.setInternalSourceSink),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_DATA_CHANNEL_CREATED),this._logger.info("Data channel set")}},t.prototype.mapDataChannelSourceIdToParticipant=function(e){var t=null;return(t=1===this.callType?this.participants[0]:u.find(this.participants,function(t){return t.hasSourceId(4,e)}))&&t.id?this._logger.info("ParticipantId: "+S.scrubMriOrOmit(t.id)+" to SourceId: "+e):this._logger.warn("No Participant found for SourceId: "+e),t},t.prototype._onAudioStreamStateChanged=function(e){this.event("mediaStreamStateChanged").raise(),e.direction===SlimCore.Enums.MediaDirection.ReceiveFromPeer&&(this.isAudioStreamConnected=e.streamState===SlimCore.Enums.MediaStreamState.StreamInactive||e.streamState===SlimCore.Enums.MediaStreamState.StreamActive),e.streamState===SlimCore.Enums.MediaStreamState.StreamFail&&this.event("mediaConnectionFailed").raise()},t.prototype._onTransferRequested=function(e){var t=this;this._logger.info("Transfer: _onTransferRequested",e);var n,r=this.getIntProperty(M.Property.CallOrigin,M.OriginType.Unspecified,e.targetCallObjectId);r===M.OriginType.Park?n=1:r===M.OriginType.Transfer?n=0:r===M.OriginType.TransferToVoicemail?n=2:this._logger.info("Unkown transfer type based on new call origin"),this._logger.info("onTransferRequested newCallOrigin="+r+" transferType="+n);var i={transferorMri:e.transferorMri,targetMri:e.transferTargetMri,transferType:n,context:{newCallObjectId:e.targetCallObjectId}};this.event("transferRequested").raise({transferContext:i,onCompleted:function(e){t._logger.debug("Transfer: transferCompleted called: "+e),1!==e&&t._slimcoreCallHandler.leaveCall(i.context.newCallObjectId)}})},t.prototype._operationStatusChanged=function(e,t,n){this._logger.info("["+e+"][OperationStatusChanged]: "+n);var r=n.causeId||F.generateCauseId();if(e.hasPendingOperation(t)){var i={reason:R.convertFailureReasonToParticipantReason(n.failureReason)};i.code=n.code,i.subCode=n.subCode,i.phrase=n.phrase,this._callTelemetry.updateOperationData(t,i,r)}},t.prototype._onCallMeBackOperationStatusChanged=function(e){this._operationStatusChanged(this._participantOperationHandler,h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,e);var t=R.convertFailureReasonToParticipantReason(e.failureReason),n={code:e.code,subCode:e.subCode,phrase:e.phrase};n.failureReason=t,e.failureReason===M.ParticipantFailureReason.NoFailure||this._participantOperationHandler.rejectOperation(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,n,e.participantMri,e.causeId)},t.prototype._onUnmuteOperationStatusChanged=function(e){this._operationStatusChanged(this._callOperationHandler,h.CALL_OPERATIONS.UNMUTE,e);var n=F.generateCauseId(),r=t.convertParticipantReasonToTerminatedReason(R.convertFailureReasonToParticipantReason(e.failureReason));e.operationResult===M.OperationResultCode.Success?this._callOperationHandler.resolveOperation(h.CALL_OPERATIONS.UNMUTE,r,void 0,n):this._callOperationHandler.rejectOperation(h.CALL_OPERATIONS.UNMUTE,r,void 0,n)},t.prototype._onNudgeParticipantOperationStatusChanged=function(e){this._operationStatusChanged(this._participantOperationHandler,h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,e);var t=F.generateCauseId(),n=R.convertFailureReasonToParticipantReason(e.failureReason);e.failureReason===M.ParticipantFailureReason.NoFailure?this._participantOperationHandler.resolveOperation(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,n,e.context,t):this._participantOperationHandler.rejectOperation(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS,n,e.context,t)},t.prototype._onUpdateMeetingRoleOperationStatusChanged=function(e){this._operationStatusChanged(this._participantOperationHandler,h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,e);var t={code:e.code,subCode:e.subCode,phrase:e.phrase};0===t.code&&0===t.subCode?this._participantOperationHandler.resolveOperation(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,t,e.causeId,e.causeId):this._participantOperationHandler.rejectOperation(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE,t,e.causeId,e.causeId)},t.prototype._onMuteParticipantOperationStatusChanged=function(e){this._operationStatusChanged(this._callOperationHandler,h.CALL_OPERATIONS.MUTE_PARTICIPANTS,e);var t={code:e.code,subCode:e.subCode,phrase:e.phrase};0===t.code&&0===t.subCode?this._callOperationHandler.resolveOperation(h.CALL_OPERATIONS.MUTE_PARTICIPANTS,t,e.causeId,e.causeId):this._callOperationHandler.rejectOperation(h.CALL_OPERATIONS.MUTE_PARTICIPANTS,t,e.causeId,e.causeId)},t.prototype._onActiveSpeakerListChanged=function(e){for(var t={},n=0,r=e.activeSpeakers?Array.from(e.activeSpeakers):[];n<r.length;n++)t[r[n]]=1;for(var i=0,o=this.participants;i<o.length;i++){var a=o[i];a.setVoiceLevel(t[a.id]||0)}this._logger.debug("_onActiveSpeakerListChanged: number of active speakers "+Object.keys(t).length)},t.prototype._onDiagnosticsCodeChanged=function(e){if(this._rawCallEndDiagnosticsInfo!==e&&e&&!u.isEmpty(e)){this._logger.info("_onDiagnosticsCodeChanged diagnosticsCode: "+e);try{this._rawCallEndDiagnosticsInfo=e,this.callEndDiagnosticsInfo=JSON.parse(e);try{this.callEndDiagnosticsInfo.additionalDiagnostics&&(this.callEndDiagnosticsInfo.additionalDiagnostics=JSON.parse(this.callEndDiagnosticsInfo.additionalDiagnostics))}catch(e){this._logger.warn("_onDiagnosticsCodeChanged failed to parse, may be OK. Error: "+e+", additionalDiagnostics: "+this.callEndDiagnosticsInfo.additionalDiagnostics+".")}this.raiseChanged()}catch(t){this._logger.info("Failed to parse raw diagnostis details. Error: "+t+", diagnosticsCode: "+e)}}},t.prototype._onTransferDiagnosticsCodeChanged=function(e){if(this._rawTransferDiagnosticsInfo!==e&&e&&!u.isEmpty(e)){this._logger.info("_onTransferDiagnosticsCodeChanged: "+e);try{this._rawTransferDiagnosticsInfo=e,this.transferDiagnosticsInfo=JSON.parse(e),this.raiseChanged()}catch(t){this._logger.info("Failed to parse raw diagnostis details. Error: "+t+", diagnosticsCode: "+e)}}},t.prototype._onDominantSpeakerListChanged=function(e){this.dominantSpeakerInfo.speakerList=e.dominantSpeakers?Array.from(e.dominantSpeakers):[],this._logger.info("_onDominantSpeakerListChanged: number of dominant speakers "+this.dominantSpeakerInfo.speakerList.length),this.raiseChanged()},t.prototype._onRemoteUserEventsReceived=function(e){this.event("remoteUserEventsReceived").raise(e.participantId,e.events)},t.prototype._updateCallLegIdChanged=function(e){this.participantId!==e&&(this._logger.info("updateCallLegIdChanged: new value is "+e),this._setParticipantId(e),this.event("callLegIdChanged").raise(e),this.raiseChanged())},t.prototype._completeTransaction=function(e,t,n,r,i){void 0===i&&(i=!1),this._logger.info("_completeTransaction["+n+"]["+r+"]: operationName "+e+" transactionEnd "+JSON.stringify(t,null,4)),this._callTelemetry.updateOperationData(e,t,n,r),0===t.code&&0===t.subCode||i&&t.code>=200&&t.code<300?this._callOperationHandler.maybeResolveOperation(e,t,r,n):this._callOperationHandler.maybeRejectOperation(e,t,r,n)},t.prototype._onOperationStatusChanged=function(e){this._logger.info("_onOperationStatusChanged: eventData "+JSON.stringify(e,null,4));var t;try{t=JSON.parse(e.result)}catch(e){return void this._logger.info("_onOperationStatusChanged: exception when parsing result "+e)}if(this._logger.info("_onOperationStatusChanged: parsed response "+JSON.stringify(t,null,4)),t)for(var n in t)if(n&&t.hasOwnProperty(n))for(var r in t[n]){t[n].hasOwnProperty(r)||this._logger.info("_onOperationStatusChanged: not a valid object "+t);var i=t[n][r];this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE,r)?this._completeTransaction(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE,i,n,r):this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE)?this._completeTransaction(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE,i,n,r):this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,n)?this._completeTransaction(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,i,n,n,!0):this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.MERGE_PARTICIPANT,r)&&this._completeTransaction(h.CALL_OPERATIONS.MERGE_PARTICIPANT,i,n,r)}else this._logger.info("_onOperationStatusChanged: causeId empty or invalid "+t)},t.prototype._onPublishStateOperationStatusChanged=function(e){this._logger.info("_onPublishStateOperationStatusChanged: eventData "+JSON.stringify(e,null,4));var t={};t.code=e.code,t.subCode=e.subCode,t.phrase=e.phrase,t.result=e.result,t.code>=200&&t.code<300&&0===t.subCode?this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.PUBLISH_STATE,e.stateId?e.stateId:e.result,e.causeId,e.causeId):this._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS.PUBLISH_STATE,t,e.causeId,e.causeId)},t.prototype._onRemoveStateOperationStatusChanged=function(e){this._logger.info("_onRemoveStateOperationStatusChanged: eventData "+JSON.stringify(e,null,4));var t={};t.code=e.code,t.subCode=e.subCode,t.phrase=e.phrase,t.result=e.result,e.operationSuccess?this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.REMOVE_STATE,e.result,e.causeId,e.causeId):this._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS.REMOVE_STATE,t,e.causeId,e.causeId)},t.prototype._updateIsHostless=function(e){var t=1===e;this.isHostless!==t&&(this._logger.info("_updateIsHostless: new value is "+t),this.isHostless=t,this.raiseChanged())},t.prototype._onCallOptimalVideoCountChanged=function(e){this._logger.info("_onCallOptimalVideoCountChanged "+e),e!==this.optimalVideoCount&&(this.optimalVideoCount=e,this.raiseChanged())},t.prototype._onCallIdChanged=function(e){this._logger.info("_onCallIdChanged "+e),e!==this.callId&&(this._setCallId(e),this.event("callIdChanged").raise(this.callId),this.raiseChanged())},t.prototype._onPublishedStatesChanged=function(e){if(this._logger.info("_onPublishedStatesChanged"),e&&this._rawPublishedStatesJsonString!==e)try{this._publishedStates=JSON.parse(e),this._rawPublishedStatesJsonString=e,this.event("publishedStatesChanged").raise(this._publishedStates),this.raiseChanged()}catch(t){this._logger.info("["+m.causeId+"]Failed to parse published states. Error: "+t+", PublishedStates: "+e)}},t.prototype._setCallId=function(e){this.callId=e,this._callTelemetry.setCallId(this.callId)},t.prototype._setParticipantId=function(e){this.participantId=e,this._callTelemetry.setParticipantId(this.participantId)},t.prototype._setConsultativeCallId=function(e){this.consultativeCallId=e,this._callTelemetry.setConsultativeCallId(this.consultativeCallId)},t.prototype._onCallTransferStatusChanged=function(e){var t=F.generateCauseId();this._logger.info("["+t+"]onCallTransferStatusChanged status: "+e+" ("+M.CallStatus[e]+")"),this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS)&&(e===M.CallStatus.Transferring?this._setTransferState(2,t):e===M.CallStatus.Transferred?this._setTransferState(3,t):e===M.CallStatus.Failed&&this._setTransferState(4,t))},t.prototype._onCallParkStatusChanged=function(e){var t=F.generateCauseId();this._logger.info("["+t+"]_onCallParkStatusChanged status: "+e+" ("+M.CallStatus[e]+")"),this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS_INTERNAL.CALL_TRANSFER_IN_PROGRESS)&&(e===M.CallStatus.Parking?this._setParkState(2,t):e===M.CallStatus.Parked?this._setParkState(3,t):e===M.CallStatus.Failed&&this._setParkState(4,t))},t.prototype._onCallStatusChanged=function(e,n){var r=this;void 0===n&&(n=F.generateCauseId());var i=this._logger.createFnLogger("onCallStatusChanged",n);if(i.info("new status="+e+", mapped to=("+M.CallStatus[e]+")"),this._updateCallLegIdChanged(this.getStrProperty(M.Property.CallLegId)),this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SIGNALING_STATE_CHANGED,{status:e,statusToEnum:M.CallStatus[e]},n),t.isCallConnecting(e))this._setCallState(2,n);else if(t.isCallPreheating(e))i.info("status=Preheating"),this._setCallState(11,n);else if(t.isCallEarlyMedia(e))i.info("status=EarlyMedia"),this._setCallState(9,n);else if(t.isCallRinging(e))i.info("status=Ringing"),this.participants.forEach(function(e){return e.setState(2,n)}),this._updateCallType(this.getIntProperty(M.Property.CallIsConference),n);else if(t.isCallInLobby(e))this._callIsSetupComplete=!0,i.info("status=InLobby"),this._setCallState(10,n),this.participants.forEach(function(e){return e.setState(7,n)}),this._updateCallType(this.getIntProperty(M.Property.CallIsConference),n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.HOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNHOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL,void 0,void 0,n),this._reportTsCallingTelemetry(!0);else if(t.isCallPreheated(e))i.info("status=Preheated"),this._setCallState(12,n),this._updateIsHostless(this.getIntProperty(M.Property.CallIsHostless)),this._updateCallType(this.getIntProperty(M.Property.CallIsConference),n),this._updateEndpointDetails(this.getStrProperty(M.Property.CallEndpointDetails)),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,void 0,void 0,n);else if(t.isCallConnected(e))this._callIsSetupComplete=!0,i.info("status=Connected"),this._setCallState(3,n),this._updateIsHostless(this.getIntProperty(M.Property.CallIsHostless)),this._updateCallType(this.getIntProperty(M.Property.CallIsConference),n),this._updateEndpointDetails(this.getStrProperty(M.Property.CallEndpointDetails)),this._onCallMutedUnmuted(!!this.getIntProperty(M.Property.CallIsMuted)),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.HOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNHOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL,void 0,void 0,n),this._reportTsCallingTelemetry(!0);else if(t.isObserving(e))this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.SUBSCRIBE,void 0,void 0,n);else if(e===M.CallStatus.LocalHold)i.info("status=LocalHold"),this._setCallState(4,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.HOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNHOLD,void 0,void 0,n);else if(e===M.CallStatus.RemoteHold)i.info("status=RemoteHold"),this._setCallState(5,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.HOLD,void 0,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS.UNHOLD,void 0,void 0,n);else if(t.isCallTerminated(e)){var o=t.convertStatusToTerminatedReason(e),a=o;i.info("status=Terminated, reason="+o);var s=this.getIntProperty(M.Property.CallFailureReason),l=this.getStrProperty(M.Property.CallEndDiagnosticsCode),c=this.getIntProperty(M.Property.CallIsConference),d=this._getFirstParticipantFailureReason(i);if(e!==M.CallStatus.Failed&&e!==M.CallStatus.Dropped&&s!==M.ParticipantFailureReason.CallNotFound||(a=this._getTerminatedReason(s,o)),8===this.state&&(this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.START_CALL)||this._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.JOIN_CALL)))return this.slimcoreCallId=0,this._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS.SUBSCRIBE,a,void 0,n),void i.info("Subscribe failed, there is pending start/join operation, ignore call end message");this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.CALL_TERMINATION_INFO,{terminatedReasonFromStatus:o,slimcoreCallFailureReason:s,firstParticipantFailureReason:d,finalReason:a,slimcoreCallType:c},n),i.info("status=Terminated, statusToReason="+o+", slimcoreCallFailureReason="+s+", finalReason="+a);var u=this._getProperties(this._slimcoreCallHandler,this.slimcoreCallId,{acceptedElsewherebyId:{propKey:M.Property.CallAcceptedElsewhereByMriIdentity},acceptedElsewherebyDisplayName:{propKey:M.Property.CallAcceptedElsewhereByDisplayName}},{});this.acceptedElsewhereBy={id:u.acceptedElsewherebyId,displayName:u.acceptedElsewherebyDisplayName},this._setCallState(7,n,a,l),this.participants.forEach(function(e){return e.setState(4,n)}),this._updateDominantSpeakerList(),this._callOperationHandler.maybeRejectOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,a,void 0,n),this._callOperationHandler.maybeResolveOperation(h.CALL_OPERATIONS_INTERNAL.CALL_ENDED,a,void 0,n),this.disconnectingPromise=this.cleanUp(n).catch(function(e){i.logFailure("Error when cleaning up the call, callId = "+r.callId+", error = "+e)})}this.raiseChanged()},t.prototype._reportTsCallingTelemetry=function(e){return l(this,void 0,void 0,function(){var t;return c(this,function(n){switch(n.label){case 0:return e&&this.setupTelemetryReported?[2]:!e&&this.inCallTelemetryReported?[2]:[4,this.connectCallPromise.catch(j.noop)];case 1:return n.sent(),t=e?"skypecosi_concore_native_ts_calling_call_setup_session":"skypecosi_concore_native_ts_calling_in_call_session",this._callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo),this._telemetryLoggers&&this._telemetryLoggers.signaling&&this._telemetryLoggers.signaling.sendEvent({eventName:t,props:this._callTelemetry.getEvent(e)}),e?(this.setupTelemetryReported=!0,this._callTelemetry.switchToInCallTelemetry()):this.inCallTelemetryReported=!0,[2]}})})},t.prototype._getTerminatedReason=function(e,n){if(this._isRelayWhiteListingIssue)return 53;if(!u.isUndefined(e)&&e!==M.ParticipantFailureReason.NoFailure)return t.convertParticipantReasonToTerminatedReason(R.convertFailureReasonToParticipantReason(e));if(this.participants.length){var r=u.head(this.participants).getIntProperty(M.Property.ParticipantFailureReason);return t.convertParticipantReasonToTerminatedReason(R.convertFailureReasonToParticipantReason(r))}return n||0},t.prototype._addParticipantToCall=function(e,t){e.setState(1,t),this._logger.info("["+t+"]starting adding participant to call, participantId = "+S.scrubMriOrOmit(e.id))},t.prototype._joinOrStartCall=function(e,t){return l(this,void 0,void 0,function(){var n,r;return c(this,function(i){switch(i.label){case 0:if(n=this._logger.createFnLogger("joinOrStartCall",t),0!==this.state&&8!==this.state)throw new Error("Trying to start a call that has already been acted on");this._setIsCast("cast"===e.conversationType),this.label=e.label,this.raiseChanged(),1==(1&e.muteFlags)&&(n.info("isMuted set to true in _joinOrStartCall"),this.isMuted=!0),2==(2&e.muteFlags)&&(n.info("isSpeakerMuted set to true in _joinOrStartCall"),this.isSpeakerMuted=!0),e.isExistingCallInObservingState=8===this.state,1==(1&e.preheatFlags)?(n.info("Call set to preheating in _joinOrStartCall"),this._setCallState(11,t)):(n.info("Call set to connecting in _joinOrStartCall"),this._setCallState(2,t)),r=this._callOperationHandler.createPendingOperation(h.CALL_OPERATIONS_INTERNAL.CONNECT_CALL,void 0,t);try{this._joinOrStartSlimCoreCall(e,t)}catch(e){throw n.logFailure("sync failure, cleaning up slimcore ready operation: error="+k.getPrintableObject(e)),this._callTelemetry.updateOperationData(h.CALL_OPERATIONS_INTERNAL.INCOMING_INITIALIZE,{error:k.getPIISafeObject(e)},t),this._callOperationHandler.rejectOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY),this.stopInternal({causeId:t}),e}return 4!==e.videoDirection?[3,2]:(n.info("Call has been started; turning on video"),[4,this.startVideoSafe(t)]);case 1:i.sent(),i.label=2;case 2:return[2,r]}})})},t.prototype._muteUnmute=function(e,t){var n=this,r=this._logger.createFnLogger("muteUnmute",t);if(r.info("muteUnmute, value = "+e+" isMuted = "+this.isMuted+" isServerMuted = "+this.isServerMuted),I.callStateIsAnyOf(this.state,[11,12]))return r.logFailure("Can not mute/unmute during preheat call"),Promise.reject(_.getRejectTransactionEnd(h.TRANSACTION_END_PHRASE.TRANSACTION_DISALLOWED));var i;return i=e?this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.MUTE):this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.UNMUTE),Promise.resolve().then(function(){return n._slimcoreCallHandler.callMute(n.slimcoreCallId,e)}).then(function(){return i}).catch(function(e){throw r.logFailure(e),_.getRejectTransactionEnd(e)})},t.prototype._muteUnmuteSpeaker=function(e,t){var n=this,r=this._logger.createFnLogger("muteUnmuteSpeaker",t);r.info("muteUnmuteSpeaker, value = "+e+" isSpeakerMuted = "+this.isSpeakerMuted);var i;return i=e?this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.MUTE_SPEAKER):this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.UNMUTE_SPEAKER),Promise.resolve().then(function(){return n._slimcoreCallHandler.callMuteSpeaker(n.slimcoreCallId,e)}).then(function(){return i}).then(function(){return n._setMutedSpeaker(e,t)}).catch(function(e){throw r.logFailure(e),e})},t.prototype._muteParticipants=function(e,n,r){var i=this,o=t.convertMuteScope(e),a=this._logger.createFnLogger("muteParticipants",r);if(void 0===o)return a.logFailure("Unrecognized "+e),Promise.reject(new Error("Unrecognized muteScope"));if(I.callStateIsAnyOf(this.state,[11,12]))return a.logFailure("Can not mute/unmute during preheat call"),Promise.reject(60);var s=[];n.forEach(function(e){s.push(e.id)});var l=this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.MUTE_PARTICIPANTS,"",r);return Promise.resolve().then(function(){return i._slimcoreCallHandler.callMuteParticipants(i.slimcoreCallId,o,s,r),T.hasFeature(M.Feature.AttendeeBlackList)?l:i._callOperationHandler.resolveOperation(h.CALL_OPERATIONS.MUTE_PARTICIPANTS,null,r,r).then()}).catch(function(e){throw a.logFailure("mute participants failed with "+e),e})},t.prototype._holdUnhold=function(e,t,n){return l(this,void 0,void 0,function(){var r,i,o;return c(this,function(a){switch(a.label){case 0:if(r=4===this.state,(i=this._logger.createFnLogger("holdUnhold",t)).info("_holdUnhold, value: "+e+" currentState: "+r),r===e)return[2,Promise.resolve()];a.label=1;case 1:return a.trys.push([1,6,,7]),this._slimcoreCallHandler.callHold(this.slimcoreCallId,e,n),e?[4,this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.HOLD)]:[3,3];case 2:return a.sent(),[3,5];case 3:return[4,this._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.UNHOLD)];case 4:a.sent(),a.label=5;case 5:return[3,7];case 6:throw o=a.sent(),i.logFailure(o),o;case 7:return[2]}})})},t.prototype._updateEndpointMetadata=function(e,t){var n=this,r=this._logger.createFnLogger("updateEndpointMetadata",t);return Promise.resolve().then(function(){return n._slimcoreCallHandler.callUpdateEndpointMetadata(n.slimcoreCallId,n._endpointMetadata)}).catch(function(e){throw r.logFailure(e),e})},t.prototype._sendDtmfTone=function(e,n){var r=this,i=this._logger.createFnLogger("sendDtmfTone",n);return Promise.resolve().then(function(){var n=t.convertToSlimCoreDtmfTone(e);if(void 0===n)throw i.logFailure("Unrecognized dtmfTone"),new Error("Unrecognized dtmfTone");try{r._slimcoreCallHandler.callSendDtmf(r.slimcoreCallId,n)}catch(e){throw i.logFailure(e),e}})},t.prototype.setMaxVideoChannels=function(e,t,n){var r=this;void 0===n&&(n=F.generateCauseId());var i=this._logger.createFnLogger("setMaxVideoChannels",n);return i.info("setMaxVideoChannels: "+e),Promise.resolve().then(function(){return r._slimcoreCallHandler.callSetMaxVideoChannels(r.slimcoreCallId,e,t,n),r._isSetVideoChannelsRenegotiated?r._callOperationHandler.waitForOperation(h.CALL_OPERATIONS.SET_MAX_VIDEO_CHANNELS):Promise.resolve()}).catch(function(e){throw i.logFailure(e),e})},t.prototype._setAudioUsageMode=function(e,n){var r=this,i=this._logger.createFnLogger("setAudioUsageMode",n);return Promise.resolve().then(function(){var n=t.convertToSlimCoreAudioUsageMode(e);if(void 0===n)throw new Error("Unrecognized audioUsageMode");r._slimcoreCallHandler.callSetAudioUsageMode(r.slimcoreCallId,n)}).catch(function(e){throw i.logFailure(e),e})},t.prototype._getParticipant=function(e){return this.participantMap.hasOwnProperty(e)?this.participantMap[e]:void 0},t.prototype._getOrCreateParticipant=function(e,t,n,r){var i,o=this,a=8===this.state;if(this.participantMap.hasOwnProperty(e)){var s=this.participantMap[e];return n&&s.attachSlimcoreObjectId(n,t,a,r),s}return(i=new P.default(this._logger,this._settings,this._slimcoreInstance,e,this._slimcoreCallHandler,this._streamContextMap,n,this._callTelemetry,a,r)).changed(function(){return o._participantChangedCallback(i)}),this._addParticipantEntry(i),this._monitorCallStart(),this.event("participantAdded").raise(i),this.raiseChangedDeferred(),i},t.prototype._participantChangedCallback=function(e){var t=this;e.previousId&&(this._callOperationHandler.updateOperationId(e.previousId,e.id),this._participantOperationHandler.updateOperationId(e.previousId,e.id),e.previousId=null);var n=this._getlocalScreenShareStream();u.each(e.streams[1],function(r){n&&!t._callOperationHandler.hasPendingOperation(h.CALL_OPERATIONS.START_SCREEN_SHARING)&&r.isAvailable&&(T.forgetAndLog(t.stopScreenSharing(!0),t._logger,"ParticipantChanged: Cleaning up local screenshare because remote screenshare is running"),t.event("sharingStolen").raise()),t.screenSharingControl&&t.screenSharingControl.isScreenSharingControlEnabled()&&(t.screenSharingControl.reportSharingSessionChangeForViewer(e,r.negotiationTag),r.isActive()&&3===t.state?t.screenSharingControl.initControlForViewer(e,r.negotiationTag):t.screenSharingControl.shutdownControlForViewer(e))}),this._updateDominantSpeakerListDeferred(),this.event("participantUpdated").raise(e),this.raiseChangedDeferred()},t.prototype._setCallState=function(e,n,r,i){if(this.state!==e){var o=this._logger.createFnLogger("setCallState",n);if(o.info("currentState="+this.state+", newState="+e+", terminatedReason="+this.terminatedReason),I.validStateTransitions[this.state].indexOf(e)>=0){if(this.state=e,this._onDiagnosticsCodeChanged(i),this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_CALL_STATE,{state:e,reason:r},n),3===e)this._callGotConnected=!0,this.callHeldAt=null;else if(5!==e&&4!==e||this.callHeldAt){if(7===e){this.terminatedReason=r,this._setFailureType(t.convertTerminatedReasonToFailureType(r,this._callGotConnected,this._wasAudioStreamConnected));var a={};this.callEndDiagnosticsInfo&&(a.code=this.callEndDiagnosticsInfo.callControllerCode,a.subCode=this.callEndDiagnosticsInfo.callControllerSubCode),this._callTelemetry.updateOperationData(h.CALL_OPERATIONS_INTERNAL.SET_CALL_STATE,a,n)}}else this.callHeldAt=new Date;this.screenSharingControl&&this.screenSharingControl.isScreenSharingControlEnabled()&&this.screenSharingControl.callStateChanged(this.state),o.logSuccess("changed to "+e+", terminatedReason: "+this.terminatedReason+", failureType="+this.failureType),this._startInitialVideoIfReady(n),this._monitorCallStart(),this.event("callStateChanged").raise(),this._updateCapabilities(n),this.raiseChanged()}else this._logger.warn("invalid state transition")}},t.prototype._setVideoOn=function(e,t){this.isVideoOn!==e&&(this.isVideoOn=e,this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_LOCAL_VIDEO,{value:e},t),this.raiseChanged())},t.prototype._setScreenSharingOn=function(e,t){this.isScreenSharingOn!==e&&(this.isScreenSharingOn=e,this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_SCREEN_SHARING,{value:e},t),this.raiseChanged()),this.event("userActivityChanged").raise()},t.prototype._setMutedSpeaker=function(e,t){this.isSpeakerMuted!==e&&(this.isSpeakerMuted=e,this._callTelemetry.recordEvent(h.CALL_OPERATIONS_INTERNAL.SET_MUTED_SPEAKER,{value:e},t),this.raiseChanged())},t.prototype._monitorCallStart=function(){!this.callStartedAt&&3===this.state&&this.participants.length&&(this.callStartedAt=new Date)},t.prototype._addParticipantEntry=function(e){this.participantMap[e.id]=e,this.participants.push(e)},t.prototype._removeParticipantEntry=function(e){if(!this.participantMap.hasOwnProperty(e))return null;var t=this.participantMap[e];return delete this.participantMap[e],u.pull(this.participants,t),t&&this.raiseChanged(),t},t.prototype._onThreadIdChanged=function(e){e&&this.threadId!==e&&(this._logger.info("_onThreadIdChanged threadId: "+e+" this.threadId: "+this.threadId),this.threadId=e,this.raiseChanged())},t.prototype._onMessageIdChanged=function(e){e&&this.messageId!==e&&(this._logger.info("_onMessageIdChanged messageId: "+e+" this.messageId: "+this.messageId),this.messageId=e,this.raiseChanged())},t.prototype._onSelfParticipantRoleChanged=function(e){e!==this.role&&(this._logger.info("Role for self is set to "+e),this.role=e,this.raiseChanged())},t.prototype._updateMeetingRole=function(e){e!==this.meetingRole&&(this.meetingRole=e,this._logger.info("_updateMeetingRole: "+this.meetingRole),this.event("meetingRoleUpdated").raise(this.meetingRole),this.raiseChanged())},t.prototype._updateTransferorMri=function(e){var t=f.stripMriAliases(e);t!==this.transferorMri&&(this.transferorMri=t,this._logger.info("_transferorMri: "+this.transferorMri),this.raiseChanged())},t.prototype._updateActiveVideoChannelCount=function(e){e!==this.activeVideoChannelCount&&(this._logger.info("_updateActiveVideoChannelCount to "+e),this.activeVideoChannelCount=e,this.raiseChanged())},t.prototype._onSelfParticipantTenantIdChanged=function(e){e!==this.tenantId&&(this._logger.info("TenantId for self is set to "+e),this.tenantId=e,this.raiseChanged())},t.prototype._updateEndpointDetails=function(e){var t=this,n=F.generateCauseId();if(this._rawEndpoints!==e&&e){try{this.endpoints=JSON.parse(e),this._rawEndpoints=e,this.endpoints.endpointDetails.forEach(function(e){e.originalId&&t._participantOperationHandler.resolveOperation(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK,null,e.originalId,n).catch(function(e){t._logger.error("["+n+"]Failed to update call me back participant "+e)})})}catch(t){this._logger.info("["+n+"]Failed to parse raw endpoint details. Error: "+t+", EndpointDetails: "+e)}this._updateCapabilities(n),this.raiseChanged()}},t.prototype._updateMeetingDetails=function(e){if(this._rawMeetingDetails!==e)try{!e||u.isEmpty(e)?this.meetingDetails=null:this.meetingDetails=JSON.parse(e),this._rawMeetingDetails=e,this.raiseChanged()}catch(t){this._logger.warn("Failed to parse the raw meeting details. Error: "+t+", MeetingDetails: "+e)}},t.prototype._onBroadcastMetadataChanged=function(e){if(e)try{this.broadcastMetadata=JSON.parse(e),this._logger.info("broadcast metadata updated"),this.broadcastMeeting&&this.broadcastMeeting.metadataChanged(e),this.raiseChanged()}catch(e){this._logger.info("broadcast metadata invalid, failed to parse")}},t.prototype._onCallProgressStatusChanged=function(e){e!==this._callProgressStatus&&(this._callProgressStatus=e,this.callProgressStatus=e,this.event("callProgressStatusChanged").raise(e))},t.prototype._getParticipantByObjectId=function(e){return u.find(this.participants,function(t){return t.slimcoreObjectId===e})},t.prototype._onQualityChanged=function(e){if(this._logger.info("onQualityChanged: oid="+e.objectId+", mtype="+e.mediaType+", otype="+e.objectType+", type="+e.type+", value="+e.value),!(e.mediaType!==M.MediaType.Audio&&e.mediaType!==M.MediaType.Video||e.objectType===M.ObjectType.Call&&e.objectId!==this.slimcoreCallId)){var n={type:t.convertQualityEventType(e.type),value:t.convertQualityLevel(e.value),mediaType:t.convertMediaType(e.mediaType),isLocalSource:e.objectType===M.ObjectType.Call};if(e.objectType===M.ObjectType.Participant){var r=this._getParticipantByObjectId(e.objectId);if(!r)return;n.id=r.id}n.type&&n.value&&(e.mediaType===M.MediaType.Audio&&e.type===M.QualityEventType.RelayWhiteListing?(this._isRelayWhiteListingIssue=!0,this.event("mediaConnectionWhitelistingWarning").raise(),this.event("mediaConnectionFailed").raise()):this.event("callQualityChanged").raise(n))}},t.prototype.getContentSharing=function(e){var t=this._slimcoreInstance.getContentSharing(e);return t?T.wrap(t,this._settings):null},t.prototype.createContentSharingSession=function(e,t,n,r){var i=this;return Promise.resolve().then(function(){var o=i._slimcoreCallHandler.createContentSharing(i.slimcoreCallId,e,t,n,r);if(!o)throw new Error("Failed to create ContentSharing SlimCore object");var a=i.getContentSharing(o);if(!a)throw new Error("Failed to create ContentSharing SlimCore native object");var s=new E.default(i._logger,i._settings,i._slimcoreInstance,i._slimcoreCallHandler,o,a,i._callTelemetry);return i.contentSharingSessions.push(s),i.event("contentSharingChanged").raise(),s})},t.prototype._onContentSharingChanged=function(){var e=this,t=this._slimcoreCallHandler.getContentSharingSessions(this.slimcoreCallId),n=!1;u.remove(t,function(t){return e._getIntProperty(e._slimcoreCallHandler,t,SlimCore.Enums.Property.ContentSharingCallId)!==e.slimcoreCallId});var r=u.remove(this.contentSharingSessions,function(e){return-1===u.indexOf(t,e.slimCoreContentSharingObjectId)});u.forEach(t,function(t){if(!u.find(e.contentSharingSessions,function(e){return e.slimCoreContentSharingObjectId===t})){var r=e.getContentSharing(t);if(r){var i=new E.default(e._logger,e._settings,e._slimcoreInstance,e._slimcoreCallHandler,t,r,e._callTelemetry);e.contentSharingSessions.push(i),e._logger.info("Added new content sharing session with guid "+i.contentSharingGuid),n=!0}}}),r.forEach(function(t){e._logger.info("Removed content sharing session with guid "+t.contentSharingGuid),t.setContentSharingStatus(7),t.dispose()}),(n||r.length)&&this.event("contentSharingChanged").raise()},t.prototype.raiseChangedDeferred=function(){var e=this;this._raiseChangedDefer||(this._raiseChangedDefer=u.defer(function(){delete e._raiseChangedDefer,e.raiseChanged()}))},t.prototype._onParticipantJoinedOrRemovedDeferred=function(e){var t=this;void 0===e&&(e=F.generateCauseId()),this._onParticipantJoinedOrRemovedDefer||(this._onParticipantJoinedOrRemovedDefer=u.defer(function(){delete t._onParticipantJoinedOrRemovedDefer,t._onParticipantJoinedOrRemoved(e)}))},t.prototype._updateDominantSpeakerListDeferred=function(){var e=this;this._updateDominantSpeakerListDefer||(this._updateDominantSpeakerListDefer=u.defer(function(){delete e._updateDominantSpeakerListDefer,e._updateDominantSpeakerList()}))},t.prototype.callStateCanToggleVideo=function(){return 3===this.state||4===this.state||5===this.state||10===this.state},t.prototype._startInitialVideoIfReady=function(e){return l(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return this.callStateCanToggleVideo()&&this._videoRequestedOnWhileConnecting?(this._logger.info("["+e+"]Call has been started; turning on video"),this._videoRequestedOnWhileConnecting=!1,[4,this.startVideoSafe(e)]):[3,3];case 1:return t.sent(),this._videoRequestedOffWhileConnecting?(this._logger.info("["+e+"]Call has been started and video turned on; turning off video"),this._videoRequestedOffWhileConnecting=!1,[4,this.stopVideo(e)]):[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.convertConnectionType=function(e){switch(e){case 0:return M.ConnectionType.AllSupported;case 1:return M.ConnectionType.NoDirectConnection;default:return M.ConnectionType.AllSupported}},t.convertStatusToTerminatedReason=function(e){switch(e){case M.CallStatus.Failed:return 7;case M.CallStatus.Finished:return 1;case M.CallStatus.Missed:return 9;case M.CallStatus.Refused:return 10;case M.CallStatus.Busy:return 11;case M.CallStatus.Cancelled:case M.CallStatus.Unplaced:return 12;case M.CallStatus.Dropped:return 4;case M.CallStatus.DeniedInLobby:return 55;case M.CallStatus.TimedOutInLobby:return 56;default:return 0}},t.convertParticipantReasonToTerminatedReason=function(e){switch(e){case 0:return 1;case 1:case 5:case 6:case 7:case 43:return 5;case 23:return 12;case 46:return 59;case 59:return 73;case 2:return 9;case 3:return 10;case 4:return 2;case 8:return 24;case 9:return 3;case 10:return 4;case 12:return 14;case 11:return 0;case 13:return 15;case 14:return 16;case 15:return 17;case 16:return 18;case 17:return 19;case 18:return 20;case 19:return 11;case 20:return 21;case 21:return 22;case 22:return 23;case 25:return 33;case 26:return 36;case 27:return 37;case 30:return 41;case 28:return 39;case 31:return 42;case 29:return 40;case 32:return 43;case 33:return 44;case 34:return 45;case 35:return 46;case 36:return 47;case 37:return 48;case 38:return 49;case 39:return 50;case 40:return 51;case 41:return 52;case 42:return 54;case 47:return 61;case 53:return 66;case 54:return 67;case 55:return 68;case 56:return 69;case 57:return 71;case 58:return 72;default:return 0}},t.convertTerminatedReasonToFailureType=function(e,t,n){switch(e){case 0:case 1:case 9:case 10:case 11:case 12:case 2:case 60:return 2;case 3:case 5:case 6:case 7:case 8:case 14:case 36:case 37:case 15:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 44:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 59:case 73:case 66:case 67:case 68:case 69:case 71:case 72:return 0;case 4:return t&&n?1:0;default:return 2}},t.convertToSlimCoreDtmfTone=function(e){switch(e){case 0:return M.DtmfTone.Num0;case 1:return M.DtmfTone.Num1;case 2:return M.DtmfTone.Num2;case 3:return M.DtmfTone.Num3;case 4:return M.DtmfTone.Num4;case 5:return M.DtmfTone.Num5;case 6:return M.DtmfTone.Num6;case 7:return M.DtmfTone.Num7;case 8:return M.DtmfTone.Num8;case 9:return M.DtmfTone.Num9;case 10:return M.DtmfTone.Star;case 11:return M.DtmfTone.Pound;case 12:return M.DtmfTone.A;case 13:return M.DtmfTone.B;case 14:return M.DtmfTone.C;case 15:return M.DtmfTone.D;case 16:return M.DtmfTone.Flash;default:return}},t.convertToSlimCoreAudioUsageMode=function(e){switch(e){case"Default":return M.AudioUsageMode.Default;case"LongrangeSpeaker":return M.AudioUsageMode.LongrangeSpeaker;case"Auditorium":return M.AudioUsageMode.Auditorium;default:return}},t.convertQualityEventType=function(e){switch(e){case M.QualityEventType.NetworkSendQuality:return 1;case M.QualityEventType.NetworkRecvQuality:return 2;case M.QualityEventType.NetworkDelay:return 3;case M.QualityEventType.NetworkBandwidthLow:return 4;case M.QualityEventType.NetworkReconnect:return 5;case M.QualityEventType.NetworkPacketLoss:return 6;case M.QualityEventType.NetworkJitter:return 7;case M.QualityEventType.NetworkRateMatching:return 8;case M.QualityEventType.DeviceCaptureNotFunctioning:return 9;case M.QualityEventType.DeviceRenderNotFunctioning:return 10;case M.QualityEventType.DeviceRenderGlitches:return 11;case M.QualityEventType.DeviceLowSNR:return 12;case M.QualityEventType.DeviceLowSpeechLevel:return 13;case M.QualityEventType.DeviceClipping:return 14;case M.QualityEventType.DeviceEcho:return 15;case M.QualityEventType.PresentationAudioQuality:return 16;case M.QualityEventType.DeviceHalfDuplexAec:return 17;case M.QualityEventType.DeviceMultipleEndpoints:return 18;case M.QualityEventType.DeviceHowling:return 19;case M.QualityEventType.DeviceRenderZeroVolume:return 20;case M.QualityEventType.DeviceRenderMute:return 21;case M.QualityEventType.NetworkSendCatastrophic:return 22;case M.QualityEventType.NetworkRecvCatastrophic:return 23;case M.QualityEventType.CpuInsufficient:return 24;case M.QualityEventType.DeviceCaptureMute:return 25;case M.QualityEventType.DeviceCaptureNotMuteButSilent:return 26;case M.QualityEventType.DeviceSpeakWhileMuted:return 27;case M.QualityEventType.VideoVbssRendered:return 28;case M.QualityEventType.NetworkEthernetInterfaceUsed:return 29;case M.QualityEventType.NetworkWlanInterfaceUsed:return 30;case M.QualityEventType.NetworkWwanInterfaceUsed:return 31;case M.QualityEventType.RelayWhiteListing:return 32;case M.QualityEventType.VideoCapturerDeviceStartFailed:return 33;case M.QualityEventType.VideoCapturerDeviceStartTimedOut:return 34;case M.QualityEventType.VideoCapturerDeviceStartFailureLackSystemRes:return 35;case M.QualityEventType.VideoCapturerDeviceStartFailureMFResConflict:return 36;case M.QualityEventType.ZeroCaptureDevicesEnumerated:return 43;case M.QualityEventType.ZeroRenderDevicesEnumerated:return 44;case M.QualityEventType.NoNetwork:return 37;case M.QualityEventType.NetworkNotWorking:return 38;case M.QualityEventType.DeviceCaptureNotFunctioningAudioSrvNotRunning:return 41;case M.QualityEventType.DeviceRenderNotFunctioningAudioSrvNotRunning:return 42;case M.QualityEventType.DeviceCaptureNotFunctioningDeviceInUse:return 39;case M.QualityEventType.DeviceRenderNotFunctioningDeviceInUse:return 40;case M.QualityEventType.VideoCaptureDeviceFreeze:return 45;case M.QualityEventType.AudioCapturePermissionDenied:return 46;case M.QualityEventType.VideoCapturePermissionDenied:return 47;case M.QualityEventType.VideoCaptureFreezeRecovered:return 48;case M.QualityEventType.DeviceRenderHowling:return 49;case M.QualityEventType.LowFarEndInput:return 50;case M.QualityEventType.RemoteNetworkConnectivityIssue:return 52;case M.QualityEventType.PresentationAudioLoopbackDeviceState:return 53;case M.QualityEventType.AudioCaptureUltrasoundDetected:return 54;default:return}},t.convertQualityLevel=function(e){switch(e){case M.QualityLevel.Unknown:return 0;case M.QualityLevel.Good:return 1;case M.QualityLevel.Poor:return 2;case M.QualityLevel.Bad:return 3;default:return}},t.convertMediaType=function(e){switch(e){case M.MediaType.Audio:return 0;case M.MediaType.Video:return 1;case M.MediaType.PanoramicCamera:return 2;case M.MediaType.AppSharing:return 3;case M.MediaType.Data:return 4;default:return}},t.toMediaDirection=function(e){switch(e){case 0:return M.MediaDirection.Disabled;case 3:return M.MediaDirection.Inactive;case 2:return M.MediaDirection.SendToPeer;case 1:return M.MediaDirection.ReceiveFromPeer;case 4:return M.MediaDirection.Bidirectional;default:return M.MediaDirection.Disabled}},t.toAnswerMediaType=function(e){switch(e){case 0:return M.AnswerMediaType.AnswerWithAudioOnly;case 1:return M.AnswerMediaType.AnswerWithAudioVideo;case 2:return M.AnswerMediaType.AnswerWithScreenshareOnly;default:return M.AnswerMediaType.AnswerWithAudioOnly}},t.convertMuteScope=function(e){switch(e){case 0:return M.MuteScope.All;case 1:return M.MuteScope.Specified;default:return}},t.convertToSlimCoreMediaPeerType=function(e){switch(e){case 0:return M.MediaPeerType.ConsumerTwoParty;case 1:return M.MediaPeerType.ConsumerPstn;case 2:return M.MediaPeerType.ConsumerMultiParty;case 3:return M.MediaPeerType.EnterpriseTwoPartyOnlineOnly;case 4:return M.MediaPeerType.EnterpriseTwoPartyHybrid;case 6:return M.MediaPeerType.EnterprisePstnOnlineOnly;case 7:return M.MediaPeerType.EnterprisePstnHybrid;case 5:return M.MediaPeerType.EnterpriseMultiParty;case 8:return M.MediaPeerType.EnterpriseFederated;case 9:return M.MediaPeerType.EnterpriseUnknown;case 10:return M.MediaPeerType.EnterpriseMultiPartyBroadcasting;default:return}},t.convertPushHandlingResult=function(e){switch(e){case M.PushHandlingResult.BadNotificationPayload:return{code:0,fatal:!0};case M.PushHandlingResult.CallSetupSucceeded:return{code:1,success:!0};case M.PushHandlingResult.BadNotificationEventType:return{code:3,fatal:!0};case M.PushHandlingResult.CallSetupSucceededCallAlreadyExists:return{code:4};case M.PushHandlingResult.CallSetupFailedCannotConnect:return{code:5,fatal:!0};case M.PushHandlingResult.CallSetupFailedNoSignaling:return{code:6,fatal:!0};case M.PushHandlingResult.CallSetupFailedConflict:return{code:7};case M.PushHandlingResult.CallSetupFailedPushIgnored:return{code:8};case M.PushHandlingResult.CallSetupFailedAnsweredElsewhere:return{code:9};case M.PushHandlingResult.CallSetupFailedAlreadyEnded:return{code:10};case M.PushHandlingResult.CallSetupProgress:return{code:11,success:!0};case M.PushHandlingResult.CallSetupFailed:case M.PushHandlingResult.CallSetupFailedNoPermission:case M.PushHandlingResult.CallSetupFailedNoCommonCodec:default:return{code:2,fatal:!0}}},Object.defineProperty(t.prototype,"origin",{get:function(){return this._origin},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isAudioStreamConnected",{get:function(){return this._isAudioStreamConnected},set:function(e){this._isAudioStreamConnected!==e&&(this._isAudioStreamConnected=e,this._wasAudioStreamConnected=this._wasAudioStreamConnected||e,this.raiseChanged())},enumerable:!0,configurable:!0}),t.isCallConnected=function(e){return e===M.CallStatus.InProgress},t.isObserving=function(e){return e===M.CallStatus.Observing},t.isCallRinging=function(e){switch(e){case M.CallStatus.RingingOut:case M.CallStatus.RingingIn:return!0;default:return!1}},t.isCallConnecting=function(e){return e===M.CallStatus.Routing},t.isCallEarlyMedia=function(e){return e===M.CallStatus.EarlyMedia},t.isCallInLobby=function(e){return e===M.CallStatus.InLobby},t.isCallPreheating=function(e){return e===M.CallStatus.Preheating},t.isCallPreheated=function(e){return e===M.CallStatus.Preheated},t.isCallTerminated=function(e){switch(e){case M.CallStatus.Missed:case M.CallStatus.Refused:case M.CallStatus.Busy:case M.CallStatus.Cancelled:case M.CallStatus.Finished:case M.CallStatus.Failed:case M.CallStatus.Dropped:case M.CallStatus.DeniedInLobby:case M.CallStatus.TimedOutInLobby:case M.CallStatus.CallTimedOut:return!0;default:return!1}},t.prototype._cleanCallResources=function(e){return l(this,void 0,void 0,function(){var t,n,r,i,o;return c(this,function(a){switch(a.label){case 0:t=this._logger.createFnLogger("cleanCallResources",e),a.label=1;case 1:return a.trys.push([1,7,8,9]),n=u.map(this.participants,function(e){return T.forgetAndLog(e.stopVideos(),t,"cleanCallResources: stopping participant videos")}),[4,Promise.all(n)];case 2:return a.sent(),(r=this._getlocalScreenShareStream())?[4,T.forgetAndLog(this.stopScreenSharing(!1,e),t,"cleanCallResources: LocalScreenShare stop")]:[3,4];case 3:a.sent(),a.label=4;case 4:return(i=this._getLocalVideo())?[4,T.forgetAndLog(i.stop(e),t,"cleanCallResources: LocalVideo stop")]:[3,6];case 5:a.sent(),a.label=6;case 6:return this.contentSharingSessions.forEach(function(t){t.setContentSharingStatus(7),t.dispose(e)}),this.contentSharingSessions=[],[3,9];case 7:return o=a.sent(),t.error(o),[3,9];case 8:return this.dispose(e),[7];case 9:return[2]}})})},t.prototype.dispose=function(t){var n=this._logger.createFnLogger("dispose",t);n.info("start"),this.subscriptions.length&&n.info(this.subscriptions.length+" subscriptions will be lost"),this._slimCoreElectronRemoteManager&&this._slimCoreElectronRemoteManager.dispose(),this.mediaStreams[0]=[],this.mediaStreams[1]=[];var r=this._getlocalScreenShareStream();r&&r.dispose(t);var i=this._getLocalVideo();i&&i.dispose(t),this.localMediaStreams=[],this.screenSharingControl&&(this.screenSharingControl.dispose(),this.screenSharingControl=null),this.dataChannelAdapter&&(this.dataChannelAdapter.dispose(),this.dataChannelAdapter=null),this._dataChannel&&(this._dataChannel.dispose(),this._dataChannel=null),this._dataChannelUsers&&(this._dataChannelUsers=null),this.participants.forEach(function(e){return e.dispose()}),e.prototype.dispose.call(this,t)},t.prototype.testTriggerMediaRelayWhiteListingIssue=function(){throw new Error("testTriggerMediaRelayWhiteListingIssue not implemented in electron call")},t.prototype.testSetCallState=function(e){this._logger.info("Overwriting call state for test purposes: "+this.state+" -> "+e),this.state=e},t.prototype.addGroupModality=function(e,t){var n=this;void 0===t&&(t=F.generateCauseId());var r=this._logger.createFnLogger(h.CALL_OPERATIONS.ADD_GROUP_MODALITY,t);if(0===this.slimcoreCallId)return Promise.reject(new Error("call is not initialized yet"));var i=e.additionalData?JSON.stringify(e.additionalData):"";return r.info("threadId = "+e.threadId+" messageId = "+e.messageId+" additionalData = "+S.scrubMriOrOmit(i)),Promise.resolve().then(function(){return n._slimcoreCallHandler.addGroupModality(n.slimcoreCallId,e.threadId,e.messageId,i,t)}).catch(function(e){throw r.logFailure(e),e})},t.prototype.getMediaTelemetry=function(){return Promise.reject("Not supported")},t.prototype.getVideoMediaStates=function(e){var t=this,n=[],r=function(e){n.push({mediaType:1,label:t._deviceManager.getLabelByCameraPosition(e)})},i=this._deviceManager.getChildCameras(e.id);return u.isEmpty(i)?r(e):i.forEach(r),n},t.prototype.getSlimcoreEnumLevel=function(e){switch(e){case"user":return M.PublishStateLevel.PublishStateUser;case"endpoint":return M.PublishStateLevel.PublishStateEndpoint;default:throw"Invalid level type."}},o([m.callOperation(h.CALL_OPERATIONS.INITIALIZE,{type:m.OPERATION_TYPE.SYNC,convertError:!0}),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],t.prototype,"init",null),o([m.callOperation(h.CALL_OPERATIONS.JOIN_CALL,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(1,m.callStartOptions),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object,Object]),a("design:returntype",Promise)],t.prototype,"join",null),o([m.callOperation(h.CALL_OPERATIONS.START_CALL,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(0,m.callStartOptions),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"start",null),o([m.callOperation(h.CALL_OPERATIONS.START_CALL_TO_VOICE_MAIL,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"startCallToVoicemail",null),o([m.callOperation(h.CALL_OPERATIONS.START_CALL_WITH_NUDGE,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(1,m.callStartOptions),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Array,Object,Object]),a("design:returntype",Promise)],t.prototype,"startCallWithNudge",null),o([m.callOperation(h.CALL_OPERATIONS.START_CALL_AND_UNPARK,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(2,m.callStartOptions),s(3,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,String,Object,Object]),a("design:returntype",Promise)],t.prototype,"startAndUnpark",null),o([m.callOperation(h.CALL_OPERATIONS.SUBSCRIBE,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0}),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object,Object]),a("design:returntype",Promise)],t.prototype,"joinCallWithoutCallModality",null),o([m.callOperation(h.CALL_OPERATIONS.JOIN_PREHEATED_CALL,{waitFor:h.CALL_OPERATIONS_INTERNAL.CALL_START_OR_JOIN_INITIATED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"joinPreheatedCall",null),o([m.callOperation(h.CALL_OPERATIONS.START_VIDEO,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"startVideo",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_VIDEO,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"stopVideo",null),o([m.callOperation(h.CALL_OPERATIONS_INTERNAL.START_LOCAL_VIDEO,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,String]),a("design:returntype",Promise)],t.prototype,"_startLocalVideo",null),o([m.callOperation(h.CALL_OPERATIONS.DUMP_VIDEO_SOURCE_IMAGES,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Promise)],t.prototype,"dumpVideoSourceImages",null),o([m.callOperation(h.CALL_OPERATIONS.START_SCREEN_SHARING,{type:m.OPERATION_TYPE.CHAINED}),s(3,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object,String,Object]),a("design:returntype",Promise)],t.prototype,"startScreenSharing",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_SCREEN_SHARING,{type:m.OPERATION_TYPE.CHAINED}),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Boolean,String,Object]),a("design:returntype",Promise)],t.prototype,"stopScreenSharing",null),o([m.callOperation(h.CALL_OPERATIONS.START_DATA_CHANNEL,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"startDataChannel",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_DATA_CHANNEL,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"stopDataChannel",null),o([m.callOperation(h.CALL_OPERATIONS.SHARE_SYSTEM_SOUNDS,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[Boolean]),a("design:returntype",Promise)],t.prototype,"shareSystemSound",null),o([m.callOperation(h.CALL_OPERATIONS.START_MULTICHANNEL_AUDIO_DEVICE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[String,Number]),a("design:returntype",Promise)],t.prototype,"startMultichannelAudioDevice",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_MULTICHANNEL_AUDIO_DEVICE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Promise)],t.prototype,"stopMultichannelAudioDevice",null),o([m.callOperation(h.CALL_OPERATIONS.BLIND_TRANSFER,{singular:!0,type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,Object]),a("design:returntype",Promise)],t.prototype,"callBlindTransfer",null),o([m.callOperation(h.CALL_OPERATIONS.SAFE_TRANSFER,{singular:!0,type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,Object]),a("design:returntype",Promise)],t.prototype,"callSafeTransfer",null),o([m.callOperation(h.CALL_OPERATIONS.TRANSFER_TO_VOICEMAIL,{singular:!0,type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"transferCallToVoicemail",null),o([m.callOperation(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER,{singular:!0,type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"callConsultativeTransfer",null),o([m.callOperation(h.CALL_OPERATIONS.CONSULTATIVE_TRANSFER_WITH_PICKUP_CODE,{singular:!0,type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"consultativeTransferWithPickupCode",null),o([m.callOperation(h.CALL_OPERATIONS.PARK_CALL,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,Object]),a("design:returntype",Promise)],t.prototype,"park",null),o([m.callOperation(h.CALL_OPERATIONS.UNPARK_CALL,{type:m.OPERATION_TYPE.CHAINED}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Number]),a("design:returntype",Promise)],t.prototype,"unpark",null),o([m.callOperation(h.CALL_OPERATIONS.MUTE,{waitFor:h.CALL_OPERATIONS.UNMUTE}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"mute",null),o([m.callOperation(h.CALL_OPERATIONS.UNMUTE,{waitFor:h.CALL_OPERATIONS.MUTE}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"unmute",null),o([m.callOperation(h.CALL_OPERATIONS.MUTE_SPEAKER,{waitFor:h.CALL_OPERATIONS.UNMUTE_SPEAKER}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"muteSpeaker",null),o([m.callOperation(h.CALL_OPERATIONS.UNMUTE_SPEAKER,{waitFor:h.CALL_OPERATIONS.MUTE_SPEAKER}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"unmuteSpeaker",null),o([m.callOperation(h.CALL_OPERATIONS.MUTE_PARTICIPANTS,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,Array,Object]),a("design:returntype",Promise)],t.prototype,"muteParticipants",null),o([m.callOperation(h.CALL_OPERATIONS.HOLD,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,Object]),a("design:returntype",Promise)],t.prototype,"hold",null),o([m.callOperation(h.CALL_OPERATIONS.UNHOLD,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"unhold",null),o([m.callOperation(h.CALL_OPERATIONS.UPDATE_ENDPOINT_METADATA,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"updateEndpointMetadata",null),o([m.callOperation(h.CALL_OPERATIONS.SEND_DTMF_TONE),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,Object]),a("design:returntype",Promise)],t.prototype,"sendDtmfTone",null),o([m.callOperation(h.CALL_OPERATIONS.SET_AUDIO_USAGE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"setAudioUsageMode",null),o([m.callOperation(h.CALL_OPERATIONS.START_AUDIO,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"startAudio",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_AUDIO,{type:m.OPERATION_TYPE.CHAINED}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"stopAudio",null),o([m.callOperation(h.CALL_OPERATIONS.ASSIMILATE,{waitFor:h.CALL_OPERATIONS.ASSIMILATE}),s(3,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,String,String,Object]),a("design:returntype",Promise)],t.prototype,"assimilate",null),o([m.callOperation(h.CALL_OPERATIONS.PUBLISH_STATE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.operationId),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"publishState",null),o([m.callOperation(h.CALL_OPERATIONS.PUBLISH_STATE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.operationId),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"publishStatesForEveryone",null),o([m.callOperation(h.CALL_OPERATIONS.REMOVE_STATE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.operationId),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"removeState",null),o([m.callOperation(h.CALL_OPERATIONS.REMOVE_STATE,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.operationId),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"removeStatesForEveryone",null),o([m.callOperation(h.CALL_OPERATIONS.UPDATE_MEETING_SETTINGS,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.operationId),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"updateMeetingSettings",null),o([m.callOperation(h.CALL_OPERATIONS.STOP_CALL,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object,Object]),a("design:returntype",Promise)],t.prototype,"stop",null),o([m.callOperation(h.CALL_OPERATIONS.REJECT,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(0,m.causeId),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"reject",null),o([m.callOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_LEAVE_CALL,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],t.prototype,"_leaveSlimCoreCall",null),o([m.callOperation(h.CALL_OPERATIONS_INTERNAL.INCOMING_INITIALIZE,{triggerAttach:!0}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,Object]),a("design:returntype",void 0)],t.prototype,"incomingCallInit",null),o([m.callOperation(h.CALL_OPERATIONS.ACKNOWLEDGE,{type:m.OPERATION_TYPE.CHAINED,triggerAttach:!0,convertError:!0}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"acknowledge",null),o([m.callOperation(h.CALL_OPERATIONS.ACCEPT,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"accept",null),o([m.callOperation(h.CALL_OPERATIONS.MERGE_PARTICIPANT),s(3,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Array,Object,String]),a("design:returntype",Promise)],t.prototype,"mergeParticipants",null),o([m.callOperation(h.CALL_OPERATIONS.MERGE_WITH_PICKUP_CODE),s(0,m.operationId),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,Object]),a("design:returntype",Promise)],t.prototype,"mergeWithPickupCode",null),o([m.callOperation(h.CALL_OPERATIONS.MERGE_CALL,{singular:!0,waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object,Object]),a("design:returntype",Promise)],t.prototype,"merge",null),o([m.callOperation(h.CALL_OPERATIONS_INTERNAL.RECONNECT),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Promise)],t.prototype,"reconnect",null),o([m.callOperation(h.CALL_OPERATIONS.ELECTRON_SHOW_CQF_INFO,{type:m.OPERATION_TYPE.CHAINED}),a("design:type",Function),a("design:paramtypes",[String,Number]),a("design:returntype",Promise)],t.prototype,"showCQFInfo",null),o([m.callOperation(h.CALL_OPERATIONS.ELECTRON_IS_CQF_RENDERED,{type:m.OPERATION_TYPE.CHAINED}),a("design:type",Function),a("design:paramtypes",[String]),a("design:returntype",Promise)],t.prototype,"isCqfRendered",null),o([m.callOperation(h.CALL_OPERATIONS.ELECTRON_PROVIDE_CQF,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[String,String,Number,String]),a("design:returntype",Promise)],t.prototype,"provideCallQualityFeedback",null),o([m.callOperation(h.CALL_OPERATIONS.ELECTRON_PROVIDE_CQF,{type:m.OPERATION_TYPE.CHAINED}),a("design:type",Function),a("design:paramtypes",[String,String,Number,String,String,String]),a("design:returntype",Promise)],t.prototype,"provideCallQualityFeedbackEx",null),o([m.participantOperation(h.PARTICIPANT_OPERATIONS.ADMIT_PARTICIPANT),s(0,m.operationId),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object]),a("design:returntype",Promise)],t.prototype,"admitParticipant",null),o([m.callOperation(h.CALL_OPERATIONS.ADMIT),a("design:type",Function),a("design:paramtypes",[Object,String]),a("design:returntype",Promise)],t.prototype,"admit",null),o([m.participantOperation(h.PARTICIPANT_OPERATIONS.CALL_ME_BACK),s(0,m.operationId),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[String,String,Object]),a("design:returntype",Promise)],t.prototype,"callMeBack",null),o([m.participantOperation(h.CALL_OPERATIONS.NUDGE_PARTICIPANTS),s(0,m.operationId),s(3,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Array,Object,Object]),a("design:returntype",Promise)],t.prototype,"nudgeParticipants",null),o([m.participantOperation(h.CALL_OPERATIONS.UPDATE_MEETING_ROLE),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Array,String,Object]),a("design:returntype",Promise)],t.prototype,"updateMeetingRoles",null),o([m.participantOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANT),s(0,m.operationId),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,Object]),a("design:returntype",Promise)],t.prototype,"addParticipant",null),o([m.participantOperation(h.PARTICIPANT_OPERATIONS.ADD_PARTICIPANTS),s(0,m.operationId),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Array,Object,Object]),a("design:returntype",Promise)],t.prototype,"addParticipants",null),o([m.participantOperation(h.PARTICIPANT_OPERATIONS.REMOVE_PARTICIPANT),s(0,m.operationId),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[String,Object,String,Number]),a("design:returntype",Promise)],t.prototype,"removeParticipant",null),o([m.callOperation(h.CALL_OPERATIONS.SET_MAX_VIDEO_CHANNELS,{type:m.OPERATION_TYPE.CHAINED}),s(2,m.causeId),a("design:type",Function),a("design:paramtypes",[Number,String,Object]),a("design:returntype",Promise)],t.prototype,"setMaxVideoChannels",null),o([m.callOperation(h.CALL_OPERATIONS.CREATE_CONTENT_SHARING_SESSION,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),a("design:type",Function),a("design:paramtypes",[String,String,String,String]),a("design:returntype",Promise)],t.prototype,"createContentSharingSession",null),o([m.callOperation(h.CALL_OPERATIONS.ADD_GROUP_MODALITY,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY}),s(1,m.causeId),a("design:type",Function),a("design:paramtypes",[Object,Object]),a("design:returntype",Promise)],t.prototype,"addGroupModality",null),t}(O.default);t.default=V},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(4),o=n(25),a=n(6),s=n(1),l=n(3),c=SlimCore.Enums;t.DATA_SOURCE_ID_ANY=4294967294;var d=function(e){function t(t,n,r,i,a,s,l,d){var u=e.call(this,t.createChild(function(){return"SlimCoreElectronDataChannel"}),n,r)||this;u._call=i,u._slimcoreCallHandler=a,u._dataChannel=s,u._dataChannelUsers=l,u.id=d,u._dataChannelActive=!1,u._protocolDataSource=null,u._protocolDataSink=null,u._dataChannelAdapterSetInternalSourceSink=null,u._lastDataChannelState=c.DataChannelStatus.Unknown,u._asyncOperationHandler=new o.default(u._logger),u._logger.info("Setting DataChannel on all users");for(var p=0;p<u._dataChannelUsers.length;p++)if(u._dataChannelUsers[p])try{u._dataChannelUsers[p].setDataChannel(u)}catch(e){u._logger.error("Exception calling setDataChannel for i="+p+" error="+e)}return u._hookSlimCorePropertyChangedEvents(),u}return r(t,e),t.prototype.setAdapterSourceSinkCallback=function(e){this._dataChannelAdapterSetInternalSourceSink=e},t.prototype._hookSlimCorePropertyChangedEvents=function(){var e=this;this._registerDisposable(this._slimcoreInstance.handle("object-property-changed",{objectId:this.id,propKey:c.Property.DataChannelStatus},function(t){return e._onDataChannelStatusChanged(t.value)}));var t=this._getIntProperty(this._slimcoreCallHandler,this.id,c.Property.DataChannelStatus);this._onDataChannelStatusChanged(t)},t.prototype.start=function(e){var t=this;return this._dataChannelActive?(this._logger.info("start() called when channel already active"),Promise.resolve()):(this._asyncOperationHandler.hasPendingOperation(a.CALL_OPERATIONS.START_DATA_CHANNEL)?this._logger.info("start promise already exists, returning previous promise"):(this._asyncOperationHandler.createPendingOperation(a.CALL_OPERATIONS.START_DATA_CHANNEL),i.asap(function(){return t._startDataChannel(e)})),this._asyncOperationHandler.waitForOperation(a.CALL_OPERATIONS.START_DATA_CHANNEL))},t.prototype.stop=function(e){var t=this;return this._dataChannelActive?(this._asyncOperationHandler.hasPendingOperation(a.CALL_OPERATIONS.STOP_DATA_CHANNEL)?this._logger.info("stop promise already exists, returning previous promise"):(this._asyncOperationHandler.createPendingOperation(a.CALL_OPERATIONS.STOP_DATA_CHANNEL),i.asap(function(){return t._stopDataChannel(e)})),this._asyncOperationHandler.waitForOperation(a.CALL_OPERATIONS.STOP_DATA_CHANNEL)):(this._logger.info("stop() called when channel not active"),Promise.resolve())},t.prototype.registerDataSource=function(e){var t=this;return i.asap(function(){return t._dataChannel.registerDataSource(e)})},t.prototype.unregisterDataSource=function(e){var t=this;return i.asap(function(){return t._dataChannel.unregisterDataSource(e)})},t.prototype.registerDataSink=function(e){var t=this;return i.asap(function(){return t._dataChannel.registerDataSink(e)})},t.prototype.unregisterDataSink=function(e){var t=this;return i.asap(function(){return t._dataChannel.unregisterDataSink(e)})},t.prototype.sendUserEvents=function(e,t){var n=this;return i.asap(function(){return n._dataChannel.sendUserEvents(e,t)})},t.prototype._onDataChannelStatusChanged=function(e){if(this._logger.info("Data channel status = "+e),e===c.DataChannelStatus.Active){this._asyncOperationHandler.maybeResolveOperation(a.CALL_OPERATIONS.START_DATA_CHANNEL);try{this._dataChannel.setDataDevices()}catch(e){this._logger.error("setDataDevices threw exception: "+e)}this._dataChannel&&!this._dataChannelActive&&(this._dataChannelActive=!0,this._createAndAttachProtocolDevices(),this._dataChannelAdapterSetInternalSourceSink&&this._dataChannelAdapterSetInternalSourceSink(c.DataDeviceId.Protocol,this._protocolDataSource,this._protocolDataSink),this._logger.info("Data channel ready"))}else e===c.DataChannelStatus.Available&&(this._asyncOperationHandler.maybeResolveOperation(a.CALL_OPERATIONS.STOP_DATA_CHANNEL),this._dataChannel&&this._dataChannelActive&&(this._dataChannelActive=!1,this._detachAndDeleteProtocolDevices(),this._logger.info("Data channel disposed")));this._lastDataChannelState===c.DataChannelStatus.Starting&&e!==c.DataChannelStatus.Active?this._asyncOperationHandler.maybeRejectOperation(a.CALL_OPERATIONS.START_DATA_CHANNEL):this._lastDataChannelState===c.DataChannelStatus.Stopping&&e!==c.DataChannelStatus.Available&&this._asyncOperationHandler.maybeRejectOperation(a.CALL_OPERATIONS.STOP_DATA_CHANNEL);for(var n=0;n<this._dataChannelUsers.length;n++)try{this._dataChannelUsers[n].onDataChannelStatusChanged(e)}catch(e){this._logger.error("Exception calling onDataChannelStatusChanged for i="+n+" error="+e)}this._lastDataChannelState!==e&&(this.event("stateChange").raise(t._mapDataChannelStatus(e)),this._lastDataChannelState=e)},t.prototype._updateProtocolDataSource=function(e){this._logger.info("Setting Protocol DataSource on all users");for(var t=0;t<this._dataChannelUsers.length;t++)if(this._dataChannelUsers[t])try{this._dataChannelUsers[t].setProtocolDataSource(e)}catch(e){this._logger.error("Exception calling setProtocolDataSource for i="+t+" error="+e)}},t.prototype._createAndAttachProtocolDevices=function(){var e=this;if(this._logger.info("_createAndAttachProtocolDevices()"),s.hasCreateDataSource(this._slimcoreInstance)&&s.hasCreateDataSink(this._slimcoreInstance))if(this._dataChannel){if(!this._protocolDataSource){this._protocolDataSource=s.createDataSource(this._slimcoreInstance,c.DataDeviceId.Protocol);try{this._dataChannel.registerDataSource(this._protocolDataSource),this._logger.info("created Protocol data source")}catch(e){this._logger.error("registerDataSource threw exception: "+e)}}if(!this._protocolDataSink){this._protocolDataSink=s.createDataSink(this._slimcoreInstance,c.DataDeviceId.Protocol);try{this._dataChannel.registerDataSink(this._protocolDataSink),this._logger.info("created Protocol data sink")}catch(e){this._logger.error("registerDataSink threw exception: "+e)}}this._protocolDataSink.on("data",function(t){try{var n=JSON.parse(s.bufferToString(t.data));if(1!==n.type){n.type>=e._dataChannelUsers.length&&e._logger.error("Error calling processProtocolMessage i="+n.type+" error=Index out of bounds");try{var r=e._call.mapDataChannelSourceIdToParticipant(t.sourceID),i=void 0;r&&(i=r.getParticipantIdForSourceId(4,t.sourceID)),e._dataChannelUsers[n.type].processProtocolMessage(n.message,r,i,t.sourceID)}catch(t){e._logger.error("Error calling processProtocolMessage i="+n.type+" error="+t)}}}catch(t){e._logger.error("Error handling protocol message error="+t)}}),this._updateProtocolDataSource(this._protocolDataSource)}else this._logger.warn("_createAndAttachProtocolDevices() null dataChannel");else this._logger.warn("createDataSource or createDataSink not implemented")},t.prototype._detachAndDeleteProtocolDevices=function(){if(this._logger.info("_detachAndDeleteProtocolDevices()"),this._protocolDataSink&&this._protocolDataSink.removeAllListeners("data"),this._dataChannel){if(this._protocolDataSource){try{this._dataChannel.unregisterDataSource(this._protocolDataSource)}catch(e){this._logger.warn("unregisterDataSource threw exception for protocol, call probably ended: "+e)}this._protocolDataSource=null,this._updateProtocolDataSource(null),this._logger.info("deleted Protocol data source")}if(this._protocolDataSink){try{this._dataChannel.unregisterDataSink(this._protocolDataSink)}catch(e){this._logger.warn("unregisterDataSink threw exception for protocol, call probably ended: "+e)}this._protocolDataSink=null,this._logger.info("deleted Protocol data sink")}}else this._logger.warn("_detachAndDeleteProtocolDevices() null dataChannel")},t.prototype._startDataChannel=function(e){if(this._logger.info("_startDataChannel()"),this._dataChannel){try{this._dataChannel.start(e)}catch(e){this._logger.error("_dataChannel.start threw exception: "+e)}this._logger.info("Data channel started")}},t.prototype._stopDataChannel=function(e){if(this._logger.info("_stopDataChannel()"),this._dataChannel){try{this._dataChannel.stop(e)}catch(e){this._logger.error("_dataChannel.stop threw exception: "+e)}this._logger.info("Data channel stopping")}},t._mapDataChannelStatus=function(e){switch(e){case c.DataChannelStatus.Available:return 1;case c.DataChannelStatus.Starting:return 2;case c.DataChannelStatus.Active:return 3;case c.DataChannelStatus.Stopping:return 4;case c.DataChannelStatus.NotStarted:return 5;case c.DataChannelStatus.Unknown:default:return 0}},t.prototype.dispose=function(){this._logger.info("SlimCoreElectronDataChannel.dispose()"),this._detachAndDeleteProtocolDevices(),this._call=null,this._dataChannel&&(this._dataChannel.dispose&&this._dataChannel.dispose(),this._dataChannel=null),e.prototype.dispose.call(this)},t}(l.default);t.default=d},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i,o=n(8),a=n(2),s=n(9),l=n(5),c=n(10),d=150;!function(e){e.Pending="Pending",e.Success="Success",e.Failure="Failure"}(i||(i={}));var u;!function(e){e[e.Event=0]="Event",e[e.Operation=1]="Operation"}(u||(u={}));var p=function(){function e(e,t,n,r,o){this.eventName=e,this.eventStartTime=t,this.type=n,this.causeId=r,this.status=i.Pending,this.eventStartTimestamp=(new Date).getTime(),this.data=[],this.type===u.Event&&delete this.status,o&&this.data.push(o)}return Object.defineProperty(e.prototype,"variant",{set:function(e){this.eventVariant=e},enumerable:!0,configurable:!0}),e.prototype.recordSuccess=function(e,t){this.recordResult(!0,e,t)},e.prototype.recordFailure=function(e,t){this.recordResult(!1,e,t)},e.prototype.addData=function(e){this.data.push(e)},e.prototype.isPending=function(){return this.status===i.Pending},e.prototype.getEvent=function(){var e,t=this,n={start:this.eventStartTime,duration:this.duration,status:this.status,result:this.result,causeId:this.causeId,resultCauseId:this.resultCauseId,variant:this.eventVariant,data:this.data.map(function(e){return t.prepareData(e,!0)}).filter(function(e){return!!e})};return this.type===u.Event&&delete n.status,n.data.length||delete n.data,n.causeId||delete n.causeId,n.resultCauseId||delete n.resultCauseId,n.result||delete n.result,n.variant||delete n.variant,e={},e[this.eventName]=n,e},e.prototype.recordResult=function(e,t,n){this.status=e?i.Success:i.Failure,this.result=this.prepareData(t),this.causeId!==n&&(this.resultCauseId=n),this.duration=(new Date).getTime()-this.eventStartTimestamp},e.prototype.prepareData=function(e,t){void 0===t&&(t=!1);var n=typeof e;if(void 0===e||null===e)return"";if("string"===n)return l.scrubMriOrOmit(e);if("number"===n||"boolean"===n)return String(e);if("function"===n)return"";if(e instanceof Error)return e.toString();try{return Object.keys(e).length?t?e:s.getPIISafeObject(e):""}catch(e){return"invalid"}},e}();!function(e){e.LOCAL="Local",e.REMOTE="Remote"}(t.CALL_TERMINATING_END||(t.CALL_TERMINATING_END={}));!function(e){e.SUCCESS="Success",e.FAILURE="Failure"}(t.RESULT_VALUE||(t.RESULT_VALUE={}));!function(e){e.INCOMING="Incoming",e.OUTGOING="Outgoing"}(t.DIRECTION||(t.DIRECTION={}));!function(e){e.CALLER="caller",e.CALLEE="callee",e.JOIN="join",e.SUBSCRIBE="SUBSCRIBE"}(t.SELF_PARTICIPANT_ROLE||(t.SELF_PARTICIPANT_ROLE={}));var h=function(){function e(e,t,n){this.logger=e,this.startTime=t,this.maxEventsExceeded=n,this.recordedEvents=[],this.ongoingOperations={}}return e.prototype.recordEvent=function(e,t,n){void 0===n&&(n=a.generateCauseId()),this.logger.debug("Event:",e,o.pii.Omit(t));var r=new p(e,this.getEventStartTime(),u.Event,n,t);return this.pushToRecordedEvents(r),r},e.prototype.recordOperationSuccess=function(e,t,n,r){void 0===t&&(t=null),this.logger.info("Event success:",r,e,o.pii.Omit(n),o.pii.Omit(t)),this.recordOperationResult(e,t,!0,n,r)},e.prototype.recordOperationFailure=function(e,t,n,r){this.logger.info("Event failure:",e,o.pii.Omit(n),t),this.recordOperationResult(e,t,!1,n,r)},e.prototype.maybeRecordOperationSuccess=function(e,t,n,r){void 0===t&&(t=null),this.hasOngoingEvent(e,n)&&this.recordOperationSuccess(e,t,n,r)},e.prototype.maybeRecordOperationFailure=function(e,t,n,r){this.hasOngoingEvent(e,n)&&this.recordOperationFailure(e,t,n,r)},e.prototype.recordOperationResult=function(e,t,n,r,i){this.hasOngoingEvent(e,r)||this.recordOperation(e,i,r);var o=this.ongoingOperations[e];r&&(o=o[r]),n?o.recordSuccess(t,i):o.recordFailure(t,i),r?delete this.ongoingOperations[e][r]:delete this.ongoingOperations[e]},e.prototype.recordOperation=function(e,t,n){this.logger.debug("Event create: "+n,e,o.pii.Omit(n));var r=new p(e,this.getEventStartTime(),u.Operation,t);return this.ongoingOperations[e]||(this.ongoingOperations[e]={}),n?this.ongoingOperations[e][n]=r:this.ongoingOperations[e]=r,this.pushToRecordedEvents(r),r},e.prototype.setOperationVariant=function(e,t,n){var r;(r=n?this.ongoingOperations[e][n]:this.ongoingOperations[e])?r.variant=t:this.logger.error("Could not find operation "+e+" to set variant "+t)},e.prototype.updateOperationData=function(e,t,n,r){try{if(!this.ongoingOperations[e])return void this.recordEvent(e,t,n);r?this.ongoingOperations[e][r]&&this.ongoingOperations[e][r].addData(t):this.ongoingOperations[e].addData(t)}catch(t){return void this.logger.info("Unable to update operation: "+e+" data")}},e.prototype.pushToRecordedEvents=function(e){this.maxEventsExceeded&&this.maxEventsExceeded()&&this.recordedEvents.shift(),this.recordedEvents.push(e)},e.prototype.hasOngoingEvent=function(e,t){return this.ongoingOperations[e]?!(t&&!this.ongoingOperations[e][t])||(this.logger.warn("Unable to find event for name\\id "+e+"\\"+o.pii.Omit(t)),!1):(this.logger.warn("Unable to find event for name "+e),!1)},e.prototype.getEventStartTime=function(){return(new Date).getTime()-this.startTime},e.prototype.getEventTimestampBag=function(e){var t=JSON.stringify({eventStart:this.startTime,events:this.recordedEvents.filter(function(t){return!e||!t.isPending()}).map(function(e){return e.getEvent()})});return this.logger.info("Call eventTimestampBag "+o.pii.Omit(t)),t},e}();t.TelemetryUtilities=h;var g=function(e){function t(t,n){var r=e.call(this,t,n,function(){return r.inCallMode&&r.recordedEvents.length>d})||this;return r.inCallMode=!1,r.getHostName=function(){try{return location.host}catch(e){return"unknown"}},r.tsCallingVersion=c.getTsCallingVersion(),r.logger=t.createChild("CallTelemetry"),r}return r(t,e),t.prototype.setCallId=function(e){this.currentCallId&&(this.previousCallId=this.currentCallId),this.currentCallId=e},t.prototype.setConsultativeCallId=function(e){this.consultativeCallId=e},t.prototype.setEndpointId=function(e){this.endpointId=e},t.prototype.setParticipantId=function(e){this.participantId=e},t.prototype.setPreheatFlags=function(e){this.preheatFlags=e},t.prototype.setCallOrigin=function(e){this.origin=e},t.prototype.setThreadId=function(e){this.threadId=e},t.prototype.setMesageId=function(e){this.messageId=e},t.prototype.setApplicationType=function(e){this.applicationType=e},t.prototype.setRing=function(e){this.ring=e},t.prototype.setTenantId=function(e){this.tenantId=e},t.prototype.setRegion=function(e){this.region=e},t.prototype.setPartition=function(e){this.partition=e},t.prototype.setFailureType=function(e){this.failureType=e},t.prototype.setIsCast=function(e){this.isCast=e?"True":"False"},t.prototype.setIsEmergency=function(e){this.isEmergency=e?"True":"False"},t.prototype.setRole=function(e){this.isAnonymous="admin"===e?"False":"True"},t.prototype.setCallType=function(e){this.callType=e},t.prototype.setConversationType=function(e){this.conversationType=e},t.prototype.setDirection=function(e){this.direction=e},t.prototype.setSelfParticipantRole=function(e){this.selfParticipantRole=e},t.prototype.setTerminationState=function(e){this.terminationState=e},t.prototype.setTerminationReason=function(e){this.terminationReason=e},t.prototype.setCallEndDiagnosticInfo=function(e){this.callEndDiagnosticInfo=e},t.prototype.setStackConfig=function(e){this.stackConfig=e},t.prototype.getEvent=function(e){var t=function(e){return void 0===e?"":e};return{CorrelationId:t(this.currentCallId),PreviousCorrelationId:t(this.previousCallId),ConsultativeCallId:t(this.consultativeCallId),EndpointId:t(this.endpointId),ParticipantId:t(this.participantId),PreheatFlags:t(this.preheatFlags),CallType:t(this.callType),ConversationType:t(this.conversationType),Direction:t(this.direction),Origin:t(this.origin),SelfParticipantRole:t(this.selfParticipantRole),IsAnonymous:t(this.isAnonymous),ThreadId:t(this.threadId),MessageId:t(this.messageId),ApplicationType:t(this.applicationType),Ring:t(this.ring),TenantId:t(this.tenantId),Region:t(this.region),Partition:t(this.partition),FailureType:t(this.failureType),IsCast:t(this.isCast),IsEmergency:t(this.isEmergency),TsCallingVersion:t(this.tsCallingVersion),TerminationState:t(this.terminationState),TerminationReason:t(this.terminationReason),StackConfig:t(this.stackConfig),EventTimestampBag:this.getEventTimestampBag(e),HostName:this.getHostName(),DiagnosticInfo:this.callEndDiagnosticInfo}},t.prototype.switchToInCallTelemetry=function(){this.recordedEvents=this.recordedEvents.filter(function(e){return e.isPending()}),this.inCallMode=!0},t}(h);t.default=g,t.getEndpointInformationForTelemetry=function(e){return Array.isArray(e)?e.map(function(e){return{endpointId:e.endpointId,participantId:e.participantId}}):null}},function(e,t,n){"use strict";function r(e){return!(!e||!e.code)}Object.defineProperty(t,"__esModule",{value:!0});var i=n(6),o=n(9);t.isTransactionEnd=r,t.getRejectTransactionEnd=function(e){return r(e)?e:{code:i.TRANSACTION_END_CODE.CLIENT_ERROR,subCode:i.TRANSACTION_END_SUBCODE.LOCAL_REJECT,phrase:"string"==typeof e?e:o.getPrintableObject(e)}},t.getSuccessTransactionEnd=function(){return{code:i.TRANSACTION_END_CODE.SUCCESS}}},function(e,t,n){"use strict";function r(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}Object.defineProperty(t,"__esModule",{value:!0});var i,o=n(6),a=n(2),s=n(7);!function(e){e.CHAINED="Chained",e.SYNC="Sync",e.ASYNC="Async"}(i=t.OPERATION_TYPE||(t.OPERATION_TYPE={}));var l;!function(e){e[e.CALL=0]="CALL",e[e.PARTICIPANT=1]="PARTICIPANT"}(l||(l={})),t.callOperation=function(e,t){return c(l.CALL,e,t)},t.participantOperation=function(e,t){return c(l.PARTICIPANT,e,t)},t.operationId=function(e,t,n){if(e[t]._operationIdValue_)throw new Error("can not specify more than one operation id");e[t]._operationIdValue_=n},t.causeId=function(e,t,n){if(e[t]._causeIdValue_)throw new Error("can not specify more than one cause id");e[t]._causeIdValue_=n},t.callStartOptions=function(e,t,n){if(e[t]._callStartOptionsValue_)throw new Error("can not specify options more than once");e[t]._callStartOptionsValue_=n};var c=function(e,t,n){return function(l,c,u){var p=u.value,h=l[c]&&l[c]._operationIdValue_,g=l[c]&&l[c]._causeIdValue_,_=l[c]&&l[c]._callStartOptionsValue_,f=n&&n.type||i.ASYNC;return u.value=function(){for(var l=this,c=[],u=0;u<arguments.length;u++)c[u]=arguments[u];var m=this,C=void 0!==h?c[h]:void 0;if(void 0!==C)if(Array.isArray(C))try{var S=C.map(function(e){return e.toString()}).sort().concat().toString();C=r(S).toString()}catch(e){return Promise.reject(32)}else if(C&&"object"==typeof C)try{var y=JSON.stringify(C);n&&n.operationIdKey&&C.hasOwnProperty(n.operationIdKey)&&(y=C[n.operationIdKey]),C=y}catch(e){return Promise.reject(32)}var v=a.generateCauseId();void 0!==g&&(c[g]&&a.validateCauseId(c[g])?v=c[g]:c[g]=v);var I=d(m,e);if(I.logOperation(v,t),n&&n.singular&&I.hasPendingOperation(t))return I.logOperation(v,t,"Not allowed, pending operation exists"),Promise.reject(60);try{void 0!==_&&c[_]&&m.processCallStartOptions(c[_],v)}catch(e){return Promise.reject(32)}var T=!(!n||!n.convertError),O=function(){return f===i.CHAINED?I.executeChained(p.bind.apply(p,[l].concat(c)),t,C,v,T):f===i.SYNC?I.executeSync(p.bind.apply(p,[l].concat(c)),t,C,v,T):I.execute(p.bind.apply(p,[l].concat(c)),t,C,v,T)};if(t!==o.CALL_OPERATIONS.START_CALL&&t!==o.CALL_OPERATIONS.JOIN_CALL||I.hasPendingOperation(o.CALL_OPERATIONS_INTERNAL.CALL_START_OR_JOIN_INITIATED)||I.createPendingOperation(o.CALL_OPERATIONS_INTERNAL.CALL_START_OR_JOIN_INITIATED).catch(s.noop),n&&n.triggerAttach&&(I.hasPendingOperation(o.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY)||I.createPendingOperation(o.CALL_OPERATIONS_INTERNAL.ELECTRON_SLIMCORE_READY).catch(s.noop)),n&&n.type!==i.SYNC){var P=n&&n.waitFor;if(P&&I.hasPendingOperation(P))return I.waitForOperation(P,void 0,v).then(O,O)}return O()},u}},d=function(e,t){if(t===l.CALL)return e._callOperationHandler;if(t===l.PARTICIPANT)return e._participantOperationHandler;throw new Error("Unsupported operation handler type!")}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a=n(5),s=n(25),l=n(2),c=n(11),d=n(15),u=n(9),p=n(42),h=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.callTelemetry=n,i.logSuccess=function(e,t,n){i._logger.info(e+" execution succeeded, result="+(t?i.stringifyForLogging(t):"void")+", time="+n.duration())},i.logFailure=function(e,t,n){i._logger.info(e+" execution failed, reason="+i.stringifyForLogging(t)+", time="+n.duration())},i.stringifyForLogging=function(e){var t;if(e instanceof Error)t=e.toString()||"Unknown Error";else try{t=JSON.stringify(e)}catch(e){t="Unable to stringify data"}return t},i.convertToTransactionEndIfErrorOrString=function(e,t,n){if(i._logger.info("ecsEnableErrorConversion in operationHandler is: "+i._ecsEnableErrorConversion),t&&i._ecsEnableErrorConversion&&("string"==typeof e||e instanceof Error)){var r=d.getRejectTransactionEnd(e);return i._logger.info(n+" Error converted from "+e+" to "+u.getPrintableObject(r)),r}return e},i._logger=t.createChild("[Operation]"),i._chainedPromise=new c.default(i._logger.createChild("[Chained]")),i._ecsEnableErrorConversion=!!r,i}return r(t,e),t.prototype.resetOperationChain=function(e){this._chainedPromise.reset(e)},t.prototype.executeSync=function(e,t,n,r,i){void 0===r&&(r=l.generateCauseId());var o=this.getOperationInfoForLogging(r,t,n),a=p.build();this._logger.info(o+"API calledSync");var s,c=this.callTelemetry.recordOperation(t,r,n);try{s=e(),c.recordSuccess(s,r),this.logSuccess(o,s,a)}catch(e){var d=this.convertToTransactionEndIfErrorOrString(e,i,o);c.recordFailure(d,r),this.logFailure(o,d,a)}return s},t.prototype.executeChained=function(e,t,n,r,a){return void 0===r&&(r=l.generateCauseId()),i(this,void 0,void 0,function(){return o(this,function(i){return[2,this.checkPendingOperationAndExecute(e,!0,t,n,r,a)]})})},t.prototype.execute=function(e,t,n,r,a){return void 0===r&&(r=l.generateCauseId()),i(this,void 0,void 0,function(){return o(this,function(i){return[2,this.checkPendingOperationAndExecute(e,!1,t,n,r,a)]})})},t.prototype.logOperation=function(e,t){for(var n=this,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];var o=r.length&&r.map(function(e){return n.stringifyForLogging(a.scrubMriOrOmit(e))});this._logger.info("["+e+"]["+t+"]API called, "+(o?"with args="+o:""))},t.prototype.rejectPendingOperations=function(t,n,r){if(void 0===n&&(n=l.generateCauseId()),r){for(var i=0,o=Object.keys(this._deferredOperations);i<o.length;i++){c=o[i];this.callTelemetry.maybeRecordOperationFailure(c,r,void 0,n)}for(var a=0,s=Object.keys(this._deferredOperationsWithOperationId);a<s.length;a++)for(var c=s[a],d=0,u=Object.keys(this._deferredOperationsWithOperationId[c]);d<u.length;d++){var p=u[d];this.callTelemetry.maybeRecordOperationFailure(c,r,p,n)}}e.prototype.rejectPendingOperations.call(this,t,n)},t.prototype.checkPendingOperationAndExecute=function(e,t,n,r,i,o){var a=this;void 0===i&&(i=l.generateCauseId());var s=this.getOperationInfoForLogging(i,n,r),c=null,d=null;return this.hasPendingOperation(n,r)?(this._logger.info(s+"already pending, returning existing operation"),c=this.waitForOperation(n,r,i)):d=this.createPendingOperation(n,r,i),t?(this._logger.info(s+"chained"),this._chainedPromise.chainPromise(function(){return c||a.executeInternal(d,i,e,n,r,o)},n,i)):c||this.executeInternal(d,i,e,n,r,o)},t.prototype.executeInternal=function(e,t,n,r,a,s){return i(this,void 0,void 0,function(){var i,l,c,d,u;return o(this,function(o){switch(o.label){case 0:i=this.getOperationInfoForLogging(t,r,a),this._logger.info(i+" executing operation..."),l=p.build(),this.callTelemetry.recordOperation(r,t,a),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n()];case 2:return c=o.sent(),this.callTelemetry.maybeRecordOperationSuccess(r,c,a),this.logSuccess(i,c,l),this.maybeResolveOperation(r,c,a,t),[3,4];case 3:return d=o.sent(),u=this.convertToTransactionEndIfErrorOrString(d,s,i),this.callTelemetry.maybeRecordOperationFailure(r,u,a),this.logFailure(i,u,l),this.maybeRejectOperation(r,u,a,t),[3,4];case 4:return[2,e]}})})},t}(s.default);t.default=h},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=n(1),a=n(3),s=n(19),l=SlimCore.Enums,c=n(7),d=function(e){function t(t,n,r,i,a,s,c,d){void 0===d&&(d=!1);var u=e.call(this,t.createChild(function(){return"SlimCoreElectronRemoteStreamManager["+u._slimcoreParticipantObjectId+"]"}),n,r)||this;return u._callHandler=i,u._slimcoreParticipantObjectId=a,u._streams=s,u._streamContextMap=c,u._logger.info("constructor"),o.hasFeature(l.Feature.RemoteVideosCountChanged)||u._registerDisposable(u._slimcoreInstance.handle("object-property-changed",{objectId:u._slimcoreParticipantObjectId,propKey:l.Property.ParticipantVideoCountChanged},function(e){return u._onVideoCountChangedDeferred()})),u._registerDisposable(u._callHandler.handle("remote-videos-count-changed",{participantObjectId:u._slimcoreParticipantObjectId},function(e){return u._onVideoCountChangedDeferred()})),d||u._onVideoCountChangedDeferred(),u}return r(t,e),t.prototype._onVideoCountChangedDeferred=function(){var e=this;this._onVideoCountChangedDefer||(this._onVideoCountChangedDefer=i.defer(function(){delete e._onVideoCountChangedDefer,e._onVideoCountChanged()}))},t.prototype._onVideoCountChanged=function(){var e=this,t=this._callHandler.callGetParticipantVideos(this._slimcoreParticipantObjectId);if(t){var n={};n[l.VideoType.Video]=[],n[l.VideoType.ScreenShare]=[],t.forEach(function(t){var r=e._getIntProperty(e._callHandler,t,l.Property.VideoType),i=e._getIntProperty(e._callHandler,t,l.Property.VideoStatus);r!==l.VideoType.Augmented&&n[r].push({videoObjectId:t,videoType:r,videoStatus:i})}),this._handleVideoCountChanged(l.VideoType.Video,n[l.VideoType.Video]),this._handleVideoCountChanged(l.VideoType.ScreenShare,n[l.VideoType.ScreenShare]),this.raiseChanged()}},t.prototype._handleVideoCountChanged=function(e,n){var r=this,o=t.SlimcoreVideoTypeToStreamType(e),a=this._streams[o],l=i.filter(a,function(e){return!i.some(n,function(t){return t.videoObjectId===e.id})});i.each(l,function(e){r._logger.info("_handleVideoCountChanged: removing stream "+e.id+" (stream type: "+o+")"),i.remove(a,e),e.dispose()}),i.each(n,function(e){if(!i.some(a,function(t){return t.id===e.videoObjectId})){r._logger.info("_handleVideoCountChanged: adding stream "+e.videoObjectId+" (stream type: "+o+")");var t=new s.default(r._logger,r._settings,r._slimcoreInstance,r._slimcoreParticipantObjectId,e.videoObjectId,o,r._callHandler,r._streamContextMap[o]);r._streams[o].push(t),t.changed(function(){return r.raiseChanged()})}})},t.prototype.stopVideos=function(){this._logger.info("stopVideos");var e=function(e){return e.disposeInternal()};return Promise.all(i.flatMap(i.values(this._streams),function(t){return i.map(t,e)})).then(c.noop)},t.prototype.dispose=function(){this._logger.info("dispose"),i.each(i.values(this._streams),function(e){return i.each(e,function(e){return e.dispose()})}),this._streams[0]=[],this._streams[1]=[],e.prototype.dispose.call(this)},t.SlimcoreVideoTypeToStreamType=function(e){switch(e){case l.VideoType.ScreenShare:return 1;case l.VideoType.Video:return 0;default:return}},t}(a.default);t.default=d},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a=n(4),s=n(2),l=n(11),c=n(1),d=n(3),u=n(28),p=SlimCore.Enums,h=function(){return function(e){this.nrRunningStreams=0,this.videoStoppedEvent=new c.VideoStateCancelEvent}}();t.SlimCoreElectronRemoteStreamContext=h;var g=0,_=function(e){function t(t,n,r,i,o,a,d,u){var h=e.call(this,t.createChild(function(){return"RemoteStream("+h._context.nrRunningStreams+")["+h._remoteVideoId+":"+h.rank+":"+h._mediaType+":"+h._videoStatus+"]"}),n,r)||this;h._participantId=i,h.id=o,h.type=a,h._callHandler=d,h._context=u,h._remoteVideoId=0,h._videoStatus=p.VideoStatus.None,h._stateCancelEvent=new c.VideoStateCancelEvent,h._shouldRun=!1,h._isDisposed=!1,h._nrRenderers=0,h._nrOngoingStreamStarts=0,h._msi=0,h._chainedApiPromise=new l.default(t.createChild(function(){return"RemoteStreamChain("+h._context.nrRunningStreams+")"})),h._remoteVideoId=o,h.rank=g++;var _=h._getProperties(h._callHandler,h._remoteVideoId,{endpointId:{propKey:p.Property.VideoEndpointId},participantId:{propKey:p.Property.VideoParticipantLegId},negotiationTag:{propKey:p.Property.VideoNegotiationTag},label:{propKey:p.Property.VideoLabel}},{mediaType:{propKey:p.Property.VideoType},videoStatus:{propKey:p.Property.VideoStatus},msi:{propKey:p.Property.VideoRank}});h._mediaType=_.mediaType,h._videoStatus=_.videoStatus;var f=s.generateCauseId();return h._onVideoObjectPropertyChanged(p.Property.VideoStatus,function(e){return h._onVideoObjectStateChanged(f)}),h._onVideoObjectPropertyChanged(p.Property.VideoNegotiationTag,function(e){return h._onVideoNegotiationTagChanged(e.value)}),h.endpointId=_.endpointId,h.participantId=_.participantId,h._msi=_.msi,h.negotiationTag=_.negotiationTag,h.label=_.label,h._logger.info("constructor: endpointId: "+h.endpointId+", participantId: "+h.participantId+", negotiationTag: "+h.negotiationTag+", causeId: "+f+", label: "+h.label),h}return r(t,e),t.prototype.getDiagnosticData=function(){return JSON.stringify({id:this.id,rank:this.rank,type:this.type,isAvailable:this.isAvailable,isStreaming:this.isStreaming,negotiationTag:this.negotiationTag,video_status:this._videoStatus,msi:this._msi,shouldRun:this._shouldRun,nrRenderers:this._nrRenderers,isDisposed:this._isDisposed})},Object.defineProperty(t.prototype,"isAvailable",{get:function(){return c.isVideoAvailable(this._videoStatus)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isStreaming",{get:function(){return this._videoStatus===p.VideoStatus.Running},enumerable:!0,configurable:!0}),t.prototype.isActive=function(){return this.isAvailable&&this.isStreaming},t.prototype.start=function(e,t){return i(this,void 0,void 0,function(){var n,r,i,a,l,d,u,p,h=this;return o(this,function(o){switch(o.label){case 0:n=Date.now(),r=n,i=n,a=s.generateCauseId(),this._shouldRun=!0,this._nrOngoingStreamStarts++,this._logger.info("start causeId: "+a),o.label=1;case 1:return o.trys.push([1,8,9,10]),[4,c.waitForVideoObjectToBeAvailable(this._slimcoreInstance,this._callHandler,this._remoteVideoId,this._logger,0,this._stateCancelEvent)];case 2:return o.sent(),r=Date.now(),[4,this._chainedApiPromise.chainPromise(function(){return h._startVideo(a,e,t)},this._chainActionFn("start"),a)];case 3:l=o.sent(),i=Date.now(),o.label=4;case 4:return o.trys.push([4,6,,7]),this._throwIfDisposed(a,"disposed while in start"),[4,c.waitForVideoObjectToBeRunning(this._slimcoreInstance,this._callHandler,this._remoteVideoId,this._logger,0,this._stateCancelEvent)];case 5:return o.sent(),this._updateVideoStatus(a),p=Date.now(),this._logger.info("start causeId: "+a+" successful. duration: "+(p-n)+" ("+(r-n)+"+"+(i-r)+"+"+(p-i)+")"),[2,l];case 6:throw d=o.sent(),l.dispose(a),d;case 7:return[3,10];case 8:throw u=o.sent(),p=Date.now(),this._logger.warn("start causeId: "+a+" failed. duration: "+(p-n)+" ("+(r-n)+"+"+(i-r)+"+"+(p-i)+") error: "+u),u;case 9:return this._nrOngoingStreamStarts--,[7];case 10:return[2]}})})},t.prototype.stop=function(){return i(this,void 0,void 0,function(){var e;return o(this,function(t){switch(t.label){case 0:return e=s.generateCauseId(),[4,this._stopWithCauseId(this._chainActionFn("stop"),e)];case 1:return t.sent(),[2]}})})},t.prototype.dispose=function(e){void 0===e&&(e=s.generateCauseId()),this._disposeWithCauseId(this._chainActionFn("dispose"),e)},t.prototype.disposeInternal=function(){return i(this,void 0,void 0,function(){var e;return o(this,function(t){switch(t.label){case 0:return e=s.generateCauseId(),[4,this._disposeWithCauseId(this._chainActionFn("disposeInternal"),e)];case 1:return t.sent(),[2]}})})},t.prototype._stopWithCauseId=function(e,t){return i(this,void 0,void 0,function(){var n=this;return o(this,function(r){switch(r.label){case 0:return this._shouldRun=!1,this._stateCancelEvent.fire(),[4,this._chainedApiPromise.chainPromise(function(){return n._stopVideo(t,!1)},e,t)];case 1:return r.sent(),[2]}})})},t.prototype.registerRenderer=function(e){this._nrRenderers++},t.prototype.unregisterRenderer=function(e){if(0==--this._nrRenderers&&0===this._nrOngoingStreamStarts){var t=s.generateCauseId();this._stopWithCauseId(this._chainActionFn("renderers disposed"),t)}},t.prototype._chainActionFn=function(e){var t=this;return function(){return e+" ["+t._participantId+":"+t._remoteVideoId+":"+t.rank+":"+t._mediaType+":"+t._videoStatus+"]"}},t.prototype._isVideoStatusInStopping=function(){return this._videoStatus===p.VideoStatus.Stopping},t.prototype._updateVideoStatus=function(e){var t=this._getIntProperty(this._callHandler,this._remoteVideoId,p.Property.VideoStatus);this._videoStatus!==t&&(this._logger.info("VideoStateChanged: causeId: "+e+" status: "+this._videoStatus+" -> "+t),this._videoStatus=t,this._isVideoStatusInStopping()&&this._videoWasStopped(e),this.raiseChanged())},t.prototype._disposeWithCauseId=function(e,t){return i(this,void 0,void 0,function(){var n=this;return o(this,function(r){switch(r.label){case 0:return this._isDisposed=!0,this._shouldRun=!1,this._stateCancelEvent.fire(),[4,this._chainedApiPromise.chainPromise(function(){return n._dispose(t)},e,t)];case 1:return r.sent(),[2]}})})},t.prototype._onVideoObjectPropertyChanged=function(e,t){this._onObjectPropertyChanged(this.id,e,t)},t.prototype._onVideoObjectStateChanged=function(e){this._updateVideoStatus(e)},t.prototype._onVideoNegotiationTagChanged=function(e){this.negotiationTag!==e&&(this.negotiationTag=e,this.raiseChanged())},t.prototype._videoWasStopped=function(e){this._stopWithCauseId(this._chainActionFn("discovered video stopped"),e)},t.prototype._isRunning=function(){return!!this._videoBinding},t.prototype._stopVideo=function(e,t){return i(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return this._shouldRun&&!t&&!this._isVideoStatusInStopping()||!this._isRunning()?[3,3]:(this._logger.info("_stopVideo causeId: "+e+" force: "+t+" will stop remote video now"),this._slimcoreInstance.videoStop(this._remoteVideoId),[4,c.forgetAndLog(this._slimcoreInstance.videoReleaseBinding(this._remoteVideoId,this._videoBinding),this._logger,"_stopVideo causeId: "+e+" videoReleaseBinding on remote video")]);case 1:return n.sent(),this._videoBinding=null,[4,c.waitForVideoObjectToBeStopped(this._slimcoreInstance,this._callHandler,this._remoteVideoId,this._logger)];case 2:return n.sent(),this._context.nrRunningStreams--,this._logger.info("_stopVideo causeId: "+e+" force: "+t+" remote video is stopped"),this._updateVideoStatus(e),this._context.videoStoppedEvent.fire(),[3,4];case 3:this._logger.info("_stopVideo causeId: "+e+" noop, force: "+t+" should run: "+this._shouldRun+" is running: "+this._isRunning()+" already disposed: "+this._isDisposed),n.label=4;case 4:return[2]}})})},t.prototype._startVideo=function(e,t,n){return i(this,void 0,void 0,function(){var r,i;return o(this,function(o){switch(o.label){case 0:return[4,this._getStartedVideo(e)];case 1:r=o.sent(),o.label=2;case 2:return o.trys.push([2,3,,6]),this._updateVideoStatus(e),this._logger.info("_startVideo causeId: "+e+" create renderer"),[2,new u.default(this._logger,this._settings,null,t,this._mediaType,this._videoBinding,n,this)];case 3:return i=o.sent(),r?[4,c.forgetAndLog(this._stopVideo(e,!0),this._logger,"_startVideo causeId: "+e+" stopping remote video while got error while starting video")]:[3,5];case 4:o.sent(),o.label=5;case 5:throw i;case 6:return[2]}})})},t.prototype._dispose=function(t){return i(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return n.trys.push([0,,2,3]),[4,this._stopVideo(t,!0)];case 1:return n.sent(),[3,3];case 2:return e.prototype.dispose.call(this,t),[7];case 3:return[2]}})})},t.prototype._getStartedVideo=function(e){return i(this,void 0,void 0,function(){var t;return o(this,function(n){switch(n.label){case 0:if(this._throwIfDisposed(e,"disposed while in _getStartedVideo"),!this._shouldRun)throw new Error("_getStartedVideo causeId: "+e+" failing, should not run any more");return this._isRunning()?[3,5]:(this._logger.info("_getStartedVideo causeId: "+e+" will start remote video now"),t=this._createVideoBindingRenderer(e),this._slimcoreInstance.videoStart(this._remoteVideoId),this._settings.enableRemoteStreamVideoBindingRetry?[4,this._videoCreateBinding(e,this._remoteVideoId,t)]:[3,2]);case 1:return n.sent(),[3,4];case 2:return[4,this._slimcoreInstance.videoCreateBinding(this._remoteVideoId,t)];case 3:n.sent(),n.label=4;case 4:return this._context.nrRunningStreams++,this._videoBinding=t,this._logger.info("_getStartedVideo causeId: "+e+" remote video is started"),[2,!0];case 5:return[2,!1]}})})},t.prototype._throwIfDisposed=function(e,t){if(this._isDisposed)throw new Error("_throwIfDisposed causeId: "+e+" reason: "+t)},t.prototype._createVideoBindingRenderer=function(e){return this._slimcoreInstance.createVideoBindingRenderer?(this._logger.info("_createVideoBindingRenderer causeId: "+e+" createVideoBindingRenderer"),this._slimcoreInstance.createVideoBindingRenderer({enableDXVA:this._settings.enableDXVA,isLocalPreview:!1})):(this._logger.info("_createVideoBindingRenderer causeId: "+e+" old createVideoBindingRenderer"),SlimCore.createVideoBindingRenderer())},t.prototype._videoCreateBinding=function(e,t,n){return i(this,void 0,void 0,function(){var r,s,l,d,u,p,h,g=this;return o(this,function(_){switch(_.label){case 0:r=10,s=200,l=a.defer(),d=this._stateCancelEvent.subscribe(function(){l.reject(new Error("_videoCreateBinding causeId: "+e+" stateCancelEvent got signalled"))}),u=a.defer(),p=this._context.videoStoppedEvent.subscribe(function(){g._logger.info("_videoCreateBinding causeId: "+e+" one of the videos was stopped will wake up for binding retry"),u.resolve()}),_.label=1;case 1:return _.trys.push([1,,3,4]),h=function(d){return i(g,void 0,void 0,function(){var i,p;return o(this,function(o){switch(o.label){case 0:if(this._throwIfDisposed(e,"disposed while in _videoCreateBinding on retry attempt: "+d),!c.isVideoAvailable(this._videoStatus))throw new Error("_videoCreateBinding causeId: "+e+" video not available any more on retry attempt: "+d);i=u.promise,u=a.defer(),this._logger.info("_videoCreateBinding causeId: "+e+" try to create video binding from slimcore on retry attempt: "+d),o.label=1;case 1:return o.trys.push([1,3,,6]),[4,this._slimcoreInstance.videoCreateBinding(t,n)];case 2:return o.sent(),[3,6];case 3:if(p=o.sent(),!(d<r))throw new Error("_videoCreateBinding causeId: "+e+" retry attempt: "+d+" exceed");return[4,Promise.race([i,u.promise,l.promise,a.delay(s)])];case 4:return o.sent(),[4,h(d+1)];case 5:return o.sent(),[3,6];case 6:return[2]}})})},[4,h(1)];case 2:return _.sent(),[3,4];case 3:return d.dispose(),p.dispose(),[7];case 4:return[2]}})})},t}(d.default);t.default=_},function(e,t,n){"use strict";function r(e){switch(e){case i.ParticipantFailureReason.NoFailure:case i.ParticipantFailureReason.HostEndedConf:return 0;case i.ParticipantFailureReason.AnsweredElsewhere:return 23;case i.ParticipantFailureReason.RecipientUserNotFound:case i.ParticipantFailureReason.RecipientNotOnline:case i.ParticipantFailureReason.PstnCouldNotConnectToSkypeProxy:case i.ParticipantFailureReason.CallNotificationDeliveryFailure:return 4;case i.ParticipantFailureReason.RecipientBlocked:return 5;case i.ParticipantFailureReason.CallerNotFriend:case i.ParticipantFailureReason.CallerNotAuthorized:return 6;case i.ParticipantFailureReason.ConfParticipantCountLimitReached:return 46;case i.ParticipantFailureReason.ConfLobbyParticipantCountLimitReached:return 59;case i.ParticipantFailureReason.PstnNoSkypeoutSubscription:return 7;case i.ParticipantFailureReason.CallNotFound:return 8;case i.ParticipantFailureReason.PstnNetworkError:case i.ParticipantFailureReason.PstnInternetConnectionLost:case i.ParticipantFailureReason.TrouterError:case i.ParticipantFailureReason.GeneralNetworkError:return 9;case i.ParticipantFailureReason.MediaDroppedError:case i.ParticipantFailureReason.SoundRecordingError:case i.ParticipantFailureReason.SoundPlaybackError:return 10;case i.ParticipantFailureReason.PstnInsufficientFunds:return 12;case i.ParticipantFailureReason.PstnCreditExpired:return 26;case i.ParticipantFailureReason.PstnCreditExpiredButEnough:return 27;case i.ParticipantFailureReason.MiscError:case i.ParticipantFailureReason.PstnMiscError:return 11;case i.ParticipantFailureReason.PstnSkypeoutAccountBlocked:return 13;case i.ParticipantFailureReason.PstnBlockedByUs:return 15;case i.ParticipantFailureReason.PstnBlockedRegulatoryIndia:return 16;case i.ParticipantFailureReason.PstnInvalidNumber:return 17;case i.ParticipantFailureReason.PstnNumberForbidden:return 18;case i.ParticipantFailureReason.PstnCallTimedOut:return 2;case i.ParticipantFailureReason.PstnBusy:return 19;case i.ParticipantFailureReason.PstnCallTerminated:return 20;case i.ParticipantFailureReason.PstnNumberUnavailable:return 21;case i.ParticipantFailureReason.PstnCallRejected:return 3;case i.ParticipantFailureReason.PstnEmergencyCallDenied:return 22;case i.ParticipantFailureReason.PstnNoSubscriptionCover:return 25;case i.ParticipantFailureReason.EnterprisePstnForbidden:return 30;case i.ParticipantFailureReason.EnterprisePstnInternalError:return 28;case i.ParticipantFailureReason.EnterprisePstnUnavailable:return 29;case i.ParticipantFailureReason.EnterprisePstnInvalidNumber:return 31;case i.ParticipantFailureReason.EnterprisePstnMiscError:return 32;case i.ParticipantFailureReason.Kicked:return 33;case i.ParticipantFailureReason.NetworkRequestTimeoutError:return 34;case i.ParticipantFailureReason.CallDoesNotExist:return 35;case i.ParticipantFailureReason.MediaSetupFailure:return 36;case i.ParticipantFailureReason.ServiceUnavailable:return 37;case i.ParticipantFailureReason.SignalingError:return 38;case i.ParticipantFailureReason.ConversationEstablishmentFailed:return 39;case i.ParticipantFailureReason.TemporarilyUnavailable:return 40;case i.ParticipantFailureReason.NetworkCannotConnectError:return 41;case i.ParticipantFailureReason.NoSignalingFromPeer:return 42;case i.ParticipantFailureReason.AnonymousJoinDisabledByPolicy:return 53;case i.ParticipantFailureReason.NoLobbyForBroadcastJoin:return 54;case i.ParticipantFailureReason.NotAllowedDueToInformationBarrier:return 55;case i.ParticipantFailureReason.BroadcastLimitReached:return 56;case i.ParticipantFailureReason.B2bJoinDisabledByPolicy:return 57;case i.ParticipantFailureReason.LocationBasedRoutingError:return 58;case i.ParticipantFailureReason.Forbidden:return 52;default:return 11}}Object.defineProperty(t,"__esModule",{value:!0});var i=SlimCore.Enums;t.convertVideoEffectType=function(e){switch(e){case 0:return i.VideoEffectType.Off;case 1:return i.VideoEffectType.BackgroundBlurDefault;case 2:return i.VideoEffectType.BackgroundBlurLight;case 4:return i.VideoEffectType.BackgroundBlurExperimental_1;case 8:return i.VideoEffectType.BackgroundBlurExperimental_2;case 16:return i.VideoEffectType.BackgroundReplacement;case 32:return i.VideoEffectType.WhiteboardZoom;case 64:return i.VideoEffectType.WhiteboardCleanup;case 128:return i.VideoEffectType.WhiteboardMotionDetection;case 96:return i.VideoEffectType.WhiteboardZoomAndCleanup;case 192:return i.VideoEffectType.WhiteboardCleanupAndMotion;case 224:return i.VideoEffectType.WhiteboardZoomAndCleanupAndMotion;default:return i.VideoEffectType.Off}},t.convertStatusAndFailureReasonToParticipantReason=function(e,t){switch(e){case i.CallStatus.Busy:return 19;case i.CallStatus.CallTimedOut:return 9;case i.CallStatus.Cancelled:return 23;case i.CallStatus.Dropped:return 10;case i.CallStatus.Refused:return 3;case i.CallStatus.Missed:return 2;case i.CallStatus.Failed:return r(t);default:return 0}},t.convertFailureReasonToParticipantReason=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(9),i=function(){function e(e){var t=this;this._callingLogger=e,this._maybeLog=function(e){for(var n,i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];try{(n=t._callingLogger)[e].apply(n,i)}catch(e){t._callingLogger.info("[failed to log]",r.getPrintableObject(e))}}}return e.prototype.getPrefix=function(e,t){var n="";return t&&(n+="["+t+"]"),e&&(n+="["+e+"]"),n},e.prototype.createChild=function(t,n){return new e(this._callingLogger.createChild(t,n))},e.prototype.createFnLogger=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new e(this._callingLogger.createChild(this.getPrefix(t,n)+r.join(""),!1))},e.prototype.logSuccess=function(e){this._maybeLog("info","success="+e+"}")},e.prototype.logFailure=function(e){var t=r.getPrintableObject(e);this._maybeLog("info","failed="+t+"}")},e.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._maybeLog.apply(this,["log"].concat(e))},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._maybeLog.apply(this,["debug"].concat(e))},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._maybeLog.apply(this,["info"].concat(e))},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._maybeLog.apply(this,["warn"].concat(e))},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._maybeLog.apply(this,["error"].concat(e))},e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=SlimCore.Enums,o=function(){function e(e){this._slimcoreInstance=e}return e.prototype.setEcsConfig=function(e){try{return this._slimcoreInstance.setEcsConfig(e.ecsBlob,e.userIdentity,e.etag,!0),Promise.resolve()}catch(e){return Promise.reject(e)}},e.prototype.shouldTriggerCQF=function(e,t,n){var o=this,a=function(n){var r=i.CallType.CallTypeS2s;return 0===n?r=i.CallType.CallTypeGroup:2===n?r=i.CallType.CallTypePstn:1===n&&(r=i.CallType.CallTypeS2s),o._slimcoreInstance.shouldTriggerCQF(e,t,r)};return r.asap(function(){return a(n)})},e.prototype.getEcsQueryParameters=function(){try{return Promise.resolve(this._slimcoreInstance.getEcsQueryParameters())}catch(e){return Promise.reject(e)}},e}();t.default=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=function(){function e(e,t){this._slimcoreInstance=e,this._accountIdentity=t}return e.prototype.getSetup=function(){var e=this;return new Promise(function(t,n){r.hasFeature(SlimCore.Enums.Feature.MultiUserSupport)?(e._setup||(e._setup=e._slimcoreInstance.getSetup(e._accountIdentity)),t(e._setup)):n("No Multiuser support")})},e.prototype.setString=function(e,t){var n=this;return this.getSetup().then(function(){return n._setup.setStr(e,t)}).catch(function(){return n._slimcoreInstance.setupSetStr(e,t)})},e.prototype.setNumber=function(e,t){var n=this;return this.getSetup().then(function(){return n._setup.setInt(e,t)}).catch(function(){return n._slimcoreInstance.setupSetInt(e,t)})},e.prototype.getString=function(e){var t=this;return this.getSetup().then(function(){return t._setup.getStr(e)}).catch(function(){return t._slimcoreInstance.setupGetStr(e)})},e.prototype.getNumber=function(e){var t=this;return this.getSetup().then(function(){return t._setup.getInt(e)}).catch(function(){return t._slimcoreInstance.setupGetInt(e)})},e.prototype.delete=function(e){var t=this;return this.getSetup().then(function(){return t._setup.delete(e)}).catch(function(){return t._slimcoreInstance.setupDelete(e)})},e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(){function e(e){this.subscriptions=[],this.eventLogger=e}return e.prototype.subscribe=function(e){return new o(this.subscriptions,e)},e.prototype.dispose=function(e){this.subscriptions=[]},e.prototype.raiseEvents=function(e){var t=this;this.subscriptions.slice().forEach(function(n){try{void 0!==n.eventHandler&&e(n.eventHandler)}catch(e){t.eventLogger&&t.eventLogger.warn&&t.eventLogger.warn("Event handler exception caught!",e)}})},e}();t.EventSourceImpl=i;var o=function(){function e(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}return e.prototype.dispose=function(){var e=this;r.remove(this.subscriptions,function(t){return t===e}),this.eventHandler=void 0},e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),i=n(5),o=n(4),a=n(2),s=n(9),l=function(){function e(e){var t=this;this._disposed=!1,this._logger=e.createChild("[ASYNC]"),this._endOperationDeferred=o.defer(),this._endOperationDeferred.promise.catch(function(e){t._logger.info("Rejected all operations")}),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._deferredOperationsWithCauseId={},this._logger=e}return e.prototype.registerPromise=function(e,t){var n=!1,r=function(){n=!0};t.then(r,r);var i=this._endOperationDeferred.promise.catch(function(t){if(!n)throw new Error("Operation "+e+" did not complete, reason:"+t)});return Promise.race([i,t])},e.prototype.updateOperationId=function(e,t){var n=this;this._logger.info("updateOperationId "+e+" "+t),Object.keys(this._deferredOperationsWithOperationId).forEach(function(r){r&&n._deferredOperationsWithOperationId[r]&&(n._logger.info("_deferredOperationsWithOperationId "+r),Object.keys(n._deferredOperationsWithOperationId[r]).forEach(function(i){i&&n._deferredOperationsWithOperationId[r][i]&&(n._logger.info("_deferredOperationsWithOperationId "+i+" "+t),i===e&&(n._deferredOperationsWithOperationId[r][t]=n._deferredOperationsWithOperationId[r][i],delete n._deferredOperationsWithOperationId[r][i]))}))}),Object.keys(this._deferredOperationsWithCauseId).forEach(function(r){r&&n._deferredOperationsWithCauseId[r]&&(n._logger.info("_deferredOperationsWithCauseId "+r),Object.keys(n._deferredOperationsWithCauseId[r]).forEach(function(i){i&&n._deferredOperationsWithCauseId[r][i]&&(n._logger.info("_deferredOperationsWithCauseId "+i+" "+t),i===e&&(n._deferredOperationsWithOperationId[r][t]=n._deferredOperationsWithOperationId[r][i],delete n._deferredOperationsWithOperationId[r][i]))}))})},e.prototype.createPendingOperation=function(e,t,n){var s=this;void 0===n&&(n=a.generateCauseId());var l=o.defer();l.promise.catch(r.noop);var c=this.getOperationInfoForLogging(n,e,t);if(this._logger.info(c+"[creating...]"),this._disposed)return this._logger.info(c+"[create failed, call is disposed]"),Promise.reject(60);if(t){if(this._deferredOperationsWithOperationId[e]||(this._deferredOperationsWithOperationId[e]={}),this._deferredOperationsWithOperationId[e][t])return this._logger.warn(c+" Deferred operation with given name and operation id is already defined"),Promise.reject(new Error("Deferred operation with given name is already defined:"+e+"/"+i.scrubMriOrOmit(t)));this._deferredOperationsWithOperationId[e][t]={deferred:l,causeId:n},this._deferredOperationsWithCauseId[n]||(this._deferredOperationsWithCauseId[n]={}),this._deferredOperationsWithCauseId[n][t]=l}else{if(this._deferredOperations[e])return this._logger.warn(c+" Deferred operation with given name is already defined"),Promise.reject(new Error("Deferred operation with given name is already defined:"+e));this._deferredOperationsWithCauseId[n]||(this._deferredOperationsWithCauseId[n]={}),this._deferredOperationsWithCauseId[n][""]=l,this._deferredOperations[e]={deferred:l,causeId:n}}var d=this._endOperationDeferred.promise.catch(function(n){return s.hasPendingOperation(e,t)?Promise.reject(new Error("Operation "+e+" did not complete, reason:"+n)):Promise.resolve(void 0)});return Promise.race([d,l.promise])},e.prototype.hasPendingOperation=function(e,t){return t?!!this._deferredOperationsWithOperationId[e]&&!!this._deferredOperationsWithOperationId[e][t]:!!this._deferredOperations[e]},e.prototype.hasPendingOperationWithCauseId=function(e,t){return t||(t=""),!!this._deferredOperationsWithCauseId[e][t]},e.prototype.getPendingOperationWithCauseId=function(e,t){return this.hasPendingOperationWithCauseId(e,t)?this._deferredOperationsWithCauseId[e][t].promise:Promise.reject("["+e+"]["+t+"]: getPendingOperationWithCauseId for given causeId, operationId")},e.prototype.resolveOperationWithCauseId=function(e,t,n){if(this.hasPendingOperationWithCauseId(e)){t||(t="");var r=this._deferredOperationsWithCauseId[e][t],i=r.promise;return r.resolve(n),this._logger.info("["+e+"]["+t+"] resolved, result="+(s.getPrintableObject(n)||"void")),delete this._deferredOperationsWithCauseId[e][t],i}return Promise.reject("["+e+"]["+t+"] resolveOperationWithCauseId failed, operation not found")},e.prototype.rejectOperationWithCauseId=function(e,t,n){if(this.hasPendingOperationWithCauseId(e)){t||(t="");var i=this._deferredOperationsWithCauseId[e][t],o=i.promise;return o.catch(r.noop),i.reject(n),this._logger.info("["+e+"]["+t+"] rejected, result="+(s.getPrintableObject(n)||"void")),delete this._deferredOperationsWithCauseId[e][t],o}return Promise.reject("["+e+"]["+t+"] rejectOperationWithCauseId failed, operation not found")},e.prototype.maybeResolveOperationWithCauseId=function(e,t,n){var r=this;this.hasPendingOperationWithCauseId(e,t)?this.resolveOperationWithCauseId(e,t,n).catch(function(t){r._logger.info(e+"maybeResolveOperationWithCauseId failed, reason="+s.getPrintableObject(t))}):this._logger.info(e+"maybeResolveOperationWithCauseId ignored, operation does not exist")},e.prototype.maybeRejectOperationWithCauseId=function(e,t,n){this.hasPendingOperationWithCauseId(e,t)?this.rejectOperationWithCauseId(e,t,n).catch(r.noop):this._logger.info(e+"maybeRejectOperationWithCauseId ignored, operation does not exist")},e.prototype.getPendingOperation=function(e,t,n){return void 0===n&&(n=a.generateCauseId()),!t&&this._deferredOperations[e]?this._deferredOperations[e].deferred.promise:this._deferredOperationsWithOperationId[e]&&this._deferredOperationsWithOperationId[e][t]?this._deferredOperationsWithOperationId[e][t].deferred.promise:Promise.reject(this.getOperationInfoForLogging(n,e,t)+": Deferred operation with given name and operation does not exist")},e.prototype.waitForOperation=function(e,t,n){return void 0===n&&(n=a.generateCauseId()),this.hasPendingOperation(e)?this._deferredOperations[e].deferred.promise:this.hasPendingOperation(e,t)?this._deferredOperationsWithOperationId[e][t].deferred.promise:Promise.reject(this.getOperationInfoForLogging(n,e,t)+"failed=wait failed, operation not found")},e.prototype.resolveOperation=function(e,t,n,r,i){if(void 0===r&&(r=a.generateCauseId()),void 0===i&&(i=!1),!e)return Promise.reject("Unable to resolve deferred operation with empty name");if(this.hasPendingOperation(e)){var o=this._deferredOperations[e],l=this._deferredOperations[e].deferred.promise;return this._deferredOperations[e].deferred.resolve(t),this._logger.info(this.getOperationInfoForLogging(o.causeId,e,n)+"resolved, result="+(s.getPrintableObject(t)||"void")),i||delete this._deferredOperations[e],l}if(this.hasPendingOperation(e,n)){l=(o=this._deferredOperationsWithOperationId[e][n]).deferred.promise;return o.deferred.resolve(t),this._logger.info(this.getOperationInfoForLogging(o.causeId,e,n)+"resolved, result="+(s.getPrintableObject(t)||"void")),i||delete this._deferredOperationsWithOperationId[e][n],l}return Promise.reject(this.getOperationInfoForLogging(r,e,n)+"failed=resolve failed, operation not found")},e.prototype.rejectOperation=function(e,t,n,i){if(void 0===i&&(i=a.generateCauseId()),!e)return Promise.reject("Unable to reject deferred operation with empty name");if(this.hasPendingOperation(e))return(l=(o=this._deferredOperations[e]).deferred.promise).catch(r.noop),o.deferred.reject(t),this._logger.info(this.getOperationInfoForLogging(o.causeId,e,n)+"rejected, reason="+(s.getPrintableObject(t)||"void")),delete this._deferredOperations[e],l;if(this.hasPendingOperation(e,n)){var o=this._deferredOperationsWithOperationId[e][n],l=o.deferred.promise;return l.catch(r.noop),o.deferred.reject(t),this._logger.info(this.getOperationInfoForLogging(o.causeId,e,n)+"rejected, reason="+(s.getPrintableObject(t)||"void")),delete this._deferredOperationsWithOperationId[e][n],l}return Promise.reject(this.getOperationInfoForLogging(i,e,n)+"failed=reject failed, operation not found")},e.prototype.maybeResolveOperation=function(e,t,n,r){var i=this;void 0===r&&(r=a.generateCauseId());var o=this.getOperationInfoForLogging(r,e,n);this.hasPendingOperation(e,n)?this.resolveOperation(e,t,n,r).catch(function(e){i._logger.info(o+"maybeResolveOperation failed, reason="+s.getPrintableObject(e))}):this._logger.info(o+"maybeResolveOperation ignored, operation does not exist")},e.prototype.maybeRejectOperation=function(e,t,n,i){void 0===i&&(i=a.generateCauseId());var o=this.getOperationInfoForLogging(i,e,n);this.hasPendingOperation(e,n)?this.rejectOperation(e,t,n,i).catch(r.noop):this._logger.info(o+"maybeRejectOperation ignored, operation does not exist")},e.prototype.rejectPendingOperations=function(e,t){var n=this;void 0===t&&(t=a.generateCauseId()),this._disposed=!0,this._logger.info("["+t+"]rejectPendingOperations="+e),Object.keys(this._deferredOperations).forEach(function(r){n.maybeRejectOperation(r,e,void 0,t),n._deferredOperationsWithOperationId[t]&&delete n._deferredOperationsWithOperationId[t][""]}),Object.keys(this._deferredOperationsWithOperationId).forEach(function(r){Object.keys(n._deferredOperationsWithOperationId[r]).forEach(function(i){n.maybeRejectOperation(r,e,i,t),n._deferredOperationsWithOperationId[t]&&delete n._deferredOperationsWithOperationId[t][i]})}),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._endOperationDeferred.reject(e)},e.prototype.getOperationInfoForLogging=function(e,t,n){return void 0===n&&(n=""),"["+e+"]["+t+"]"+(n?"["+i.scrubMriOrOmit(n)+"]":"")},e}();t.default=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=/;aliases=.*$/i;t.MRI_SKYPE_PREFIX="8:",t.MRI_ALIAS_PREFIX=";aliases=",t.MRI_SIP_PREFIX="2:",t.PSTN_MRI_PREFIX="4:",t.stripMriAliases=function(e){return e?e.replace(r,""):e},t.generateAliasedMri=function(e,n){var r=e;return n&&(r+=t.MRI_ALIAS_PREFIX+t.MRI_SIP_PREFIX+n),r}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i,o=n(0),a=n(3),s=n(12),l=n(13),c=n(18),d=n(5),u=n(1),p=n(20),h=SlimCore.Enums,g=n(6),_=n(14),f=n(2),m=n(26),C=(i={},i[0]=[1,2,3,4,6,7,5],i[1]=[2,3,4,6,7,0],i[2]=[0,1,3,4,6,7],i[3]=[2,1,4,5,0,7],i[4]=[0],i[5]=[3,4,0],i[6]=[3,4,0],i[7]=[3,4,0],i);t.participantStrProps={displayName:{propKey:h.Property.ParticipantDisplayName},role:{propKey:h.Property.ParticipantRole},tenantId:{propKey:h.Property.ParticipantTenantId},acceptedBy:{propKey:h.Property.ParticipantAcceptedBy},endpointDetails:{propKey:h.Property.ParticipantEndpointDetails},meetingRole:{propKey:h.Property.ParticipantMeetingRole}},t.participantIntProps={isServerMuted:{propKey:h.Property.ParticipantIsServerMuted},capabilities:{propKey:h.Property.ParticipantCapabilities,fallback:SlimCore.Enums.Capability.All},contentRole:{propKey:h.Property.ParticipantContentRole,fallback:h.ContentSharingRole.None},status:{propKey:h.Property.ParticipantStatus},failure:{propKey:h.Property.ParticipantFailureReason}};var S=function(e){function n(t,r,i,o,a,s,l,c,u,p){var h;void 0===l&&(l=0),void 0===u&&(u=!1);var g=e.call(this,t.createChild(function(){return"ICallParticipant["+d.scrubMriOrOmit(g.id)+"]["+g.state+"]["+g.slimcoreObjectId+"]"}),r,i)||this;return g._callHandler=a,g._streamContextMap=s,g._callTelemetry=c,g.streams=(h={},h[0]=[],h[1]=[],h),g.voiceLevel=0,g.isServerMuted=!1,g.dominantSpeakerRank=0,g.state=0,g.id=null,g.role=null,g.tenantId=null,g.balanceUpdates={},g.enableParticipantLegToSourceIdMapping=!0,g.id=m.stripMriAliases(o),g._logger.info("created"),g.participantCapabilities=n.convertCapabilities(SlimCore.Enums.Capability.All),l&&0!==l&&g.attachSlimcoreObjectId(l,"ctor",u,p),g._slimcoreInstance.ecsGetSettingAsBool&&(g.enableParticipantLegToSourceIdMapping=g._slimcoreInstance.ecsGetSettingAsBool("SkypeCalling","enableParticipantLegToSourceIdMapping",!0)),g._logger.info("created enableParticipantLegToSourceIdMapping: "+g.enableParticipantLegToSourceIdMapping),g}return r(n,e),n.prototype.getDiagnosticData=function(){return JSON.stringify({id:this.id,slimcoreObjectId:this.slimcoreObjectId,state:this.state,isServerMuted:this.isServerMuted})},n.prototype.attachSlimcoreObjectId=function(e,r,i,o){var a=this;if(void 0===i&&(i=!1),this.slimcoreObjectId&&0!==this.slimcoreObjectId)this._logger.debug("Attach called on existing participant");else{this.slimcoreObjectId=e;var s=o&&o.props||this._getProperties(this._callHandler,this.slimcoreObjectId,t.participantStrProps,t.participantIntProps);this.displayName=s.displayName,this.role=s.role,this.tenantId=s.tenantId,this.participantCapabilities=n.convertCapabilities(s.capabilities),this.acceptedBy=s.acceptedBy,this.isServerMuted=!!s.isServerMuted,this.meetingRole=s.meetingRole,this._slimCoreElectronRemoteStreamManager=new c.default(this._logger,this._settings,this._slimcoreInstance,this._callHandler,this.slimcoreObjectId,this.streams,this._streamContextMap,i),this._slimCoreElectronRemoteStreamManager.changed(function(){return a.raiseChanged()}),this._updateEndpointDetails(s.endpointDetails),this._onParticipantPropertyChanged(h.Property.ParticipantStatus,function(e){return a._onStatusChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantIsServerMuted,function(e){return a._onIsServerMuted(!!e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantFailureReason,function(e){return a._onFailureReasonChange(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantAdmitFailureReason,function(e){return a._onAdmitFailureReasonChange(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantRemoveFailureReason,function(e){return a._onRemoveFailureReasonChange(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantIsActiveSpeaker,function(e){return a.setVoiceLevel(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantDominantSpeakerRank,function(e){return a._onDominantSpeakerRankChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantEndpointDetails,function(e){return a._updateEndpointDetails(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantCapabilities,function(e){return a._onCapabilitiesChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantAcceptedBy,function(e){return a._onAcceptedByChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantRole,function(e){return a._onRoleChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantTenantId,function(e){return a._onTenantIdChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantContentRole,function(e){return a._onParticipantContentSharingRoleChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantBalanceUpdate,function(e){return a._onBalanceUpdateChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantDiagnosticsCode,function(e){return a._onParticipantDiagnosticsCodeChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantMeetingRole,function(e){return a._onMeetingRoleChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantMriIdentity,function(e){return a._onMriChanged(e.value)}),this._onParticipantPropertyChanged(h.Property.ParticipantDisplayName,function(e){return a._onDisplayNameChanged(e.value)}),this._onStatusChanged(s.status,!1,s.failure),this._onParticipantContentSharingRoleChanged(s.contentRole)}},n.prototype.getStrProperty=function(e,t){return this._getStrProperty(this._callHandler,this.slimcoreObjectId,e,t)},n.prototype.getIntProperty=function(e,t){return this._getIntProperty(this._callHandler,this.slimcoreObjectId,e,t)},n.prototype._onParticipantPropertyChanged=function(e,t){this._onObjectPropertyChanged(this.slimcoreObjectId,e,t)},n.prototype._onCapabilitiesChanged=function(e){var t=n.convertCapabilities(e);t!==this.participantCapabilities&&(this._logger.info("Computed capabilities: "+JSON.stringify(t)),this.participantCapabilities=t,this.raiseChangedDeferred())},n.prototype._onAcceptedByChanged=function(e){e!==this.acceptedBy&&(this._logger.info("Accepted by is set to "+d.scrubMriOrOmit(e)),this.acceptedBy=e,this.raiseChanged())},n.prototype._onRoleChanged=function(e){e!==this.role&&(this._logger.info("Role is set to "+e),this.role=e,this.raiseChanged())},n.prototype._onTenantIdChanged=function(e){e!==this.tenantId&&(this._logger.info("TenantId is set to "+e),this.tenantId=e,this.raiseChanged())},n.prototype._onMeetingRoleChanged=function(e){e!==this.meetingRole&&(this._logger.info("_onMeetingRoleChanged meetingRole: "+e),this.meetingRole=e,this.raiseChanged())},n.prototype._onMriChanged=function(e){e!==this.id&&(this._logger.info("_onMriChanged from old mri "+d.scrubMriOrOmit(this.id)+" to new Mri: "+d.scrubMriOrOmit(e)),this.previousId=this.id,this.id=e,this.raiseChanged())},n.prototype._onDisplayNameChanged=function(e){e!==this.displayName&&(this._logger.info("_onDisplayNameChanged new displayName: "+d.scrubMriOrOmit(e)),this.displayName=e,this.raiseChanged())},n.prototype.raiseChangedDeferred=function(){var e=this;this._raiseChangedDefer||(this._raiseChangedDefer=o.defer(function(){delete e._raiseChangedDefer,e.raiseChanged()}))},n.prototype._getParticipantIdForSourceId=function(e,t){try{if(null!=this.endpoints)for(var n=0,r=this.endpoints.endpointDetails;n<r.length;n++){var i=r[n];if(null!=i&&null!=i.mediaStreams)for(var o=0,a=i.mediaStreams;o<a.length;o++){var s=a[o];if(t===s.sourceId&&u.mapMediaTypeStringToMediaType(s.type)===e)return null!=i.participantId?i.participantId:null}}}catch(e){this._logger.error("getSourceIdForMediaType caught exception error="+e)}},n.prototype.getParticipantIdForSourceId=function(e,t){var n=this._getParticipantIdForSourceId(e,t);return n||this._logger.warn("participantId is "+n+" for mediaType: "+e+", sourceId: "+t),n},n.prototype.hasSourceId=function(e,t){return this.enableParticipantLegToSourceIdMapping?void 0!==this._getParticipantIdForSourceId(e,t):this.getSourceIdForMediaType(e)===t},n.prototype.getSourceIdForMediaType=function(e){var t=-1;try{if(this.endpoints)e:for(var n=0,r=this.endpoints.endpointDetails;n<r.length;n++){var i=r[n];if(null!==i&&void 0!==i.mediaStreams)for(var o=0,a=i.mediaStreams;o<a.length;o++){var s=a[o];if(u.mapMediaTypeStringToMediaType(s.type)===e){t=s.sourceId;break e}}else t=l.DATA_SOURCE_ID_ANY}}catch(e){this._logger.error("getSourceIdForMediaType caught exception error="+e)}return t},n.prototype.getSourceId=function(e,t){if(!this.enableParticipantLegToSourceIdMapping)return this.getSourceIdForMediaType(t);if(!this.endpoints)return this._logger.warn("endpoints is invalid"),-1;try{var n=o.find(this.endpoints.endpointDetails,function(t){return null!=t&&t.participantId===e});if(!n)return this._logger.warn("participantId not found: "+e),this.getSourceIdForMediaType(t);if(!n.mediaStreams)return this._logger.warn("participantLeg "+e+" does not have valid mediaStreams"),this.getSourceIdForMediaType(t);var r=o.find(n.mediaStreams,function(e){return u.mapMediaTypeStringToMediaType(e.type)===t});return r?r.sourceId:(this._logger.warn("participantLeg "+e+" has no channel of type "+t),-1)}catch(e){this._logger.error("getSourceId caught exception error="+e)}return-1},n.prototype._isScreenSharerStream=function(e){return"sendonly"===e.direction&&"applicationsharing-video"===e.label},n.prototype.getSharingParticipantLeg=function(){var e=this;if(this.endpoints&&this.endpoints.endpointDetails){if(1===this.endpoints.endpointDetails.length)return this.endpoints.endpointDetails[0].participantId;var t=o.find(this.endpoints.endpointDetails,function(t){return null!=t&&null!=t.mediaStreams&&o.some(t.mediaStreams,function(t){return e._isScreenSharerStream(t)})});if(t){if(t.participantId)return t.participantId;this._logger.warn("invalid participantId")}else this._logger.warn("could not find sharer")}else this._logger.warn("endpoints are not defined")},n.getEndpointDetailsLogString=function(e){if(!e||!e.endpointDetails)return"";var t=[];return e.endpointDetails.forEach(function(e){t.push({participantId:e.participantId,endpointId:e.endpointId,clientVersion:e.clientVersion,mediaStreams:e.mediaStreams})}),JSON.stringify(t)},n.prototype._updateEndpointDetails=function(e){if(this._rawEndpoints!==e&&e){try{this.endpoints=JSON.parse(e),this._rawEndpoints=e,this._logger.info("Updating endpointDetails: "+n.getEndpointDetailsLogString(this.endpoints))}catch(t){return void this._logger.warn("Failed to parse call member endpointDetails - "+t+" -"+e)}this.raiseChanged()}},n.prototype._onStatusChanged=function(e,t,r){void 0===t&&(t=!0);var i=f.generateCauseId();this._logger.info("["+i+"]Status changed "+e+" ("+h.CallStatus[e]+")");var o=void 0!==r?r:this.getIntProperty(h.Property.ParticipantFailureReason),a=n.convertParticipantStatus(e);void 0!==a?(this.setState(a,i,p.convertStatusAndFailureReasonToParticipantReason(e,o),t),this._admitParticipantDeffered&&n.isParticipantActive(this.state)&&(this._admitParticipantDeffered.resolve(),this._admitParticipantDeffered=null),this._removeParticipantDeffered&&!n.isParticipantActive(this.state)&&(this._removeParticipantDeffered.resolve(),this._removeParticipantDeffered=null)):this._logger.warn("Unrecognized "+a)},n.prototype._onParticipantContentSharingRoleChanged=function(e){this._logger.info("Content sharing role changed "+e+" ("+h.ContentSharingRole[e]+")"),this.setContentSharingRole(n.convertContentSharingRole(e))},n.prototype._onFailureReasonChange=function(e){var t=f.generateCauseId();this._logger.info("["+t+"]Failure reason changed "+e+" ("+h.ParticipantFailureReason[e]+")");var r=this.getIntProperty(h.Property.ParticipantStatus);this.setState(n.convertParticipantStatus(r),t,p.convertFailureReasonToParticipantReason(e))},n.prototype._onAdmitFailureReasonChange=function(e){if(this._logger.info("Admit failure reason changed "+e+" ("+h.ParticipantFailureReason[e]+")"),e!==h.ParticipantFailureReason.NoFailure){var t=p.convertFailureReasonToParticipantReason(e);this.rejectAdmitParticipantDeferred(t)}},n.prototype._onRemoveFailureReasonChange=function(e){if(this._logger.info("Remove failure reason changed "+e+" ("+h.ParticipantFailureReason[e]+")"),e!==h.ParticipantFailureReason.NoFailure){var t=p.convertFailureReasonToParticipantReason(e);this.rejectRemoveParticipantDeferred(t)}},n.prototype.setVoiceLevel=function(e){this.voiceLevel!==e&&(this.voiceLevel=e,this.raiseChanged())},n.prototype._onIsServerMuted=function(e){e!==this.isServerMuted&&(this.isServerMuted=e,this.raiseChanged())},n.prototype._onDominantSpeakerRankChanged=function(e){this.dominantSpeakerRank!==e&&(this._logger.info("DominantSpeakerRank changing from "+this.dominantSpeakerRank+" to "+e),this.dominantSpeakerRank=e,this.raiseChanged())},n.prototype._onBalanceUpdateChanged=function(e){if(o.isEmpty(e))o.isEmpty(this.balanceUpdates)||(this.balanceUpdates={},this.raiseChanged());else{try{var t=JSON.parse(e);if(o.isEqual(this.balanceUpdates[t.sender.endpointId],t))return;this.balanceUpdates[t.sender.endpointId]=t}catch(t){return void this._logger.warn("Failed to parse call member balanceUpdate - "+t+" -"+e)}this.raiseChanged()}},n.prototype._onParticipantDiagnosticsCodeChanged=function(e){this._logger.info("_onParticipantDiagnosticsCodeChanged diagnosticsCode: "+e),this._updateDiagnosticsCode(e)},n.prototype._updateDiagnosticsCode=function(e){if(this._rawCallEndDiagnosticsInfo!==e&&e)try{this.callEndDiagnosticsInfo=JSON.parse(e),this._rawCallEndDiagnosticsInfo=e,this.raiseChanged()}catch(t){this._logger.info("Failed to parse raw diagnostis details. Error: "+t+", diagnosticsCode: "+e)}},n.prototype.setContentSharingRole=function(e){this.contentSharingRole!==e&&(this.contentSharingRole=e,this.raiseChanged())},n.prototype.setState=function(e,t,n,r){if(void 0===r&&(r=!0),this.state!==e){var i=this._logger.createFnLogger("setState",t),o=C[this.state].indexOf(e)>=0,a={state:this.state,reason:this.stateReason,endpoints:[]};if(this.endpoints&&this.endpoints.endpointDetails&&this.endpoints.endpointDetails.length&&(a.endpoints=_.getEndpointInformationForTelemetry(this.endpoints.endpointDetails)),!o)return i.logFailure("Invalid state transition "+this.state+"->"+e+" attempted"),void this._callTelemetry.recordEvent(g.PARTICIPANT_OPERATIONS_INTERNAL.SET_PARTICIPANT_STATE_INVALID,a,t);if(i.info("state="+this.state+"->"+e+" reason="+this.stateReason+"->"+n),this.state=e,this.stateReason=n,3===this.state&&r){var s=this.getStrProperty(h.Property.ParticipantEndpointDetails);this._updateEndpointDetails(s)}else if(4===this.state){var l=this.getStrProperty(h.Property.ParticipantDiagnosticsCode);this._updateDiagnosticsCode(l)}this.raiseChangedDeferred()}},n.convertParticipantStatus=function(e){return s.default.isCallRinging(e)?2:s.default.isCallTerminated(e)?4:s.default.isCallConnected(e)?3:s.default.isCallConnecting(e)?1:s.default.isCallEarlyMedia(e)?6:s.default.isCallInLobby(e)?7:e===h.CallStatus.LocalHold||e===h.CallStatus.RemoteHold?5:void 0},n.isParticipantActive=function(e){switch(e){case 3:case 6:case 5:return!0;default:return!1}},n.convertContentSharingRole=function(e){switch(e){case h.ContentSharingRole.Attendee:return 1;case h.ContentSharingRole.Presenter:return 2;default:return 0}},n.convertCapabilities=function(e){return{canConference:!!(e&h.Capability.Conference),canShareScreen:!!(e&h.Capability.ShareScreen),canMerge:!!(e&h.Capability.Merge)}},n.prototype.addAdmitParticipantDeferred=function(e){this._admitParticipantDeffered=e},n.prototype.rejectAdmitParticipantDeferred=function(e){this._admitParticipantDeffered&&(this._admitParticipantDeffered.reject(e),this._admitParticipantDeffered=null)},n.prototype.addRemoveParticipantDeferred=function(e){this._removeParticipantDeffered=e},n.prototype.rejectRemoveParticipantDeferred=function(e){this._removeParticipantDeffered&&(this._removeParticipantDeffered.reject(e),this._removeParticipantDeffered=null)},n.prototype.stopVideos=function(){return this._slimCoreElectronRemoteStreamManager?this._slimCoreElectronRemoteStreamManager.stopVideos():Promise.resolve()},n.prototype.dispose=function(){this._slimCoreElectronRemoteStreamManager&&this._slimCoreElectronRemoteStreamManager.dispose(),this.streams[0]=[],this.streams[1]=[],this._admitParticipantDeffered&&(this._admitParticipantDeffered.resolve(),this._admitParticipantDeffered=null),this._removeParticipantDeffered&&(this._removeParticipantDeffered.resolve(),this._removeParticipantDeffered=null),this.slimcoreObjectId=0,e.prototype.dispose.call(this)},n}(a.default);t.default=S},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(29),o=SlimCore.Enums,a=0,s=function(e){function t(t,n,r,i,s,l,c,d){var u=e.call(this,t.createChild(function(){return"RemoteVideoRenderer["+u._id+"]"}),n,r)||this;u._renderTarget=i,u._videoType=s,u._options=c,u._rendererTracker=d,u._id=a++,u._logger.info("constructor");var p=s===o.VideoType.ScreenShare;return u._videoBinding=l,u._options=c||{scalingMode:p?2:1,transparent:p,ignoreMirroring:!1},u._createVideoRenderer(u._renderTarget,u._options,!1),u._rendererTracker.registerRenderer(u),u}return r(t,e),Object.defineProperty(t.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:!0,configurable:!0}),t.prototype.clone=function(e){return this._logger.info("clone"),new t(this._logger,this._settings,this._slimcoreInstance,e,this._videoType,this._videoBinding,this._options,this._rendererTracker)},t.prototype.dispose=function(t){this._logger.info("dispose");try{e.prototype.dispose.call(this,t)}finally{this._renderTarget=null,this._rendererTracker&&(this._rendererTracker.unregisterRenderer(this),this._rendererTracker=null)}},t}(i.default);t.default=s},function(e,t,n){"use strict";function r(e){return void 0!==e.renderer}function i(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;default:return-1}}function o(e){switch(e.reason){case 1:return 2;case 2:return 3;default:return 1}}function a(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;default:return}}var s=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var l=n(0),c=n(4),d=n(3),u=n(1),p=function(e){function t(t,n,r){var o=e.call(this,t,n,r)||this;return o.isRendering=!1,o._paused=!1,o._isFrameSinkSet=!1,o._videoElementSizeChangeIntervalHandle=0,o._isStartedLogged=!1,o._frameTypeChanged=function(e){o._logger.info("frame-type-changed: "+e.type),o.event("frameTypeChanged").raise(i(e.type))},o._frameSizeChanged=function(e){o._logger.info("frame-size-changed: "+e.width+" x "+e.height)},o._firstFrameRendered=function(e){o._logger.info("first-frame-rendered"),o.event("firstFrameRendered").raise()},o._fullFrameRenderRequired=function(e){o._logger.info("full-frame-render-required: "+e.fullFrameRenderRequired),o.event("fullFrameRenderRequired").raise(e.fullFrameRenderRequired)},o._videoUriChangedUwp=function(e){o._videoElement&&(o._videoElement.src=e.uri||"")},o._videoResizedUwp=function(){o._videoSizeChanged(o._videoElement.videoWidth,o._videoElement.videoHeight)},o._videoPausedUwp=function(){o._videoElement&&(o._videoElement.src=o._videoBindingRT.uri||"",o._videoElement.play())},o}return s(t,e),t.prototype.dispose=function(t){this._disposeVideoRenderer(t),e.prototype.dispose.call(this,t)},Object.defineProperty(t.prototype,"rendererType",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameType",{get:function(){return this._frameSink&&this._frameSink.getFrameType?i(this._frameSink.getFrameType()):-1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paused",{get:function(){return this._paused},set:function(e){if(this._settings.platform!==u.PlatformType.Electron)throw new Error("Only implemented for Electron renderer");e!==this._paused&&(this._frameSink&&this._controlFrameSink(!e),this._paused=e)},enumerable:!0,configurable:!0}),t.prototype.captureFrame=function(e,t){return this._videoBinding?this._videoBinding.captureFrame({timeout:e,bufferName:t}).then(function(e){return new h(u.convertImageData(e.image),e.mirror)}):Promise.resolve()},t.prototype.getStats=function(){var e=this;return c.asap(function(){return e._getStats()})},t.prototype.setScalingMode=function(e){var t=this;return this._renderer?this._renderer.setScalingMode(a(e)):this._videoElement?c.asap(function(){t._videoElement.msZoom=1===e}):Promise.reject("No video renderer")},t.prototype.dumpVideoSourceImages=function(){return Promise.reject(new Error("Supposed to be overriden by preview video renderer. Not implemented for remote video renderer"))},t.prototype._createVideoRenderer=function(e,t,n){switch(this._settings.platform){case u.PlatformType.Electron:return this._createVideoRendererElectron(e,t);case u.PlatformType.Uwp:return this._createVideoRendererUwp(e,t,n);default:throw new Error("Unsupported platform: "+this._settings.platform)}},t.prototype._createVideoRendererElectron=function(e,t){var n=this;r(e)?this._renderer=e.renderer:this._renderer=this._createVideoRendererImpl(e,t),this._renderer.on("video-size-changed",function(e){return n._videoSizeChanged(e.width,e.height)}),this._frameSink&&(this._frameSink.on("frame-type-changed",this._frameTypeChanged),this._frameSink.on("frame-size-changed",this._frameSizeChanged),this._frameSink.on("first-frame-rendered",this._firstFrameRendered),this._frameSink.on("full-frame-render-required",this._fullFrameRenderRequired),!l.isUndefined(t.ignoreMirroring)&&this._frameSink.setIgnoreMirroring&&this._frameSink.setIgnoreMirroring(t.ignoreMirroring),this._controlFrameSink(!0))},t.prototype._createVideoRendererUwp=function(e,t,n){var r=this;this._logger.info("Creating uwp video renderer with uri "+this._videoBindingRT.uri),this._videoBindingRT.on("video-uri-changed",this._videoUriChangedUwp);var i=e;if(this._videoElement=i.ownerDocument.createElement("video"),i.appendChild(this._videoElement),this._videoElement.autoplay=!0,this._videoElement.msHorizontalMirror=!t.ignoreMirroring&&n,this._videoElement.msZoom=1===t.scalingMode,this._videoElement.style.backgroundColor=t.transparent?"":"black",this._videoElement.addEventListener("resize",this._videoResizedUwp),this._videoElement.src=this._videoBindingRT.uri||"",this._videoElement.addEventListener("pause",this._videoPausedUwp),!n&&this._videoBindingRT.setVideoPreference){var o={width:0,height:0};this._videoElementSizeChangeIntervalHandle=setInterval(function(){var e={width:r._videoElement.offsetWidth,height:r._videoElement.offsetHeight};l.isEqual(o,e)||(o=e,r._videoBindingRT.setVideoPreference(e.width,e.height))},2e3)}},t.prototype._disposeVideoRenderer=function(e){this._frameSink&&(this._frameSink.removeListener("frame-type-changed",this._frameTypeChanged),this._frameSink.removeListener("frame-size-changed",this._frameSizeChanged),this._frameSink.removeListener("first-frame-rendered",this._firstFrameRendered),this._frameSink.removeListener("full-frame-render-required",this._fullFrameRenderRequired),this._controlFrameSink(!1)),this._renderer&&(this._renderer.removeAllListeners(),this._renderer.dispose(),this._renderer=null),this._videoBindingRT&&this._videoBindingRT.removeListener("video-uri-changed",this._videoUriChangedUwp),this._videoElementSizeChangeIntervalHandle&&(clearInterval(this._videoElementSizeChangeIntervalHandle),this._videoElementSizeChangeIntervalHandle=0),this._videoElement&&(this._videoElement.removeEventListener("resize",this._videoResizedUwp),this._videoElement.removeEventListener("pause",this._videoPausedUwp),this._videoElement.remove(),this._videoElement=null)},Object.defineProperty(t.prototype,"_frameSink",{get:function(){return this._renderer?this._renderer.getFrameSink():null},enumerable:!0,configurable:!0}),t.prototype._videoSizeChanged=function(e,t){this._logger.info("video-size-changed: "+e+" x "+t),this.streamSize={width:e,height:t},this.isRendering=e>0&&t>0,!this._isStartedLogged&&this.isRendering&&(this._logger.info("renderStarted"),this.event("renderStarted").raise(),this._isStartedLogged=!0),this.event("videoSizeChanged").raise(e,t),this.raiseChanged()},t.prototype._getStats=function(){if(!this._frameSink)throw new Error("Renderer is not initialized");if(this._frameSink.getStats)return this._frameSink.getStats();throw new Error("Renderer does not support stats")},Object.defineProperty(t.prototype,"frameSinkMetadata",{get:function(){return this._frameSink&&this._frameSink.getMetadata?this._frameSink.getMetadata():null},enumerable:!0,configurable:!0}),t.prototype._createVideoRendererImpl=function(e,t){var n={container:e,transparent:t.transparent,scalingMode:a(t.scalingMode),useBufferSharing:!!this._settings.enableBufferSharing,useFirstFrameRender:!!this._settings.enableFirstFrameRender,logger:this._logger};try{var r=SlimCore.createChromiumFrameSink?SlimCore.createChromiumFrameSink():SlimCore.createPepperFrameSink();return VideoRenderer.createChromiumVideoRenderer(r,n)}catch(e){throw this._logger.error("createChromiumVideoRenderer failed: "+e),new g(e,o(e))}},Object.defineProperty(t.prototype,"_videoBindingRT",{get:function(){return this._videoBinding},enumerable:!0,configurable:!0}),t.prototype._controlFrameSink=function(e){this._videoBinding&&this._isFrameSinkSet!==e&&(this._isFrameSinkSet=e,e?this._videoBinding.addFrameSink(this._frameSink):this._videoBinding.removeFrameSink(this._frameSink))},t}(d.default);t.default=p;var h=function(){function e(e,t){this._imageData=e,this._mirrored=t}return e.prototype.getSize=function(){return{width:this._imageData.width,height:this._imageData.height}},e.prototype.isMirrored=function(){return this._mirrored},e.prototype.getImageData=function(){return this._imageData},e}(),g=function(){function e(e,t){void 0===t&&(t=-1),this.reason=e,this.errorType=t}return e.prototype.toString=function(){return"Reason="+this.reason+", errorType="+this.errorType},e}()},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var l=n(0),c=n(1),d=n(3),u=n(31),p=SlimCore.Enums,h=n(6),g=n(2),_=n(16),f=n(17),m=function(e){function t(t,n,r,i,o,a,s,l,c){var d=e.call(this,t.createChild(function(){return"LocalScreenShare["+d._localVideoObjectId+"]"}),n,r)||this;d._callObjectId=i,d._callHandler=o,d._deviceManager=a,d._appHooks=s,d._screenSharingControl=l,d._callTelemetry=c,d.isStreaming=!1,d.isAvailable=!0,d.mediaType=3,d._localVideoObjectId=0,d._previewVideoObjectId=0,d._editViewPPTWindowId=0,d._canHandleEvents=!1,d._logger.info("constructor"),d._callOperationHandler=new f.default(d._logger,d._callTelemetry);try{d._screenScraper=new u.default(d._slimcoreInstance)}catch(e){d._logger.warn(""+e)}return d._screenScraper&&d._registerDisposable(d._appHooks.onDisplaysChanged(function(){return d.handleDisplaysChanged()})),d}return r(t,e),t.prototype.isActive=function(){return this.isAvailable&&this.isStreaming},t.prototype._showSharingIndicator=function(e){var t=this;this._appHooks.showSharingIndicator(e);var n=this._appHooks.getControlInjector();n&&n.setInjectionRect&&n.setInjectionRect(e).catch(function(n){var r=JSON.stringify({errorMsg:n,region:e});t._screenSharingControl.enableScreenSharingControl(!1,0,r),t._logger.error("Set control Injector failure, disable screen sharing control. Error: "+n)})},t.prototype._videoObjectChanged=function(e){var t=g.generateCauseId();this.isAvailable=c.isVideoAvailable(e),this.isStreaming=!1,c.isVideoInState(e,[p.VideoStatus.Starting,p.VideoStatus.Running])&&(this._selectedMonitor||this._selectedWindow||this._selectedCamera?(this.isStreaming=!0,this._selectedCamera||this._appHooks.showSharingIndicator(this._selectedRegion||this._selectedMonitor&&this._selectedMonitor.region||this._selectedWindow&&this._selectedWindow.windowId)):c.forgetAndLog(this.stop(t),this._logger,"stopping screen sharing due to no monitor/camera being selected")),c.isVideoInState(e,[p.VideoStatus.Paused])&&this._appHooks.hideSharingIndicator(),this.raiseChanged()},t.prototype._setCaptureRegionAndWindow=function(e,t){if(this._slimcoreInstance.setScreenCaptureRectangle)this._slimcoreInstance.setScreenCaptureRectangle(this._localVideoObjectId,e,void 0,t);else{if(!this._videoBindingScreenShare)throw new Error("Failed to set capture region / window");this._videoBindingScreenShare.setCaptureRegionAndWindow(e,t)}},t.prototype._handleScraperEvent=function(e){this._logger.info("Handle Scraper event, event = "+e.event+" data = "+e.data);var t=e.data;switch(e.event){case p.ScraperEvent.PPTPresenterView_Enter:this._editViewPPTWindowId=this._selectedWindow.windowId,this._selectedWindow.windowId=t,this._appHooks.showSharingIndicator(t),this._setCaptureRegionAndWindow(void 0,t),this._logger.info("shared PPT entered presenter mode");break;case p.ScraperEvent.PPTPresenterView_Exit:this._selectedWindow.windowId=this._editViewPPTWindowId,this._appHooks.showSharingIndicator(this._selectedWindow.windowId),this._setCaptureRegionAndWindow(void 0,this._selectedWindow.windowId),this._logger.info("shared PPT exited presenter mode");break;case p.ScraperEvent.WindowClosed:if(this._selectedWindow.windowId!==t)return;this._logger.info("Application window closed. Stopping the screenshare"),this.event("windowClosed").raise();break;default:this.event("scraperEvent").raise(e)}},t.prototype._startPreviewVideoObject=function(){var e=this;return this._shouldUseVideoBindingScreenShare()?this._deviceManager.getPreviewVideo(p.VideoType.ScreenShare).then(function(t){return e._deviceManager.getScreenShareBindingManager().acquire(e,t).then(function(n){e._previewVideoObjectId=t,e._videoBindingScreenShare=n,e._videoBindingScreenShare.on("scraper-event",function(t){return e._handleScraperEvent(t)})})}):Promise.resolve()},t.prototype._stopPreviewVideoObject=function(){var e=this;if(this._shouldUseVideoBindingScreenShare()){if(this._previewVideoObjectId&&this._videoBindingScreenShare){this._logger.info("calling slimcore video release binding"),this._videoBindingScreenShare.removeAllListeners("scraper-event");var t=this._deviceManager.getScreenShareBindingManager().release(this,this._previewVideoObjectId).catch(function(t){return e._logger.error("Failed on releasing screen sharing binding. Error: "+t)});return this._previewVideoObjectId=0,this._videoBindingScreenShare=null,t}return Promise.resolve()}return Promise.resolve()},t.prototype._shouldUseVideoBindingScreenShare=function(){return!this._slimcoreInstance.setScreenCaptureRectangle&&this._deviceManager.hasVideoBindingScreenShare()},t.prototype.start=function(e,t,n,r){var i=this,o=this._logger.createFnLogger(h.CALL_OPERATIONS_INTERNAL.ELECTRON_START_SCREEN_SHARING,e);o.info("local screen share start");var l=Promise.resolve().then(function(){return a(i,void 0,void 0,function(){var e,i,a,l,d=this;return s(this,function(s){switch(s.label){case 0:if(!(e=this.sourceToInfo(t)))throw new Error("Unable to start sharing, source could not be found");return o.info("calling slimcore create local video"),(i=!!t&&3===t.getType())?(a=e,this._localVideoObjectId=this._slimcoreInstance.createLocalVideo(p.VideoType.ScreenShare,a.label,a.id)):this._localVideoObjectId=this._slimcoreInstance.createLocalVideo(p.VideoType.ScreenShare,"",""),this._videoStatusChangedHandler=this._slimcoreInstance.handle("object-property-changed",{objectId:this._localVideoObjectId,propKey:p.Property.VideoStatus},function(e){return d._videoObjectChanged(e.value)}),l=this._getIntProperty(this._callHandler,this._localVideoObjectId,p.Property.VideoStatus),this._videoObjectChanged(l),this._callHandler.callAttachSendVideo(this._callObjectId,this._localVideoObjectId),o.info("waiting for video object to be available"),[4,c.waitForVideoObjectToBeAvailable(this._slimcoreInstance,this._callHandler,this._localVideoObjectId,this._logger,500)];case 1:return s.sent(),i?[3,3]:(this._logger.info("start preview video object"),[4,this._startPreviewVideoObject()]);case 2:s.sent(),s.label=3;case 3:return o.info("calling slimcore video start"),this._canHandleEvents=!0,this.selectSource(t,e,n),this.negotiationTag=r,this._slimcoreInstance.videoStart(this._localVideoObjectId,r),this.isStreaming=!0,this.raiseChanged(),[2]}})})});return this._callOperationHandler.registerPromise(h.CALL_OPERATIONS_INTERNAL.ELECTRON_START_SCREEN_SHARING,l).catch(function(t){o.logFailure("Failed to start LocalScreenShare. Error: "+t),i.stop(void 0,e),Promise.reject(t)})},t.prototype.changeCropRegion=function(e){var t=this.sourceToInfo(null);this.selectMonitorWithOptionalCrop(t,e)},t.prototype.stop=function(e,t){var n=this,r=this._logger.createFnLogger(h.CALL_OPERATIONS_INTERNAL.ELECTRON_STOP_SCREEN_SHARING,e),i=function(){n._localVideoObjectId=0,n.isStreaming=!1,n._selectedMonitor=null,n._selectedRegion=null,n._selectedWindow=null,n._selectedCamera=null,n._editViewPPTWindowId=0,n._appHooks.hideSharingIndicator(),n._videoStatusChangedHandler&&(n._videoStatusChangedHandler.dispose(),n._videoStatusChangedHandler=null),n.raiseChanged()},o=Promise.resolve().then(function(){n._canHandleEvents=!1,n._stopPreviewVideoObject()}).then(function(){0!==n._localVideoObjectId&&(r.info("calling slimcore video stop"),n.negotiationTag=t,n._slimcoreInstance.videoStop(n._localVideoObjectId,n.negotiationTag))}).then(i,function(e){throw r.logFailure("Failed to stop LocalScreenShare. Error: "+e),i(),e});return this._callOperationHandler.registerPromise(h.CALL_OPERATIONS_INTERNAL.ELECTRON_STOP_SCREEN_SHARING,o)},t.prototype.dispose=function(t){this._logger.info("Disposing of LocalScreenShare"),0===this._localVideoObjectId&&0===this._previewVideoObjectId||this.stop(t),this._videoStatusChangedHandler&&(this._videoStatusChangedHandler.dispose(),this._videoStatusChangedHandler=null),e.prototype.dispose.call(this)},t.prototype.selectSource=function(e,t,n){e&&2===e.getType()?this.selectWindow(t):e&&3===e.getType()?this._selectedCamera=t:this.selectMonitorWithOptionalCrop(t,n)},t.prototype.selectMonitorWithOptionalCrop=function(e,t){var n=t||e.region;this._logger.info("Selected region with optional crop, x = "+n.x+", y = "+n.y+", width = "+n.width+" height = "+n.height),this._showSharingIndicator(n),this._setCaptureRegionAndWindow(n),this._selectedMonitor=e,this._selectedRegion=t},t.prototype.selectWindow=function(e){this._appHooks.showSharingIndicator(e.windowId),this._setCaptureRegionAndWindow(void 0,e.windowId),this._selectedWindow=e},t.prototype.handleDisplaysChanged=function(){var e=g.generateCauseId(),t=this._logger.createFnLogger("HandleDisplaysChanged",e);if(this._canHandleEvents)if(this._selectedMonitor){var n=function(e){try{return JSON.stringify(e)}catch(e){return"unable to stringify"}};if(t.info("On display change, currenlty selected monitor: "+n(this._selectedMonitor)+" selected region:  "+n(this._selectedRegion)),!this._selectedRegion){for(var r=this._screenScraper.getMonitorList()||[],i=0,o=r;i<o.length;i++){var a=o[i];t.info("On display change, new listed monitor: "+n(a))}var s=c.selectMonitorForScreenSharing(this._selectedMonitor,r);if(s)return t.info("On display change, re-selected monitor: "+n(s)),void this.selectMonitorWithOptionalCrop(s)}t.info("stopping screen share because displays changed and could not resolve monitor info"),c.forgetAndLog(this.stop(e),t,"stopping screen share because sharing source lost"),this.event("sharingSourceLost").raise()}else t.logFailure("On display change, monitor not seleted yet");else t.logFailure("LocalScreenShare is not running, ingnoring events")},t.prototype.sourceToInfo=function(e){if(!e){if(this._screenScraper){t=this._screenScraper.getMonitorList()||[];return l.find(t,function(e){return e.isPrimary})}return this._logger.error("ScreenShare has no way to recover primary monitor"),null}switch(e.getType()){case 2:t=this._screenScraper.getWindowList()||[];return l.find(t,function(t){return t.windowId===e.getId()});case 1:if(!this._screenScraper)return{monitorId:0,name:e.getDescription(),region:e.getBounds(),isPrimary:!0,isInternal:!0,isDuplicated:!1};var t=this._screenScraper.getMonitorList()||[];return l.find(t,function(t){return t.monitorId===e.getId()||l.isEqual(t.region,e.getBounds())});case 3:return this._deviceManager.getCamera(e.getDeviceId());default:throw new Error("Invalid source type: "+e.getType())}},i([_.callOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_START_SCREEN_SHARING,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_STOP_SCREEN_SHARING}),o("design:type",Function),o("design:paramtypes",[String,Object,Object,String]),o("design:returntype",Promise)],t.prototype,"start",null),i([_.callOperation(h.CALL_OPERATIONS_INTERNAL.ELECTRON_STOP_SCREEN_SHARING,{waitFor:h.CALL_OPERATIONS_INTERNAL.ELECTRON_START_SCREEN_SHARING}),o("design:type",Function),o("design:paramtypes",[String,String]),o("design:returntype",Promise)],t.prototype,"stop",null),t}(d.default);t.default=m},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=function(){function e(e){if(this._slimcoreInstance=e,!this._slimcoreInstance.getMonitorList||!this._slimcoreInstance.getWindowList){var t=r.isSlimCoreRTModuleAvailable()?SlimCoreRT.SlimCore:SlimCore;if(!t.ScreenScraper)throw new Error("ScreenScraper not supported");this._screenScraper=new t.ScreenScraper}}return e.prototype.getMonitorList=function(){if(this._slimcoreInstance.getMonitorList)return this._slimcoreInstance.getMonitorList();if(this._screenScraper)return this._screenScraper.getMonitorList();throw new Error("not supported")},e.prototype.getMonitorPreview=function(e,t,n,i,o){return this._slimcoreInstance.getMonitorSnapshot?this._slimcoreInstance.getMonitorSnapshot(e,{width:t,height:n,asImage:i},o).then(r.convertImageData):this._screenScraper?this._screenScraper.getMonitorPreview(e,t,n,i):Promise.reject(new Error("not supported"))},e.prototype.getWindowList=function(){if(this._slimcoreInstance.getWindowList)return this._slimcoreInstance.getWindowList();if(this._screenScraper)return this._screenScraper.getWindowList();throw new Error("not supported")},e.prototype.getWindowPreview=function(e,t,n,i){return this._slimcoreInstance.getWindowSnapshot?this._slimcoreInstance.getWindowSnapshot(e,{width:t,height:n,asImage:i}).then(r.convertImageData):this._screenScraper?this._screenScraper.getWindowPreview(e,t,n,i):Promise.reject(new Error("not supported"))},e.prototype.getWindowIcon=function(e,t,n,i){return this._slimcoreInstance.getWindowIcon?this._slimcoreInstance.getWindowIcon(e,{width:t,height:n,asImage:i}).then(r.convertImageData):this._screenScraper?this._screenScraper.getWindowIcon(e,t,n,i):Promise.reject(new Error("not supported"))},e}();t.default=i},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),s=n(4),l=n(11),c=n(2),d=n(1),u=n(3),p=SlimCore.Enums,h=0,g=function(e){function t(t,n,r,i,o,a){var s=e.call(this,t,n,r)||this;s.objectId=o,s.label=a;var l=function(e){var t=e===p.VideoStatus.Running;t!==s.isStreaming&&(s.isStreaming=t,s._logger.info("VideoState["+o+","+a+"] videoStatusChanged isRunning: "+s.isStreaming+" status: "+e),s.raiseChanged())},c=i.getIntProperty(o,p.Property.VideoStatus);return l(c),s._logger.info("VideoState ctor "+o+" "+c+" "+s.isStreaming),s._slimcoreInstance.handle("object-property-changed",{objectId:o,propKey:p.Property.VideoStatus},function(e){return l(e.value)}),s}return r(t,e),t}(u.default);t.VideoState=g;var _=function(e){function t(t,n,r,i,o,a,s){var c=e.call(this,t.createChild(function(){return"LocalVideo["+c._id+"]"}),n,r)||this;c._callObjectId=i,c._callHandler=o,c._deviceManager=a,c._id=h++,c._state=null,c._shouldRun=!1,c._disableFastCameraSwap=!1,c.mediaType=1,c.isStreaming=!1;try{c._disableFastCameraSwap=c._slimcoreInstance.ecsGetSettingAsBool("MediaAgent","tsc_disableFastCameraSwap",!1)}catch(e){c._logger.logFailure(e)}return c._logger.info("constructor causeId: "+s+" disableFastCameraSwap "+c._disableFastCameraSwap),c._chainedApiPromise=new l.default(t.createChild(function(){return"LocalVideo["+c._id+"]"})),c._registerDisposable(c._deviceManager.on("devicesChanged",function(){return c._devicesChanged(s)})),c}return r(t,e),t.prototype.setRunning=function(){var e=!!this._state&&!!a.find(this._state.videoStates,function(e){return e.isStreaming});this.isStreaming!==e&&(this._logger.info("isStreaming changed to: "+e),this.isStreaming=e,this.raiseChanged())},t.prototype.setVideoState=function(e){var t=this;this._state&&a.forEach(this._state.videoStates,function(e){return e.dispose()}),this._state=e,this._state&&a.forEach(this._state.videoStates,function(e){return e.changed(function(){return t.setRunning()})}),this.setRunning()},t.prototype._devicesChanged=function(e){var t=this;this._logger.info("_devicesChanged causeId: "+e),this._chainedApiPromise.chainPromise(function(){return t._swapVideoDevice(e)},"swapVideoDevice",e)},t.prototype.start=function(e,t){var n=this;return this._logger.info("start causeId: "+e),this._shouldRun=!0,this._chainedApiPromise.chainPromise(function(){return n._startVideo(e,t)},"start",e)},t.prototype.stop=function(e,t){var n=this;return this._logger.info("stop causeId: "+e),this._shouldRun=!1,this._chainedApiPromise.chainPromise(function(){return n._stopVideo(e,!1,t)},"stop",e)},t.prototype.dumpVideoSourceImages=function(){return i(this,void 0,void 0,function(){return o(this,function(e){if(!this._isRunning())throw new Error("Cannot dump video fx debug images when there is no local video");return[2,this._slimcoreInstance.dumpVideoSourceImages(this._state.videoStates[0].objectId)]})})},t.prototype.dispose=function(e){var t=this;void 0===e&&(e=c.generateCauseId()),this._logger.info("dispose causeId: "+e),this._shouldRun=!1,this._chainedApiPromise.chainPromise(function(){return t._dispose(e)},"dispose",e)},t.prototype._isRunning=function(){return!!this._state},t.prototype._dispose=function(t){return i(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return n.trys.push([0,,2,3]),[4,this._stopVideo(t,!0)];case 1:return n.sent(),[3,3];case 2:return e.prototype.dispose.call(this,t),[7];case 3:return[2]}})})},t.prototype._areAllStreamsStreaming=function(e){return a.reduce(e.videoStates,function(e,t){return e&&t.isStreaming},!0)},t.prototype._swapVideoDevice=function(e){return i(this,void 0,void 0,function(){var t,n,r,i,a,s;return o(this,function(o){switch(o.label){case 0:return this._shouldRun?(t=this._deviceManager.getSelectedCamera())?this._ignoredVideoDeviceInVideoSwap&&this._ignoredVideoDeviceInVideoSwap.id!==t.id?(this._ignoredVideoDeviceInVideoSwap=t,this._isRunning()?(n=this._state,r=this._disableFastCameraSwap||!this._areAllStreamsStreaming(n),this._logger.info("_swapVideoDevice causeId: "+e+" full stopstart? "+r+" will change local video device: "+this._state.camera.id+" -> "+t.id),this.setVideoState(null),r?[4,this._stopVideoDevices(e,n,this._negotiationTag)]:[3,3]):[3,8]):[2]:(this._logger.info("_swapVideoDevice causeId: "+e+" noop, no selected device, should run: "+this._shouldRun+" is running: "+this._isRunning()),[2]):(this._logger.info("_swapVideoDevice causeId: "+e+" noop, should run: "+this._shouldRun+" is running: "+this._isRunning()),[2]);case 1:return o.sent(),i=this.setVideoState,[4,this._startVideoDevices(e,t,this._negotiationTag)];case 2:return i.apply(this,[o.sent()]),[3,7];case 3:return o.trys.push([3,,5,7]),a=this.setVideoState,[4,this._startVideoDevices(e,t,this._negotiationTag)];case 4:return a.apply(this,[o.sent()]),[3,7];case 5:return[4,this._stopVideoDevices(e,n,this._negotiationTag)];case 6:return o.sent(),[7];case 7:return[3,10];case 8:return this._logger.info("_swapVideoDevice causeId: "+e+" will resurrect local video device: "+t.id),s=this.setVideoState,[4,this._startVideoDevices(e,t,this._negotiationTag)];case 9:s.apply(this,[o.sent()]),o.label=10;case 10:return[2]}})})},t.prototype._startVideo=function(e,t){return i(this,void 0,void 0,function(){var n,r;return o(this,function(i){switch(i.label){case 0:return!this._shouldRun||this._isRunning()?[3,2]:(n=this._getSelectedCamera(e),this._negotiationTag=t||this._negotiationTag,r=this.setVideoState,[4,this._startVideoDevices(e,n,this._negotiationTag)]);case 1:return r.apply(this,[i.sent()]),this._ignoredVideoDeviceInVideoSwap=n,[3,3];case 2:this._logger.info("_startVideo causeId: "+e+" noop, should run: "+this._shouldRun+" is running: "+this._isRunning()),i.label=3;case 3:return[2]}})})},t.prototype._getSelectedCamera=function(e){var t=this._deviceManager.getSelectedCamera();if(!t)throw new Error("_getSelectedCamera causeId: "+e+" no selected camera to start local video");return t},t.prototype._getCamerasToStart=function(e){var t=this,n=[],r=function(e){var r=t._deviceManager.getLabelByCameraPosition(e);n.push({camera:e,label:r})},i=this._deviceManager.getChildCameras(e.id);return a.isEmpty(i)?r(e):i.forEach(r),n},t.prototype._startVideoDevices=function(e,t,n){return i(this,void 0,void 0,function(){var r,i,a,s=this;return o(this,function(o){switch(o.label){case 0:r={camera:t,videoStates:[]},i=this._getCamerasToStart(t),o.label=1;case 1:return o.trys.push([1,3,,6]),[4,Promise.all(i.map(function(t){return s._startVideoObject(e,t.camera,t.label,n).then(function(e){r.videoStates.push(new g(s._logger,s._settings,s._slimcoreInstance,s._callHandler,e,t.label))})}))];case 2:return o.sent(),[3,6];case 3:return a=o.sent(),this._logger.info("_startVideoDevices causeId: "+e+" failed for some cameras"),r.videoStates.length>0?[4,this._stopVideoDevices(e,r,this._negotiationTag)]:[3,5];case 4:o.sent(),o.label=5;case 5:throw a;case 6:return[2,r]}})})},t.prototype._startVideoObject=function(e,t,n,r){return i(this,void 0,void 0,function(){var i,a=this;return o(this,function(o){switch(o.label){case 0:if(this._logger.info("_startVideoObject causeId: "+e+" create local video "+n+" for device name: "+t.label+" path: "+t.id),0===(i=this._slimcoreInstance.createLocalVideo(p.VideoType.Video,t.label,t.id,n)))throw new Error("_startVideoObject id-"+i+" causeId: "+e+" local video is null?");return[4,d.waitForVideoObjectState({slimcoreInstance:this._slimcoreInstance,slimcoreObject:this._callHandler,videoObjectId:i,logger:this._logger,resolveStates:[p.VideoStatus.Starting,p.VideoStatus.Running],rejectStates:[p.VideoStatus.Stopping,p.VideoStatus.NotStarted],timeout:1e3,operation:function(){return s.asap(function(){a._logger.info("_startVideoObject id-"+i+" causeId: "+e+" attach local video and wait it to become AVAILABLE"),a._callHandler.callAttachSendVideo(a._callObjectId,i),a._logger.info("_startVideoObject id-"+i+" causeId: "+e+" start local video and wait it to become STARTING|RUNNING"),a._slimcoreInstance.videoStart(i,r)})}})];case 1:return o.sent(),this._logger.info("_startVideoObject id-"+i+" causeId: "+e+" start local video successful"),[2,i]}})})},t.prototype._stopVideo=function(e,t,n){return i(this,void 0,void 0,function(){var r;return o(this,function(i){switch(i.label){case 0:return this._shouldRun&&!t||!this._isRunning()?[3,2]:(this._ignoredVideoDeviceInVideoSwap=void 0,this._negotiationTag=n||this._negotiationTag,r=this._state,this.setVideoState(null),[4,this._stopVideoDevices(e,r,this._negotiationTag)]);case 1:return i.sent(),[3,3];case 2:this._logger.info("_stopVideo causeId: "+e+" noop, force: "+t+" should run: "+this._shouldRun+" is running: "+this._isRunning()),i.label=3;case 3:return[2]}})})},t.prototype._doCallVideoStop=function(e){return!this._state||!this._state.videoStates.find(function(t){return t.label===e})},t.prototype._stopVideoDevices=function(e,t,n){return i(this,void 0,void 0,function(){var r=this;return o(this,function(i){switch(i.label){case 0:return[4,Promise.all(t.videoStates.map(function(t){return r._stopVideoObject(e,t.objectId,r._doCallVideoStop(t.label),n)}))];case 1:return i.sent(),[2]}})})},t.prototype._stopVideoObject=function(e,t,n,r){return i(this,void 0,void 0,function(){var i=this;return o(this,function(o){switch(o.label){case 0:return[4,d.waitForVideoObjectState({slimcoreInstance:this._slimcoreInstance,slimcoreObject:this._callHandler,videoObjectId:t,logger:this._logger,resolveStates:[p.VideoStatus.Stopping,p.VideoStatus.NotStarted,p.VideoStatus.Available],rejectStates:[],timeout:1e3,operation:function(){return s.asap(function(){n&&(i._logger.info("_stopVideoObject id-"+t+" causeId: "+e+" stop local video and wait it to become STOPPING|NOT_STARTED|AVAILABLE"),i._slimcoreInstance.videoStop(t,r))})}})];case 1:return o.sent(),this._logger.info("_stopVideoObject id-"+t+" causeId: "+e+" stop local video successful"),[2]}})})},t}(u.default);t.default=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),s=n(4),l=n(7),c=n(33),d=n(5),u=n(1),p=n(3),h=n(12),g=n(22),_=n(23),f=SlimCore.Enums,m=n(2),C=n(15),S=n(21),y=function(e){function t(t,n,r,i,o,a,l){var c=e.call(this,new S.default(t).createChild("CallRegistry"),n,r)||this;return c._deviceManager=i,c._appHooks=o,c._telemetryLoggers=a,c._skypeIdentity=l,c.calls=[],c._loginPromiseDefered=s.defer(),c._logoutPromiseDefered=s.defer(),c._startSlimcorePromiseDefered=s.defer(),c.isDisposing=!1,c._disposedPromise=s.defer(),c.slimcoreInstanceStartCalled=!1,c._logger.info("constructor"),c._slimcoreInstance.setMaxListeners(0),c._ecsProvider=new g.default(c._slimcoreInstance),l&&(c.identity=l.id,c._setup=new _.default(c._slimcoreInstance,c.identity)),c}return r(t,e),t.prototype.dispose=function(t){return void 0===t&&(t=m.generateCauseId()),i(this,void 0,void 0,function(){var n,r,i,a,s=this;return o(this,function(o){return(n=this._logger.createFnLogger("dispose",t)).info("disposing call registry"),this.isDisposing?(n.warn("call registry is already in disposing stage!"),[2,this._disposedPromise.promise]):(this.isDisposing=!0,r=function(){s.calls=[],s._slimcoreCallHandler&&(s._slimcoreCallHandler.dispose(),s._slimcoreCallHandler=void 0),n.info("callhandler is disposed"),s._account&&(s._account.dispose(),s._account=void 0),n.info("account is disposed"),s.event("disposed").raise(),e.prototype.dispose.call(s),s._disposedPromise.resolve()},i=this.calls.map(function(e){return e.stop()}),a=function(){return s.logout(t)},Promise.all(i).then(a,a).then(r,r),[2,this._disposedPromise.promise])})})},Object.defineProperty(t.prototype,"loginPromise",{get:function(){return this._loginPromiseDefered.promise},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"disposePromise",{get:function(){return this._disposedPromise.promise},enumerable:!0,configurable:!0}),t.prototype._initCall=function(e,t,n){this._logger.createFnLogger("initCall[callId="+e.callId+"][participantId="+e.participantId+"]",n).info("callObjectId="+t),e.incomingCallInit(t,n)},t.prototype._incomingCallMonitor=function(e,t){var n=this._logger.createFnLogger("incomingCallMonitor",t);n.info("_incomingCallMonitor for objectPropertyChange objectId="+e.objectId);var r=this._getStrProperty(this._slimcoreCallHandler,e.objectId,f.Property.CallName);if(u.hasFeature(f.Feature.MultiUserSupport)){var i=this._getStrProperty(this._slimcoreCallHandler,e.objectId,f.Property.CallAccountIdentity);if(i!==this.identity)return void n.info("incoming call("+r+") for user("+d.mriOrId(i)+") but current user is "+d.mriOrId(this.identity))}var o=this._getStrProperty(this._slimcoreCallHandler,e.objectId,f.Property.CallLegId);this._getCall(r,o,t)||n.logFailure("getCall failed to find the call(callId: "+r+", localParticipantId: "+o+")")},t.prototype.init=function(e,t,n){var r=this;void 0===t&&(t={block:!0}),void 0===n&&(n=m.generateCauseId());var i=this._logger.createFnLogger("init",n);i.info("init"),t.block||u.hasFeature(f.Feature.AsyncStart)||(t.block=!0);var o=null;return this.slimcoreInstanceStartCalled?i.info("skipping slimcoreInstance start, because it was already started"):(t.block||this._registerDisposable(this._slimcoreInstance.handle("lib-status-changed",{libStatus:SlimCore.Enums.LibStatus.Running},function(e){return r._onLibStatusChanged(e)})),this._slimcoreInstance.setupSetStr("*Lib/SCT/Telemetry/DiagnosticLevel",t.telemetryDiagnosticLevel||""),this._slimcoreInstance.start(t.block),i.info("starting slimcoreInstance block="+t.block),this.slimcoreInstanceStartCalled=!0,t.block&&(this.libStatus=f.LibStatus.Running,this._startSlimcorePromiseDefered.resolve())),this._skypeIdentity=e,this.identity=e.id,this._skypeIdentity.tokenProvider().then(function(e){i.info("setting up stack callbacks"),o=r._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.AccountStatus,value:f.AccountStatus.LoggedIn},function(){var e=r._slimcoreInstance.createCallInterface();r._slimcoreCallHandler=u.wrap(e,r._settings),i.info("createCallInterface returned"),r._loginPromiseDefered.resolve(r._slimcoreCallHandler),o&&(o.dispose(),o=null),r._hookCallRegistryEvents()}),r._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.CallStatus,value:f.CallStatus.RingingIn},function(e){return r._incomingCallMonitor(e,n)}),r._initializeSlimCore(e),r._logger.info("initialize returned")}).catch(function(e){i.logFailure(e),r._loginPromiseDefered.reject(e)}),this.loginPromise.then(l.noop)},t.prototype.uninit=function(){var e=this;this.slimcoreInstanceStartCalled?this.libStatus!==f.LibStatus.Running&&(this._startSlimcorePromiseDefered.reject(new Error("Callregistry uninit called before slimcore reached Running state")),this._logoutPromiseDefered.reject(new Error("Callregistry uninit called before slimcore reached Running state"))):this._logoutPromiseDefered.reject(new Error("CallRegistry uninit called without slimcore::start()"));var t=null;try{this._logger.info("uninit: setting up stack callbacks"),t=this._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.AccountStatus,value:f.AccountStatus.LoggedOut},function(){e._logoutPromiseDefered.resolve(),t&&(t.dispose(),t=null)}),this._logger.info("uninit(): calling slimcore.logout()"),this._slimcoreInstance.logout()}catch(e){this._logger.error("slimcore.logout() failed.",e),this._logoutPromiseDefered.reject(e)}return this.slimcoreInstanceStartCalled=!1,this._logoutPromiseDefered.promise.then(l.noop)},t.prototype.login=function(e,t){return void 0===t&&(t=m.generateCauseId()),this._logger.createFnLogger("login",t).info("login"),this._skypeIdentity=e,this.identity=e.id,this._setup=new _.default(this._slimcoreInstance,this.identity),this.initialize(t)},t.prototype.initialize=function(e,t){var n=this;void 0===e&&(e=m.generateCauseId());var r=this._logger.createFnLogger("initialize",e);r.info("initialize");var i=null;return this._skypeIdentity.tokenProvider().then(function(o){r.info("setting up stack callbacks"),i=n._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.AccountStatus,value:f.AccountStatus.LoggedIn},function(e){if(u.hasFeature(f.Feature.MultiUserSupport)&&n._account.getObjectId()!==e.objectId)r.error("accountObjectId: "+n._account.getObjectId+" does not match with "+e.objectId);else{var t=n._createCallHandler();n._slimcoreCallHandler=u.wrap(t,n._settings),r.info("createCallInterface returned"),n._loginPromiseDefered.resolve(n._slimcoreCallHandler),i&&(i.dispose(),i=null),n._hookCallRegistryEvents()}}),n._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.CallStatus,value:f.CallStatus.RingingIn},function(t){return n._incomingCallMonitor(t,e)}),n._login(o,n._skypeIdentity.displayName,r,JSON.stringify(t))}).catch(function(e){r.logFailure(e),n._loginPromiseDefered.reject(e)}),this.loginPromise.then(function(){return n.setAdditionalIdentities()})},t.prototype._login=function(e,t,n,r){if(u.hasFeature(f.Feature.MultiUserSupport)){if(this._account)return n.info("already logged in. updating displayname and skypetoken!"),this._account.updateDisplayName(t),void this._account.updateSkypeToken(e);var i=this._slimcoreInstance.getAccount(this.identity);this._account=u.wrap(i,this._settings),this._account.login(e,t,u.mapToEmptyStrIfFalsy(r))}else this._slimcoreInstance.login(this.identity,e,t)},t.prototype._createCallHandler=function(){return u.hasFeature(f.Feature.MultiUserSupport)?this._slimcoreInstance.getCallHandler(this._account.getObjectId()):this._slimcoreInstance.createCallInterface()},t.prototype.logout=function(e){var t=this;void 0===e&&(e=m.generateCauseId());var n=this._logger.createFnLogger("logout",e);n.info("logout");var r=null;try{n.info("setting up stack callbacks"),r=this._slimcoreInstance.handle("object-property-changed",{propKey:f.Property.AccountStatus,value:f.AccountStatus.LoggedOut},function(e){u.hasFeature(f.Feature.MultiUserSupport)&&t._account.getObjectId()!==e.objectId||(t._logoutPromiseDefered.resolve(),r&&(r.dispose(),r=null))}),n.info("calling slimcore.logout()"),this._logout()}catch(e){n.error("slimcore.logout() failed.",e),this._logoutPromiseDefered.reject(e)}return this._logoutPromiseDefered.promise.then(l.noop)},t.prototype._logout=function(){u.hasFeature(f.Feature.MultiUserSupport)?this._account.logout():this._slimcoreInstance.logout()},t.prototype.setConfiguration=function(e){var t=this;return Promise.resolve().then(function(){if(u.hasFeature(f.Feature.MultiUserSupport)&&t._account&&t._account.setConfiguration){var n=JSON.stringify(e);t._logger.info("setConfiguration:"+n),t._account.setConfiguration(n)}})},t.prototype.updateDisplayName=function(e){var t=this;return Promise.resolve().then(function(){return u.hasFeature(f.Feature.MultiUserSupport)&&t._account?t._account.updateDisplayName(e):t._skypeIdentity.tokenProvider().then(function(n){return t._login(n,e,t._logger)})})},t.prototype.updateSkypeToken=function(e){u.hasFeature(f.Feature.MultiUserSupport)&&this._account?this._account.updateSkypeToken(e):this._slimcoreInstance.updateSkypeToken(e)},t.prototype.updateToken=function(e,t,n,r,i){var o=this;return Promise.resolve().then(function(){return u.hasFeature(f.Feature.MultiUserSupport)&&o._account?(o._account.updateToken(e,JSON.stringify(t),n||"",r,i||0),C.getSuccessTransactionEnd()):Promise.reject("Invalid, update token require MTMA, and account should be logged in")})},t.prototype.fireIntent=function(e,t){var n=this;return Promise.resolve().then(function(){u.hasFeature(f.Feature.MultiUserSupport)&&n._slimcoreInstance.fireIntent(f.Intent.CallPush,t,void 0,n.identity)})},t.prototype.getSetup=function(){return this._setup},t.prototype.getEcsProvider=function(){return this._ecsProvider},t.prototype.createCall=function(e,t,n,r,i){var o=this;void 0===i&&(i=m.generateCauseId());var s=this._logger.createFnLogger("createCall",i);if(s.info("threadId:"+e+", callId:"+t+", localParticipantId: "+n+", messageId:"+r),null===this._slimcoreCallHandler||void 0===this._slimcoreCallHandler)throw s.logFailure("Stack not initialized yet"),new Error("Stack not initialized yet");this._skypeIdentity.tokenProvider().then(function(e){e&&(s.info("Updating Skype Token..."),o.updateSkypeToken(e),s.info("Token update complete"))});var l=null;return e&&(l=a.find(this.calls,function(n){return n.threadId===e&&(t&&n.callId===t||r&&n.messageId===r)}))?(s.logFailure("Call Registry already has an entry for threadId: "+l.threadId+", callId: "+l.callId+", messageId: "+l.messageId),l):(l=this._getCall(t,n,i))?l:(l=new h.default(this._logger,this._settings,this._slimcoreInstance,this._slimcoreCallHandler,this._deviceManager,this._appHooks,e,t||c.default(),this._skypeIdentity,n,this._telemetryLoggers,r),this.calls.push(l),this.event("callAdded").raise(l),this.raiseChanged(),l)},t.prototype.getCall=function(e,t,n){return void 0===n&&(n=m.generateCauseId()),this._getCall(e,t,n)},t.prototype._getCall=function(e,t,n){var r=this,i=this._logger.createFnLogger("getCall[callId="+e+"][participantId="+t+"]",n);if(!e&&!t)return i.logFailure("callId & participantId is undefined"),null;if(null===this._slimcoreCallHandler||void 0===this._slimcoreCallHandler)throw i.logFailure("Stack not initialized yet"),new Error("Stack not initialized yet");var o=a.find(this.calls,function(t){return t.callId===e});if(o)return 8===o.state?(this._initCall(o,o.slimcoreCallId,n),o):(i.info("Call Registry already has an entry for this call"),o);var s=a.find(this._slimcoreCallHandler.getActiveCalls(),function(n){return r._slimcoreCallHandler.getStrProperty(n,f.Property.CallName)===e&&r._slimcoreCallHandler.getStrProperty(n,f.Property.CallLegId)===t});if(!s)return i.logFailure("slimCoreCallObjectId not found"),null;var l=this._slimcoreCallHandler.getStrProperty(s,f.Property.CallThreadId),c=this._slimcoreCallHandler.getStrProperty(s,f.Property.CallMessageId);return o=new h.default(this._logger,this._settings,this._slimcoreInstance,this._slimcoreCallHandler,this._deviceManager,this._appHooks,l,e,this._skypeIdentity,t,this._telemetryLoggers,c),this._initCall(o,s,n),this.calls.push(o),this.event("callAdded").raise(o),this.raiseChanged(),o},t.prototype.deleteCall=function(e,t,n){var r=this;void 0===t&&(t=!0),void 0===n&&(n=m.generateCauseId()),this._logger.info("deleteCall "+e.callId);var i=!1;return a.each(a.remove(this.calls,function(t){return t===e}),function(o){i=!0,t&&(r.event("callRemoved").raise(e),7!==o.state&&o.dispose(n))}),!!i&&(this.raiseChanged(),!0)},t.prototype.debugInformation=function(e){var t=this._slimcoreCallHandler.getDebugInformation("/callinfo");return!e||t&&!a.isEmpty(t)||(t="CallInformation\n * CallId="+e.callId),Promise.resolve(t)},t.prototype.setLocationInfo=function(e,t,n){var r=this;void 0===n&&(n=m.generateCauseId());var i=this._logger.createFnLogger("setLocationInfo",n);if(i.info("infoType:"+e+", contentJson:(redacted)"),!this._slimcoreCallHandler)throw i.logFailure("Stack not initialized yet"),new Error("Stack not initialized yet");return this.loginPromise.then(function(){return r._slimcoreCallHandler.setLocationInfo(r.mapLocationInfoType(e),t)}).catch(function(e){throw i.logFailure(e),e})},t.prototype.mapLocationInfoType=function(e){switch(e){case 0:return f.LocationInfoType.NoLocationInfo;case 1:return f.LocationInfoType.LocationContent;case 2:default:return f.LocationInfoType.NetworkContent}},t.prototype.setAdditionalIdentities=function(){var e=this;return Promise.resolve().then(function(){if(e._skypeIdentity.sipUri){var t="2:"+e._skypeIdentity.sipUri;u.hasFeature(f.Feature.MultiUserSupport)&&e._account?e._account.setAdditionalIdentities(t):e._slimcoreInstance.setAdditionalIdentities(t)}})},t.prototype._initializeSlimCore=function(e){var t=this;try{this._startSlimcorePromiseDefered.promise.then(function(){t._logger.info("logging in to slimcore libStatus="+t.libStatus),t._slimcoreInstance.login(t._skypeIdentity.id,e,t._skypeIdentity.displayName)})}catch(e){this._logger.error("initialization failed.",e)}},t.prototype._onSkypeTokenRequired=function(e){this.event("skypeTokenRequired").raise(e.invalidToken)},t.prototype._onTokenRequired=function(e){this._logger.info("_onTokenRequired factors="+e.factorsJson+" metadata="+e.requestMetadataJson+" tokenType="+e.tokenType);try{var t=JSON.parse(e.requestMetadataJson);this.event("tokenRequired").raise(e.factorsJson,e.tokenType,t,e.invalidToken)}catch(e){this._logger.warn("_onTokenRequired failed to parse requestMetadataJson")}},t.prototype._onLibStatusChanged=function(e){this._logger.info("_onLibStatusChanged from "+this.libStatus+" => "+e.libStatus),e.libStatus===f.LibStatus.Running?this._startSlimcorePromiseDefered.resolve():e.libStatus===f.LibStatus.FatalError&&this.libStatus===f.LibStatus.Constructed&&this._startSlimcorePromiseDefered.reject(new Error("Slimcore FatalError during start")),this.libStatus=e.libStatus},t.prototype._onProxiedPushNotification=function(e){var t={eventId:e.eventId,payload:e.payload};this.event("proxiedPushNotification").raise(t)},t.prototype._hookCallRegistryEvents=function(){var e=this;u.hasFeature(f.Feature.MultiUserSupport)&&this._account?(this._registerDisposable(this._account.handle("skype-token-required",void 0,function(t){return e._onSkypeTokenRequired(t)})),this._registerDisposable(this._account.handle("token-required",void 0,function(t){return e._onTokenRequired(t)})),this._registerDisposable(this._slimcoreCallHandler.handle("proxied-push-notification",void 0,function(t){return e._onProxiedPushNotification(t)}))):(this._registerDisposable(this._slimcoreInstance.handle("skype-token-required",void 0,function(t){return e._onSkypeTokenRequired(t)})),this._registerDisposable(this._slimcoreInstance.handle("proxied-push-notification",void 0,function(t){return e._onProxiedPushNotification(t)})))},t}(p.default);t.default=y},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var s=n(0),l=n(1),c=n(3),d=n(51),u=n(20),p=n(36),h=SlimCore.Enums,g=n(4),_=n(2),f=function(){function e(e){this._logger=e,this._devices=[],this._slimcoreDevices=[],this._logger.info("constructor")}return e.prototype._getDeviceId=function(e){return e?e.id:null},e.prototype.getList=function(){return this._devices},e.prototype.update=function(e){var t=!s.isEqual(s.sortBy(this._slimcoreDevices),s.sortBy(e));return t&&(this._slimcoreDevices=e,this._logger.info("update: "+JSON.stringify(e)),this._devices=this._enumerate(e)),t},e}(),m=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._getBestDevice=function(){return this._getDeviceId(s.first(this._devices))},t.prototype._isAvailable=function(e){return!(!e||!s.find(this._devices,function(t){return t.id===e}))},t.prototype.getSelectedDevice=function(){if(this._isAvailable(this._selectedDevice))return this._logger.debug("getSelectedDevice: "+this._selectedDevice),this._selectedDevice;var e=this._getBestDevice();return this._logger.debug("getSelectedDevice - unknown device selected, returning preferred device: "+e),e},t.prototype.selectDevice=function(e){this._isAvailable(e)?(this._logger.info("selectDevice: "+e),this._selectedDevice=e):(this._logger.info("selectDevice - unknown device selected, selecting preferred device"),this._selectedDevice=null)},t}(f),C=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._getBestDevice=function(){var t=this._findCamera(3),n=this._findCamera(1),r=this._findCamera(4),i=this._findCamera(5),o=this._findCamera(),a=e.prototype._getBestDevice.call(this);return t||n||r||i||o||a},t.prototype._enumerate=function(e){var t=this,n=this._enumerateComposites(e),r=s.filter(e,function(e){return-1===s.findIndex(n,function(t){return t.id===e.id})});return s.map(r,function(e){return t._convert(e,1)}).concat(n)},t.prototype._convert=function(e,t){return{id:e.id,browserId:e.browserId,label:e.label,kind:t,position:this._getCameraPosition(e.cameraFacing),isVirtual:e.deviceType===h.DeviceType.Virtual}},t.prototype._enumerateComposites=function(e){var t=this,n=[],r=s.filter(e,function(e){return!!e.compositeId}),o=s.groupBy(r,"compositeId");return Object.keys(o).forEach(function(e){if(o[e].length>1){var r={id:"composite_video_"+e,label:"Composite Device "+e,kind:1,position:0,isVirtual:!0,isComposite:!0};n.push(r),o[e].forEach(function(e,o){var a=i({},t._convert(e,5),{parentId:r.id,useForPreview:0===o});n.push(a),0===r.position&&6===a.position&&(r.position=a.position,r.label=a.label)})}}),n},t.prototype._findCamera=function(e){var t=s.find(this._devices,function(t){return!(t.isVirtual||e&&t.position!==e)});return this._getDeviceId(t)},t.prototype._getCameraPosition=function(e){switch(e){case h.CameraFacing.Front:return 1;case h.CameraFacing.LeftFront:return 4;case h.CameraFacing.RightFront:return 5;case h.CameraFacing.Back:return 2;case h.CameraFacing.External:return 3;case h.CameraFacing.Panoramic:return 6;default:return 0}},t}(m),S=function(e){function t(t,n){var r=e.call(this,n)||this;return r._kind=t,r}return r(t,e),t.prototype._enumerate=function(e){var t=this,n=s.find(e,function(e){return e.isSystemDefault})||s.first(e);return s.map(e,function(e){return{id:e.id,browserId:e.browserId,label:e.label,kind:t._kind,productId:""+(e.productId||""),vendorId:""+(e.vendorId||""),isSystemDefault:e===n}})},t}(m),y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._enumerate=function(e){var t=this;return s.map(e,function(e){return{id:null,browserId:null,label:e.label,kind:4,microphoneId:e.microphoneId,speakerId:e.speakerId,formFactor:t._getCompositeDeviceFormFactor(e.deviceType),isPcInternalDevice:e.isPcInternalDevice}})},t.prototype._getCompositeDeviceFormFactor=function(e){switch(e){case h.CompositeAudioDeviceType.Speakers:return 1;case h.CompositeAudioDeviceType.Headphones:return 2;case h.CompositeAudioDeviceType.Headset:return 3;case h.CompositeAudioDeviceType.Handset:return 4;case h.CompositeAudioDeviceType.Speakerphone:return 5;default:return 0}},t}(f),v=function(e){function t(t,n,r,i,o){var a=e.call(this,t.createChild("DeviceManager"),n,r)||this;return a._mediaReadyPromise=i,a._appHooks=o,a._browserDevices=[],a._haveStartedMedia=!1,a._startPreviewVideo=function(e){return a._mediaReadyPromise.then(function(t){return a._logger.info("Wait AVAILABLE for preview video "+e),l.waitForVideoObjectState({slimcoreInstance:a._slimcoreInstance,slimcoreObject:t,videoObjectId:e,logger:a._logger,resolveStates:[h.VideoStatus.Available],rejectStates:[h.VideoStatus.NotAvailable],timeout:l.videoObjectTimeout(a._settings)}).then(function(){return l.waitForVideoObjectState({slimcoreInstance:a._slimcoreInstance,slimcoreObject:t,videoObjectId:e,logger:a._logger,resolveStates:[h.VideoStatus.Starting,h.VideoStatus.Running],rejectStates:[h.VideoStatus.NotAvailable],timeout:l.videoObjectTimeout(a._settings),operation:function(){return g.asap(function(){a._logger.info("Starting preview video "+e),a._slimcoreInstance.videoStart(e)})}})}).then(function(){return a._logger.info("Now can use preview video "+e)})})},a._stopPreviewVideo=function(e){return g.asap(function(){a._logger.info("Stopping preview video "+e),a._slimcoreInstance.videoStop(e)})},a._createRendererBinding=function(e){var t;return a._previewVideoManager.acquire(a._rendererBindingManager,e).then(function(){return t=a._slimcoreInstance.createVideoBindingRenderer?a._slimcoreInstance.createVideoBindingRenderer({enableDXVA:a._settings.enableDXVA,isLocalPreview:!0}):SlimCore.createVideoBindingRenderer(),a._logger.info("Create rendering binding for preview video "+e),a._slimcoreInstance.videoCreateBinding(e,t)}).then(function(){return a._logger.info("Created rendering binding for preview video "+e),t})},a._releaseRendererBinding=function(e,t){return g.asap(function(){return a._logger.info("Release rendering binding for preview video "+e),a._slimcoreInstance.videoReleaseBinding(e,t)}).then(function(){return a._logger.info("Released rendering binding for preview video "+e),a._previewVideoManager.release(a._rendererBindingManager,e)})},a._createScreenShareBinding=function(e){var t;return a._previewVideoManager.acquire(a._screenShareBindingManager,e).then(function(){return t=a._createVideoBindingScreenShare(),a._logger.info("Create screenshare binding for preview video "+e),a._slimcoreInstance.videoCreateBinding(e,t)}).then(function(){return a._logger.info("Created screenshare binding for preview video "+e),t})},a._releaseScreenShareBinding=function(e,t){return g.asap(function(){return a._logger.info("Release screenshare binding for preview video "+e),a._slimcoreInstance.videoReleaseBinding(e,t)}).then(function(){return a._logger.info("Released screenshare binding for preview video "+e),a._previewVideoManager.release(a._screenShareBindingManager,e)})},a._logger.info("constructor"),a._cameras=new C(a._logger.createChild("cameras")),a._microphones=new S(2,a._logger.createChild("microphones")),a._speakers=new S(3,a._logger.createChild("speakers")),a._compositeDevices=new y(a._logger.createChild("compositeaudiodevices")),a._devicesEnumeratedPromise=a._mediaReadyPromise.then(function(){return a._updateBrowserDevices()}).then(function(){a._updateAudioDevices(),a._updateVideoDevices(),a._handleDisplaysChanged()}),a._previewVideoManager=new d.SlimCoreElectronBindingManager(a._startPreviewVideo,a._stopPreviewVideo,a._logger),a._rendererBindingManager=new d.SlimCoreElectronBindingManager(a._createRendererBinding,a._releaseRendererBinding,a._logger),a._screenShareBindingManager=new d.SlimCoreElectronBindingManager(a._createScreenShareBinding,a._releaseScreenShareBinding,a._logger),a._registerDisposable(a._slimcoreInstance.handle("device-list-changed",void 0,function(e){return a._slimCoreDevicesChangedHander(e)})),a._registerDisposable(a._appHooks.onDisplaysChanged(function(){return a._handleDisplaysChanged()})),a}return r(t,e),t.prototype.getRendererBindingManager=function(){return this._rendererBindingManager},t.prototype.getScreenShareBindingManager=function(){return this._screenShareBindingManager},t.prototype.getPreviewVideo=function(e,t,n){var r=this,i=0;return this._mediaReadyPromise.then(function(o){if(0===(i=r._slimcoreInstance.createPreviewVideo(e,t,n)))throw new Error("SlimCore returned invalid video object ID 0");return r._logger.info("Got preview video. Waiting for video to become AVAILABLE|STARTING|RUNNING"),l.waitForVideoObjectState({slimcoreInstance:r._slimcoreInstance,slimcoreObject:o,videoObjectId:i,logger:r._logger,resolveStates:[h.VideoStatus.Available,h.VideoStatus.Starting,h.VideoStatus.Running],rejectStates:[h.VideoStatus.NotAvailable],timeout:l.videoObjectTimeout(r._settings)})}).then(function(){return i})},Object.defineProperty(t.prototype,"isAudioOutputSelectionSupported",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype._handleDisplaysChanged=function(){try{this._slimcoreInstance.setDeviceRotation(SlimCore.queryDeviceRotation())}catch(e){this._logger.warn("Displays Changed handling error: "+e)}},t.prototype._updateVideoDevices=function(){return this._cameras.update(this._fillBrowserDeviceIds(this._slimcoreInstance.getCameraList(),"videoinput"))},t.prototype._updateAudioDevices=function(){var e=this._microphones.update(this._fillBrowserDeviceIds(this._slimcoreInstance.getMicrophoneList(),"audioinput")),t=this._speakers.update(this._fillBrowserDeviceIds(this._slimcoreInstance.getSpeakerList(),"audiooutput")),n=this._slimcoreInstance.getCompositeAudioDevices&&this._compositeDevices.update(this._slimcoreInstance.getCompositeAudioDevices());return(e||t)&&this._selectAudioDevices(),e||t||n},t.prototype._updateBrowserDevices=function(){var e=this;return"object"!=typeof navigator?(this._logger.warn("Browser-backed device list won't be fetched as navigator is not available"),Promise.resolve()):this._browserDevicesPromise?this._browserDevicesPromise:this._browserDevicesPromise=navigator.mediaDevices.enumerateDevices().then(function(t){e._browserDevices=t,e._browserDevicesPromise=void 0})},t.prototype._fillBrowserDeviceIds=function(e,t){if(!e)return e;var n=s.slice(e);n.sort(function(e,t){return t.label.length-e.label.length});var r=this._browserDevices.filter(function(e){return t===e.kind});r.sort(function(e,t){return e.label.length-t.label.length});for(var i=this,o=0,a=n;o<a.length;o++)!function(e){var t=s.findIndex(r,function(t){return 0===t.label.indexOf(e.label)});-1!==t?(e.browserId=r[t].deviceId,r.splice(t,1)):i._logger.warn("No browser device found for device "+e.label)}(a[o]);return e},t.prototype._selectAudioDevices=function(){var e=this._microphones.getSelectedDevice(),t=this._speakers.getSelectedDevice();this._logger.info("SlimCore - selectAudioDevices: "+e+", "+t),this._slimcoreInstance.selectAudioDevices(e,t)},t.prototype._slimCoreDevicesChangedHander=function(e){var t=this;this._logger.info("SlimCore Devices changed: "+JSON.stringify(e)),this._updateBrowserDevices().then(function(){var n=!1;(n=e.video?t._updateVideoDevices()||n:t._updateAudioDevices()||n)?(t._raiseDevicesChanged(),t._logger.info("Raised device changed notification: "+JSON.stringify(e))):t._logger.info("Supress device changed notification as nothing changed: "+JSON.stringify(e))}).catch(function(e){t._logger.error("Failed to raise device changed notification, error = "+e)})},t.prototype._raiseDevicesChanged=function(){this.raiseChanged(),this.event("devicesChanged").raise(this._enumerateDevices())},t.prototype._enumerateDevices=function(){var e=this._cameras.getList(),t=this._microphones.getList(),n=this._speakers.getList(),r=this._compositeDevices.getList();return[].concat(e,t,n,r)},t.prototype.askDevicePermission=function(e){return g.asap(function(){return{audio:!0,video:!0}})},t.prototype._triggerMediaInitOnce=function(){l.hasFeature(h.Feature.LazyMediaInit)&&!this._haveStartedMedia&&(this._slimcoreInstance.fireIntent(h.Intent.MediaInit),this._haveStartedMedia=!0)},t.prototype.enumerateDevicesAsync=function(){var e=this;return new Promise(function(t,n){e._triggerMediaInitOnce(),e._devicesEnumeratedPromise.then(function(){return e._enumerateDevices()}).then(t,n)})},t.prototype.selectDevices=function(e){var t=this;this._devicesEnumeratedPromise.then(function(){t._selectDevices(e)})},t.prototype.getPermissionState=function(e){return"granted"},t.prototype._selectDevices=function(e){this._logger.debug("selectDevices - "+JSON.stringify(e)),void 0!==e.camera&&this._cameras.selectDevice(e.camera),void 0!==e.microphone&&this._microphones.selectDevice(e.microphone),void 0!==e.speaker&&this._speakers.selectDevice(e.speaker),this._selectAudioDevices(),this._raiseDevicesChanged()},t.prototype.setVideoCaptureConfigAsync=function(e,t){var n=this;return this._mediaReadyPromise.then(function(){n._slimcoreInstance.setVideoCaptureConfig?n._slimcoreInstance.setVideoCaptureConfig(e,t):n._logger.warn("setVideoCaptureConfig is not available")}).catch(function(e){throw n._logger.error("Failed to set video capture config, Error = "+e),e})},t.prototype.setDeviceEffectsAsync=function(e,t){var n=this;return this._mediaReadyPromise.then(function(){n._slimcoreInstance.setDeviceEffects?n._slimcoreInstance.setDeviceEffects(e,u.convertVideoEffectType(t)):n._logger.warn("setDeviceEffects is not available")}).catch(function(e){throw n._logger.error("Failed to set Video Effects, Error = "+e),e})},t.prototype.getDeviceEffectsCapabilityAsync=function(e,t){var n=this;return this._mediaReadyPromise.then(function(){return n._slimcoreInstance.getDeviceEffectsCapability?n._slimcoreInstance.getDeviceEffectsCapability(e,t):(n._logger.warn("getDeviceEffectsCapability is not available"),0)}).catch(function(e){throw n._logger.error("Error in getDeviceEffectsCapabilityAsync, error = "+e),e})},t.prototype.setBackgroundImageAsync=function(e,t){var n=this;return this._mediaReadyPromise.then(function(){n._slimcoreInstance.setBackgroundImage?n._slimcoreInstance.setBackgroundImage(e,t):n._logger.warn("setBackgroundImage is not available")}).catch(function(e){throw n._logger.error("Failed to set background image, Error = "+e),e})},t.prototype.getSelectedDevices=function(){var e={camera:this._cameras.getSelectedDevice(),microphone:this._microphones.getSelectedDevice(),speaker:this._speakers.getSelectedDevice()};return this._logger.debug("getSelectedDevices - "+JSON.stringify(e)),e},t.prototype.getCamera=function(e){return s.find(this._cameras.getList(),function(t){return t.id===e})},t.prototype.getChildCameras=function(e){return s.filter(this._cameras.getList(),function(n){return t.isChildVideoDeviceDescr(n)&&n.parentId===e})},t.isChildVideoDeviceDescr=function(e){return 5===e.kind},t.prototype.getLabelByCameraPosition=function(e){return l.hasFeature(h.Feature.MediaLabels)?6===e.position?"panoramic-video":"main-video":""},t.prototype._getCameraForPreview=function(e){var t=this.getChildCameras(e);return s.isEmpty(t)?this.getCamera(e):s.find(t,function(e){return e.useForPreview})},t.prototype.getCameraForPreview=function(e){var t=this._getCameraForPreview(e);return this._logger.debug("getCameraForPreview id "+e+" - "+JSON.stringify(t)),t},t.prototype.getSelectedCameraForPreview=function(){var e=this._cameras.getSelectedDevice(),t=this._getCameraForPreview(e);return this._logger.debug("getSelectedCameraForPreview id "+e+" - "+JSON.stringify(t)),t},t.prototype.getSelectedCamera=function(){var e=this._cameras.getSelectedDevice(),t=this.getCamera(e);return this._logger.debug("getSelectedCamera - "+JSON.stringify(t)),t},t.prototype.createPreview=function(e,t,n,r){return void 0===r&&(r=_.generateCauseId()),o(this,void 0,void 0,function(){var i;return a(this,function(o){switch(o.label){case 0:return i=new p.default(this._logger,this._settings,this._slimcoreInstance,e,this,t,n,r),[4,i.startVideoAsync(r)];case 1:return o.sent(),[2,i]}})})},t.prototype.createPreviewRenderer=function(e,t,n){return void 0===n&&(n=_.generateCauseId()),this.createPreview(e,{kind:"camera"},t,n)},t.prototype.createScreenSharingPreviewRenderer=function(e,t,n){return void 0===n&&(n=_.generateCauseId()),this.createPreview(e,{kind:"sharing"},t,n)},t.prototype.getDeviceNameAsync=function(e){var t=this;return g.asap(function(){var n=s.find(t._enumerateDevices(),function(t){return t.id===e});if(!n)throw new Error("Device with id: "+e+" not found");return n.label})},t.prototype.getSpeakerVolume=function(){var e=this;return this._mediaReadyPromise.then(function(){return e._slimcoreInstance.getSpeakerVolume()})},t.prototype.getSpeakerSystemVolume=function(){var e=this;return this._mediaReadyPromise.then(function(){return e._slimcoreInstance.getSpeakerSystemVolume()})},t.prototype.setSpeakerVolume=function(e){var t=this;return this._mediaReadyPromise.then(function(){return t._slimcoreInstance.setSpeakerVolume(e)})},t.prototype.setSpeakerSystemVolume=function(e){var t=this;return this._mediaReadyPromise.then(function(){return t._slimcoreInstance.setSpeakerSystemVolume(e)})},t.prototype.unmuteMicrophone=function(){var e=this;return this._mediaReadyPromise.then(function(){return e._slimcoreInstance.unmuteMicrophone()})},t.prototype.unmuteSpeaker=function(){var e=this;return this._mediaReadyPromise.then(function(){return e._slimcoreInstance.unmuteSpeaker()})},t.prototype.getNrgLevelsForDeviceTuner=function(e){var t=this;return this._mediaReadyPromise.then(function(){return t._slimcoreInstance.getNrgLevelsForDeviceTuner(e)})},t.prototype.getMicrophoneVolume=function(){var e=this;return this._mediaReadyPromise.then(function(){return e._slimcoreInstance.getMicrophoneVolume()})},t.prototype.setMicrophoneVolume=function(e){var t=this;return this._mediaReadyPromise.then(function(){return t._slimcoreInstance.setMicrophoneVolume(e)})},t.prototype.hasVideoBindingScreenShare=function(){return!(!this._slimcoreInstance.createVideoBindingScreenShare&&!SlimCore.createVideoBindingScreenShare)},t.prototype._createVideoBindingScreenShare=function(){return this._slimcoreInstance.createVideoBindingScreenShare?this._slimcoreInstance.createVideoBindingScreenShare():SlimCore.createVideoBindingScreenShare()},t}(c.default);t.default=v},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),s=n(11),l=n(2),c=n(29),d=SlimCore.Enums,u=0,p=function(e){function t(t,n,r,i,o,l,c,d){var p=e.call(this,t.createChild(function(){return"LocalVideoPreview["+p._id+"]["+p._selection.kind+"]["+p._previewVideoObjectId+"]"}),n,r)||this;if(p._currentTarget=i,p._deviceManager=o,p._selection=l,p._options=c,p._id=u++,p._previewVideoObjectId=0,p._shouldRun=!1,p._logger.info("constructor device? "+p._selection.device+" causeId: "+d),"camera"!==p._selection.kind&&("sharing"!==p._selection.kind||!a.isUndefined(p._selection.device)))throw new Error("invalid selection parameters causeId: "+d);return p._chainedApiPromise=new s.default(t.createChild(function(){return"LocalVideoPreview["+p._id+"]["+p._selection.kind+"]["+p._previewVideoObjectId+"]"})),"camera"===p._selection.kind&&a.isUndefined(p._selection.device)&&p._registerDisposable(p._deviceManager.on("devicesChanged",function(){return p._devicesChanged(d)})),p}return r(t,e),t.prototype._devicesChanged=function(e){var t=this;this._logger.info("_devicesChanged causeId: "+e),this._chainedApiPromise.chainPromise(function(){return t._swapVideoDevice(e)},"swapVideoDevice",e)},t.prototype.startVideoAsync=function(e){var t=this;return this._logger.info("startVideoAsync causeId: "+e),this._shouldRun=!0,this._chainedApiPromise.chainPromise(function(){return t._startVideo(e)},"startVideoAsync",e)},t.prototype.stop=function(e){var t=this;return this._logger.info("stop causeId: "+e),this._shouldRun=!1,this._chainedApiPromise.chainPromise(function(){return t._stopVideo(e,!1)},"stopVideoAsync",e)},t.prototype.dumpVideoSourceImages=function(){return this._previewVideoObjectId?this._slimcoreInstance.dumpVideoSourceImages(this._previewVideoObjectId):Promise.reject(new Error("Cannot dump video fx debug images when there is no preview video"))},t.prototype.dispose=function(e){var t=this;void 0===e&&(e=l.generateCauseId()),this._logger.info("dispose causeId: "+e),this._shouldRun=!1,this._chainedApiPromise.chainPromise(function(){return t._dispose(e)},"dispose",e)},t.prototype._isRunning=function(){return 0!==this._previewVideoObjectId&&!!this._videoBinding},t.prototype._dispose=function(t){return i(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return n.trys.push([0,,2,3]),[4,this._stopVideo(t,!0)];case 1:return n.sent(),[3,3];case 2:return this._currentTarget=null,e.prototype.dispose.call(this,t),[7];case 3:return[2]}})})},t.prototype._swapVideoDevice=function(e){return i(this,void 0,void 0,function(){var t;return o(this,function(n){switch(n.label){case 0:return this._shouldRun&&this._currentTarget?(t=this._deviceManager.getSelectedCameraForPreview())?this._ignoredVideoDeviceInVideoSwap&&this._ignoredVideoDeviceInVideoSwap.id!==t.id?this._isRunning()?(this._logger.info("_swapVideoDevice causeId: "+e+" will change video preview device: "+this._ignoredVideoDeviceInVideoSwap.id+" -> "+t.id),this._ignoredVideoDeviceInVideoSwap=t,[4,this._stopVideoDevice(e)]):[3,3]:[2]:(this._logger.info("_swapVideoDevice causeId: "+e+" noop, no selected device, should run: "+this._shouldRun+" is running: "+this._isRunning()+" has target: "+!!this._currentTarget),[2]):(this._logger.info("_swapVideoDevice causeId: "+e+" noop, should run: "+this._shouldRun+" is running: "+this._isRunning()+" has target: "+!!this._currentTarget),[2]);case 1:return n.sent(),[4,this._startVideoDevice(t.label,t.id,d.VideoType.Video)];case 2:return n.sent(),[3,5];case 3:return this._logger.info("_swapVideoDevice causeId: "+e+" will resurrect video preview device: "+t.id),this._ignoredVideoDeviceInVideoSwap=t,[4,this._startVideoDevice(t.label,t.id,d.VideoType.Video)];case 4:n.sent(),n.label=5;case 5:return[2]}})})},t.prototype._startVideo=function(e){return i(this,void 0,void 0,function(){var t,n,r,i;return o(this,function(o){switch(o.label){case 0:if(!this._shouldRun||this._isRunning()||!this._currentTarget)return[3,2];if(t="",n="",r=d.VideoType.ScreenShare,i=void 0,"camera"===this._selection.kind){if(!(i=a.isUndefined(this._selection.device)?this._deviceManager.getSelectedCameraForPreview():this._deviceManager.getCameraForPreview(this._selection.device)))throw new Error("_startVideo causeId: "+e+" no camera to start video preview");r=d.VideoType.Video,t=i.label,n=i.id}return this._logger.info("_startVideo causeId: "+e+" will start video preview now for device name: "+t+" path: "+n),[4,this._startVideoDevice(t,n,r)];case 1:return o.sent(),this._ignoredVideoDeviceInVideoSwap=i,[3,3];case 2:this._logger.info("_startVideo causeId: "+e+" noop, should run: "+this._shouldRun+" is running: "+this._isRunning()+" has target: "+!!this._currentTarget),o.label=3;case 3:return[2]}})})},t.prototype._startVideoDevice=function(e,t,n){return i(this,void 0,void 0,function(){var r,i,a;return o(this,function(o){switch(o.label){case 0:return r=this,[4,this._deviceManager.getPreviewVideo(n,e,t)];case 1:return r._previewVideoObjectId=o.sent(),i=this,[4,this._deviceManager.getRendererBindingManager().acquire(this,this._previewVideoObjectId)];case 2:return i._videoBinding=o.sent(),a=this._options||{scalingMode:1,transparent:!1},this._createVideoRenderer(this._currentTarget,a,!0),[2]}})})},t.prototype._stopVideo=function(e,t){return i(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return this._shouldRun&&!t||!this._isRunning()?[3,2]:(this._logger.info("_stopVideo causeId: "+e+" force: "+t+" will stop video preview now"),this._ignoredVideoDeviceInVideoSwap=void 0,[4,this._stopVideoDevice(e)]);case 1:return n.sent(),[3,3];case 2:this._logger.info("_stopVideo causeId: "+e+" noop, force: "+t+" should run: "+this._shouldRun+" is running: "+this._isRunning()+" has target: "+!!this._currentTarget),n.label=3;case 3:return[2]}})})},t.prototype._stopVideoDevice=function(e){return i(this,void 0,void 0,function(){var t;return o(this,function(n){switch(n.label){case 0:try{this._disposeVideoRenderer(e)}catch(t){this._logger.warn("_stopVideoDevice causeId: "+e+" _disposeVideoRenderer error: "+t+" falied @ "+(new Error).stack)}return t=this._deviceManager.getRendererBindingManager().release(this,this._previewVideoObjectId),this._previewVideoObjectId=0,this._videoBinding=null,[4,t];case 1:return n.sent(),[2]}})})},t}(c.default);t.default=p},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=n(4),a=n(3),s=n(31),l=function(e){function t(t,n,r,i,o){var a=e.call(this,t.createChild("ScreenSharingManager"),n,r)||this;a._appHooks=i,a._deviceManager=o,a._logger.info("constructor");try{a._screenScraper=new s.default(a._slimcoreInstance)}catch(e){a._logger.warn(""+e)}return a._registerDisposable(a._appHooks.onDisplaysChanged(function(){return a._raiseScreensChanged()})),a}return r(t,e),t.prototype.enumerateScreensAsync=function(){var e=this;return o.asap(function(){return e._enumerateScreens()})},t.prototype.enumerateWindowsAsync=function(){var e=this;return o.asap(function(){return e._enumerateWindows()})},t.prototype.enumerateCamerasAsync=function(){var e=this;try{return this._deviceManager?this._deviceManager.enumerateDevicesAsync().then(function(t){var n=t.filter(function(e){return 1===e.kind});return e._logger.debug("enumerateCameras() result: "+JSON.stringify(n)),i.map(n,function(e){return new u(e)})}):Promise.resolve([])}catch(e){return this._logger.error("enumerateCameras() failed: "+e),Promise.reject("enumerateCameras() failed: "+e)}},t.prototype._enumerateScreens=function(){var e=this;try{var t=this._screenScraper&&this._screenScraper.getMonitorList()||[];return this._logger.debug("ScreenScraper.getMonitorList() result: "+JSON.stringify(t)),i.map(t,function(t){return new c(t,e._logger,e._screenScraper)})}catch(e){throw this._logger.error("ScreenScraper.getMonitorList() failed: "+e),e}},t.prototype._enumerateWindows=function(){var e=this;try{var t=this._screenScraper&&this._screenScraper.getWindowList()||[];return this._logger.debug("ScreenScraper.getWindowList() result: "+JSON.stringify(t)),i.map(t,function(t){return new d(t,e._logger,e._screenScraper)})}catch(e){throw this._logger.error("ScreenScraper.getWindowList() failed: "+e),e}},t.prototype._raiseScreensChanged=function(){this._logger.debug("raising onScreensChanged"),this.event("screensChanged").raise()},t}(a.default);t.default=l;var c=function(){function e(e,t,n){this._monitorInfo=e,this._logger=t,this._screenScraper=n}return e.prototype.getId=function(){return this._monitorInfo.monitorId},e.prototype.getDeviceId=function(){return String(this._monitorInfo.monitorId)},e.prototype.getType=function(){return 1},e.prototype.getPreview=function(e,t,n){return Promise.reject("not implemented")},e.prototype.getPreviewAsync=function(e,t,n){var r=this;return new Promise(function(i){i(r._screenScraper.getMonitorPreview(r.getId(),e,t,n,r._monitorInfo.region))}).then(function(e){return r._logger.debug("ScreenScraper.getMonitorPreview("+r.getId()+") result: "+e.width+"x"+e.height),e},function(e){throw r._logger.error("ScreenScraper.getMonitorPreview("+r.getId()+") failed: "+e),e})},e.prototype.getDescription=function(){return this._monitorInfo.name},e.prototype.getIcon=function(e,t){return Promise.resolve(null)},e.prototype.getBounds=function(){return{x:this._monitorInfo.region.x,y:this._monitorInfo.region.y,width:this._monitorInfo.region.width,height:this._monitorInfo.region.height}},e}(),d=function(){function e(e,t,n){this._windowInfo=e,this._logger=t,this._screenScraper=n}return e.prototype.getId=function(){return this._windowInfo.windowId},e.prototype.getDeviceId=function(){return String(this._windowInfo.windowId)},e.prototype.getType=function(){return 2},e.prototype.getPreview=function(e,t,n){return Promise.reject("not implemented")},e.prototype.getPreviewAsync=function(e,t,n){var r=this;return new Promise(function(i){i(r._screenScraper.getWindowPreview(r.getId(),e,t,n))}).then(function(e){return r._logger.debug("ScreenScraper.getWindowPreview("+r.getId()+") result: "+e.width+"x"+e.height),e},function(e){throw r._logger.error("ScreenScraper.getWindowPreview("+r.getId()+") failed: "+e),e})},e.prototype.getDescription=function(){return this._windowInfo.title},e.prototype.getAppName=function(){return this._windowInfo.applicationName},e.prototype.getIcon=function(e,t,n){var r=this;return new Promise(function(i){i(r._screenScraper.getWindowIcon(r.getId(),e,t,n))}).then(function(e){return r._logger.debug("ScreenScraper.getWindowIcon("+r.getId()+") result: "+e.width+"x"+e.height),e},function(e){throw r._logger.error("ScreenScraper.getWindowIcon("+r.getId()+") failed: "+e),e})},e.prototype.getBounds=function(){},e}(),u=function(){function e(e){this._cameraDescription=e}return e.prototype.getId=function(){return null},e.prototype.getDeviceId=function(){return this._cameraDescription.id},e.prototype.getType=function(){return 3},e.prototype.getPreview=function(e,t,n){return Promise.reject("not implemented")},e.prototype.getPreviewAsync=function(e,t,n){return Promise.reject("not implemented")},e.prototype.getDescription=function(){return this._cameraDescription.label},e.prototype.getIcon=function(e,t,n){return Promise.reject("not implemented")},e.prototype.getBounds=function(){},e}()},function(e,t,n){"use strict";function r(e){var t;if(e.telemetryLoggers)t=e.telemetryLoggers;else if(e.telemetryService&&e.telemetryService.getGenericTelemetryLogger&&e.telemetryTenantTokens)c.forEach(Object.keys(e.telemetryTenantTokens),function(n){return t[n]=e.telemetryService.getGenericTelemetryLogger(e.telemetryTenantTokens[n])});else if(e.telemetryService&&e.telemetryService.sendEvent){var n={sendEvent:function(t){e.telemetryService.sendEvent(t.eventName,t.props)}};t={media:n,rootTools:n,signaling:n}}return t}function i(){return SlimCore.getApiVersion&&SlimCore.getApiVersion()}function o(){return!(!SlimCore||!SlimCore.getVersion)}var a=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},l=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var c=n(0),d=n(4),u=n(5),p=n(10),h=n(52),g=n(1),_=n(3),f=n(34),m=n(35),C=n(22),S=n(37),y=n(23),v=n(60),I=SlimCore.Enums,T=n(2),O=n(7),P=n(21),E=7,A=function(e){function t(t,n){void 0===n&&(n=1);var r=e.call(this,t)||this;return r.callSupport=n,r}return a(t,e),t}(Error),R=function(e){function t(t){var n=e.call(this,new P.default(t.logger).createChild("CallingStack"),c.assign(t.settings,{platform:g.PlatformType.Electron}),g.wrap(t.slimCoreInstance,t.settings))||this;if(n.callRegistries=[],n._startSlimcorePromiseDefered=d.defer(),n._telemetryLoggers={},n._stackLoginPromise=d.defer(),n._mediaStartDeferredPromise=d.defer(),!o())throw new A("slimcore module is not available",1);if(i()<E)throw new A("slimcore module API version "+i()+" incompatible with required "+E,2);t.settings.enableTsCallingULLogging&&h.initDelegate(n._slimcoreInstance,t),n._appHooks=t.appHooks,n._telemetryLoggers=r(t),n._setup=new y.default(n._slimcoreInstance),n._ecsProvider=new C.default(n._slimcoreInstance),n._stackLoginPromise.promise.then(function(){return n._startSlimcorePromiseDefered.resolve(n._slimcoreInstance)});var a=new P.default(t.logger),s=g.hasFeature(I.Feature.MultiUserSupport)?n._startSlimcorePromiseDefered.promise:n._stackLoginPromise.promise,l=g.hasFeature(I.Feature.LazyMediaInit)?s.then(function(){return n._mediaStartDeferredPromise.promise}):s;return n._deviceManager=new m.default(a,n._settings,n._slimcoreInstance,l,t.appHooks),n._screenSharingManager=new S.default(a,n._settings,n._slimcoreInstance,t.appHooks,n._deviceManager),n._registerDisposable(n._slimcoreInstance.handle("e911-info-changed",void 0,function(e){return n._onE911Info(e)})),n._registerDisposable(n._slimcoreInstance.handle("media-status-changed",void 0,function(e){return n._onMediaStatus(e)})),n._registerDisposable(n._slimcoreInstance.handle("probe-devices-status-changed",void 0,function(e){return n._onProbeDevicesStatusChanged(e)})),g.hasFeature(I.Feature.ExternalEventsCollector)&&n._registerDisposable(n._slimcoreInstance.handle("incoming-telemetry-event",void 0,function(e){return n._onIncomingTelemetryEvent(e)})),n}return a(t,e),t.prototype.dispose=function(t){return s(this,void 0,void 0,function(){var n,r,i,o=this;return l(this,function(a){return(n=this._logger.createFnLogger("dispose",t)).info("dispose"),this._libStatus!==I.LibStatus.Running&&this._startSlimcorePromiseDefered.reject(new Error("CallingStack dispose called before slimcore reached Running state")),this._mediaStartDeferredPromise.reject(new Error("CallingStack dispose called before media was initialized")),r=function(){o.callRegistries=[],n.info("call registries are disposed"),o._screenSharingManager.dispose(t),o._screenSharingManager=void 0,n.info("screensharing manager is disposed"),o._deviceManager.dispose(t),o._deviceManager=void 0,n.info("device manager is disposed"),h.deinitLogging(),o._slimcoreInstance.dispose(),o._slimcoreInstance=void 0,n.info("slimcore instance is disposed"),e.prototype.dispose.call(o)},i=this.callRegistries.map(function(e){return e.dispose(t)}),[2,Promise.all(i).then(r,r)]})})},t.prototype.init=function(e,t){return void 0===e&&(e={block:!0}),void 0===t&&(t=T.generateCauseId()),s(this,void 0,void 0,function(){var n,r=this;return l(this,function(i){switch(i.label){case 0:return(n=this._logger.createFnLogger("init",t)).info("init"),this._slimcoreInstance?(g.hasFeature(I.Feature.AsyncStart)||(e.block=!0),e.block||this._registerDisposable(this._slimcoreInstance.handle("lib-status-changed",{libStatus:SlimCore.Enums.LibStatus.Running},function(e){return r._onLibStatusChanged(e)})),[4,Promise.all([this.getSetup().setNumber("*Lib/LazyMediaInit",g.hasFeature(I.Feature.LazyMediaInit)&&e.lazyMediaInit?1:0),this.getSetup().setString("*Lib/SCT/Telemetry/DiagnosticLevel",e.telemetryDiagnosticLevel||"")])]):[2,Promise.reject(new Error("slimcore instance is already disposed"))];case 1:return i.sent(),this._slimcoreInstance.start(e.block),n.info("starting slimcoreInstance block="+e.block),e.block&&(this._libStatus=I.LibStatus.Running,this._startSlimcorePromiseDefered.resolve(this._slimcoreInstance)),[2,this._startSlimcorePromiseDefered.promise.then(O.noop)]}})})},t.prototype._onLibStatusChanged=function(e){this._logger.info("_onLibStatusChanged from "+this._libStatus+" => "+e.libStatus),e.libStatus===I.LibStatus.Running?this._startSlimcorePromiseDefered.resolve(this._slimcoreInstance):e.libStatus===I.LibStatus.FatalError&&this._libStatus===I.LibStatus.Constructed&&this._startSlimcorePromiseDefered.reject(new Error("Slimcore FatalError during start")),this._libStatus=e.libStatus},t.prototype.getCallRegistry=function(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()},t.prototype.createCallRegistry=function(e,t){var n=this;void 0===t&&(t=T.generateCauseId());var r=e?u.mriOrId(e.id):void 0,i=this._logger.createFnLogger("createCallRegistry[identity="+r+"]",t),o=this.callRegistries.find(function(t){return t.identity===e.id});if(o&&!o.isDisposing)return i.info("callRegistry already exists for "+u.mriOrId(e.id)),Promise.resolve(o);var a=o&&o.isDisposing?o.disposePromise:Promise.resolve().then(O.noop);return this._startSlimcorePromiseDefered.promise.then(function(){return s(n,void 0,void 0,function(){return l(this,function(t){switch(t.label){case 0:return[4,a];case 1:return t.sent(),o=this._createCallRegistry(e),[2,o]}})})})},t.prototype._createCallRegistry=function(e){var t=this,n=new f.default(this._logger,this._settings,this._slimcoreInstance,this._deviceManager,this._appHooks,this._telemetryLoggers,e);return n.on("disposed",function(){t.callRegistries.splice(t.callRegistries.indexOf(n),1)}),n.loginPromise.then(this._stackLoginPromise.resolve,this._stackLoginPromise.reject),this.callRegistries.push(n),n},t.prototype.getDeviceManager=function(){return this._deviceManager},t.prototype.getScreenSharingManager=function(){return this._screenSharingManager},t.prototype.getSetup=function(){return this._setup},t.prototype.getEcsProvider=function(){return this._ecsProvider},t.prototype.fireIntent=function(e,n){if(this._slimcoreInstance){var r=t._callingIntentToSlimcoreIntent(e);r&&this._slimcoreInstance.fireIntent(r,n)}},t.prototype.getVersion=function(){return{build:p.getTsCallingVersion(),ovb:p.getOvb()}},t._callingIntentToSlimcoreIntent=function(e){switch(e){case 0:return I.Intent.CallPush;case 1:return I.Intent.CallUser;case 2:return I.Intent.CallPreheat;case 3:return I.Intent.MediaInit;default:return}},t.prototype._slimcoreMediaStatusToCallingMediaStatus=function(e){switch(e){case I.MediaStatus.Initialized:return 1;case I.MediaStatus.NotAvailable:return 0;case I.MediaStatus.Failed:return 2;case I.MediaStatus.Uninitialized:return 3;default:return}},t.prototype.getMediaStatus=function(){return this._slimcoreMediaStatusToCallingMediaStatus(this._slimcoreInstance.getMediaStatus())},t.prototype.setMediaConfig=function(e){var t=this;return new Promise(function(n){t._setMediaConfig(e,t._startSlimcorePromiseDefered.promise),n()})},t.prototype._setMediaConfig=function(e,t){var n=this;if(!!this._slimcoreInstance.setMediaConfig)this._logger.info("Set Media Configuration, using setMediaConfig"),this._slimcoreInstance.setMediaConfig(e);else{var r=!!this._slimcoreInstance.setMediaPortRanges,i=!!this._slimcoreInstance.enableMediaQoS,o=!!this._slimcoreInstance.createMediaConfig,a=!!this._slimcoreInstance.setOpenCameraInMaxResolution,s=!!this._slimcoreInstance.enableTtySupport,l=!!this._slimcoreInstance.enableAGC,c=e.hasOwnProperty("mediaPortRanges"),d=e.hasOwnProperty("enableMediaQoS"),u=e.hasOwnProperty("openCameraInMaxResolution"),p=e.hasOwnProperty("enableTtySupport"),h=e.hasOwnProperty("enableAGC");if(a&&u&&(this._logger.info("Set Media Configuration, using OpenCameraInMaxResolution"),this._slimcoreInstance.setOpenCameraInMaxResolution(e.openCameraInMaxResolution)),d||c)if(i&&r)d&&(this._logger.info("Set Media Configuration, using set enableMediaQos"),this._slimcoreInstance.enableMediaQoS(e.enableMediaQoS)),c&&(this._logger.info("Set Media Configuration, using set Media port ranges"),this._slimcoreInstance.setMediaPortRanges(e.mediaPortRanges));else if(o){this._logger.info("Set Media Configuration, using CreateMediaConfig");var g=this._slimcoreInstance.createMediaConfig();d&&g.enableMediaQoS(e.enableMediaQoS),c&&g.setMediaPortRanges(e.mediaPortRanges)}else this._logger.error("Set Media Configuration, failed no suitable methods found for qos or port ranges");(p||h)&&(this._logger.info("Set Media Configuration, queuing operation to run when media is ready"),t.then(function(){if(p)if(s)n._logger.info("Set Media Configuration, using enableTtySupport"),n._slimcoreInstance.enableTtySupport(e.enableTtySupport);else if(o){var t=n._slimcoreInstance.createMediaConfig();t.enableTtySupport?(n._logger.info("Set Media Configuration, using CreateMediaConfig.enableTtySupport"),t.enableTtySupport(e.enableTtySupport)):n._logger.error("Set Media Configuration, failed no suitable methods found for enableTtySupport on CreateMediaConfig")}else n._logger.error("Set Media Configuration, failed no suitable methods found for enableTtySupport");h&&l&&(n._logger.info("Set Media Configuration, using enableAGC"),n._slimcoreInstance.enableAGC(e.enableAGC))}))}},t.prototype.getE911Info=function(){var e=this;return this._slimcoreInstance?this._slimcoreInstance.getE911Info?this._startSlimcorePromiseDefered.promise.then(function(){var t=e._slimcoreInstance.getE911Info();try{return JSON.parse(t)}catch(e){return Promise.reject(new Error("failed to parse e911Info"))}}):Promise.reject(new Error("getE911Info is not available")):Promise.reject(new Error("slimcore instance is already disposed"))},t.prototype._onE911Info=function(e){var t;try{t=JSON.parse(e.info)}catch(e){return void this._logger.error("failed to parse e911Info")}this.event("e911InfoChanged").raise(t)},t.prototype._onMediaStatus=function(e){var t=this._slimcoreMediaStatusToCallingMediaStatus(e.mediaStatus);this.event("mediaStatusChanged").raise(t),1===t?this._mediaStartDeferredPromise.resolve(this._slimcoreInstance):2===t&&this._mediaStartDeferredPromise.reject(new Error("Media initialization FatalError"))},t.prototype._onProbeDevicesStatusChanged=function(e){this.event("probeDevicesStatusChanged").raise(e.ready)},t.prototype._onIncomingTelemetryEvent=function(e){this.event("incomingTelemetryEvent").raise(e.serializedEvent)},t}(_.default);t.SlimCoreElectronStack=R;var b=function(e){function t(t){var n=e.call(this,new P.default(t.logger).createChild("CallingStack",!0),c.assign(t.settings,{platform:g.PlatformType.Uwp}),g.wrap(new v.UwpEngineWrapped(t.slimCoreInstance).objectAsWrapped,t.settings))||this;if(n.callRegistries=[],n._startSlimcorePromiseDefered=d.defer(),n._stackLoginPromise=d.defer(),n._mediaStartDeferredPromise=d.defer(),!g.isSlimCoreRTModuleAvailable())throw new A("slimcore module is not available",1);n._appHooks=t.appHooks,n._telemetryLoggers=r(t),n._setup=new y.default(n._slimcoreInstance),n._stackLoginPromise.promise.then(function(){return n._startSlimcorePromiseDefered.resolve(n._slimcoreInstance)});var i=g.hasFeature(I.Feature.MultiUserSupport)?n._startSlimcorePromiseDefered.promise:n._stackLoginPromise.promise,o=g.hasFeature(I.Feature.LazyMediaInit)?i.then(function(){return n._mediaStartDeferredPromise.promise}):i;return n._deviceManager=new m.default(n._logger,n._settings,n._slimcoreInstance,o,t.appHooks),n._screenSharingManager=new S.default(n._logger,n._settings,n._slimcoreInstance,t.appHooks,n._deviceManager),n._registerDisposable(n._slimcoreInstance.handle("media-status-changed",void 0,function(e){return n._onMediaStatus(e)})),g.hasFeature(I.Feature.ExternalEventsCollector)&&n._registerDisposable(n._slimcoreInstance.handle("incoming-telemetry-event",void 0,function(e){return n._onIncomingTelemetryEvent(e)})),n}return a(t,e),t.prototype.dispose=function(t){return void 0===t&&(t=T.generateCauseId()),s(this,void 0,void 0,function(){var n,r,i,o=this;return l(this,function(a){return(n=this._logger.createFnLogger("dispose",t)).info("dispose"),this._libStatus!==I.LibStatus.Running&&this._startSlimcorePromiseDefered.reject(new Error("CallingStack dispose called before slimcore reached Running state")),this._mediaStartDeferredPromise.reject(new Error("CallingStack dispose called before media was initialized")),r=function(){o.callRegistries=[],n.info("call registries are disposed"),o._screenSharingManager.dispose(t),o._screenSharingManager=void 0,n.info("screensharing manager is disposed"),o._deviceManager.dispose(t),o._deviceManager=void 0,n.info("device manager is disposed"),o._slimcoreInstance.dispose(),o._slimcoreInstance=void 0,n.info("slimcore instance is disposed"),e.prototype.dispose.call(o)},i=this.callRegistries.map(function(e){return e.dispose(t)}),[2,Promise.all(i).then(r,r)]})})},t.prototype.init=function(e,t){return void 0===e&&(e={block:!0}),void 0===t&&(t=T.generateCauseId()),s(this,void 0,void 0,function(){var n,r=this;return l(this,function(i){switch(i.label){case 0:return(n=this._logger.createFnLogger("init",t)).info("init"),this._slimcoreInstance?(g.hasFeature(I.Feature.AsyncStart)||(e.block=!0),e.block||this._registerDisposable(this._slimcoreInstance.handle("lib-status-changed",{libStatus:SlimCore.Enums.LibStatus.Running},function(e){return r._onLibStatusChanged(e)})),[4,Promise.all([this.getSetup().setNumber("*Lib/LazyMediaInit",g.hasFeature(I.Feature.LazyMediaInit)&&e.lazyMediaInit?1:0),this.getSetup().setString("*Lib/SCT/Telemetry/DiagnosticLevel",e.telemetryDiagnosticLevel||"")])]):[2,Promise.reject(new Error("slimcore instance is already disposed"))];case 1:return i.sent(),this._slimcoreInstance.start(e.block),n.info("starting slimcoreInstance block="+e.block),e.block&&(this._libStatus=I.LibStatus.Running,this._startSlimcorePromiseDefered.resolve(this._slimcoreInstance)),[2,this._startSlimcorePromiseDefered.promise.then(O.noop)]}})})},t.prototype._onLibStatusChanged=function(e){this._logger.info("_onLibStatusChanged from "+this._libStatus+" => "+e.libStatus),e.libStatus===I.LibStatus.Running?this._startSlimcorePromiseDefered.resolve(this._slimcoreInstance):e.libStatus===I.LibStatus.FatalError&&this._libStatus===I.LibStatus.Constructed&&this._startSlimcorePromiseDefered.reject(new Error("Slimcore FatalError during start")),this._libStatus=e.libStatus},t.prototype.getCallRegistry=function(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()},t.prototype.createCallRegistry=function(e,t){var n=this;void 0===t&&(t=T.generateCauseId());var r=e?u.mriOrId(e.id):void 0,i=this._logger.createFnLogger("createCallRegistry[identity="+r+"]",t),o=this.callRegistries.find(function(t){return t.identity===e.id});if(o&&!o.isDisposing)return i.info("callRegistry already exists for "+u.mriOrId(e.id)),Promise.resolve(o);var a=o&&o.isDisposing?o.disposePromise:Promise.resolve().then(O.noop);return this._startSlimcorePromiseDefered.promise.then(function(){return s(n,void 0,void 0,function(){return l(this,function(t){switch(t.label){case 0:return[4,a];case 1:return t.sent(),o=this._createCallRegistry(e),[2,o]}})})})},t.prototype._createCallRegistry=function(e){var t=this,n=new f.default(this._logger,this._settings,this._slimcoreInstance,this._deviceManager,this._appHooks,this._telemetryLoggers,e);return n.on("disposed",function(){t.callRegistries.splice(t.callRegistries.indexOf(n),1)}),n.loginPromise.then(this._stackLoginPromise.resolve,this._stackLoginPromise.reject),this.callRegistries.push(n),n},t.prototype.getDeviceManager=function(){return this._logger.info("retrieving device manager"),this._deviceManager},t.prototype.getScreenSharingManager=function(){return this._screenSharingManager},t.prototype.getSetup=function(){return this._setup},t.prototype.getEcsProvider=function(){return null},t.prototype.fireIntent=function(e,t){},t.prototype.getVersion=function(){return{build:p.getTsCallingVersion(),ovb:p.getOvb()}},t.prototype.getMediaStatus=function(){return null},t.prototype.setMediaConfig=function(e){var t=this;return new Promise(function(n){t._logger.info("Set Media Configuration, using new default method"),t._slimcoreInstance.setMediaConfig(e),n()})},t.prototype._slimcoreMediaStatusToCallingMediaStatus=function(e){switch(e){case I.MediaStatus.Initialized:return 1;case I.MediaStatus.NotAvailable:return 0;case I.MediaStatus.Failed:return 2;case I.MediaStatus.Uninitialized:return 3;default:return}},t.prototype._onMediaStatus=function(e){var t=this._slimcoreMediaStatusToCallingMediaStatus(e.mediaStatus);this.event("mediaStatusChanged").raise(t),1===t?this._mediaStartDeferredPromise.resolve(this._slimcoreInstance):2===t&&this._mediaStartDeferredPromise.reject(new Error("Media initialization FatalError"))},t.prototype._onIncomingTelemetryEvent=function(e){this.event("incomingTelemetryEvent").raise(e.serializedEvent)},t}(_.default);t.SlimCoreUwpStack=b,t.slimCoreElectronStackFactory={build:function(e){return Promise.resolve().then(function(){return e.settings.enableTsCallingULLogging&&h.patchLogger(e),new R(e)}).catch(function(e){throw e instanceof A?e:new A(""+e)})},getVersion:function(){return{build:p.getTsCallingVersion(),ovb:p.getOvb()}}},t.slimCoreUwpStackFactory={build:function(e){return Promise.resolve().then(function(){return new b(e)}).catch(function(e){throw e instanceof A?e:new A(""+e)})},getVersion:function(){return{build:p.getTsCallingVersion(),ovb:p.getOvb()}}}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){n(1),n(3),n(12),n(27),n(34),n(35),n(22),n(30),n(32),n(36),n(19),n(18),n(28),n(37),n(23),n(38),e.exports=n(61)},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t){return e.call(this,t)||this}return r(t,e),t.prototype.changed=function(e){return this.subscribe({changed:e,on:void 0})},t.prototype.on=function(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})},t.prototype.once=function(e,t,n){var r,i=this;return r=this.on(e,this._fromEventCallback(function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];r.dispose(n),i._toEventCallback(t).apply(void 0,e)}))},t.prototype.raiseChanged=function(){this.raiseEvents(function(e){return e.changed&&e.changed()})},t.prototype.event=function(e){var t=this;return{raise:this._fromEventCallback(function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return t._raiseEventImpl.apply(t,[String(e)].concat(n))})}},t.prototype._raiseEventImpl=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.raiseEvents(function(n){var r;return n.on&&n.on.name===e&&(r=n.on).handler.apply(r,t)})},t.prototype._toEventCallback=function(e){return e},t.prototype._fromEventCallback=function(e){return e},t}(n(24).EventSourceImpl);t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){var e=this;this.msElapsed=0,this.isPaused=!1,this._startTime=(new Date).getTime(),this.pause=function(){e.isPaused||(e.msElapsed+=(new Date).getTime()-e._startTime,e.isPaused=!0)},this.resume=function(){e.isPaused&&(e.isPaused=!1,e._startTime=(new Date).getTime())},this.duration=function(){return e.isPaused?e.msElapsed:e.msElapsed+(new Date).getTime()-e._startTime},this.durationInMinutes=function(){var t=e.duration()/6e4;return Math.ceil(t)},this.durationInSeconds=function(){var t=e.duration()/1e3;return Math.ceil(t)}}return Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},enumerable:!0,configurable:!0}),e}();t.Stopwatch=r,t.build=function(){return new r}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CONSTANTS={CODE:{SUCCESS:0,CLIENT_ERROR_CODE:499},SUB_CODE:{ACTION_NOT_ALLOWED:3548,ABANDONED:4990,ENDED_BY_REMOTE_ENDPOINT:5028}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.findParticipantUsingParticipantLegId=function(e,t){function n(e,t){if(e.endpoints&&e.endpoints.endpointDetails)for(var n=0,r=e.endpoints.endpointDetails;n<r.length;n++)if(r[n].participantId===t)return!0;return!1}return e.participants.find(function(e){return n(e,t)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r;t.callStateIsAnyOf=function(e,t){return-1!==t.indexOf(e)},t.validStateTransitions=(r={},r[0]=[1,2,8,6,10,11],r[1]=[2,6,7,10],r[2]=[1,3,6,7,9,10],r[3]=[6,7,4,5,10],r[8]=[1,11,10,2,6,7],r[4]=[6,7,3,5,10],r[5]=[6,7,3,4,10],r[9]=[3,6,7,10],r[10]=[3,6,7,9,4,5],r[11]=[12,1,2,6,7],r[12]=[2,6,7],r[6]=[7],r[7]=[],r)},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};Object.defineProperty(t,"__esModule",{value:!0});var s=n(4),l=n(6),c=n(47),d=n(3),u=SlimCore.Enums,p=n(2),h=n(16),g=n(17),_=function(e){function t(t,n,r,i,o,a,s){var d=e.call(this,t.createChild(function(){return"ContentSharing["+d.slimCoreContentSharingObjectId+"]"}),n,r)||this;return d._slimcoreCallHandler=i,d.slimCoreContentSharingObjectId=o,d._nativeContentSharing=a,d.callTelemetry=s,d.noFailureReason=SlimCore.Enums.ContentSharingFailureReason.NoFailure,d._getCallEndOperation=function(){return d._callOperationHandler.hasPendingOperation(l.CONTENT_SHARING_OPERATIONS.STOP_CONTENT_SHARING)?d._callOperationHandler.waitForOperation(l.CONTENT_SHARING_OPERATIONS.STOP_CONTENT_SHARING):Promise.resolve()},d._logger.info("constructor"),d._session=new c.ContentSharingSession(d,d._logger),d._callOperationHandler=new g.default(d._logger,d.callTelemetry),d._onContentSharingPropertyChanged(SlimCore.Enums.Property.ContentSharingStatus,function(e){return d._onContentSharingStatusChanged(e.value)}),d._onContentSharingPropertyChanged(SlimCore.Enums.Property.ContentSharingState,function(e){return d._onContentSharingStateChanged(e.value)}),d._onContentSharingPropertyChanged(SlimCore.Enums.Property.ContentSharingFailureReason,function(e){return d._onContentSharingResultCodeChanged(e.value)}),d.contentSharingStatus=d.convertContentSharingStatus(d.getIntProperty(SlimCore.Enums.Property.ContentSharingStatus)),d.contentSharingGuid=d.getStrProperty(SlimCore.Enums.Property.ContentSharingId),d.contentSharingState=d.getStrProperty(SlimCore.Enums.Property.ContentSharingState),d.contentSharingIdentity=d.getStrProperty(SlimCore.Enums.Property.ContentSharingIdentity),d._logger.info("Session created with status "+d.contentSharingStatus+", guid "+d.contentSharingGuid),d._registerDisposable(d._nativeContentSharing.handle("update-session-state-result",void 0,function(e){return d._onSessionStateResult(e)})),d._registerDisposable(d._nativeContentSharing.handle("take-control-result",void 0,function(e){return d._onTakeControlResult(e)})),d._registerDisposable(d._nativeContentSharing.handle("update-participant-state-result",void 0,function(e){return d._onUpdateParticipantStateResult(e)})),d._registerDisposable(d._nativeContentSharing.handle("join-result",void 0,function(e){return d._onJoinResult(e)})),d}return r(t,e),t.prototype._onContentSharingPropertyChanged=function(e,t){this._onObjectPropertyChanged(this.slimCoreContentSharingObjectId,e,t)},t.prototype.setContentSharingStatus=function(e){if(this._logger.info("setContentSharingStatus. currentStatus: "+this.contentSharingStatus+" newStatus: "+e),this.contentSharingStatus!==e&&7!==this.contentSharingStatus&&8!==this.contentSharingStatus){if(this._logger.info("Changing content sharing status to: "+e),this.contentSharingStatus=e,7===e||8===e){if(this.contentSharingTerminationReason&&0!==this.contentSharingTerminationReason.terminatedReason)return;var t=this.getIntProperty(u.Property.ContentSharingFailureReason),n=this.getIntProperty(u.Property.ContentSharingFailureCode),r=this.getIntProperty(u.Property.ContentSharingFailureSubCode),i=this.convertFailureReason(t);this._logger.info("setting failure reason for content sharing session. reason: "+i),this.contentSharingTerminationReason={terminatedReason:i,terminatedReasonCode:n,terminatedReasonSubCode:r,errorMessage:"Session is terminated"}}this._session.statusChanged(e),this.raiseChanged()}},t.prototype.getStrProperty=function(e,t){return this._getStrProperty(this._slimcoreCallHandler,this.slimCoreContentSharingObjectId,e,t)},t.prototype.getIntProperty=function(e,t){return this._getIntProperty(this._slimcoreCallHandler,this.slimCoreContentSharingObjectId,e,t)},t.prototype._onContentSharingStatusChanged=function(e){this._logger.info("_onContentSharingStateChanged called"),this.setContentSharingStatus(this.convertContentSharingStatus(e))},t.prototype._onContentSharingStateChanged=function(e){this._logger.info("_onContentSharingStateChanged called"),this.contentSharingState=e,this.raiseChanged()},t.prototype._onContentSharingResultCodeChanged=function(e){if(this._logger.info("_onContentSharingResultCodeChanged called"),!this.contentSharingTerminationReason||0===this.contentSharingTerminationReason.terminatedReason){var t=this.getIntProperty(u.Property.ContentSharingFailureCode),n=this.getIntProperty(u.Property.ContentSharingFailureSubCode),r=this.convertFailureReason(e);this._logger.info("setting failure reason for content sharing session. reason: "+r),this.contentSharingTerminationReason={terminatedReason:r,terminatedReasonCode:t,terminatedReasonSubCode:n,errorMessage:"Session is terminated"}}},t.prototype.convertContentSharingStatus=function(e){switch(e){case u.ContentSharingStatus.Routing:return 1;case u.ContentSharingStatus.Ringing:return 2;case u.ContentSharingStatus.Connected:return 4;case u.ContentSharingStatus.Presenting:return 3;case u.ContentSharingStatus.Viewing:return 5;case u.ContentSharingStatus.Finishing:return 6;case u.ContentSharingStatus.Done:case u.ContentSharingStatus.Failed:case u.ContentSharingStatus.TimedOut:return 7;default:return 0}},t.prototype.startContentSharing=function(e){return void 0===e&&(e=p.generateCauseId()),this._session.startContentSharing(e)},t.prototype.joinContentSharing=function(e){return void 0===e&&(e=p.generateCauseId()),this._session.joinContentSharing(e)},t.prototype.updateContentSharingParticipantStateToViewer=function(e){return void 0===e&&(e=p.generateCauseId()),this._session.updateContentSharingParticipantStateToViewer(e)},t.prototype.updateContentSharingSessionState=function(e,t,n){return void 0===n&&(n=p.generateCauseId()),this._session.updateContentSharingSessionState(e,t,n)},t.prototype.takeContentSharingControl=function(e){return void 0===e&&(e=p.generateCauseId()),this._session.takeContentSharingControl(e)},t.prototype.stopContentSharing=function(e){return void 0===e&&(e=p.generateCauseId()),this._session.stopContentSharing(e)},t.prototype._onJoinResult=function(e){this._session.onJoinResultEvent(e)},t.prototype._onUpdateParticipantStateResult=function(e){this._session.onUpdateParticipantStateResultEvent(e)},t.prototype._onSessionStateResult=function(e){this._session.onSessionStateResultEvent(e)},t.prototype._onTakeControlResult=function(e){this._session.onTakeControlResultEvent(e)},t.prototype.callStartContentSharing=function(){var e=this;return s.asap(function(){return e._nativeContentSharing.startContentSharing()})},t.prototype.callStopContentSharing=function(){var e=this;return s.asap(function(){return e._nativeContentSharing.stopContentSharing()})},t.prototype.callUpdateContentSharingSessionState=function(e,t){var n=this;return s.asap(function(){return n._nativeContentSharing.updateContentSharingSessionState(e,t)})},t.prototype.callTakeContentSharingControl=function(){var e=this;return s.asap(function(){return e._nativeContentSharing.takeContentSharingControl()})},t.prototype.callUpdateContentSharingParticipantState=function(){var e=this;return s.asap(function(){return e._nativeContentSharing.updateContentSharingParticipantState()})},t.prototype.convertFailureReason=function(e){switch(e){case u.ContentSharingFailureReason.NoFailure:return 1;case u.ContentSharingFailureReason.SessionNotFound:return 34;case u.ContentSharingFailureReason.SessionTimedOut:return 35;case u.ContentSharingFailureReason.NetworkError:return 3;case u.ContentSharingFailureReason.NetworkCannotConnectError:return 52;case u.ContentSharingFailureReason.ServiceFailure:return 48;case u.ContentSharingFailureReason.RequestTimedOut:return 45;case u.ContentSharingFailureReason.AuthFailure:return 29;case u.ContentSharingFailureReason.ActionNotAllowed:return 60;case u.ContentSharingFailureReason.Forbidden:return 8;case u.ContentSharingFailureReason.Failure:default:return 32}},t.prototype.dispose=function(t){var n=this;void 0===t&&(t=p.generateCauseId());var r=this.contentSharingTerminationReason?this.contentSharingTerminationReason:{terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Call ended"};this.slimCoreContentSharingObjectId=0,this._getCallEndOperation().then(function(){n._callOperationHandler.rejectPendingOperations(r,t),e.prototype.dispose.call(n,t)})},i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.START_CONTENT_SHARING),a(0,h.causeId),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],t.prototype,"startContentSharing",null),i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.JOIN_CONTENT_SHARING),a(0,h.causeId),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],t.prototype,"joinContentSharing",null),i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.UPDATE_PARTICIPANT_STATE),a(0,h.causeId),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],t.prototype,"updateContentSharingParticipantStateToViewer",null),i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.UPDATE_CONTENT_SHARING_SESSION_STATE),a(0,h.operationId),a(2,h.causeId),o("design:type",Function),o("design:paramtypes",[String,String,Object]),o("design:returntype",Promise)],t.prototype,"updateContentSharingSessionState",null),i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.TAKE_CONTENT_SHARING_CONTROL),a(0,h.causeId),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],t.prototype,"takeContentSharingControl",null),i([h.callOperation(l.CONTENT_SHARING_OPERATIONS.STOP_CONTENT_SHARING,{waitFor:l.CONTENT_SHARING_OPERATIONS.START_CONTENT_SHARING}),a(0,h.causeId),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],t.prototype,"stopContentSharing",null),t}(d.default);t.default=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(4),o=n(21),a={CANCELED_TERMINATION_REASON:{terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Content sharing is disconnected"},ACTION_NOT_ALLOWED:function(e){return{terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:e}}},s=function(){function e(e,t){var n=this;this._platformImpl=e,this._pendingDeferreds=[],this._updateContentSharingSessionStateDeferredPromises={},this.onJoinResultEvent=function(e){if(n._joinContenSharingDeferredPromise)if(n._logger.info("JoinContentSharing completed for: "+n._platformImpl.contentSharingGuid+", status: "+JSON.stringify(e)),e.failureReason===n._platformImpl.noFailureReason)n._invokeDeferred(n._joinContenSharingDeferredPromise);else{var t=e.code,r=e.subCode,i=n._platformImpl.convertFailureReason(e.failureReason),o="Join failed with reason "+i;n._logger.error(o),n._rejectDeferred(n._joinContenSharingDeferredPromise,{terminatedReason:i,terminatedReasonCode:t,terminatedReasonSubCode:r,errorMessage:o})}else n._logger.warn("No pending promise for join. Event data: "+e)},this.onUpdateParticipantStateResultEvent=function(e){if(n._updateParticipantStateDeferredPromise)if(n._logger.info("UpdateContentSharingParticipantStateToViewer completed for: "+n._platformImpl.contentSharingGuid+", status: "+JSON.stringify(e)),e.failureReason===n._platformImpl.noFailureReason)n._invokeDeferred(n._updateParticipantStateDeferredPromise);else{var t=e.code,r=e.subCode,i=n._platformImpl.convertFailureReason(e.failureReason),o="Update participant state failed with reason "+i;n._logger.error(o),n._rejectDeferred(n._updateParticipantStateDeferredPromise,{terminatedReason:i,terminatedReasonCode:t,terminatedReasonSubCode:r,errorMessage:o})}else n._logger.warn("No pending promise for update participant state. Event data: "+e)},this.onSessionStateResultEvent=function(e){if(n._logger.info("UpdateContentSharingSessionState completed for: "+n._platformImpl.contentSharingGuid+", status: "+JSON.stringify(e)),n._updateContentSharingSessionStateDeferredPromises.hasOwnProperty(e.id))if(e.failureReason===n._platformImpl.noFailureReason)n._updateContentSharingSessionStateDeferredPromises[e.id].resolve();else{var t=e.code,r=e.subCode,i=n._platformImpl.convertFailureReason(e.failureReason),o="Update SessionState failed with reason "+i;n._logger.error(o),n._updateContentSharingSessionStateDeferredPromises[e.id].reject({terminatedReason:i,terminatedReasonCode:t,terminatedReasonSubCode:r,errorMessage:o})}},this.onTakeControlResultEvent=function(e){if(n._takeControlDeferredPromise)if(n._logger.info("TakeContentSharingControl completed for: "+n._platformImpl.contentSharingGuid+", "+JSON.stringify(e)),e.failureReason===n._platformImpl.noFailureReason)n._invokeDeferred(n._takeControlDeferredPromise);else{var t=e.code,r=e.subCode,i=n._platformImpl.convertFailureReason(e.failureReason),o="Take content sharing control failed with reason "+i;n._logger.error(o),n._rejectDeferred(n._takeControlDeferredPromise,{terminatedReason:i,terminatedReasonCode:t,terminatedReasonSubCode:r,errorMessage:o})}else n._logger.warn("No pending promise for take control. Event data: "+e)},this._logger=new o.default(t)}return e.prototype.statusChanged=function(e){if(7===e||8===e){if(this._stopContentSharingDeferredPromise&&this._invokeDeferred(this._stopContentSharingDeferredPromise),this._startContentSharingDeferredPromise){n=this._platformImpl.contentSharingTerminationReason&&0!==this._platformImpl.contentSharingTerminationReason.terminatedReason?this._platformImpl.contentSharingTerminationReason:a.CANCELED_TERMINATION_REASON;this._rejectDeferred(this._startContentSharingDeferredPromise,n)}this._logger.info("Content sharing is disconnected"),this._rejectPendingPromises(a.CANCELED_TERMINATION_REASON)}else if(2===e||5===e||4===e){if(this._stopContentSharingDeferredPromise){var t="Content sharing cannot be ended when not presenting",n=a.ACTION_NOT_ALLOWED(t);this._logger.error(t),this._rejectDeferred(this._stopContentSharingDeferredPromise,n)}}else 3===e&&(this._startContentSharingDeferredPromise&&this._invokeDeferred(this._startContentSharingDeferredPromise),this._takeControlDeferredPromise&&this._invokeDeferred(this._takeControlDeferredPromise))},e.prototype.startContentSharing=function(e){var t=this,n=this._logger.createFnLogger("startContentSharing",e);if(this._startContentSharingDeferredPromise)return this._startContentSharingDeferredPromise.promise;if(0!==this._platformImpl.contentSharingStatus){var r="Content sharing cannot be started as it is not in the initial state",o=a.ACTION_NOT_ALLOWED(r);return n.logFailure(r),Promise.reject(o)}n.info("Start content sharing for : "+this._platformImpl.contentSharingGuid),this._startContentSharingDeferredPromise=i.defer();var s=function(){t._startContentSharingDeferredPromise=null};return this._startContentSharingDeferredPromise.promise.then(s,s),Promise.resolve(void 0).then(function(){return t._platformImpl.callStartContentSharing()}).then(function(){return t._pendingDeferreds.push(t._startContentSharingDeferredPromise)}).then(function(){return t._startContentSharingDeferredPromise.promise}).catch(function(e){t.handleContentSharingOperationError(e,"startContentSharing",n)})},e.prototype.joinContentSharing=function(e){var t=this,n=this._logger.createFnLogger("joinContentSharing",e);if(this._joinContenSharingDeferredPromise)return this._joinContenSharingDeferredPromise.promise;if(2!==this._platformImpl.contentSharingStatus){var r="Content sharing cannot be joined as it is not in ringing state",o=a.ACTION_NOT_ALLOWED(r);return n.logFailure(r),Promise.reject(o)}n.info("Join content sharing for : "+this._platformImpl.contentSharingGuid),this._joinContenSharingDeferredPromise=i.defer();var s=function(){t._joinContenSharingDeferredPromise=null};return this._joinContenSharingDeferredPromise.promise.then(s,s),Promise.resolve(void 0).then(function(){return t._platformImpl.callStartContentSharing()}).then(function(){return t._pendingDeferreds.push(t._joinContenSharingDeferredPromise)}).then(function(){return t._joinContenSharingDeferredPromise.promise}).catch(function(e){t.handleContentSharingOperationError(e,"joinContentSharing",n)})},e.prototype.updateContentSharingParticipantStateToViewer=function(e){var t=this,n=this._logger.createFnLogger("updateContentSharingParticipantStateToViewer",e);if(this._updateParticipantStateDeferredPromise)return this._updateParticipantStateDeferredPromise.promise;if(4!==this._platformImpl.contentSharingStatus){var r="Cannot update participant state as content sharing is not in connected state",o=a.ACTION_NOT_ALLOWED(r);return n.logFailure(r),Promise.reject(o)}n.info("Update content sharing participant state for : "+this._platformImpl.contentSharingGuid),this._updateParticipantStateDeferredPromise=i.defer();var s=function(){t._updateParticipantStateDeferredPromise=null};return this._updateParticipantStateDeferredPromise.promise.then(s,s),Promise.resolve(void 0).then(function(){return t._platformImpl.callUpdateContentSharingParticipantState()}).then(function(){return t._pendingDeferreds.push(t._updateParticipantStateDeferredPromise)}).then(function(){return t._updateParticipantStateDeferredPromise.promise}).catch(function(e){t.handleContentSharingOperationError(e,"joinContentSharing",n)})},e.prototype.updateContentSharingSessionState=function(e,t,n){var r=this,o=this._logger.createFnLogger("updateContentSharingSessionState",n);if(this._updateContentSharingSessionStateDeferredPromises[e])return this._updateContentSharingSessionStateDeferredPromises[e].promise;if(3!==this._platformImpl.contentSharingStatus){var s="Cannot update session state as content sharing is not in presenting state",l=a.ACTION_NOT_ALLOWED(s);return o.logFailure(s),Promise.reject(l)}var c=i.defer();this._updateContentSharingSessionStateDeferredPromises[e]=c;var d=function(){delete r._updateContentSharingSessionStateDeferredPromises[e]};return this._updateContentSharingSessionStateDeferredPromises[e].promise.then(d,d),o.info("Update content sharing session state for : "+this._platformImpl.contentSharingGuid),Promise.resolve(void 0).then(function(){return r._platformImpl.callUpdateContentSharingSessionState(e,t)}).then(function(){return r._updateContentSharingSessionStateDeferredPromises[e].promise}).catch(function(e){r.handleContentSharingOperationError(e,"updateContentSharingSessionState",o)})},e.prototype.takeContentSharingControl=function(e){var t=this,n=this._logger.createFnLogger("takeContentSharingControl",e);if(this._takeControlDeferredPromise)return this._takeControlDeferredPromise.promise;if(5!==this._platformImpl.contentSharingStatus){var r="Cannot take control of content sharing as it is not in viewing state",o=a.ACTION_NOT_ALLOWED(r);return n.logFailure(r),Promise.reject(o)}n.info("Taking control of content sharing for : "+this._platformImpl.contentSharingGuid),this._takeControlDeferredPromise=i.defer();var s=function(){t._takeControlDeferredPromise=null};return this._takeControlDeferredPromise.promise.then(s,s),Promise.resolve(void 0).then(function(){return t._platformImpl.callTakeContentSharingControl()}).then(function(){return t._pendingDeferreds.push(t._takeControlDeferredPromise)}).then(function(){return t._takeControlDeferredPromise.promise}).catch(function(e){t.handleContentSharingOperationError(e,"takeContentSharingControl",n)})},e.prototype.stopContentSharing=function(e){var t=this,n=this._logger.createFnLogger("stopContentSharing",e);if(this._stopContentSharingDeferredPromise)return this._stopContentSharingDeferredPromise.promise;if(2===this._platformImpl.contentSharingStatus||4===this._platformImpl.contentSharingStatus||5===this._platformImpl.contentSharingStatus){var r="Incoming content sharing cannot be stopped",o=a.ACTION_NOT_ALLOWED(r);return n.logFailure(r),Promise.reject(o)}this._stopContentSharingDeferredPromise=i.defer();var s=function(){t._stopContentSharingDeferredPromise=null};return this._stopContentSharingDeferredPromise.promise.then(s,s),n.info("Stop content sharing for : "+this._platformImpl.contentSharingGuid),Promise.resolve(void 0).then(function(){return t._platformImpl.callStopContentSharing()}).then(function(){return t._pendingDeferreds.push(t._stopContentSharingDeferredPromise)}).then(function(){return t._stopContentSharingDeferredPromise.promise}).catch(function(e){t.handleContentSharingOperationError(e,"stopContentSharing",n)})},e.prototype.handleContentSharingOperationError=function(e,t,n){var r=e instanceof Error?e.toString():JSON.stringify(e);throw n.logFailure("Error in "+t+"(), contentSharingGuid = "+this._platformImpl.contentSharingGuid+", error = "+r),e&&e.hasOwnProperty("terminatedReason")?e:a.ACTION_NOT_ALLOWED(r)},e.prototype._rejectPendingPromises=function(e){this._logger.info("rejectPendingPromises"),this._pendingDeferreds.forEach(function(t){t.reject(e)}),this._pendingDeferreds=[],r.forEach(this._updateContentSharingSessionStateDeferredPromises,function(t){t.reject(e)}),this._updateContentSharingSessionStateDeferredPromises={}},e.prototype._invokeDeferred=function(e){this._logger.info("_invokeDeferred"),e&&(r.pull(this._pendingDeferreds,e),e.resolve())},e.prototype._rejectDeferred=function(e,t){this._logger.info("_rejectDeferred"),e&&(r.pull(this._pendingDeferreds,e),e.reject(t))},e}();t.ContentSharingSession=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=function(){function e(e,t,n,r){this.dataId=e,this.handler=t,this.sourceSinkInternallyCreated=n,this.direction=r,this.isAttached=!1}return e.prototype.isSourceEnabled=function(){return 0===this.direction||1===this.direction},e.prototype.isSinkEnabled=function(){return 0===this.direction||2===this.direction},e}(),o=function(){function e(e,t){this.logger=e,this._slimcoreInstance=t,this._dataChannel=null,this._dataChannelStatus=SlimCore.Enums.DataChannelStatus.Unknown,this._handlers={},this._availableHandlers=0,this._dataChannelStartCalled=!1,this.setInternalSourceSink=this.setInternalSourceSink.bind(this)}return e.prototype.addHandler=function(e,t,n,r,o){if(void 0===n&&(n=!1),void 0===o&&(o=0),e<0||e>=64)return Promise.reject(new Error("Data Id "+e+" is outside the valid range of 0-63"));if(this._handlers.hasOwnProperty(e)&&this._handlers[e].handler)return Promise.reject(new Error("Data Id "+e+" is already registered to a non-null handler"));this.logger.info("Adding handler to dataId: "+e+", "+(n?"skipping source sink creation":"making source sink"));var a=null,s=!1;return e in this._handlers?((a=this._handlers[e]).handler=t,s=!0):(a=new i(e,t,n,o),this._handlers[e]=a,n||(s=!0)),s&&(this._availableHandlers++,this._isDataChannelAvailable&&(this._negotiationTag=r,this.start()),this._isDataChannelActive)?this._attachHandler(a):Promise.resolve()},e.prototype.removeHandler=function(e){var t=this._handlers[e];return t?(this._detachHandler(t),delete this._handlers[e],this._availableHandlers--,Promise.resolve()):Promise.reject(new Error("Handler associated with Data Id "+e+" wasn't attached in the first place"))},e.prototype.updateNegotiationTag=function(e){return this._negotiationTag=e,Promise.resolve()},e.prototype.dispose=function(){this._detachAllHandlers(),this._dataChannel&&(this._dataChannel=null)},e.prototype.setDataChannel=function(e){if(this._dataChannel)throw new Error("Unexpected setting of data channel when we already have one");return this._dataChannel=e,Promise.resolve()},e.prototype.onDataChannelStatusChanged=function(e){var t=this;return e!==SlimCore.Enums.DataChannelStatus.Active||this._isDataChannelActive?e===SlimCore.Enums.DataChannelStatus.Available&&(this._isDataChannelActive||this._isDataChannelStopping?(this._dataChannelStartCalled=!1,this._detachAllHandlers()):this._availableHandlers>0&&this.start()):this._attachAllHandlers().catch(function(e){t.logger.error("Failed to attach all handlers error: "+e)}),this._dataChannelStatus=e,Promise.resolve()},e.prototype.setProtocolDataSource=function(e){return Promise.resolve()},e.prototype.processProtocolMessage=function(e,t,n,r){return Promise.resolve()},Object.defineProperty(e.prototype,"_isDataChannelAvailable",{get:function(){return!!this._dataChannel&&this._dataChannelStatus===SlimCore.Enums.DataChannelStatus.Available},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_isDataChannelActive",{get:function(){return!!this._dataChannel&&this._dataChannelStatus===SlimCore.Enums.DataChannelStatus.Active},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_isDataChannelStopping",{get:function(){return!!this._dataChannel&&this._dataChannelStatus===SlimCore.Enums.DataChannelStatus.Stopping},enumerable:!0,configurable:!0}),e.prototype._attachAllHandlers=function(){var e=this;return Promise.all(Object.keys(this._handlers).map(function(t){var n=e._handlers[t];return n&&(n.handler&&n.dataSource&&n.dataSink||!n.sourceSinkInternallyCreated)?e._attachHandler(n):Promise.resolve(null)}))},e.prototype.setInternalSourceSink=function(e,t,n){if(e<0||e>=64)throw new Error("Data Id "+e+" is outside the valid range of 0-63");if(this._handlers.hasOwnProperty(e)&&(this._handlers[e].dataSource||this._handlers[e].dataSink))this.logger.info("Data Id "+e+" for internal source sink is already registered");else if(this.logger.info("Setting internal source sink for dataId: "+e),e in this._handlers)this._handlers[e].dataSource=t,this._handlers[e].dataSink=n,this.logger.info("Completed adapter details for dataId: "+e),this._availableHandlers++;else{var r=new i(e,null,!0,0);r.dataSource=t,r.dataSink=n,this._handlers[e]=r}},e.prototype._attachHandler=function(e){var t=this;if(e.isAttached)return Promise.resolve();try{if(this.logger.info("Attaching handler for dataId: "+e.dataId+", "+(e.sourceSinkInternallyCreated?"skipping source sink creation":"making source sink")),e.sourceSinkInternallyCreated){if(!e.dataSource||!e.dataSink)return this.logger.error("Attaching handler with null datasource or datasink"),Promise.reject(new Error("Attaching handler with null datasource or datasink"))}else e.isSourceEnabled()&&(e.dataSource=r.createDataSource(this._slimcoreInstance,e.dataId),this._dataChannel.registerDataSource(e.dataSource)),e.isSinkEnabled()&&(e.dataSink=r.createDataSink(this._slimcoreInstance,e.dataId),this._dataChannel.registerDataSink(e.dataSink));e.dataSink&&(e.listener=function(n){try{e.handler.onDataReceived(e.dataId,n.data,n.sourceID)}catch(n){t.logger.error("Exception thrown from onDataReceived for data id "+e.dataId+", error: "+n)}},e.dataSink.on("data",e.listener));return e.isAttached=!0,e.handler.onStarted(e.dataId,function(t,n){if(!e.dataSource)return Promise.reject(new Error("Data sent to sink-only DataChannelAdapter"));try{return e.dataSource.sendData(t,n),Promise.resolve()}catch(e){return Promise.reject(e)}}),Promise.resolve()}catch(t){return this.logger.error("Attaching handler for data id "+e.dataId+" threw exception: "+t),Promise.reject(t)}},e.prototype._detachAllHandlers=function(){var e=this;Object.keys(this._handlers).forEach(function(t){e._detachHandler(e._handlers[t])})},e.prototype._detachHandler=function(e){var t=this;if(e.isAttached)try{if(this.logger.info("Detaching data handler dataid: "+e.dataId),e.handler&&e.handler.onStopped(e.dataId).catch(function(e){t.logger.warn("Error in handler onStopped :"+e)}),e.sourceSinkInternallyCreated){if(e.dataSink)try{e.dataSink.removeListener("data",e.listener)}catch(e){this.logger.warn("Error removing internal listener, call probably ended: "+e)}}else e.dataSource&&this._dataChannel.unregisterDataSource(e.dataSource).catch(function(e){t.logger.warn("Failed to unregister data source, call probably ended: "+e)}).then(function(){e.dataSource.dispose(),e.dataSource=null}),e.dataSink&&(e.dataSink.removeAllListeners("data"),this._dataChannel.unregisterDataSink(e.dataSink).catch(function(e){t.logger.warn("Failed to unregister data sink, call probably ended: "+e)}).then(function(){e.dataSink.dispose(),e.dataSink=null}));e.isAttached=!1}catch(t){this.logger.error("Exception thrown while detaching handler for data id "+e.dataId+", error: "+t)}},e.prototype.start=function(){return this.logger.info("Data channel start called from adapter"),this._dataChannel?this._dataChannelStartCalled?(this.logger.warn("Data channel start called more than once"),Promise.resolve()):(this._dataChannelStartCalled=!0,this._dataChannel.start(this._negotiationTag)):Promise.reject(new Error("Attempted to call start without a data channel"))},e}();t.default=o},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a,s=n(50),l=n(13),c=n(0),d=n(4),u=n(14),p=n(33),h=n(5),g=n(10),_=n(8),f=n(1),m=n(3);!function(e){e.INITIATED="Initiated",e.CALL_STATE="CallState",e.SHARING_STARTED="SharingStarted",e.DATA_CHANNEL_AVAILABLE="DataChannelAvailable",e.DATA_CHANNEL_UNAVAILABLE="DataChannelUnavailable",e.AVAILABLE_HANDSHAKE="AvailableHandshake",e.SESSION_SHUTDOWN="Shutdown",e.SESSION_SHUTDOWN_BY_ANOTHER_SESSION="ShutdownByOtherSession"}(a||(a={}));var C;!function(e){e.INITIATED="Initiated",e.CALL_STATE="CallState",e.DATA_CHANNEL_AVAILABLE="DataChannelAvailable",e.DATA_CHANNEL_UNAVAILABLE="DataChannelUnavailable",e.CONTROL_REQUEST="ControlRequest",e.SESSION_SHUTDOWN="Shutdown",e.SESSION_SHUTDOWN_BY_ANOTHER_SESSION="ShutdownByOtherSession"}(C||(C={}));var S=function(e){function t(t,n,r,i,o,a){var s=e.call(this,t,n,function(){return s.recordedEvents.length>100})||this;return s.negotiationTag=r,s.callId=i,s.participantId=o,s.endpointId=a,s.messagesFromUnknownSender={},s.tsCallingVersion=g.getTsCallingVersion(),s}return r(t,e),t.prototype.recordProtocolMessage=function(e,t){e||(t in this.messagesFromUnknownSender||(this.messagesFromUnknownSender[t]=0),this.messagesFromUnknownSender[t]++)},t.prototype.setCallId=function(e){this.callId=e},t.prototype.setEndpointId=function(e){this.endpointId=e},t.prototype.setParticipantId=function(e){this.participantId=e},t.prototype.setTenantId=function(e){this.tenantId=e},t}(u.TelemetryUtilities),y=function(e){function t(t,n,r,i,o,a,s){var l=e.call(this,t,n,r,i,o,a)||this,d=s.getSharingParticipantLeg();if(d){l.sharerParticipantId=d;var u=c.find(s.endpoints.endpointDetails,function(e){return e.participantId===d});u&&(l.sharerClientVersion=u.clientVersion)}return l}return r(t,e),t.prototype.getEvent=function(){var t=function(e){return void 0===e?"":e};return{CorrelationId:t(this.callId),ParticipantId:t(this.participantId),EndpointId:t(this.endpointId),NegotiationTag:t(this.negotiationTag),TsCallingVersion:t(this.tsCallingVersion),TenantId:t(this.tenantId),SharerParticipantId:t(this.sharerParticipantId),SharerClientVersion:t(this.sharerClientVersion),EventTimestampBag:e.prototype.getEventTimestampBag.call(this),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}},t}(S),v=function(e){function t(t,n,r,i,o,a){return e.call(this,t,n,r,i,o,a)||this}return r(t,e),t.prototype.getEvent=function(){var t=function(e){return void 0===e?"":e};return{CorrelationId:t(this.callId),ParticipantId:t(this.participantId),EndpointId:t(this.endpointId),NegotiationTag:t(this.negotiationTag),TsCallingVersion:t(this.tsCallingVersion),TenantId:t(this.tenantId),EventTimestampBag:e.prototype.getEventTimestampBag.call(this),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}},t}(S),I=function(e){function t(t,n,r,i,o,a){var s=e.call(this,t.createChild(function(){return"SlimCoreElectronScreenSharingControl"}),n,r)||this;return s._controlInjector=o,s._telemetryLoggers=a,s.controlState=0,s.role=0,s.controlDataChannelStatus={id:null,readyForControl:!1,state:0},s._enabled=!1,s._availableAckEnabled=!0,s._dataChannelActive=!1,s._dataChannelAvailableSent=!1,s._protocolDataSource=null,s._controlDataSource=null,s._controlDataSink=null,s._controlRequest=null,s._controlRequestSubscription=null,s._controllerParticipant=null,s._controllerParticipantSubscription=null,s._screenSharingVideoRenderer=null,s._screenSharingVideoRendererSubscriptions=[],s._sharerParticipant=null,s._controlCapturer=null,s._captureEventSubscription=null,s._mouseControlEventSubscription=null,s._keyboardControlEventSubscription=null,s._requestControlTimer=null,s._grantControlTimer=null,s._acceptControlTimer=null,s._terminateControlTimer=null,s._availableAckTimer=null,s._retryAttempt=0,s._injectRawInputErrorTimer=null,s._lastInjectRawInputErrorCount=0,s._raiseRenderedAtViewer=null,s._participantSubscriptions={},s._viewerSessionLastTerminatedReason=0,s._completedViewerSessions=[],s._logger.info("constructor"),s._callId=i.callId,i.on("callIdChanged",function(e){s._callId=e,s._currentViewerSessionTelemetry&&s._currentViewerSessionTelemetry.setCallId(e),s._currentSharerSessionTelemetry&&s._currentSharerSessionTelemetry.setCallId(e)}),s._participantId=i.participantId,i.on("callLegIdChanged",function(e){s._participantId=e,s._currentViewerSessionTelemetry&&s._currentViewerSessionTelemetry.setParticipantId(e),s._currentSharerSessionTelemetry&&s._currentSharerSessionTelemetry.setParticipantId(e)}),s._endpointId=i.endpointId,s._slimcoreInstance.ecsGetSettingAsBool?s._enableControlSessionTelemetry=s._slimcoreInstance.ecsGetSettingAsBool("MediaAgent","EnableGtcTelemetry",!1):s._enableControlSessionTelemetry=!1,s}return r(t,e),t.prototype.enableScreenSharingControl=function(e,t,n,r){if(this._availableAckEnabled!==e||this._allowControlForUser!==r){if(this._allowControlForUser=r,e)this._raiseScreenSharingControlCapableEvent(!0,"");else{if(0===t){var i={reason:2,detail:n};this.event("sharingControlError").raise(i)}this._raiseScreenSharingControlCapableEvent(!1,"")}this._availableAckEnabled=e}},t.prototype.setRaiseRenderedAtViewer=function(e){this._raiseRenderedAtViewer=e},t.prototype.setScreenSharingControlFeatureFlag=function(e){this._enabled=e,this._availableAckEnabled=e},t.prototype.isScreenSharingControlEnabled=function(){return this._enabled},t.prototype._disposeRenderer=function(){this._disposeControlCapturer();for(var e=0,t=this._screenSharingVideoRendererSubscriptions;e<t.length;e++)t[e].dispose();this._screenSharingVideoRendererSubscriptions=[],this._screenSharingVideoRenderer=null},t.prototype.setRenderer=function(e,t){var n=this;if(this._disposeRenderer(),!e)return Promise.resolve();var r=e,i=t||r.renderTarget;return d.asap(function(){return n._setViewingRenderer(r,i)})},t.prototype.setDataChannel=function(e){var t=this;return d.asap(function(){return t._setDataChannel(e)})},t.prototype._setDataChannel=function(e){this._logger.info("Setting DataChannel "+(e&&e.id)),this._dataChannel&&!e&&this._detachAndDeleteControlDevices(),this._dataChannel=e,e&&(this.controlDataChannelStatus={id:e.id,readyForControl:!1,state:l.default._mapDataChannelStatus(e._lastDataChannelState)},this.event("controlDataChannelStateChanged").raise(this.controlDataChannelStatus))},t.prototype.setProtocolDataSource=function(e){var t=this;return d.asap(function(){return t._setProtocolDataSource(e)})},t.prototype._setProtocolDataSource=function(e){this._protocolDataSource=e},t.prototype._raiseScreenSharingControlCapableEvent=function(e,t,n){if(this._enabled){this._logger.info("_raiseScreenSharingControlCapableEvent() enabled is true, raising control capability, capable="+e);r={capable:e,id:t,disabledBySharer:n};this.event("sharingControlCapable").raise(r)}else{this._logger.info("_raiseScreenSharingControlCapableEvent() enabled is false, disabling control capability");var r={capable:!1,id:t};this.event("sharingControlCapable").raise(r)}},t.prototype.initControlForSharer=function(e){this._logger.info("initControlForSharer()"),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this.role=1,this._dataChannelAvailableSent=!1,this._setInjectorMode(0),this._raiseScreenSharingControlCapableEvent(!0,""),this._initiateSharerSessionTelemetry(e)},t.prototype.shutdownControlForSharer=function(){if(this._logger.info("shutdownControlForSharer()"),this._controlRequest){this._logger.warn("Rejecting pending control requests");var e=this._getDataSourceIdForParticipantLeg(this._controlRequest),t=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(t),this._sendRequest({action:4,terminatedReason:5},e)}if(this.role=0,this._controllerParticipant){var n={inControl:!1,id:this._controllerParticipant.participant.id,terminatedReason:5};this.event("sharingControlChanged").raise(n)}this._finalizeSharerSessionTelemetry(C.SESSION_SHUTDOWN),this._teardownSharerRemoteControl(),this._resetControlState(),this._resetParticipantSubscriptions(),this._availableAckEnabled=this._enabled},t.prototype._resetParticipantSubscriptions=function(){this._logger.info("resetParticipantSubscriptions(): Stopping tracking all participant state changes"),c.each(this._participantSubscriptions,function(e){e.dispose()}),this._participantSubscriptions={}},t.prototype._initiateViewerSessionTelemetry=function(e,t,n){if(!n&&!t)return null;if(!n&&c.find(this._completedViewerSessions,function(e){return t===e}))return null;if(this._currentViewerSessionTelemetry){if(this._currentViewerSessionTelemetry.negotiationTag===t)return null;this._finalizeViewerSessionTelemetry(a.SESSION_SHUTDOWN_BY_ANOTHER_SESSION)}return this._logger.info("initiating new viewer session telemetry for "+t),this._currentViewerSessionTelemetry=new y(this._logger,(new Date).getTime(),t,this._callId,this._participantId,this._endpointId,e),this._currentViewerSessionTelemetry.recordEvent(a.CALL_STATE,{state:this._callState}),this._dataChannel&&this._dataChannelActive&&this._currentViewerSessionTelemetry.recordEvent(a.DATA_CHANNEL_AVAILABLE),this._currentViewerSessionTelemetry},t.prototype._recordViewerSessionTelemetry=function(e,t){void 0===t&&(t=!0),this._currentViewerSessionTelemetry?e&&e(this._currentViewerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")},t.prototype._finalizeViewerSessionTelemetry=function(e){if(this._currentViewerSessionTelemetry){this._currentViewerSessionTelemetry.recordEvent(e);var t=this._currentViewerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_viewer_session",t),this._currentViewerSessionTelemetry.negotiationTag&&this._completedViewerSessions.push(this._currentViewerSessionTelemetry.negotiationTag),this._currentViewerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentViewerSessionTelemetry.messagesFromUnknownSender).length&&_.RootToolsManager.logExternalForDDL("ScreenSharingControl_viewer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentViewerSessionTelemetry=null}},t.prototype._initiateSharerSessionTelemetry=function(e){if(this._currentSharerSessionTelemetry){if(this._currentSharerSessionTelemetry.negotiationTag===e)return null;this._finalizeSharerSessionTelemetry(C.SESSION_SHUTDOWN_BY_ANOTHER_SESSION)}this._logger.info("initiating new sharer session telemetry for "+e),this._currentSharerSessionTelemetry=new v(this._logger,(new Date).getTime(),e,this._callId,this._participantId,this._endpointId),this._dataChannel&&this._dataChannelActive&&this._currentSharerSessionTelemetry.recordEvent(C.DATA_CHANNEL_AVAILABLE)},t.prototype._recordSharerSessionTelemetry=function(e,t){void 0===t&&(t=!0),this._currentSharerSessionTelemetry?e&&e(this._currentSharerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")},t.prototype._finalizeSharerSessionTelemetry=function(e){if(this._currentSharerSessionTelemetry){this._currentSharerSessionTelemetry.recordEvent(e);var t=this._currentSharerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_sharer_session",t),this._currentSharerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentSharerSessionTelemetry.messagesFromUnknownSender).length&&_.RootToolsManager.logExternalForDDL("ScreenSharingControl_sharer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentSharerSessionTelemetry=null}},t.prototype._sendTelemetryEvent=function(e,t){var n=this;this._enableControlSessionTelemetry?this._logger.info("sending event "+e+": "):this._logger.info(e+": "),Object.keys(t).forEach(function(e){n._logger.info("     "+e+" => "+t[e])}),this._enableControlSessionTelemetry&&this._telemetryLoggers&&this._telemetryLoggers.media&&this._telemetryLoggers.media.sendEvent({eventName:e,props:t})},t.prototype._recordProtocolMessage=function(e,t){this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.recordProtocolMessage(e,t),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.recordProtocolMessage(e,t)},t.prototype.reportSharingSessionChangeForViewer=function(e,t){t&&this._initiateViewerSessionTelemetry(e,t,!1)},t.prototype.initControlForViewer=function(e,t){this._logger.info("initControlForViewer("+t+")");var n=!this._sharerParticipant||this._sharerParticipant&&this._sharerParticipant.id!==e.id||t!==this._currentNegotiationTag;this._currentNegotiationTag=t,this.role=2,this._sharerParticipant?this._sharerParticipant.id!==e.id&&(this._recordViewerSessionTelemetry(function(e){return e.recordEvent(a.SESSION_SHUTDOWN_BY_ANOTHER_SESSION,null,t)}),this._logger.info("initControlForViewer() sharer switched, new sharer id="+h.scrubMriOrOmit(e.id)),this._dataChannelAvailableSent=!1,4===this.controlState&&this._terminateControl(!1)):(this._logger.info("initControlForViewer() setting sharer to id="+h.scrubMriOrOmit(e.id)),this._sharerParticipant=e,this._dataChannelAvailableSent=!1),this._initiateViewerSessionTelemetry(e,t,!0),n&&this._recordViewerSessionTelemetry(function(e){return e.recordEvent(a.SHARING_STARTED)}),this._dataChannel&&this._dataChannelActive&&!this._dataChannelAvailableSent&&(this._resetControlState(),this.role=2,this._sharerParticipant=e,this._logger.info("initControlForViewer() sending Available message to sharer"),this._startAvailableHandshake())},t.prototype.shutdownControlForViewer=function(e){this._logger.info("shutdownControlForViewer()");var t=!1;if((!e||this._sharerParticipant&&e.id===this._sharerParticipant.id)&&(this._logger.info("shutdownControlForViewer: setting shouldShutdownControlForViewer to true"),t=!0),t&&this._isViewing()){if(1===this.controlState){if(this._sharerParticipant){var n=this._getSharerDataSourceId();this._sendRequest({action:2,terminatedReason:6},n)}else this._logger.warn("shutdownControlForViewer: sharer participant is null");r={inControl:!1,id:"",terminatedReason:6};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:r,details:""}))):this._logger.error("Unexpected, no promise could be resolved - state =ControlState.RequestSent action =shutdownControlForViewer")}else if(4===this.controlState){var r={inControl:!1,id:"",terminatedReason:6};this.event("sharingControlChanged").raise(r)}this._teardownViewerRemoteControl(),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._dataChannelAvailableSent=!1,this._finalizeViewerSessionTelemetry(a.SESSION_SHUTDOWN),this._raiseScreenSharingControlCapableEvent(!1,"")}},t.prototype._resetControlRequest=function(e){this._clearControlRequest(),this._controlRequest=e,this._registerParticipantListener(e),3===e.participantState&&this.event("sharingIncomingControlRequest").raise(e.participant.id)},t.prototype._clearControlRequest=function(){this._stopListeningToParticipantChanges(this._controlRequest),this._controlRequest=null},t.prototype._stopListeningToParticipantChanges=function(e){this._controlRequestSubscription&&(this._logger.info("_stopListeningToParticipantChanges: stopping tracking changes for "+e.participant.id),this._controlRequestSubscription.dispose(),this._controlRequestSubscription=null)},t.prototype._registerParticipantListener=function(e){var t=this;this._logger.info("_registerParticipantListener: tracking changes for "+e.participant.id),this._controlRequestSubscription=e.participant.changed(function(){if(e.participant.state!==e.participantState)switch(e.participantState=e.participant.state,e.participantState){case 3:t.event("sharingIncomingControlRequest").raise(e.participant.id);break;case 0:case 5:case 4:t.denyControlRequest().catch(function(e){t._logger.info("it is ok if denyControlRequest rejects here as screensharing may have just been stopped. Err is "+e)}),t._logger.info("_registerParticipantListener: participant "+e.participant.id+" is no longer connected. resetting"),t._clearControlRequest(),t._raiseControlRequestCanceled(e);break;case 1:case 2:case 6:case 7:break;default:t._logger.error("unexpected participantState {request.participantState} unhandled")}})},t.prototype._resetControllerParticipant=function(e){var t=this;this._controllerParticipantSubscription&&(this._logger.info("_resetControllerParticipant: stopping tracking changes for "+this._controllerParticipant.participant.id),this._controllerParticipantSubscription.dispose(),this._controllerParticipantSubscription=null),e&&(this._logger.info("_resetControllerParticipant: tracking changes for "+e.participant.id),this._controllerParticipantSubscription=e.participant.changed(function(){3!==e.participant.state&&t.handleParticipantRemoved(e.participant.id)})),this._controllerParticipant=e},t.prototype.handleParticipantRemoved=function(e){if(this._participantSubscriptions[e]&&(this._logger.info("handleParticipantRemoved(): Stopping tracking state changes for "+e),this._participantSubscriptions[e].dispose(),delete this._participantSubscriptions[e]),this._isSharing()){if(this._controllerParticipant&&this._controllerParticipant.participant.id===e){this._logger.info("handleParticipantRemoved: controller left call, tearing down control session"),this._teardownSharerRemoteControl(),this.controlState=0,this._resetControllerParticipant();t={inControl:!1,id:e,terminatedReason:5};this.event("sharingControlChanged").raise(t)}this._raiseScreenSharingControlCapableEvent(!1,e)}else if(this._sharerParticipant&&this._sharerParticipant.id===e&&4===this.controlState){this._logger.info("handleParticipantRemoved: sharer left call, tearing down control session"),this._teardownViewerRemoteControl(),this.controlState=0;var t={inControl:!1,id:"",terminatedReason:6};this.event("sharingControlChanged").raise(t)}},t.prototype.callStateChanged=function(e){this._callState=e,this._recordViewerSessionTelemetry(function(t){return t.recordEvent(a.CALL_STATE,{state:e})},!1),this._recordSharerSessionTelemetry(function(t){return t.recordEvent(C.CALL_STATE,{state:e})},!1),7===e&&this._handleCallDisconnected()},t.prototype._handleCallDisconnected=function(){this._logger.info("handleCallDisconnected()"),this._isSharing()?this.shutdownControlForSharer():this.shutdownControlForViewer()},t.prototype._videoSizeChanged=function(e,t){null!=this._controlCapturer&&this._controlCapturer.updateVideoSize(e,t)},t.prototype._onRenderStarted=function(){var e={action:11,terminatedReason:0};if(this._sharerParticipant){var t=this._getSharerDataSourceId();this._sendRequest(e,t)}else this._logger.error("Attempted to send sharing rendered message to null sharerParticipant")},t.prototype._setViewingRenderer=function(e,t){var n=this;try{this._screenSharingVideoRenderer=e,this._screenSharingVideoRendererSubscriptions.push(this._screenSharingVideoRenderer.on("videoSizeChanged",function(e,t){return n._videoSizeChanged(e,t)})),this._screenSharingVideoRendererSubscriptions.push(this._screenSharingVideoRenderer.on("renderStarted",function(){return n._onRenderStarted()})),this._controlCapturer=new s.SlimCoreElectronControlCapturer(this._logger,t),4===this.controlState?(this._logger.info("_setViewingRenderer: detected local state is controlling"),this._setupViewerRemoteControl()):this._teardownViewerRemoteControl()}catch(e){this._logger.error("_setViewingRenderer: unable to set _screenSharingVideoRenderer error = "+e)}},t.prototype._isSharing=function(){return 1===this.role},t.prototype._isViewing=function(){return 2===this.role},t.prototype._createAndAttachControlDevices=function(){var e=this;if(this._logger.info("_createAndAttachControlDevices()"),f.hasCreateDataSource(this._slimcoreInstance)&&f.hasCreateDataSink(this._slimcoreInstance))if(this._dataChannel){var t=Promise.resolve(),n=Promise.resolve();this._controlDataSource||(this._controlDataSource=f.createDataSource(this._slimcoreInstance,SlimCore.Enums.DataDeviceId.Control),this._logger.info("created Control DataSource"),t=this._dataChannel.registerDataSource(this._controlDataSource).then(function(){return e._logger.info("registered Control DataSource")}).catch(function(t){return e._logger.error("registerDataSource threw exception: "+t)})),this._controlDataSink||(this._controlDataSink=f.createDataSink(this._slimcoreInstance,SlimCore.Enums.DataDeviceId.Control),this._logger.info("created Control DataSink"),n=this._dataChannel.registerDataSink(this._controlDataSink).then(function(){return e._logger.info("registered Control DataSink")}).catch(function(t){return e._logger.error("registerDataSink threw exception: "+t)})),Promise.all([t,n]).then(function(){e.controlDataChannelStatus.readyForControl=!0,e.event("controlDataChannelStateChanged").raise(e.controlDataChannelStatus)}),this._controlDataSink.on("data",function(t){e._controlInjector.injectRawInput(t.data,t.sourceID).catch(function(n){e._lastInjectRawInputErrorCount++,null===e._injectRawInputErrorTimer&&(e._injectRawInputErrorTimer=setTimeout(function(){var r={reason:1,detail:JSON.stringify({dataChannelId:e._dataChannel.id,sourceId:t&&t.sourceID,count:e._lastInjectRawInputErrorCount,errorMsg:n})};e.event("sharingControlError").raise(r),e._lastInjectRawInputErrorCount=0,e._injectRawInputErrorTimer=null},1e4))})})}else this._logger.warn("_createAndAttachControlDevices() null dataChannel");else this._logger.warn("createDataSource or createDataSink not implemented")},t.prototype._detachAndDeleteControlDevices=function(){var e=this;this._logger.info("_detachAndDeleteControlDevices()"),this._controlDataSink&&this._controlDataSink.removeAllListeners("data"),this._dataChannel?(this._controlDataSource&&(this._dataChannel.unregisterDataSource(this._controlDataSource).then(function(){return e._logger.info("Control DataSource unregistered")}).catch(function(t){return e._logger.warn("unregisterDataSource threw exception: "+t)}),this._controlDataSource=null,this._logger.info("deleted Control data source")),this._controlDataSink&&(this._dataChannel.unregisterDataSink(this._controlDataSink).then(function(){return e._logger.info("Control DataSink unregistered")}).catch(function(t){return e._logger.warn("unregisterDataSink threw exception: "+t)}),this._controlDataSink=null,this._logger.info("deleted Control data sink"))):this._logger.warn("_detachAndDeleteControlDevices() null dataChannel")},t.prototype.onDataChannelStatusChanged=function(e){var t=this;return d.asap(function(){return t._onDataChannelStatusChanged(e)})},t.prototype._onDataChannelStatusChanged=function(e){this._logger.info("Data channel status = "+e),this.controlDataChannelStatus.readyForControl=this.controlDataChannelStatus.readyForControl&&e===SlimCore.Enums.DataChannelStatus.Active,this.controlDataChannelStatus.state=l.default._mapDataChannelStatus(e),this.event("controlDataChannelStateChanged").raise(this.controlDataChannelStatus),e===SlimCore.Enums.DataChannelStatus.Active?this._enabled&&this._dataChannel&&!this._dataChannelActive&&(this._dataChannelActive=!0,this._recordViewerSessionTelemetry(function(e){return e.recordEvent(a.DATA_CHANNEL_AVAILABLE)},!1),this._recordSharerSessionTelemetry(function(e){return e.recordEvent(C.DATA_CHANNEL_AVAILABLE)},!1),this._createAndAttachControlDevices(),this._isViewing()?this._dataChannelAvailableSent||(this._sharerParticipant?(this._logger.info("_onDataChannelStatusChanged() sending Available message to sharer"),this._startAvailableHandshake()):this._logger.error("Unexpected null _sharerParticipant trying to send Available to sharer")):this._isSharing()&&this._raiseScreenSharingControlCapableEvent(!0,"")):this._dataChannel&&this._dataChannelActive&&(this._recordViewerSessionTelemetry(function(e){return e.recordEvent(a.DATA_CHANNEL_UNAVAILABLE)},!1),this._recordSharerSessionTelemetry(function(e){return e.recordEvent(C.DATA_CHANNEL_UNAVAILABLE)},!1),this._dataChannelActive=!1,this._dataChannelAvailableSent=!1,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(3),this._detachAndDeleteControlDevices(),this._raiseScreenSharingControlCapableEvent(!1,""))},t.prototype._handleAvailableRequest=function(e,t,n){var r=this,i=!1,o=0;if(!1===this._enabled)this._logger.info("feature flag is off. no need to answer the available ack"),i=!0,o=9;else if(!1===this._availableAckEnabled)this._logger.info("available ack is off. no need to answer the available ack"),i=!0,o=9;else if(t&&t.id){if(this._allowControlForUser&&typeof this._allowControlForUser==typeof Function)return void this._allowControlForUser(t).then(function(a){a||(i=!0,o=1),r._sendResponseToAvailableRequest(e,t,n,i,o)})}else i=!0,o=10;this._sendResponseToAvailableRequest(e,t,n,i,o)},t.prototype._sendResponseToAvailableRequest=function(e,t,n,r,i){var o=this;r?(this._logger.info("Rejecting Available for handShake:"+n+":"+e.handshakeId),this.event("controlAvailableHandshake").raise(e.handshakeId,n,7,this._getAvailableHandshakeTerminatedFromControlTerminated(i)),this._sendRequest({action:10,terminatedReason:i,handshakeId:e.handshakeId},n)):(this._raiseScreenSharingControlCapableEvent(!0,t.id),this._participantSubscriptions[t.id]||(this._logger.info("Tracking participant status for "+t.id),this._participantSubscriptions[t.id]=t.changed(function(){3!==t.state&&(o._logger.info("Participant "+t.id+" is not connected. removing"),o.handleParticipantRemoved(t.id))})),this._logger.info("Acking Available for handShake:"+n+":"+e.handshakeId),this.event("controlAvailableHandshake").raise(e.handshakeId,n,3),this._sendRequest({action:9,terminatedReason:0,handshakeId:e.handshakeId},n))},t.prototype.processProtocolMessage=function(e,t,n,r){var i=this;return d.asap(function(){return i._processProtocolMessage(e,t,n,r)})},t.prototype._raiseControlRequestCanceled=function(e){this.event("sharingIncomingControlRequestCancelled").raise(e.participant.id)},t.prototype._processProtocolMessage=function(e,t,n,r){var i;this._recordProtocolMessage(t,r);try{i=JSON.parse(e)}catch(e){return void this._logger.error("Error parsing controlMessage")}if(this._logger.info("_processProtocolMessage action="+i.action+" sender="+r),t||this._logger.warn("protocol message from unknown sender with sourceId="+r),0===i.action)this._handleAvailableRequest(i,t,r);else if(1===i.action)!1===this._enabled?(this._logger.warn("Sharer control is disabled - rejecting request"),this._sendRequest({action:4,terminatedReason:9},r)):this._controlRequest?(this._logger.warn("Sharer is already processing a control request...rejecting new requests"),this._sendRequest({action:4,terminatedReason:3},r)):this._controllerParticipant&&this._controllerParticipant.participant===t?this._controllerParticipant.participantId&&this._controllerParticipant.participantId!==n?(this._logger.warn("rejecting control request from second endpoint. participantId: "+n),this._sendRequest({action:4,terminatedReason:3},r)):(this._logger.warn("Got control request for someone already in control"),this._sendRequest({action:3,terminatedReason:0},r)):t?this._resetControlRequest({participant:t,participantState:t.state,participantId:n}):this._logger.error("Got ControlRequest message but could not find a sender participant, ignoring");else if(3===i.action)1===this.controlState?((s=this._sendRequest({action:5,terminatedReason:0},r))?(this._setupViewerRemoteControl(),this.controlState=4,this._requestControlPromise?this._requestControlPromise.resolve():this._logger.error("Unexpected, no promise could be resolved - state =ControlState.RequestSent action ="+i.action)):this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control is accepted, but fail to send ack"}))):this._logger.error("Unexpected, no promise could be resolved - state ="+this.controlState+" action ="+i.action),this._cancelRequestControlTimer()):this._logger.warn("AcceptRequest message received in controlState="+this.controlState);else if(4===i.action)if(1===this.controlState){this.controlState=0;d={inControl:!1,id:"",terminatedReason:i.terminatedReason};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:d,details:""}))):this._logger.error("Unexpected, no promise could be resolved - state =ControlState.RequestSent action ="+i.action),this._cancelRequestControlTimer()}else this._logger.warn("RejectRequest message received in controlState="+this.controlState+" reason="+i.terminatedReason);else if(2===i.action){if(this._controlRequest){var o=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(o)}}else if(6===i.action){var s=this._sendRequest({action:5,terminatedReason:0},r);if(s){this._setupViewerRemoteControl(),this.controlState=4;d={inControl:!0,id:"",terminatedReason:i.terminatedReason};this.event("sharingControlChanged").raise(d)}}else if(5===i.action)if(2===this.controlState)if(this._controllerParticipant&&this._controllerParticipant.participant===t){var l=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);r!==l&&this._logger.warn("acknowledging source id: "+r+" does not match requesting source id: "+l),this._logger.info("Setting up remote control for controller source id="+l),this._setupSharerRemoteControl(l),this.controlState=3;d={inControl:!0,id:this._controllerParticipant.participant.id,terminatedReason:i.terminatedReason};this.event("sharingControlChanged").raise(d),this._grantControlPromise?(this._grantControlPromise.resolve(),this._cancelGrantControlTimer()):this._acceptControlPromise?(this._acceptControlPromise.resolve(),this._cancelAcceptControlTimer()):this._logger.error("Unexpected, no promise could be resolved - state =ControlState.WaitingForControlAck action ="+i.action)}else t?this._logger.warn("Ignoring ack from participant that does not match controller id = "+h.scrubMriOrOmit(t.id)):this._logger.warn("Ignoring ack from null participant source id = "+r);else 5===this.controlState?(this.controlState=0,this._resetControllerParticipant(),this._terminateControlPromise?(this._terminateControlPromise.resolve(),this._cancelTerminateControlTimer()):this._logger.error("Unexpected, no promise could be resolved - state =ControlState.WaitingForTerminateAck action ="+i.action)):this._logger.warn("Unexpected ack in control state = "+this.controlState);else if(7===i.action||8===i.action){var c=void 0;this._isViewing()?(this._teardownViewerRemoteControl(),c=""):(this._teardownSharerRemoteControl(),t?c=t.id:this._logger.error("Got terminate message but could not find a sender participant!")),this.controlState=0,this._resetControllerParticipant();var d={inControl:!1,id:c,terminatedReason:i.terminatedReason};this.event("sharingControlChanged").raise(d),8===i.action&&this._sendRequest({action:5,terminatedReason:0},r)}else if(9===i.action)this._terminateAvailableHandshake&&this._terminateAvailableHandshake(1,i.handshakeId),this._raiseScreenSharingControlCapableEvent(!0,"");else if(10===i.action){if(this._viewerSessionLastTerminatedReason=i.terminatedReason,this._recordViewerSessionTelemetry(function(e){return e.updateOperationData(a.AVAILABLE_HANDSHAKE,{nackReason:i.terminatedReason},i.handshakeId)}),10===i.terminatedReason)return;this._terminateAvailableHandshake&&this._terminateAvailableHandshake(this._getAvailableHandshakeTerminatedFromControlTerminated(i.terminatedReason),i.handshakeId),1===i.terminatedReason?this._raiseScreenSharingControlCapableEvent(!0,"",!0):this._raiseScreenSharingControlCapableEvent(!1,"")}else 11===i.action?this._raiseRenderedAtViewer&&(t?this._raiseRenderedAtViewer(t.id):this._logger.error("Got RenderedAtViewer message but could not find a sender participant!")):this._logger.error("Unknown request action received on control protocol data sink, action="+i.action)},t.prototype._getAvailableHandshakeTerminatedFromControlTerminated=function(e){switch(e){case 10:return 6;case 1:return 7;case 9:default:return 0}},t.prototype._sendRequest=function(e,t){var n=!1,r=this._protocolDataSource;if(t<0)return this._logger.error("Unexpected: invalid sourceID="+t),n;if(r){this._logger.info("sending control message action="+e.action+" to sourceID="+t);var i={type:0,message:JSON.stringify(e)};try{var o=[t];r.sendData(f.stringToBuffer(JSON.stringify(i)),o),n=!0}catch(e){this._logger.error("Unexpected: failure in call to sendData. Error="+e);var a={reason:5,detail:JSON.stringify({sourceId:t,errorMsg:e})};this.event("sharingControlError").raise(a)}}else this._logger.error("Unexpected: null dataSource in _sendRequest");return n},t.prototype._resetControlState=function(){this._logger.info("_resetControlState()"),this.controlState=0,this._resetControllerParticipant(),this._sharerParticipant=null,this._clearControlRequest(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer()},t.prototype._setupSharerRemoteControl=function(e){var t=this;this._logger.info("_setupSharerRemoteControl() sourceId="+e),this._setInjectorMode(1),this._controlInjector.allowSingleController(e).catch(function(n){var r={reason:3,detail:JSON.stringify({sourceId:e,errorMsg:n})};t.event("sharingControlError").raise(r)})},t.prototype._teardownSharerRemoteControl=function(){var e=this;this._logger.info("_teardownSharerRemoteControl()"),this._controlInjector.allowSingleController(0).catch(function(t){var n={reason:3,detail:JSON.stringify({sourceId:0,errorMsg:t})};e.event("sharingControlError").raise(n)}),this._setInjectorMode(0)},t.prototype._setupViewerRemoteControl=function(){this._logger.info("_setupViewerRemoteControl()"),this._setCapturerMode(3)},t.prototype._teardownViewerRemoteControl=function(){this._logger.info("_teardownViewerRemoteControl()"),this._setCapturerMode(0)},t.prototype._setInjectorMode=function(e){var t=this;this._logger.info("_setInjectorMode() mode="+e);var n={mode:e,noMotionTimeoutMs:0,noMotionSharerTimeoutMs:0};this._controlInjector.setInjectorConfig(n).catch(function(n){var r={reason:0,detail:JSON.stringify({mode:e,errorMsg:n})};t.event("sharingControlError").raise(r)})},t.prototype._clearCapturerEventSubscriptions=function(){this._logger.info("_clearCapturerEventSubscriptions()"),this._captureEventSubscription&&(this._captureEventSubscription.dispose(),this._captureEventSubscription=null),this._mouseControlEventSubscription&&(this._mouseControlEventSubscription.dispose(),this._mouseControlEventSubscription=null),this._keyboardControlEventSubscription&&(this._keyboardControlEventSubscription.dispose(),this._keyboardControlEventSubscription=null)},t.prototype.sendRemoteControlEvent=function(e,t){if(t)switch(e){case"mouseControlEvent":this._sendControlEvent(s.SlimCoreElectronControlCapturer.formatMouseEvent(t));break;case"keyboardControlEvent":this._sendControlEvent(s.SlimCoreElectronControlCapturer.formatKeyboardEvent(t));break;default:return void this._logger.error("sendRemoteControlEvent: Invalid type = ",e)}else this._logger.error("sendRemoteControlEvent: Invalid argument.")},t.prototype._sendControlEvent=function(e){if(this._controlDataSource&&this._sharerParticipant&&4===this.controlState){var t=[this._getSharerDataSourceId()];this._controlDataSource.sendData(e,t)}else this._logger.error("_sendControlEvent: Data channel not set up / Not in control")},t.prototype._setCapturerMode=function(e){var t=this;this._logger.info("_setCapturerMode() capturerMode="+e),this._controlCapturer?(this._controlCapturer.setCaptureMode(e),this._clearCapturerEventSubscriptions(),1===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",function(e){0===e&&t.event("sharingRendererClicked").raise()}):2===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",function(e){1===e?t.event("sharingRendererMouseEntering").raise():2===e&&t.event("sharingRendererMouseLeaving").raise()}):3===e&&(this._mouseControlEventSubscription=this._controlCapturer.on("mouseControlEvent",function(e){return t._sendControlEvent(s.SlimCoreElectronControlCapturer.formatMouseEvent(e))}),this._keyboardControlEventSubscription=this._controlCapturer.on("keyboardControlEvent",function(e){return t._sendControlEvent(s.SlimCoreElectronControlCapturer.formatKeyboardEvent(e))}),this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",function(e){1===e?t.event("sharingRendererMouseEntering").raise():2===e&&t.event("sharingRendererMouseLeaving").raise()}))):this._logger.warn("_controlCapturer not found when trying to setup viewer capture mode")},t.prototype.setPointerImage=function(e,t){return this._logger.warn("setPointerImage is deprecated. Use setLocalPointerImage or setRemotePointerImage"),e?this.setRemotePointerImage(e,t):this.setLocalPointerImage(t)},t.prototype.setLocalPointerImage=function(e){return 0===e.length?Promise.reject(new Error("setLocalPointerImage invalid image length")):this._setPointerImage(0,e)},t.prototype.setRemotePointerImage=function(e,t){return i(this,void 0,void 0,function(){var n,r,i,a;return o(this,function(o){switch(o.label){case 0:if(!e)throw new Error("setRemotePointerImage participant is null");if(0===t.length)throw new Error("setRemotePointerImage invalid image length");if(e.enableParticipantLegToSourceIdMapping)return[3,2];if((a=this._mapParticipantToSourceId(e))<0)throw new Error("setRemotePointerImage unable to map participant to sourceId");return[4,this._setPointerImage(a,t)];case 1:return o.sent(),[2];case 2:if(0===(n=this._getParticipantsDataSourceIds(e)).length)throw new Error("setRemotePointerImage unable to map participant to sourceIds");this._logger.info("set pointer image for "+n.length+" sources"),r=0,i=n,o.label=3;case 3:return r<i.length?(a=i[r],[4,this._setPointerImage(a,t)]):[3,6];case 4:o.sent(),o.label=5;case 5:return r++,[3,3];case 6:return[2]}})})},t.prototype._setPointerImage=function(e,t){return this._isSharing()||this._logger.warn("_setPointerImage called when not sharing"),this._controlInjector.setAvatar(f.stringToBuffer(t),e)},t.prototype.startPointerMode=function(){var e=this;return this._dataChannelActive?0!==this.controlState?Promise.reject(new Error("startPointerMode called in bad control state="+this.controlState)):this._isViewing()?d.asap(function(){return e._setCapturerMode(2)}):Promise.reject(new Error("startPointerMode when not viewing")):Promise.reject(new Error("startPointerMode when data channel not active"))},t.prototype.stopPointerMode=function(){var e=this;return 0!==this.controlState?Promise.reject(new Error("stopPointerMode called in bad control state="+this.controlState)):this._isViewing()?d.asap(function(){return e._setCapturerMode(1)}):Promise.reject(new Error("stopPointerMode when not viewing"))},t.prototype._startAvailableHandshake=function(){var e=this,t=this._getSharerDataSourceId();t<0&&this._logger.warn("sharer: "+this._sharerParticipant+" has no data channel");var n=p.default();this._logger.info("_startAvailableHandshake() - handshakeId: "+t+":"+n),this.event("controlAvailableHandshake").raise(n,t,1),this._terminateAvailableHandshake&&(this._logger.warn("Replacing existing availble handshake"),this._terminateAvailableHandshake(4)),this._recordViewerSessionTelemetry(function(e){return e.recordOperation(a.AVAILABLE_HANDSHAKE,n)}),this._sendRequest({action:0,terminatedReason:0,handshakeId:n},t)||this._logger.error("Failed to send Available message to sharer, will retry after backoff"),this._dataChannelAvailableSent=!0,this._waitForAvailableAck(n),this._terminateAvailableHandshake=function(r,i){void 0===r&&(r=0),e._logger.info("_terminateAvailableHandshake() - handshakeId: "+t+":"+n+", status: "+r),e._recordViewerSessionTelemetry(function(t){return t.updateOperationData(a.AVAILABLE_HANDSHAKE,{tries:e._retryAttempt},i)}),1===r?e._recordViewerSessionTelemetry(function(e){return e.recordOperationSuccess(a.AVAILABLE_HANDSHAKE,null,"",i)}):(e._logger.error("GTC handshake failed with code "+r+", last message: "+e._viewerSessionLastTerminatedReason),_.RootToolsManager.logExternalForDDL("GTC handshake failed with code "+r+",",e._viewerSessionLastTerminatedReason.toString()),e._recordViewerSessionTelemetry(function(e){return e.recordOperationFailure(a.AVAILABLE_HANDSHAKE,{reason:r},"",i)})),e._terminateAvailableHandshake=null,e.event("controlAvailableHandshake").raise(n,t,1===r?5:6,r),i&&i!==n&&e._logger.warn("AvailableSeries: Got handshake from another series - expected: "+n+", received: "+i),e._availableAckTimer&&(clearTimeout(e._availableAckTimer),e._availableAckTimer=null),e._retryAttempt=0}},t.prototype._waitForAvailableAck=function(e){var t=this;this._logger.info("_waitForAvailableAck()"),this._availableAckTimer=setTimeout(function(){t._logger.warn("No Ack received for Available message from attempt="+t._retryAttempt),t._availableAckTimer=null;var n=t._getSharerDataSourceId();if(t._retryAttempt<=6)t._logger.info("Re-sending Available message handshakeId: "+n+":"+e),t.event("controlAvailableHandshake").raise(e,n,2),t._sendRequest({action:0,terminatedReason:0,handshakeId:e},n),t._waitForAvailableAck(e);else if(t._logger.error("Reached Available retry limit! Control capability will be false"),t._terminateAvailableHandshake)t._terminateAvailableHandshake(5);else{var r={reason:4,detail:JSON.stringify({sourceId:n,errorMsg:"Timed out after "+t._retryAttempt+" tries"})};t.event("sharingControlError").raise(r)}},2e3*++this._retryAttempt)},t.prototype.requestControl=function(){return this._dataChannelActive?0!==this.controlState?Promise.reject(new Error("requestControl called in bad state="+this.controlState)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while requesting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while requesting control")):this._requestControl():Promise.reject(new Error("requestControl unexpected null sharer")):Promise.reject(new Error("requestControl when not viewing")):Promise.reject(new Error("requestControl when data channel not active"))},t.prototype._requestControl=function(){var e=this;this._logger.info("_requestControl()"),this._requestControlPromise=d.defer();var t=function(){e._requestControlPromise=null};this._requestControlPromise.promise.then(t,t);var n=this._getSharerDataSourceId();if(!this._sendRequest({action:1,terminatedReason:0},n)){var r={inControl:!1,id:"",terminatedReason:7};return this._requestControlPromise.reject(new Error),Promise.reject(new Error(JSON.stringify({controlInfo:r,details:""})))}return this.controlState=1,this._requestControlTimer=setTimeout(function(){if(1===e.controlState){e.controlState=0,e._logger.warn("No response to control request - canceling"),e._sendRequest({action:2,terminatedReason:2},n)||e._logger.error("fail to send the cancel control request");var t={inControl:!1,id:"",terminatedReason:2};e._requestControlPromise?e._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:t,details:"we did not get any response to the control - terminating control"}))):e._logger.error("Unexpected, no promise could be resolved - controlState = ControlState.RequestSent")}else e._requestControlPromise?e._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control - times out in bad state - do nothing"}))):e._logger.error("Unexpected, no promise could be resolved - controlState = "+e.controlState);e._requestControlTimer=null},3e4),this._requestControlPromise.promise},t.prototype._cancelRequestControlTimer=function(){this._requestControlTimer&&(this._requestControlPromise&&this._requestControlPromise.reject(new Error("cancelled by _cancelRequestControlTimer")),clearTimeout(this._requestControlTimer),this._requestControlTimer=null)},t.prototype.cancelControl=function(){return this._dataChannelActive?1!==this.controlState?Promise.reject(new Error("cancelControl called in bad state="+this.controlState)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while cancelling control")):this._cancelControl():Promise.reject(new Error("request control promise has been resolved while cancelling control")):Promise.reject(new Error("cancelControl unexpected null sharer")):Promise.reject(new Error("cancelControl when not viewing")):Promise.reject(new Error("cancelControl when data channel not active"))},t.prototype._cancelControl=function(){this._logger.info("_cancelControl()");var e=this._getSharerDataSourceId();if(1!==this.controlState)return Promise.reject(new Error("cancel control - in bad state - do nothing"));if(this._cancelRequestControlTimer(),this.controlState=0,this._logger.info("Viewer cancel the control"),!this._sendRequest({action:2,terminatedReason:8},e))return Promise.reject(new Error("fail to send cancel control request"));var t={inControl:!1,id:"",terminatedReason:8};return this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:t,details:""}))),new Promise(function(e,t){e()})},t.prototype.acceptControlRequest=function(){return this._dataChannelActive?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("accept control promise has not been resolved yet while accepting control")):this._grantControlPromise?Promise.reject(new Error("grant control promise has not been resolved yet while accepting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while accepting control")):this._acceptControlRequest():Promise.reject(new Error("acceptControlRequest when not sharing")):Promise.reject(new Error("acceptControlRequest while no control request pending")):Promise.reject(new Error("acceptControlRequest when data channel not active"))},t.prototype._acceptControlRequest=function(){var e=this;this._logger.info("_acceptControlRequest()"),this._acceptControlPromise=d.defer();var t=function(){e._acceptControlPromise=null};if(this._acceptControlPromise.promise.then(t,t),this._controllerParticipant){this._logger.warn("_acceptControlRequest called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();var n=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},n)||this._logger.error("fail to send the terminateNoAck request"),this._resetControllerParticipant()}var r=this._getDataSourceIdForParticipantLeg(this._controlRequest),i=this._controlRequest.participant.id;return this._sendRequest({action:3,terminatedReason:0},r)?(this._resetControllerParticipant(this._controlRequest),this._clearControlRequest(),this.controlState=2,this._acceptControlTimer=setTimeout(function(){if(2===e.controlState){e.controlState=0,e._resetControllerParticipant(),e._logger.error("No ack received when accepting control request - terminating control"),e._sendRequest({action:7,terminatedReason:4},r)||e._logger.error("fail to send the TerminateNoAck request");var t={inControl:!1,id:i,terminatedReason:4};e.event("sharingControlChanged").raise(t),e._acceptControlPromise?e._acceptControlPromise.reject(new Error("No ack received when accept control - terminating control")):e._logger.error("Unexpected, no promise could be resolved - controlState = ControlState.WaitingForControlAck")}else e._acceptControlPromise?e._acceptControlPromise.reject(new Error("accept control - times out in bad state - do nothing")):e._logger.error("Unexpected, no promise could be resolved - controlState = "+e.controlState);e._acceptControlTimer=null},1e4),this._acceptControlPromise.promise):(this._logger.error("fail to send the accept control request"),this._acceptControlPromise.reject(new Error),Promise.reject(new Error("fail to send the accept control request!")))},t.prototype._cancelAcceptControlTimer=function(){this._acceptControlTimer&&(this._acceptControlPromise&&this._acceptControlPromise.reject(new Error("cancelled by _cancelAcceptControlTimer")),clearTimeout(this._acceptControlTimer),this._acceptControlTimer=null)},t.prototype.denyControlRequest=function(){return this._dataChannelActive?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("accept control promise has not been resolved yet while denying control")):this._grantControlPromise?Promise.reject(new Error("grant control promise has not been resolved yet while denying control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while denying control")):this._denyControlRequest():Promise.reject(new Error("denyControlRequest when not sharing")):Promise.reject(new Error("denyControlRequest while no control request pending")):Promise.reject(new Error("denyControlRequest when data channel not active"))},t.prototype._denyControlRequest=function(){this._logger.info("_denyControlRequest()");var e=this._getDataSourceIdForParticipantLeg(this._controlRequest);return this._clearControlRequest(),this._sendRequest({action:4,terminatedReason:1},e)?new Promise(function(e,t){e()}):Promise.reject(new Error("fail to send the deny control requst"))},t.prototype.grantControl=function(e){return this._dataChannelActive?this._controlRequest?Promise.reject(new Error("grantControl called while control request pending")):this._isSharing()?e?this._acceptControlPromise?Promise.reject(new Error("accept control promise has not been resolved yet while granting control")):this._grantControlPromise?Promise.reject(new Error("grant control promise has not been resolved yet while granting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while granting control")):this._grantControl(e):Promise.reject(new Error("grantControl null participant")):Promise.reject(new Error("grantControl when not sharing")):Promise.reject(new Error("grantControl when data channel not active"))},t.prototype._grantControl=function(e){var t=this;this._logger.info("_grantControl()"),this._grantControlPromise=d.defer();var n=function(){t._grantControlPromise=null};if(this._grantControlPromise.promise.then(n,n),3===this.controlState){if(this._controllerParticipant.participant===e)return this._logger.warn("grantControl called for participant who already has control"),this._grantControlPromise.resolve(),new Promise(function(e,t){e()});this._logger.warn("_grantControl called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();var r=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},r)||this._logger.error("fail to send the terminateNoAck request")}var i=this._mapParticipantToSourceId(e);if(!this._sendRequest({action:6,terminatedReason:0},i))return this._logger.error("fail to send the grant control request"),this._grantControlPromise.reject(new Error),Promise.reject(new Error("fail to send the grant control request!"));var o=this._getParticipantIdForDataSourceId(e,i);return this._resetControllerParticipant({participant:e,participantState:e.state,participantId:o}),this.controlState=2,this._grantControlTimer=setTimeout(function(){2===t.controlState?(t.controlState=0,t._resetControllerParticipant(),t._logger.error("No ack received when granting control - terminating control"),t._sendRequest({action:7,terminatedReason:4},i)||t._logger.error("fail to send the terminateNoAck request"),t._grantControlPromise?t._grantControlPromise.reject(new Error("No ack received when granting control - terminating control")):t._logger.error("Unexpected, no promise could be resolved - controlState = ControlState.WaitingForControlAck")):t._grantControlPromise?t._grantControlPromise.reject(new Error("grant control - times out in bad state - do nothing")):t._logger.error("Unexpected, no promise could be resolved - controlState = "+t.controlState),t._grantControlTimer=null},1e4),this._grantControlPromise.promise},t.prototype._cancelGrantControlTimer=function(){this._grantControlTimer&&(this._grantControlPromise&&this._grantControlPromise.reject(new Error("cancelled by _cancelGrantControlTimer")),clearTimeout(this._grantControlTimer),this._grantControlTimer=null)},t.prototype._mapParticipantToSourceId=function(e){return this._dataChannel?e.getSourceIdForMediaType(4):(this._logger.error("Null data channel cannot map participant to source id"),-1)},t.prototype._getParticipantsDataSourceIds=function(e){var t=[];try{if(e&&e.endpoints&&e.endpoints.endpointDetails){if(!(1!==e.endpoints.endpointDetails.length||(i=e.endpoints.endpointDetails[0])&&i.mediaStreams))return t.push(l.DATA_SOURCE_ID_ANY),t;for(var n=0,r=e.endpoints.endpointDetails;n<r.length;n++){var i=r[n];if(i&&i.mediaStreams)for(var o=0,a=i.mediaStreams;o<a.length;o++){var s=a[o];if(4===f.mapMediaTypeStringToMediaType(s.type)){if(t.push(s.sourceId),t.length>=8)return this._logger.error("excessive amount of data streams"),t;break}}}}}catch(e){this._logger.error("_getParticipantsDataSourceIds caught exception error="+e)}return t},t.prototype._getParticipantIdForDataSourceId=function(e,t){return e.getParticipantIdForSourceId(4,t)},t.prototype._getDataSourceIdForParticipantId=function(e,t){return this._dataChannel?e.getSourceId(t,4):(this._logger.error("Null data channel cannot map participant to source id"),-1)},t.prototype._getDataSourceIdForParticipantLeg=function(e){return this._getDataSourceIdForParticipantId(e.participant,e.participantId)},t.prototype._getSharerDataSourceId=function(){var e=this._sharerParticipant.getSharingParticipantLeg();return e?this._getDataSourceIdForParticipantId(this._sharerParticipant,e):(this._logger.warn("unable to identify the sharer participantId, falling back to first data channel"),this._mapParticipantToSourceId(this._sharerParticipant))},t.prototype.terminateControl=function(){if(this._isViewing()){if(4!==this.controlState)return Promise.reject(new Error("terminateControl called while not in control"));if(!this._sharerParticipant)return Promise.reject(new Error("terminateControl called but _sharerParticipant is null"))}else{if(!this._isSharing())return Promise.reject(new Error("terminateControl called but not sharing nor viewing"));if(!this._controllerParticipant)return Promise.reject(new Error("terminateControl called but controllerParticipant is null"))}return this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while terminating control")):this._acceptControlPromise?Promise.reject(new Error("accept control promise has not been resolved yet while terminating control")):this._grantControlPromise?Promise.reject(new Error("grant control promise has not been resolved yet while terminating control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while terminating control")):this._terminateControl()},t.prototype._terminateControl=function(e){var t=this;void 0===e&&(e=!0),this._logger.info("_terminateControl()"),this._terminateControlPromise=d.defer();var n=function(){t._terminateControlPromise=null};this._terminateControlPromise.promise.then(n,n);var r,i,o=0,a=e?8:7;if(this._isViewing()){if(4!==this.controlState)return this._logger.error("Local viewer called terminateControl when not controlling"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local viewer called terminateControl when not controlling"));this._teardownViewerRemoteControl(),o=6,r=this._getSharerDataSourceId(),i=""}else{if(3!==this.controlState||!this._controllerParticipant)return this._logger.error("Local sherer called terminateControl when no one is in control"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local sherer called terminateControl when no one is in control"));this._teardownSharerRemoteControl(),o=5,r=this._getDataSourceIdForParticipantLeg(this._controllerParticipant),i=this._controllerParticipant.participant.id}if(!this._sendRequest({action:a,terminatedReason:o},r)){if(e)return this._logger.error("fail to send the terminate control request"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("fail to send the grant control request!"));this._logger.error("fail to send the terminateNoAck request")}this.controlState=e?5:0;var s={inControl:!1,id:i,terminatedReason:o};return this.event("sharingControlChanged").raise(s),e?(this._terminateControlTimer=setTimeout(function(){5===t.controlState?(t.controlState=0,t._resetControllerParticipant(),t._logger.error("No ack received when terminating control - resending terminate request"),t._sendRequest({action:7,terminatedReason:4},r)||t._logger.error("fail to send the terminateNoAck request"),t._terminateControlPromise?t._terminateControlPromise.reject(new Error("No ack received when terminating control - resending terminate request")):t._logger.error("Unexpected, no promise could be resolved - controlState = ControlState.WaitingForTerminateAck")):t._terminateControlPromise?t._terminateControlPromise.reject(new Error("terminate control - times out in bad state - do nothing")):t._logger.error("Unexpected, no promise could be resolved - controlState = "+t.controlState),t._terminateControlTimer=null},1e4),this._terminateControlPromise.promise):(this._terminateControlPromise.resolve(),new Promise(function(e,t){e()}))},t.prototype._cancelTerminateControlTimer=function(){this._terminateControlTimer&&(this._terminateControlPromise&&this._terminateControlPromise.reject(new Error("cancelled by _cancelTerminateControlTimer")),clearTimeout(this._terminateControlTimer),this._terminateControlTimer=null)},t.prototype._disposeControlCapturer=function(){this._logger.info("_disposeControlCapturer"),this._clearCapturerEventSubscriptions(),this._controlCapturer&&(this._controlCapturer.dispose(),this._controlCapturer=null)},t.prototype.dispose=function(){this._logger.info("SlimCoreElectronScreenSharingControl.dispose()"),this._detachAndDeleteControlDevices(),this._resetControlState(),this._dataChannel&&(this._dataChannel=null),this._disposeRenderer(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._resetParticipantSubscriptions(),this._finalizeViewerSessionTelemetry(a.SESSION_SHUTDOWN),this._finalizeSharerSessionTelemetry(C.SESSION_SHUTDOWN),e.prototype.dispose.call(this)},t}(m.default);t.default=I},function(e,t,n){!function(t,r){e.exports=r(n(0))}("undefined"!=typeof self&&self,function(e){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function r(e){switch(e){case 0:return 0;case 2:return 1;case 1:return 2;default:return}}var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=250,a=function(e){function t(t,n,i){void 0===i&&(i=!0);var a=e.call(this)||this;return a._logger=t,a._element=n,a._captureRegionPreserveAspectRatio=i,a._mouseMoveCount=0,a._isMouseOnRenderer=!1,a._captureMode=0,a._pollTimerID=0,a._resizeTimerID=0,a._handleResizeEvents=function(){clearTimeout(a._resizeTimerID),a._resizeTimerID=window.setTimeout(function(){return a.updateCaptureRegion()},o)},a._handleMouseLeave=function(e){!a._isOnScreenContent(e)&&a._isMouseOnRenderer&&(a._raiseCaptureEvent(2),a._logger.info("Mouse leaving render region")),a._isMouseOnRenderer=!1},a._handleMouseEnter=function(e){a._isOnScreenContent(e)&&(a._isMouseOnRenderer=!0,a._raiseCaptureEvent(1),a._logger.info("Mouse entering render region"))},a._handleLosingFocus=function(e){a._syncKeyStates(!0)},a._handleClick=function(e){a._isOnScreenContent(e)&&(a._raiseCaptureEvent(0),a._logger.info("Mouse clicked"))},a._handleMouseMove=function(e){if(!a._isOnScreenContent(e)&&a._isMouseOnRenderer)return a._raiseCaptureEvent(2),a._isMouseOnRenderer=!1,void a._logger.info("Mouse leaving render region");if(a._isOnScreenContent(e)&&!a._isMouseOnRenderer&&(a._raiseCaptureEvent(1),a._isMouseOnRenderer=!0,a._logger.info("Mouse entering render region")),(2===a._captureMode||3===a._captureMode)&&(a._mouseMoveCount++,a._isOnScreenContent(e)&&a._mouseMoveCount%2!=0)){var t={type:0};a._normalizeMousePosition(e,t),a._raiseMouseEvent(t)}},a._handleMouseDown=function(e){if((2===a._captureMode||3===a._captureMode)&&a._isOnScreenContent(e)){var t={type:2,buttonType:r(e.button),buttonDown:!0};a._normalizeMousePosition(e,t),a._raiseMouseEvent(t)}},a._handleMouseUp=function(e){if((2===a._captureMode||3===a._captureMode)&&a._isOnScreenContent(e)){var t={type:2,buttonType:r(e.button),buttonDown:!1};a._normalizeMousePosition(e,t),a._raiseMouseEvent(t)}},a._handleKeyDown=function(e){a._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!1}),e.stopPropagation(),e.preventDefault()},a._handleKeyUp=function(e){a._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!0}),e.stopPropagation(),e.preventDefault()},a._handleWheel=function(e){a._raiseMouseEvent({type:1,wheelRotation:e.deltaY>0?-120:120})},a._handleContextMenu=function(e){e.preventDefault()},a._ensureCanReceiveKeyboardInput(),a._element.ownerDocument&&a._element.ownerDocument.defaultView&&a._element.ownerDocument.defaultView.addEventListener("resize",a._handleResizeEvents,!1),a._captureRegion={left:0,top:0,width:a._element.clientWidth,height:a._element.clientHeight},a._videoSize={width:640,height:360},a._origElementSize={width:0,height:0},a._checkElementSize(),a}return i(t,e),Object.defineProperty(t.prototype,"captureMode",{get:function(){return this._captureMode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"captureRegion",{get:function(){return this._captureRegion},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._logger.info("Disposing of Control Capturer"),window.clearTimeout(this._pollTimerID),this._element.ownerDocument&&this._element.ownerDocument.defaultView&&this._element.ownerDocument.defaultView.removeEventListener("resize",this._handleResizeEvents,!1)},t.prototype.updateVideoSize=function(e,t){this._videoSize.width=e,this._videoSize.height=t,this.updateCaptureRegion()},t.prototype.updateCaptureRegion=function(){this._captureRegionPreserveAspectRatio?(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientWidth*this._videoSize.height/this._videoSize.width,this._captureRegion.height>this._element.clientHeight?(this._captureRegion.width=this._element.clientHeight*this._videoSize.width/this._videoSize.height,this._captureRegion.height=this._element.clientHeight,this._captureRegion.left=(this._element.clientWidth-this._captureRegion.width)/2,this._captureRegion.top=0):(this._captureRegion.left=0,this._captureRegion.top=(this._element.clientHeight-this._captureRegion.height)/2)):(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientHeight,this._captureRegion.top=0,this._captureRegion.left=0)},t.prototype.setCaptureMode=function(e){3===this._captureMode&&3!==e&&this._syncKeyStates(!0),this._captureMode=e,0!==e?(this._element.addEventListener("click",this._handleClick),this._element.addEventListener("pointermove",this._handleMouseMove),this._element.addEventListener("pointerdown",this._handleMouseDown),this._element.addEventListener("pointerup",this._handleMouseUp),this._element.addEventListener("pointerenter",this._handleMouseEnter),this._element.addEventListener("pointerleave",this._handleMouseLeave),3===e?(this._element.addEventListener("wheel",this._handleWheel),this._element.addEventListener("keydown",this._handleKeyDown),this._element.addEventListener("keyup",this._handleKeyUp),this._element.addEventListener("contextmenu",this._handleContextMenu),this._element.addEventListener("blur",this._handleLosingFocus)):(this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))):(this._element.removeEventListener("pointermove",this._handleMouseMove),this._element.removeEventListener("pointerdown",this._handleMouseDown),this._element.removeEventListener("pointerup",this._handleMouseUp),this._element.removeEventListener("pointerenter",this._handleMouseEnter),this._element.removeEventListener("pointerleave",this._handleMouseLeave),this._element.removeEventListener("click",this._handleClick),this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))},t.prototype._ensureCanReceiveKeyboardInput=function(){this._element.tabIndex=this._element.tabIndex},t.prototype._checkElementSize=function(){var e=this;this._origElementSize.width===this._element.clientWidth&&this._origElementSize.height===this._element.clientHeight||(this.updateCaptureRegion(),this._origElementSize.width=this._element.clientWidth,this._origElementSize.height=this._element.clientHeight),this._pollTimerID=window.setTimeout(function(){return e._checkElementSize()},3e3)},t.prototype._raiseMouseEvent=function(e){this.event("mouseControlEvent").raise(e)},t.prototype._raiseKeyboardEvent=function(e){this.event("keyboardControlEvent").raise(e)},t.prototype._raiseCaptureEvent=function(e){this.event("ctrlCaptureEvent").raise(e)},t.prototype._normalizeMousePosition=function(e,t){t.xPos=(e.offsetX-this._captureRegion.left)/this._captureRegion.width*65535,t.yPos=(e.offsetY-this._captureRegion.top)/this._captureRegion.height*65535},t.prototype._isOnScreenContent=function(e){var t=this._captureRegion.left,n=this._captureRegion.left+this._captureRegion.width,r=this._captureRegion.top,i=this._captureRegion.top+this._captureRegion.height;return t<=e.offsetX&&e.offsetX<n&&r<=e.offsetY&&e.offsetY<i},t.prototype._syncKeyStates=function(e){this._raiseKeyboardEvent({codeType:1,code:17,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:16,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:18,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:91,repeat:!1,keyUp:e}),this._logger.info("Synced Key states.")},t.formatMouseEvent=function(e){if(!e)return new Uint8Array(0);e.buttonType||(e.buttonType=0),e.xPos||(e.xPos=0),e.yPos||(e.yPos=0),e.wheelRotation||(e.wheelRotation=0);var t=new ArrayBuffer(7),n=new DataView(t),r=(3&e.type)<<0,i=(7&e.buttonType)<<2,o=(e.buttonDown?1:0)<<5,a=(e.wheelButtonDown?1:0)<<6;return n.setUint8(0,1),n.setUint8(1,r|i|o|a|0),n.setUint16(2,e.xPos,!0),n.setUint16(4,e.yPos,!0),n.setUint8(6,e.wheelRotation),new Uint8Array(t)},t.formatKeyboardEvent=function(e){var t=new ArrayBuffer(3),n=new DataView(t),r=(3&e.codeType)<<0,i=(e.keyUp?1:0)<<4,o=(e.repeat?1:0)<<5;return n.setUint8(0,0),n.setUint8(1,0|(0|r|i|o)),n.setUint8(2,e.code),new Uint8Array(t)},t}(n(2).default);t.SlimCoreElectronControlCapturer=a},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t){return e.call(this,t)||this}return r(t,e),t.prototype.changed=function(e){return this.subscribe({changed:e,on:void 0})},t.prototype.on=function(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})},t.prototype.once=function(e,t,n){var r,i=this;return r=this.on(e,this._fromEventCallback(function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];r.dispose(n),i._toEventCallback(t).apply(void 0,e)}))},t.prototype.raiseChanged=function(){this.raiseEvents(function(e){return e.changed&&e.changed()})},t.prototype.event=function(e){var t=this;return{raise:this._fromEventCallback(function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return t._raiseEventImpl.apply(t,[String(e)].concat(n))})}},t.prototype._raiseEventImpl=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.raiseEvents(function(n){var r;return n.on&&n.on.name===e&&(r=n.on).handler.apply(r,t)})},t.prototype._toEventCallback=function(e){return e},t.prototype._fromEventCallback=function(e){return e},t}(n(3).EventSourceImpl);t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=function(){function e(e){this.subscriptions=[],this.eventLogger=e}return e.prototype.subscribe=function(e){return new o(this.subscriptions,e)},e.prototype.dispose=function(e){this.subscriptions=[]},e.prototype.raiseEvents=function(e){var t=this;this.subscriptions.slice().forEach(function(n){try{void 0!==n.eventHandler&&e(n.eventHandler)}catch(e){t.eventLogger&&t.eventLogger.warn&&t.eventLogger.warn("Event handler exception caught!",e)}})},e}();t.EventSourceImpl=i;var o=function(){function e(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}return e.prototype.dispose=function(){var e=this;r.remove(this.subscriptions,function(t){return t===e}),this.eventHandler=void 0},e}()},function(t,n){t.exports=e}])})},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{l(r.next(e))}catch(e){o(e)}}function s(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((r=r.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n){this._create=e,this._release=t,this._logger=n,this._bindingMap={},this._logger.info("BindingManager created")}return e.prototype.acquire=function(e,t){var n=this;if(!this._bindingMap[t]||this._bindingMap[t].releasePromise){var r=!1,i=void 0;this._bindingMap[t]?(i=this._bindingMap[t].releasePromise.catch(function(e){return n._logger.info("Release binding error: "+e)}),r=!0):i=Promise.resolve();var o=i.then(function(){return n._create(t)}).then(function(e){return e}).catch(function(e){throw delete n._bindingMap[t],e});this._bindingMap[t]={createPromise:o,owners:[],chained:r}}return this._bindingMap[t].owners.push(e),this._bindingMap[t].createPromise},e.prototype.release=function(e,t){return r(this,void 0,void 0,function(){var n,r,o=this;return i(this,function(i){switch(i.label){case 0:return this._bindingMap[t]?[4,this._bindingMap[t].createPromise]:[3,2];case 1:if(n=i.sent(),(r=this._bindingMap[t].owners.indexOf(e))>-1&&this._bindingMap[t].owners.splice(r,1),0===this._bindingMap[t].owners.length)return this._bindingMap[t].releasePromise=this._release(t,n).then(function(){o._bindingMap[t].chained||delete o._bindingMap[t]}),[2,this._bindingMap[t].releasePromise];i.label=2;case 2:return[2]}})})},e}();t.SlimCoreElectronBindingManager=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(8),i=n(53),o=n(54),a=n(55);t.initDelegate=function(e,t){if(!r.RootToolsManager.isDelegateSet()){var n=new a.RootToolsManagerDelegate(e,t.logger);r.RootToolsManager.setDelegate(n)}},t.patchLogger=function(e){if(!r.RootToolsManager.isDelegateSet()&&e.logger){var t=new o.RedirectingLogAppender(e.logger);r.LogFactory.instance().addAppender(t)}e.logger=new i.TsCallingLogger("JS.TsCalling.Electron",!1)},t.deinitLogging=function(){r.RootToolsManager.stopAsyncOperations()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(8),i=n(0),o=function(){function e(e,t,n){void 0===n&&(n=""),this.ulLogComponent=e,this.ulSafeComponent=t,this._getPrefix=i.isFunction(n)?n:function(){return n},this.logComponent=r.LogFactory.instance().component(this.ulLogComponent),r.LogFactory.instance().declareComponentSafe(this.ulLogComponent,t)}return e.prototype.createChild=function(t){var n=this,r=i.isFunction(t)?t:function(){return t};return new e(this.ulLogComponent,this.ulSafeComponent,function(){return n._getPrefix()?n._getPrefix()+"/"+r():r()})},e.prototype.log=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._apply(function(t){return e.logComponent.debug2(null,t)},t)},e.prototype.debug=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._apply(function(t){return e.logComponent.debug4(null,t)},t)},e.prototype.info=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._apply(function(t){return e.logComponent.debug1(null,t)},t)},e.prototype.warn=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._apply(function(t){return e.logComponent.warn(null,t)},t)},e.prototype.error=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._apply(function(t){return e.logComponent.error(null,t)},t)},e.prototype._apply=function(e,t){void 0===t&&(t=[]),this._addPrefix(t),e(t.map(function(e){return e instanceof DOMException?e.toString():e}).map(function(e){return i.isObject(e)?JSON.stringify(e):e}).join(", "))},e.prototype._addPrefix=function(e){if(e&&e[0]){var t=this._getPrefix()+" "+e[0];e[0]=t}},e}();t.TsCallingLogger=o},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(8),o=function(e){function t(t){var n=e.call(this,new i.StandardLogFormatter(i.SLF_Flags.Component))||this;return n._logger=t,n}return r(t,e),t.prototype.log=function(e,t,n,r){if(this._logger){var o=e.level<=i.LogLevel.Debug4?this._logger.debug:e.level<=i.LogLevel.Debug2?this._logger.log:e.level<=i.LogLevel.Debug1?this._logger.info:e.level<=i.LogLevel.Warning?this._logger.warn:this._logger.error;o&&o.apply(this._logger,[this.formatter().format(e,t,n,r)])}},t}(i.AbstractLogAppender);t.RedirectingLogAppender=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(56),i=function(){function e(e,t){this._slimcore=e,this._logger=t}return e.prototype.fetchEcsConfig=function(e,t){return r.Resolved(void 0)},e.prototype.sendTelemetry=function(e,t){},e.prototype.sendLoggingEventToNative=function(e,t){this._slimcore.handleLoggingEvent?this._slimcore.handleLoggingEvent(e,t):this._logger.warn("slimcore.handleLoggingEvent is not available")},e.prototype.setNativeLoggingEventCallback=function(e){var t=this;e&&"function"==typeof e?this._slimcore.handle("logging-event",void 0,function(n){t._logger.debug("RootToolsManagerDelegate: LoggingNativeEvent msg:"+n.message+" aux"+n.auxiliaryPayload),e(n.message,n.auxiliaryPayload)}):this._logger.warn("RootToolsManagerDelegate.setNativeLoggingEventCallback invalid callback provided")},e}();t.RootToolsManagerDelegate=i},function(e,t,n){"use strict";(function(e){function n(e){return null!==e&&void 0!==e&&"function"==typeof e.then}function r(e){return null!==e&&void 0!==e&&"function"==typeof e.cancel}function i(e,n){if(!t.config.catchExceptions)return e();try{return e()}catch(e){return n(e)}}function o(t){d.push(t),1===d.length&&(u?e(a):setTimeout(a,0))}function a(){var e=d;d=[];for(var t=0;t<e.length;t++)e[t]()}function s(){return new p.SyncTask}function l(e){return(new p.SyncTask).resolve(e).promise()}function c(e){var t=s(),i=!1;return t.onCancel(function(t){e.forEach(function(e){r(e)&&p.SyncTask.cancelOtherInternal(e,t)})}),e.forEach(function(e){n(e)?e.then(function(e){i||(i=!0,t.resolve(e))},function(e){i||(i=!0,t.reject(e))}):i||(i=!0,t.resolve(e))}),t.promise()}Object.defineProperty(t,"__esModule",{value:!0}),t.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(e){throw e}},t.fromThenable=function(e){var t=s();return e.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().thenAsync(function(e){return e})};var d=[],u=void 0!==e;t.asyncCallback=o;var p;!function(e){var a=function(){function e(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return e.prototype._addCallbackSet=function(t,n){var r=this,i=new e;return i.onCancel(function(e){t.wasCanceled=!0,t.cancelContext=e,r._cancelInternal(e)}),t.task=i,this._storedCallbackSets.push(t),n?this._mustHandleError=!1:i._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),i.promise()},e.prototype.onCancel=function(e){return this._completedSuccess||this._completedFail||(this._wasCanceled?e(this._cancelContext):this._cancelCallbacks.push(e)),this},e.prototype.then=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t},!0)},e.prototype.thenAsync=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t,asyncCallback:!0},!0)},e.prototype.catch=function(e){return this._addCallbackSet({failFunc:e},!0)},e.prototype.always=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!0)},e.prototype.setTracingEnabled=function(e){return this._traceEnabled=e,this},e.prototype.finally=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!1),this},e.prototype.done=function(e){return this._addCallbackSet({successFunc:e},!1),this},e.prototype.fail=function(e){return this._addCallbackSet({failFunc:e},!1),this},e.prototype.resolve=function(e){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=e,this._cancelCallbacks=[],this._resolveSuccesses(),this},e.prototype.reject=function(t){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=t,this._cancelCallbacks=[],this._resolveFailures(),e._enforceErrorHandled(this),this},e.prototype._checkState=function(e){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var n="Failed to "+(e?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(n)}(t.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},e._enforceErrorHandled=function(n){n._mustHandleError&&(e._rejectedTasks.push(n),e._enforceErrorHandledTimer||(e._enforceErrorHandledTimer=setTimeout(function(){e._enforceErrorHandledTimer=void 0;var n=e._rejectedTasks;e._rejectedTasks=[],n.forEach(function(e,n){e._mustHandleError&&t.config.unhandledErrorHandler(e._storedErrResolution)})},0)))},e.prototype.cancel=function(e){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(e)},e.prototype._cancelInternal=function(e){var t=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=e;var n=this._cancelCallbacks;this._cancelCallbacks=[],n.length>0&&n.forEach(function(e){t._completedSuccess||t._completedFail||e(t._cancelContext)})}},e.cancelOtherInternal=function(e,t){var n=e;n._storedCallbackSets&&n._cancelInternal?n._cancelInternal(t):e.cancel(t)},e.prototype.promise=function(){return this},e.prototype._resolveSuccesses=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach(function(t){t.asyncCallback?o(function(){return e._resolveSuccessCallback(t)}):e._resolveSuccessCallback(t)})}this._resolving=!1},e.prototype._resolveSuccessCallback=function(t){var o=this;t.successFunc?i(function(){var i=t.successFunc(o._storedResolution);r(i)&&(t.wasCanceled?e.cancelOtherInternal(i,t.cancelContext):t.task.onCancel(function(t){return e.cancelOtherInternal(i,t)})),n(i)?i.then(function(e){t.task.resolve(e)},function(e){t.task.reject(e)}):t.task.resolve(i)},function(e){o._handleException(e,"SyncTask caught exception in success block: "+e.toString()),t.task.reject(e)}):t.task.resolve(this._storedResolution)},e.prototype._resolveFailures=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach(function(t){t.asyncCallback?o(function(){return e._resolveFailureCallback(t)}):e._resolveFailureCallback(t)})}this._resolving=!1},e.prototype._resolveFailureCallback=function(t){var o=this;t.failFunc?i(function(){var i=t.failFunc(o._storedErrResolution);r(i)&&(t.wasCanceled?e.cancelOtherInternal(i,t.cancelContext):t.task.onCancel(function(t){return e.cancelOtherInternal(i,t)})),n(i)?i.then(function(e){t.task.resolve(e)},function(e){t.task.reject(e)}):t.task.resolve(i)},function(e){o._handleException(e,"SyncTask caught exception in failure block: "+e.toString()),t.task.reject(e)}):t.task.reject(this._storedErrResolution)},e.prototype._handleException=function(e,n){t.config.exceptionsToConsole&&console.error(n),t.config.exceptionHandler&&t.config.exceptionHandler(e)},e.prototype.toEs6Promise=function(){var e=this;return new Promise(function(t,n){return e.then(t,n)})},e._rejectedTasks=[],e}();e.SyncTask=a}(p||(p={})),t.all=function(e){if(0===e.length)return l([]);var t,i=s(),o=e.length,a=Array(e.length);i.onCancel(function(t){e.forEach(function(e){r(e)&&p.SyncTask.cancelOtherInternal(e,t)})});var c=function(){0==--o&&(void 0!==t?i.reject(t):i.resolve(a))};return e.forEach(function(e,r){n(e)?e.then(function(e){a[r]=e,c()},function(e){void 0===t&&(t=void 0===e||e),c()}):(a[r]=e,c())}),i.promise()},t.Defer=s,t.Resolved=l,t.Rejected=function(e){return(new p.SyncTask).reject(e).promise()},t.race=c,t.raceTimer=function(e,t){var n=s(),r=setTimeout(function(){n.resolve({timedOut:!0})},t);return c([e.then(function(e){return clearTimeout(r),{timedOut:!1,result:e}}),n.promise()])}}).call(t,n(57).setImmediate)},function(e,t,n){(function(e){function r(e,t){this._id=e,this._clearFn=t}var i=void 0!==e&&e||"undefined"!=typeof self&&self||window,o=Function.prototype.apply;t.setTimeout=function(){return new r(o.call(setTimeout,i,arguments),clearTimeout)},t.setInterval=function(){return new r(o.call(setInterval,i,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},r.prototype.unref=r.prototype.ref=function(){},r.prototype.close=function(){this._clearFn.call(i,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(58),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(t,n(39))},function(e,t,n){(function(e,t){!function(e,n){"use strict";function r(e){delete l[e]}function i(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}function o(e){if(c)setTimeout(o,0,e);else{var t=l[e];if(t){c=!0;try{i(t)}finally{r(e),c=!1}}}}if(!e.setImmediate){var a,s=1,l={},c=!1,d=e.document,u=Object.getPrototypeOf&&Object.getPrototypeOf(e);u=u&&u.setTimeout?u:e,"[object process]"==={}.toString.call(e.process)?a=function(e){t.nextTick(function(){o(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&o(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),a=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){o(e.data)},a=function(t){e.port2.postMessage(t)}}():d&&"onreadystatechange"in d.createElement("script")?function(){var e=d.documentElement;a=function(t){var n=d.createElement("script");n.onreadystatechange=function(){o(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():a=function(e){setTimeout(o,0,e)},u.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return l[s]=r,a(s),s++},u.clearImmediate=r}}("undefined"==typeof self?void 0===e?this:e:self)}).call(t,n(39),n(59))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function i(e){if(d===setTimeout)return setTimeout(e,0);if((d===n||!d)&&setTimeout)return d=setTimeout,setTimeout(e,0);try{return d(e,0)}catch(t){try{return d.call(null,e,0)}catch(t){return d.call(this,e,0)}}}function o(e){if(u===clearTimeout)return clearTimeout(e);if((u===r||!u)&&clearTimeout)return u=clearTimeout,clearTimeout(e);try{return u(e)}catch(t){try{return u.call(null,e)}catch(t){return u.call(this,e)}}}function a(){_&&h&&(_=!1,h.length?g=h.concat(g):f=-1,g.length&&s())}function s(){if(!_){var e=i(a);_=!0;for(var t=g.length;t;){for(h=g,g=[];++f<t;)h&&h[f].run();f=-1,t=g.length}h=null,_=!1,o(e)}}function l(e,t){this.fun=e,this.array=t}function c(){}var d,u,p=e.exports={};!function(){try{d="function"==typeof setTimeout?setTimeout:n}catch(e){d=n}try{u="function"==typeof clearTimeout?clearTimeout:r}catch(e){u=r}}();var h,g=[],_=!1,f=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];g.push(new l(e,t)),1!==g.length||_||i(s)},l.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=c,p.addListener=c,p.once=c,p.off=c,p.removeListener=c,p.removeAllListeners=c,p.emit=c,p.prependListener=c,p.prependOnceListener=c,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i,o=n(0);!function(e){e[e.Integer=0]="Integer",e[e.String=1]="String",e[e.Binary=2]="Binary"}(i||(i={}));var a=function(e){function t(t){var n=e.call(this,t)||this;return n.eventListenerArrays={},void 0!==t.oncommonwrapperevent&&(t.oncommonwrapperevent=function(e){var t=n.argsFromCommonWrapperEventPayload(e),r=n.eventListenerArrays[e.target];r&&r.forEach(function(e){e(t)})}),n}return r(t,e),t.prototype.argsFromCommonWrapperEventPayload=function(e){if("object-property-changed"===e.target){var t=e.detail[0],n={objectType:t.objectType,objectId:t.objectId,propKey:t.propKey,value:void 0};switch(t.value.type){case i.Integer:n.value=t.value.intVal;break;case i.String:n.value=t.value.strVal;break;case i.Binary:n.value=t.value.binVal}return n}return e.detail[0]},t.prototype.addListener=function(e,t){var n=this.eventListenerArrays[e];return n||(n=this.eventListenerArrays[e]=[]),-1===n.indexOf(t)&&n.push(t),this},t.prototype.on=function(e,t){return this.addListener(e,t)},t.prototype.once=function(e,t){return this.addListener(e,t)},t.prototype.removeListener=function(e,t){var n=this.eventListenerArrays[e];if(n){var r=n.indexOf(t);r>-1&&n.splice(r,1)}return this},t.prototype.removeAllListeners=function(e){var t=this;if(e){var n=this.eventListenerArrays[e];return n&&(n=this.eventListenerArrays[e]=[]),this}return Object.keys(this.eventListenerArrays).forEach(function(e){t.eventListenerArrays[e]=[]}),this},t.prototype.getMaxListeners=function(){return 0},t.prototype.setMaxListeners=function(e){},t.prototype.listeners=function(e){return this.eventListenerArrays[e]},t.prototype.emit=function(e,t){var n=this.eventListenerArrays[e];return n&&n.forEach(function(e){e(t)}),!0},t}(function(){function e(e){var t=this;this._nativeObject=e,o.forIn(e,function(e,n,r){o.isFunction(e)?t[n]||(t[n]=function(){return e.apply(r,arguments)}):Object.defineProperty(t,n,{get:function(){return r[n]},set:function(e){r[n]=e}})})}return Object.defineProperty(e.prototype,"objectToWrap",{get:function(){return this._nativeObject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"objectAsWrapped",{get:function(){return this},enumerable:!0,configurable:!0}),e}()),s=function(e){function t(t){return e.call(this,t)||this}return r(t,e),t}(a),l=function(e){function t(t){return e.call(this,t)||this}return r(t,e),t.prototype.getAccount=function(e){var t=this.objectToWrap.getAccount(e);return new a(t).objectAsWrapped},t.prototype.getCallHandler=function(e){var t=this.objectToWrap.getCallHandler(e);return new a(t).objectAsWrapped},t.prototype.createCallInterface=function(){var e=this.objectToWrap.createCallInterface();return new a(e).objectAsWrapped},t.prototype.getContentSharing=function(e){var t=this.objectToWrap.getContentSharing(e);return new a(t).objectAsWrapped},t.prototype.createVideoBindingRenderer=function(e){var t=this.objectToWrap.createVideoBindingRenderer(e);return new s(t).objectAsWrapped},t.prototype.createVideoBindingScreenShare=function(){var e=this.objectToWrap.createVideoBindingScreenShare();return new s(e).objectAsWrapped},t.prototype.videoCreateBinding=function(e,t){var n=this;return new Promise(function(r,i){var o=t,a=o.objectToWrap;void 0!==a.onvideobindingcreatedevent&&(a.onvideobindingcreatedevent=function(){r()}),void 0!==a.onvideobindingfailedevent&&(a.onvideobindingfailedevent=function(){n.objectToWrap.videoReleaseBinding(e,o.objectToWrap),i("binding creation failed")}),n.objectToWrap.videoCreateBinding(e,o.objectToWrap)})},t.prototype.videoReleaseBinding=function(e,t){var n=this;return new Promise(function(r,i){var o=t,a=o.objectToWrap;void 0!==a.onvideobindingreleasedevent&&(a.onvideobindingreleasedevent=function(){r()}),n.objectToWrap.videoReleaseBinding(e,o.objectToWrap)})},t.prototype.setMediaConfig=function(e){this.objectToWrap.setMediaConfig(JSON.stringify(e))},t}(a);t.UwpEngineWrapped=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(38);t.slimCoreElectronStackFactory=r.slimCoreElectronStackFactory,t.slimCoreUwpStackFactory=r.slimCoreUwpStackFactory;var i=n(10);t.getOvb=i.getOvb,t.getVersion=i.getTsCallingVersion;var o=n(2);t.generateCauseId=o.generateCauseId}])});